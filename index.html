<!DOCTYPE html>
<html lang='en-US'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment Buddy Smart (2.0)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <script src="lib/face-api.min.js"></script> 
    <script src="lib/jszip.min.js"></script>
    <script src="lib/pdfkit.min.js"></script>
    <script src="lib/blob-stream.min.js"></script>
    <script src="shareable_html_generator.js"></script>

    <style>
/* Smooth Modal Entry */
@keyframes modalFadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
.gy-modal-content, .modal-content {
    animation: modalFadeIn 0.2s ease-out;
}

/* --- NEW: Split Layout for Drag & Drop --- */
.gy-split-container {
    display: flex;
    gap: 20px;
    height: 60vh; /* Fixed height to enable internal scrolling */
    border-top: 1px solid #e2e8f0;
    padding-top: 20px;
    margin-top: 20px;
}

/* Left Side: Source Gallery */
.gy-source-panel {
    width: 300px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #e2e8f0;
    padding-right: 15px;
}

.gy-source-scroll {
    overflow-y: auto;
    flex-grow: 1;
    padding: 5px;
}

/* Right Side: Cards List */
.gy-cards-panel {
    flex-grow: 1;
    overflow-y: auto; /* Independent scrolling */
    padding-right: 10px;
    position: relative;
}

/* Gallery Grid Tweak */
/* Gallery Grid Container */
        #gySourceGrid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* 2 columns */
            gap: 0.75rem; 
            overflow-y: auto; 
            align-content: start; 
            padding: 0.25rem;
            flex: 1;       /* CRITICAL: Fills the remaining vertical space */
            min-height: 0; /* CRITICAL: Allows scrolling inside a flex container */
        }
        
        /* Gallery Item Card */
        .gy-source-item { 
            position: relative; 
            height: 8rem; /* CRITICAL: Explicit height (approx 128px) prevents collapse */
            width: 100%; 
            background: white; 
            border-radius: 0.5rem; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            overflow: hidden; 
            cursor: grab; 
            transition: all 0.2s; 
        }
        .gy-source-item:hover { border-color: #a5b4fc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* The Image Inside */
        .gy-source-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image fills the box perfectly */
            pointer-events: none;
        }

/* Drag Auto-Scroll Hotzones */
.scroll-zone {
    position: absolute; left: 0; right: 0; height: 50px; z-index: 20;
    pointer-events: none; /* Let clicks pass through */
}
.scroll-top { top: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent); }
.scroll-bottom { bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.1), transparent); }

/* Modern Scrollbars */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
::-webkit-scrollbar-track {
    background: #f1f5f9; 
}
::-webkit-scrollbar-thumb {
    background: #cbd5e1; 
    border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
    background: #94a3b8; 
}

/* Risk Badge Classes (can be applied via JS) */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}
.badge-critical { background-color: #fee2e2; color: #991b1b; }
.badge-high { background-color: #ffedd5; color: #9a3412; }
.badge-medium { background-color: #fef9c3; color: #854d0e; }
.badge-low { background-color: #dcfce7; color: #166534; }

        /* ADD TO YOUR CSS */
.gy-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
}
.gy-modal-content {
    background: white; width: 95%; max-width: 1600px; height: 90%; 
    border-radius: 16px; padding: 40px; overflow-y: auto; position: relative;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); font-family: 'Segoe UI', sans-serif;
}
.gy-close-modal {
    position: absolute; top: 15px; right: 20px; font-size: 30px; border: none; 
    background: none; cursor: pointer; color: #666;
}
.gy-dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 25px; margin-bottom: 30px; }
.gy-dropzone {
    border: 3px dashed #27ae60; border-radius: 10px; padding: 20px; text-align: center; background: #f0fff4; 
    cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center;
    transition: all 0.2s; height: 100%; box-sizing: border-box;
}
.gy-dropzone:hover { background: #e8f8f0; border-color: #219150; transform: translateY(-2px); }
.gy-mapper-box { background: #f8f9fa; border: 1px solid #e9ecef; padding: 20px; border-radius: 10px; }
.gy-mapper-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
.gy-mapper-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
.gy-map-field input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
#gyRefreshBtn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; }
.gy-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 25px; margin-top: 20px; }
.gy-card { border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; background: white; display: flex; flex-direction: column; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.gy-card-img { height: 200px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #eee; overflow: hidden; }
.gy-card-img img { max-width: 100%; max-height: 100%; object-fit: contain; }
.gy-row-badge { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; pointer-events: none; z-index: 5; }
.gy-action-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; border: none; position: absolute; top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.gy-down-btn { right: 80px; background: #10b981; color: white; }
.gy-down-btn:hover { background: #059669; transform: scale(1.1); }
.gy-del-btn { right: 10px; background: #e74c3c; color: white; }
.gy-rep-btn { right: 45px; background: #3498db; color: white; }
.gy-card-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.gy-textarea { width: 100%; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px; font-size: 0.9rem; min-height: 50px; background: #fafafa; }
.gy-main-btn { background: #27ae60; color: white; border: none; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; }
        .btn-indigo { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); color: white; border: none; padding: 12px 24px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
        .btn-indigo:hover { background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4); }
        .btn-indigo:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-white { background: white; color: #4f46e5; border: 2px solid #4f46e5; padding: 10px 20px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .btn-white:hover { background: #f5f3ff; border-color: #4338ca; }


        /* Custom styles for Google Charts transparency */
        #riskChart div, #hazardChart div { background-color: transparent !important; }
        /* Fix for lightbox drag-and-drop */
        #lightboxGallery img.dragging { opacity: 0.5; cursor: grabbing; }
        .gallery-item { 
            border-radius: 0.5rem; 
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .gallery-item.dragging { 
            opacity: 0.5; 
            cursor: grabbing;
            transform: scale(0.95);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
        }
        /* Drop target indicator */
        .gallery-item.drop-target { 
            transition: none;
        }
        /* Drop position placeholder */
        .drop-position-placeholder {
            border: 3px dashed #fbbf24;
            background-color: rgba(251, 191, 36, 0.2);
            transition: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fbbf24;
            font-weight: bold;
            font-size: 14px;
            border-radius: 0.5rem;
            animation: placeholder-pulse 1.5s ease-in-out infinite;
        }
        .modal-hazard-invalid {
            outline: 2px solid #f87171;
            outline-offset: 1px;
        }
        .hazard-invalid {
            outline: 2px solid #f87171;
            outline-offset: 1px;
        }
        .text-hazard-invalid { color: #ef4444; font-weight: 600; }
        @keyframes placeholder-pulse {
            0%, 100% { 
                background-color: rgba(251, 191, 36, 0.2);
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4);
            }
            50% { 
                background-color: rgba(251, 191, 36, 0.3);
                box-shadow: 0 0 0 6px rgba(251, 191, 36, 0);
            }
        }
        /* Recording microphone pulse animation */
        @keyframes recording-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
            }
        }
        .speech-btn.recording {
            animation: recording-pulse 1s ease-in-out infinite !important;
            background-color: #dc2626 !important;
        }
        .speech-btn.recording:hover {
            background-color: #b91c1c !important;
        }
        /* Recording indicator overlay */
        .recording-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.5);
            animation: recording-indicator-pulse 1.5s ease-in-out infinite;
        }
        @keyframes recording-indicator-pulse {
            0%, 100% { 
                box-shadow: 0 4px 20px rgba(220, 38, 38, 0.5);
            }
            50% { 
                box-shadow: 0 4px 30px rgba(220, 38, 38, 0.8);
            }
        }
        .recording-indicator .rec-dot {
            width: 12px;
            height: 12px;
            background-color: #fff;
            border-radius: 50%;
            animation: rec-dot-blink 1s ease-in-out infinite;
        }
        @keyframes rec-dot-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        /* Interim transcription display */
        .speech-interim-display {
            position: fixed;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 15px;
            z-index: 9998;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .speech-interim-display .interim-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        .speech-interim-display .interim-text {
            color: #fbbf24;
            font-weight: 500;
        }
        /* Style for hidden file input */
        input[type="file"].hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        /* Ensure translate widgets don't overflow */
         .skiptranslate { overflow: hidden; }
         .goog-te-gadget { white-space: nowrap; }
        /* Deleted / struck-through row styling */
        .deleted-row td { text-decoration: line-through; opacity: 0.55; }
        .delete-btn { background:#ef4444; color:#fff; padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
        .restore-btn { background:#10b981; color:#fff; padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
        
        /* Hierarchy of Control Triangle */
        #controlTriangle {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            box-sizing: border-box;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .control-level {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: brightness(1) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            stroke-width: 2;
        }
        .control-level:hover {
            filter: brightness(1.1) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
            stroke-width: 2.5;
            opacity: 0.95;
        }
        .control-level.selected {
            filter: brightness(0.95) drop-shadow(0 6px 12px rgba(0, 0, 0, 0.2));
            stroke: #ffffff;
            stroke-width: 1.5;
            opacity: 1;
        }
        
        /* Custom scrollbar for risk reduction panel */
        .risk-panel-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }
        .risk-panel-scroll:hover {
            scrollbar-color: #cbd5e1 transparent;
        }
        .risk-panel-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .risk-panel-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .risk-panel-scroll::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 2px;
        }
        .risk-panel-scroll:hover::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
        }
        
        /* Risk Reduction Panel collapsible styling */
        #riskReductionPanel summary::-webkit-details-marker {
            display: none;
        }
        #riskReductionPanel > summary > span:last-child {
            transition: transform 0.2s ease;
        }
        #riskReductionPanel[open] > summary > span:last-child {
            transform: rotate(180deg);
        }
        
        /* Prevent rotation on nested details text spans */
        #riskReductionPanel details span[data-en-text] {
            display: inline-block;
        }
        
        
        .control-label {
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            user-select: none;
            dominant-baseline: middle;
        }
        
        /* Hide extra spacing for hidden language sections */
        details[style*="display: none"] {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            display: none !important;
        }

        /* Modern Hover Effect for Clickable Table Cells */
        .modern-hover-cell {
            transition: background 0.25s ease, box-shadow 0.25s ease;
            position: relative;
        }

        .modern-hover-cell::after {
            content: '‚úèÔ∏è';
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.25s ease;
            pointer-events: none;
        }

        .modern-hover-cell:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
            box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.4), 0 2px 8px rgba(59, 130, 246, 0.15) !important;
        }

        .modern-hover-cell:hover::after {
            opacity: 1;
        }

        /* EHS Standards Table Row Hover Effects */
        .ehs-freq-row,
        .ehs-sev-row,
        .ehs-like-row {
            transition: background 0.25s ease, box-shadow 0.25s ease;
        }

        .ehs-freq-row:hover,
        .ehs-sev-row:hover,
        .ehs-like-row:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
            box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.3), 0 2px 12px rgba(59, 130, 246, 0.12) !important;
        }

        /* EHS Value Cell (F, S, L numbers) Hover Effect */
        .select-ehs-value {
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .select-ehs-value:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.3), 0 4px 12px rgba(59, 130, 246, 0.35) !important;
            font-weight: 600;
        }

    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    <main class="mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8 space-y-8">
<div id="howToUseContainer">
<details class="bg-indigo-50 rounded-lg border border-indigo-200 mb-8 group overflow-hidden" id="howToUse-en" data-lang="en" style="display: block;">
    <summary class="p-6 flex justify-between items-center cursor-pointer list-none">
        <h2 class="text-xl font-semibold text-indigo-900">How to Use This App üöÄ</h2>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-700 transform transition-transform duration-200 group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
    </summary>

    <div class="px-6 pb-6 pt-0 space-y-4">
        <p class="text-indigo-700 font-semibold mb-4">Risk Assessment Buddy is a field accelerator tool that helps accelerate and streamline your risk assessment projects. There are three workflows for using this app:</p>

        <!-- Workflow 1: Image/Video First -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üé• Workflow 1: Start Fresh with Rich Media (Images/Videos)</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Upload images or videos of your risk assessment project.</li>
                <li>Faces are automatically detected and blurred. If auto-detection fails, manually blur faces by clicking with the mouse.</li>
                <li>Add details to each image, preferably sitting with your operational leads:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li><strong>Description</strong>: Explain what is happening in the image</li>
                        <li><strong>Hazards</strong>: Identify potential hazards (optional rating: 1-5)</li>
                        <li><strong>Controls</strong>: Suggest mitigations or controls</li>
                    </ul>
                </li>
                <li>Once image notes are complete, click <strong class="font-medium">"Generate AI Risk Assessment from Image Notes"</strong></li>
                <li>AI will process your notes:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li>If you added a manual risk rating, AI will preserve it</li>
                        <li>If there are additional hazards, AI will identify and populate them (marked as <strong>AI</strong>)</li>
                    </ul>
                </li>
                <li>Review and edit the table as needed. Delete any steps that are not required.</li>
                <li>Once satisfied, click <strong class="font-medium">"Download Project Zip"</strong> to download all project files to your PC.</li>
            </ul>
        </div>

        <!-- Workflow 2: Text First -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üìù Workflow 2: Describe the Task in Plain Language</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Go to <strong class="font-medium">"1. Describe the Task"</strong> section.</li>
                <li>Type a plain language description of your task or process.</li>
                <li>Click <strong class="font-medium">"Generate Task Breakdown"</strong></li>
                <li>AI will automatically split it and generate a standard risk assessment table for you.</li>
            </ul>
        </div>

        <!-- Workflow 3: Legacy Risk Assessment -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üìä Workflow 3: Format Legacy Risk Assessments</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Upload your legacy risk assessment Excel file.</li>
                <li>Use the <strong class="font-medium">Column Mapper</strong> to map columns to the new format.</li>
                <li>Handle images:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li>Replace outdated images with new ones</li>
                        <li>Embedded images from your Excel sheet are available on the left pane</li>
                        <li>Drag and drop images to steps as needed</li>
                        <li>Delete unnecessary images and clean up</li>
                    </ul>
                </li>
                <li>Once satisfied, load the Excel data as a new project.</li>
                <li>Click <strong class="font-medium">"Generate AI Risk Assessment from Image Notes"</strong> to generate your Risk Assessment table.</li>
            </ul>
        </div>

        <!-- Important Notes -->
        <div class="bg-blue-50 rounded-lg border border-blue-200 p-4 mt-4">
            <h3 class="font-bold text-blue-900 mb-3">‚ö†Ô∏è Important Notes</h3>
            <ul class="list-disc list-inside text-sm text-blue-800 space-y-2">
                <li><strong>No Cloud Storage:</strong> No data is saved in the cloud. All your files are downloaded locally.</li>
                <li><strong>Save and Resume:</strong> You can save your project file and resume work by loading it back into the app.</li>
                <li><strong>Browser Refresh Warning:</strong> If you refresh your browser, your data in memory is lost. You will need to restart from the beginning or load your saved project file.</li>
                <li><strong>Language Support:</strong> You can read all dropdowns and hazard options in French or German by using the üåê Language selector at the top right of the app.</li>
            </ul>
        </div>
    </div>
</details>

<!-- FRENCH VERSION -->
<details class="bg-indigo-50 rounded-lg border border-indigo-200 mb-8 group overflow-hidden" id="howToUse-fr" data-lang="fr" style="display: none;">
    <summary class="p-6 flex justify-between items-center cursor-pointer list-none">
        <h2 class="text-xl font-semibold text-indigo-900">Comment utiliser cette application üöÄ</h2>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-700 transform transition-transform duration-200 group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
    </summary>

    <div class="px-6 pb-6 pt-0 space-y-4">
        <p class="text-indigo-700 font-semibold mb-4">Risk Assessment Buddy est un outil acc√©l√©rateur sur le terrain qui vous aide √† acc√©l√©rer et rationaliser vos projets d'√©valuation des risques. Il existe trois flux de travail pour utiliser cette application:</p>

        <!-- Workflow 1: Image/Video First -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üé• Flux de travail 1 : Commencez de z√©ro avec des m√©dias riches (images/vid√©os)</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>T√©l√©chargez des images ou des vid√©os de votre projet d'√©valuation des risques.</li>
                <li>Les visages sont automatiquement d√©tect√©s et flout√©s. Si la d√©tection automatique √©choue, floutez manuellement les visages en cliquant avec la souris.</li>
                <li>Ajoutez des d√©tails √† chaque image, de pr√©f√©rence en discutant avec vos responsables op√©rationnels:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li><strong>Description</strong>: Expliquez ce qui se passe dans l'image</li>
                        <li><strong>Dangers</strong>: Identifiez les dangers potentiels (√©valuation optionnelle: 1-5)</li>
                        <li><strong>Contr√¥les</strong>: Sugg√©rez des mesures d'att√©nuation ou des contr√¥les</li>
                    </ul>
                </li>
                <li>Une fois les notes d'image termin√©es, cliquez sur <strong class="font-medium">"G√©n√©rer une √©valuation des risques IA √† partir des notes d'image"</strong></li>
                <li>L'IA traitera vos notes:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li>Si vous avez ajout√© une √©valuation des risques manuelle, l'IA la pr√©servera</li>
                        <li>S'il y a d'autres dangers, l'IA les identifiera et les remplira (marqu√©s comme <strong>IA</strong>)</li>
                    </ul>
                </li>
                <li>Passez en revue et modifiez le tableau selon vos besoins. Supprimez les √©tapes qui ne sont pas requises.</li>
                <li>Une fois satisfait, cliquez sur <strong class="font-medium">"T√©l√©charger le ZIP du projet"</strong> pour t√©l√©charger tous les fichiers du projet sur votre PC.</li>
            </ul>
        </div>

        <!-- Workflow 2: Text First -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üìù Flux de travail 2 : D√©crivez la t√¢che en langage simple</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Acc√©dez √† la section <strong class="font-medium">"1. D√©crivez la t√¢che"</strong>.</li>
                <li>Tapez une description en langage simple de votre t√¢che ou processus.</li>
                <li>Cliquez sur <strong class="font-medium">"G√©n√©rer la d√©composition des t√¢ches"</strong></li>
                <li>L'IA divisera automatiquement et g√©n√©rera un tableau d'√©valuation des risques standard pour vous.</li>
            </ul>
        </div>

        <!-- Workflow 3: Legacy Risk Assessment -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üìä Flux de travail 3 : Formater les √©valuations des risques h√©rit√©es</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>T√©l√©chargez votre fichier Excel d'√©valuation des risques h√©rit√©.</li>
                <li>Utilisez le <strong class="font-medium">Mappeur de colonnes</strong> pour mapper les colonnes au nouveau format.</li>
                <li>G√©rez les images:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li>Remplacez les images obsol√®tes par de nouvelles</li>
                        <li>Les images int√©gr√©es de votre feuille Excel sont disponibles dans le volet gauche</li>
                        <li>Glissez-d√©posez les images selon vos besoins</li>
                        <li>Supprimez les images inutiles et nettoyez</li>
                    </ul>
                </li>
                <li>Une fois satisfait, chargez les donn√©es Excel en tant que nouveau projet.</li>
                <li>Cliquez sur <strong class="font-medium">"G√©n√©rer une √©valuation des risques IA √† partir des notes d'image"</strong> pour g√©n√©rer votre tableau d'√©valuation des risques.</li>
            </ul>
        </div>

        <!-- Important Notes -->
        <div class="bg-blue-50 rounded-lg border border-blue-200 p-4 mt-4">
            <h3 class="font-bold text-blue-900 mb-3">‚ö†Ô∏è Notes Importantes</h3>
            <ul class="list-disc list-inside text-sm text-blue-800 space-y-2">
                <li><strong>Pas de stockage cloud:</strong> Aucune donn√©e n'est enregistr√©e dans le cloud. Tous vos fichiers sont t√©l√©charg√©s localement.</li>
                <li><strong>Enregistrer et reprendre:</strong> Vous pouvez enregistrer votre fichier de projet et reprendre le travail en le rechargeant dans l'application.</li>
                <li><strong>Avertissement d'actualisation du navigateur:</strong> Si vous actualisez votre navigateur, vos donn√©es en m√©moire sont perdues. Vous devrez recommencer depuis le d√©but ou charger votre fichier de projet enregistr√©.</li>
                <li><strong>Support multilingue:</strong> Vous pouvez lire tous les menus d√©roulants et les options de dangers en anglais, fran√ßais ou allemand en utilisant le s√©lecteur de langue üåê en haut √† droite de l'application.</li>
            </ul>
        </div>
    </div>
</details>

<!-- GERMAN VERSION -->
<details class="bg-indigo-50 rounded-lg border border-indigo-200 mb-8 group overflow-hidden" id="howToUse-de" data-lang="de" style="display: none;">
    <summary class="p-6 flex justify-between items-center cursor-pointer list-none">
        <h2 class="text-xl font-semibold text-indigo-900">Verwendung dieser Anwendung üöÄ</h2>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-700 transform transition-transform duration-200 group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
    </summary>

    <div class="px-6 pb-6 pt-0 space-y-4">
        <p class="text-indigo-700 font-semibold mb-4">Risk Assessment Buddy ist ein feldgest√ºtztes Beschleunigungstool, das Ihnen dabei hilft, Ihre Risikobewertungsprojekte zu beschleunigen und zu rationalisieren. Es gibt drei Workflows f√ºr die Verwendung dieser Anwendung:</p>

        <!-- Workflow 1: Image/Video First -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üé• Arbeitsablauf 1: Beginnen Sie von vorne mit Rich Media (Bilder/Videos)</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Laden Sie Bilder oder Videos Ihres Risikobewertungsprojekts hoch.</li>
                <li>Gesichter werden automatisch erkannt und unsch√§rfer. Wenn die automatische Erkennung fehlschl√§gt, k√∂nnen Sie Gesichter manuell verbergen, indem Sie mit der Maus klicken.</li>
                <li>F√ºgen Sie Details zu jedem Bild hinzu, vorzugsweise in Diskussion mit Ihren operativen Leitern:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li><strong>Beschreibung</strong>: Erkl√§ren Sie, was auf dem Bild passiert</li>
                        <li><strong>Gefahren</strong>: Identifizieren Sie potenzielle Gefahren (optionale Bewertung: 1-5)</li>
                        <li><strong>Kontrollen</strong>: Schlagen Sie Abhilfe- oder Kontrollma√ünahmen vor</li>
                    </ul>
                </li>
                <li>Klicken Sie nach Abschluss der Bildbeschreibungen auf <strong class="font-medium">"KI-Risikobewertung aus Bildnotizen generieren"</strong></li>
                <li>Die KI wird Ihre Notizen verarbeiten:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li>Wenn Sie eine manuelle Risikobewertung hinzugef√ºgt haben, wird die KI diese beibehalten</li>
                        <li>Wenn es zus√§tzliche Gefahren gibt, werden diese von der KI identifiziert und aufgelistet (gekennzeichnet als <strong>KI</strong>)</li>
                    </ul>
                </li>
                <li>√úberpr√ºfen und bearbeiten Sie die Tabelle nach Bedarf. L√∂schen Sie nicht erforderliche Schritte.</li>
                <li>Klicken Sie auf <strong class="font-medium">"Projekt-ZIP herunterladen"</strong>, um alle Projektdateien auf Ihren PC herunterzuladen.</li>
            </ul>
        </div>

        <!-- Workflow 2: Text First -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üìù Arbeitsablauf 2: Beschreiben Sie die Aufgabe in einfacher Sprache</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Gehen Sie zum Abschnitt <strong class="font-medium">"1. Aufgabe beschreiben"</strong>.</li>
                <li>Geben Sie eine umgangssprachliche Beschreibung Ihrer Aufgabe oder Ihres Prozesses ein.</li>
                <li>Klicken Sie auf <strong class="font-medium">"Task-Aufschl√ºsselung generieren"</strong></li>
                <li>Die KI teilt dies automatisch auf und generiert eine standardisierte Risikobewertungstabelle f√ºr Sie.</li>
            </ul>
        </div>

        <!-- Workflow 3: Legacy Risk Assessment -->
        <div class="bg-white rounded-lg border border-indigo-200 p-4">
            <h3 class="font-bold text-slate-800 text-lg mb-3">üìä Arbeitsablauf 3: Formatieren Sie √§ltere Risikobewertungen</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                <li>Laden Sie Ihre Excel-Datei zur veralteten Risikobewertung hoch.</li>
                <li>Verwenden Sie den <strong class="font-medium">Spaltenmapper</strong>, um Spalten dem neuen Format zuzuordnen.</li>
                <li>Verwalten Sie Bilder:
                    <ul class="list-circle list-inside ml-4 mt-1 space-y-1 text-slate-600">
                        <li>Ersetzen Sie veraltete Bilder durch neue</li>
                        <li>In Ihr Excel-Blatt eingebettete Bilder sind im linken Bereich verf√ºgbar</li>
                        <li>Ziehen Sie Bilder nach Bedarf ab</li>
                        <li>L√∂schen Sie unn√∂tige Bilder und r√§umen Sie auf</li>
                    </ul>
                </li>
                <li>Laden Sie nach Fertigstellung die Excel-Daten als neues Projekt.</li>
                <li>Klicken Sie auf <strong class="font-medium">"KI-Risikobewertung aus Bildnotizen generieren"</strong>, um Ihre Risikobewertungstabelle zu generieren.</li>
            </ul>
        </div>

        <!-- Important Notes -->
        <div class="bg-blue-50 rounded-lg border border-blue-200 p-4 mt-4">
            <h3 class="font-bold text-blue-900 mb-3">‚ö†Ô∏è Wichtige Hinweise</h3>
            <ul class="list-disc list-inside text-sm text-blue-800 space-y-2">
                <li><strong>Keine Cloud-Speicherung:</strong> Keine Daten werden in der Cloud gespeichert. Alle Dateien werden lokal heruntergeladen.</li>
                <li><strong>Speichern und fortfahren:</strong> Sie k√∂nnen Ihre Projektdatei speichern und die Arbeit fortsetzen, indem Sie sie zur√ºck in die Anwendung laden.</li>
                <li><strong>Browseraktualisierungswarnung:</strong> Wenn Sie Ihren Browser aktualisieren, gehen Ihre im Speicher befindlichen Daten verloren. Sie m√ºssen von vorne beginnen oder Ihre gespeicherte Projektdatei laden.</li>
                <li><strong>Mehrsprachige Unterst√ºtzung:</strong> Sie k√∂nnen alle Dropdowns und Gefahrenoptionen auf Englisch, Franz√∂sisch oder Deutsch lesen, indem Sie den Sprachw√§hler üåê oben rechts in der Anwendung verwenden.</li>
            </ul>
        </div>
    </div>
</details>
</div>
        <!-- Modern Tab Interface Header -->
        <section class="bg-gradient-to-r from-indigo-600 to-blue-700 rounded-t-2xl shadow-lg overflow-hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-6 sm:p-8 text-white">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold mb-2">Risk Assessment Buddy (SMART 2.0)</h1>
                    <p class="text-indigo-100" data-en-text="Choose your workflow to get started">Choose your workflow to get started</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Best Practices Button -->
                    <button id="bestPracticesBtn" class="bg-yellow-400 hover:bg-yellow-300 text-indigo-900 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center gap-2" title="Best Practices Guide">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <span data-en-text="Best Practices">Best Practices</span>
                    </button>
                    <div class="bg-white/20 backdrop-blur-md p-4 rounded-lg border border-white/30">
                        <label for="langSelect" class="block text-sm font-semibold text-white mb-2">üåê Language:</label>
                        <select id="langSelect" class="w-full p-2 border border-white/40 rounded-md bg-white/90 focus:ring-2 focus:ring-yellow-300 transition font-medium text-slate-800">
                            <option value="en">English</option>
                            <option value="fr">Fran√ßais (French)</option>
                            <option value="de">Deutsch (German)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex border-t border-white/20 bg-gradient-to-r from-indigo-700 to-blue-800">
                <button id="tab-rich-media" class="tab-btn flex-1 sm:flex-none px-6 py-4 text-white font-semibold text-sm sm:text-base hover:bg-white/10 transition border-b-4 border-yellow-400 bg-white/10 flex items-center justify-center gap-2" onclick="switchTab('rich-media')" data-en-text="Rich Media">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Rich Media
                </button>
                <button id="tab-free-text" class="tab-btn flex-1 sm:flex-none px-6 py-4 text-white font-semibold text-sm sm:text-base hover:bg-white/10 transition border-b-4 border-transparent flex items-center justify-center gap-2" onclick="switchTab('free-text')" data-en-text="Free Text">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Free Text
                </button>
                <button id="tab-excel" class="tab-btn flex-1 sm:flex-none px-6 py-4 text-white font-semibold text-sm sm:text-base hover:bg-white/10 transition border-b-4 border-transparent flex items-center justify-center gap-2" onclick="switchTab('excel')" data-en-text="Excel Sheet">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                    Excel Sheet
                </button>
            </div>
        </section>

        <!-- Tab Content Panels -->
        <section id="tab-content-rich-media" class="tab-content bg-white rounded-b-2xl shadow-xl p-6 sm:p-8 space-y-6">
            <!-- Rich Media Stream Content -->
            <div id="face-blurrer-app">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">üì∏ Upload Images & Videos</h2>
                <p class="text-slate-600 mb-6">Upload media files. Faces will be automatically blurred. Click thumbnails to add risk descriptions, hazards, and controls.</p>
                
                <div class="space-y-6">
                    <div>
                        <label for="imageUpload" class="w-full bg-gradient-to-br from-indigo-50 to-blue-50 border-2 border-dashed border-indigo-300 rounded-lg p-8 flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-100 transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            <span class="font-semibold text-indigo-900" data-en-text="Click to upload or drag and drop">Click to upload or drag and drop</span>
                            <span class="text-sm text-indigo-700" data-en-text="Images or Videos">Images or Videos</span>
                        </label>
                        <input type="file" id="imageUpload" multiple accept="image/png, image/jpeg, video/mp4, video/quicktime, video/x-msvideo, video/x-matroska, .mov, .avi, .mkv, .webm" class="hidden-file-input">
                    </div>
                    <div id="progress-container" class="hidden space-y-2">
                        <label for="progressBar" class="font-semibold text-sm text-slate-700">Overall Progress:</label>
                        <progress id="progressBar" value="0" max="100" class="w-full [&::-webkit-progress-bar]:rounded-lg [&::-webkit-progress-value]:rounded-lg [&::-webkit-progress-bar]:bg-slate-200 [&::-webkit-progress-value]:bg-indigo-600 [&::-moz-progress-bar]:bg-indigo-600"></progress>
                    </div>
                    
                    <div id="status" class="text-center font-semibold text-slate-600 bg-slate-100 p-4 rounded-lg">Loading AI models... üß†</div>
                    <div id="results" class="hidden max-h-40 overflow-y-auto bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm"></div>
                    <div id="manual-blur-info" class="hidden text-center text-sm font-medium text-indigo-800 bg-indigo-100 p-4 rounded-lg border border-indigo-200" data-en-text="Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.">
                        Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.
                    </div>
                    <button id="processBtn" disabled class="w-full bg-indigo-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Process Files</button>
                </div>
                <div id="videoSection" class="hidden mt-8">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Uploaded Videos (Capture frames below)</h3>
                    <div id="videoGallery" class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex flex-wrap gap-4 justify-center">
                        <p class="text-slate-500">Uploaded videos will appear here...</p>
                    </div>
                </div>
                <div id="imageGallery" class="mt-8 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200 min-h-[120px]">
                    <p class="text-slate-500 col-span-full text-center">Processed images/frames will appear here...</p>
                </div>
                <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <button id="downloadBtn" style="display: none;" class="w-full bg-green-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50">Download All Images and Reports as ZIP</button>
                    <button id="generateAiReportBtn" style="display: none;" class="w-full bg-amber-500 text-black font-semibold py-3 px-5 rounded-lg shadow-md hover:bg-amber-600 transition duration-300 disabled:opacity-50">Generate AI Risk Assessment from Image Notes</button>
                    <button id="saveProjectBtn" style="display: none;" class="w-full bg-blue-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Save Project</button>
                    <button id="loadProjectBtn" class="w-full bg-purple-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Load Project</button>
                </div>
                <input type="file" id="projectFileInput" accept=".json" class="hidden">
                <canvas id="manualBlurCanvas" style="display: none;"></canvas>
            </div>
        </section>

        <section id="tab-content-free-text" class="tab-content bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-6 hidden">
            <!-- Free Text Stream Content -->
            <h2 class="text-2xl font-bold text-slate-900">‚úçÔ∏è Describe Your Task</h2>
            <p class="text-slate-600">Write a detailed description of the work process. Mention any previous incidents for better risk scoring.</p>
            
            <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-lg border border-indigo-200">
                <textarea id="freeTextInput" rows="6" placeholder="Start writing here... e.g., 'Every morning, I use a forklift to get a heavy pallet from the warehouse...'" class="w-full p-4 border border-indigo-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition font-medium"></textarea>
                <button id="generateTasksBtn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50">Generate Task Breakdown</button>
            </div>
        </section>

        <section id="tab-content-excel" class="tab-content bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-6 hidden">
            <!-- Excel Sheet Stream Content -->
            <h2 class="text-2xl font-bold text-slate-900">üìä Import Excel File</h2>
            <p class="text-slate-600">Upload an Excel file containing risk data. The system will parse and convert it to risk assessment format.</p>
            
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-lg border-2 border-dashed border-green-300 text-center cursor-pointer hover:bg-green-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" class="hidden" />
                <label for="excelUpload" class="cursor-pointer">
                    <p class="text-lg font-semibold text-green-900">Click to select Excel file</p>
                    <p class="text-sm text-green-700 mt-1">Supported: .xlsx, .xls, .csv</p>
                </label>
            </div>
            <button onclick="document.getElementById('excelImportModal').style.display='flex'" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">üìÇ Advanced Import / Convert</button>
        </section>
        
        <hr class="border-t-2 border-dashed border-slate-300 my-8 sm:my-12">

        <!-- Risk Assessment Section (Works across all tabs) -->
        <section id="risk-generator-app" class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 sm:p-8 space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-lg border border-amber-200">
                        <h3 class="text-lg font-bold text-amber-900 mb-3" data-en-text="üí° Pro Tips">üí° Pro Tips</h3>
                        <ul class="space-y-2 text-sm text-amber-800">
                            <li data-en-text="‚Ä¢ Mention past incidents for more accurate scoring">‚Ä¢ Mention past incidents for more accurate scoring</li>
                            <li data-en-text="‚Ä¢ Add detailed hazard descriptions in notes">‚Ä¢ Add detailed hazard descriptions in notes</li>
                            <li data-en-text="‚Ä¢ Review AI suggestions before finalizing">‚Ä¢ Review AI suggestions before finalizing</li>
                            <li data-en-text="‚Ä¢ Save your Project and resume your work">‚Ä¢ Save your Project and resume your work </li>
                        </ul>
                    </div>
                </div>
            <div id="dashboard-container" style="display: none;">
                <h1 class="text-3xl font-bold text-white bg-gradient-to-r from-indigo-700 to-blue-800 p-6 sm:p-8 flex flex-col sm:flex-row items-center justify-center gap-4 text-center">

                    RISK ASSESSMENT
                </h1>
                
                <div class="p-6 sm:p-8 bg-slate-50 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
                        <div id="riskChart"></div>
                        <div id="chartError" class="hidden text-red-600 text-center p-4">Could not load risk chart.</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
                        <div id="hazardChart"></div>
                        <div id="hazardChartError" class="hidden text-red-600 text-center p-4">Could not load hazard chart.</div>
                    </div>
                </div>
                <div class="p-6 sm:p-8 bg-white">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-100">
                                    <th class="p-4 font-semibold text-slate-700 rounded-l-lg">Average Risk Score</th>
                                    <th class="p-4 font-semibold text-slate-700">Highest Risk Details</th>
                                    <th class="p-4 font-semibold text-slate-700 rounded-r-lg">Last Reviewed</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-slate-100">
                                    <td class="p-4 text-slate-600"><span id="avgScore" class="text-2xl font-bold text-indigo-700"></span></td>
                                    <td class="p-4 text-slate-600" id="highestCard"></td>
                                    <td class="p-4 text-slate-600"><span id="lastReviewed"></span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
               <div class="p-6 sm:p-8 bg-slate-50">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">2. Generate AI Recommendations</h2>
            
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <button class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300" onclick="generateRecommendations()">Generate AI Recommendations & Visuals</button>
                
                <div class="w-full sm:w-auto">
                    <label for="recCountSelect" class="text-sm font-medium text-slate-700 mr-2">For the:</label>
                    <select id="recCountSelect" class="w-auto p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 transition">
                        <option value="5" selected>Top 5 Risks</option>
                        <option value="10">Top 10 Risks</option>
                        <option value="all">All High/Medium Risks</option>
                    </select>
                </div>
            </div>

            <div id="recommendations" class="mt-4 bg-white p-6 rounded-lg shadow-inner border border-slate-200 min-h-[100px]">
                <p class="text-slate-500 italic">Click the button above to generate mitigation advice for the highest-risk tasks.</p>
            </div>
        </div>
                <div class="p-6 sm:p-8 bg-white border-t border-slate-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">

                        <div class="flex gap-4 w-full sm:w-auto flex-wrap">
                            <button class="flex-1 sm:flex-none bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-slate-700 transition duration-300" onclick="window.print();">Print</button>
                            <button id="translateTableBtn" class="flex-1 sm:flex-none bg-amber-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-amber-700 transition duration-300">Translate Table</button>
                            <button id="downloadProjectZipBtn" class="flex-1 sm:flex-none bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Download Project ZIP</button>
                            <button id="saveProjectBtn2" class="flex-1 sm:flex-none bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-purple-700 transition duration-300" data-en-text="Save Project">Save Project</button>
                        </div>
                    </div>
                </div>
                <div class="table-wrapper overflow-x-auto" id="table-container">
                    </div>
            </div>
        </section>
    </main>
    <footer class="text-center py-8 text-slate-500">
        <button id="privacyBtn" class="text-indigo-600 hover:text-indigo-800 hover:underline font-medium transition">Privacy Policy</button>
    </footer>
    <div id="lightboxModal" class="lightbox-overlay hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-4 items-center justify-center" style="display: none;">
        <span id="closeLightbox" class="absolute top-4 right-6 text-white text-5xl font-bold cursor-pointer hover:text-slate-300 transition">&times;</span>
        
        <span id="prevArrow" class="lightbox-arrow absolute left-4 top-1/2 -translate-y-1/2 text-white text-3xl p-4 cursor-pointer hover:bg-black/20 rounded-full transition">&#10094;</span>
        
        <div class="lightbox-content w-full max-w-6xl">
            <div class="lightbox-main-area flex flex-col md:flex-row gap-6">
                <div class="image-wrapper flex-auto w-full md:w-2/3">
                    <img id="lightboxImage" alt="Large preview for blurring" class="w-full h-auto max-h-[75vh] object-contain rounded-lg shadow-xl cursor-crosshair bg-black">
                </div>
                <div class="lightbox-form-wrapper flex-none w-full md:w-1/3 bg-white p-6 rounded-lg shadow-lg max-h-[75vh] overflow-y-auto">
                    <form id="lightboxForm" onsubmit="return false;" class="space-y-4">
    <div class="relative">
        <label for="stepDescription" class="block text-sm font-semibold text-slate-700 mb-1">Description of step:</label>
        <textarea id="stepDescription" rows="4" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition pr-10"></textarea>
        <button type="button" class="speech-btn absolute bottom-2 right-2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition focus:outline-none" data-target="stepDescription">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </button>
    </div>
    <div class="relative">
        <label for="spotHazards" class="block text-sm font-semibold text-slate-700 mb-1">What can go wrong / spot hazards:</label>
        <textarea id="spotHazards" rows="4" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition pr-10"></textarea>
        <button type="button" class="speech-btn absolute bottom-2 right-2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition focus:outline-none" data-target="spotHazards">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </button>
    </div>
    <div class="relative">
        <label for="existingControls" class="block text-sm font-semibold text-slate-700 mb-1">Any existing controls:</label>
        <textarea id="existingControls" rows="4" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition pr-10"></textarea>
        <button type="button" class="speech-btn absolute bottom-2 right-2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition focus:outline-none" data-target="existingControls">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </button>
    </div>

    <!-- Optional: User-defined Risk Ratings -->
    <div class="border-t border-slate-200 pt-4 mt-4">
        <p class="text-xs font-semibold text-slate-600 mb-3 uppercase">Optional: Set Risk Rating (AI will enhance)</p>
        <div class="grid grid-cols-3 gap-2">
            <div>
                <label for="userFrequency" class="block text-xs font-medium text-slate-700 mb-1">Frequency:</label>
                <select id="userFrequency" class="w-full p-2 text-xs border border-slate-300 rounded-md bg-white focus:ring-1 focus:ring-indigo-500 transition">
                    <option value="">Not set</option>
                    <option value="1">1 - RARELY</option>
                    <option value="1.25">1.25 - OCCASIONAL</option>
                    <option value="1.5">1.5 - INTERMEDIATE</option>
                    <option value="1.75">1.75 - FREQUENTLY</option>
                    <option value="2">2 - PERMANENT</option>
                </select>
            </div>
            <div>
                <label for="userSeverity" class="block text-xs font-medium text-slate-700 mb-1">Severity:</label>
                <select id="userSeverity" class="w-full p-2 text-xs border border-slate-300 rounded-md bg-white focus:ring-1 focus:ring-indigo-500 transition">
                    <option value="">Not set</option>
                    <option value="1">1 - No potential of injury</option>
                    <option value="3">3 - Potential of FIRST AID</option>
                    <option value="5">5 - Potential of MEDICAL TREATMENT</option>
                    <option value="7">7 - Potential of DART</option>
                    <option value="9">9 - Potential of SIA</option>
                    <option value="10">10 - Potential of Fatality</option>
                </select>
            </div>
            <div>
                <label for="userLikelihood" class="block text-xs font-medium text-slate-700 mb-1">Likelihood:</label>
                <select id="userLikelihood" class="w-full p-2 text-xs border border-slate-300 rounded-md bg-white focus:ring-1 focus:ring-indigo-500 transition">
                    <option value="">Not set</option>
                    <option value="1">1 - Almost impossible</option>
                    <option value="3">3 - Very unlikely</option>
                    <option value="5">5 - Possible to happen</option>
                    <option value="8">8 - Likely to happen</option>
                    <option value="10">10 - Very likely to happen</option>
                </select>
            </div>
        </div>
    </div>
</form>
                </div>
            </div>
            
            <div class="lightbox-controls mt-4 flex flex-col sm:flex-row gap-4 justify-center">
                <button id="undoBlurBtn" disabled class="bg-amber-500 text-black font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-amber-600 transition duration-300 disabled:opacity-50">Undo Last Manual Blur</button>
                
                <button id="replaceImageBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Replace Image</button>
                <input type="file" id="replaceImageInput" accept="image/*" class="hidden">

                <button id="deleteLightboxBtn" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-red-700 transition duration-300">Delete Image</button>
            </div>
            <div id="lightboxGallery" class="mt-6 flex gap-2 justify-center p-3 overflow-x-auto bg-black/20 rounded-lg">
                </div>
        </div>
        
        <span id="nextArrow" class="lightbox-arrow absolute right-4 top-1/2 -translate-y-1/2 text-white text-3xl p-4 cursor-pointer hover:bg-black/20 rounded-full transition">&#10095;</span>
    </div>

    <!-- NEW: Full-Screen Video Capture Modal -->
    <div id="fullscreenVideoModal" class="fixed inset-0 z-[110] bg-black hidden flex flex-col" style="display: none;">
        <!-- Header with instructions and close button -->
        <div class="bg-gradient-to-r from-indigo-900 to-blue-900 text-white p-6 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold mb-2">Full-Screen Video Capture</h2>
                <p class="text-indigo-200 text-sm">Press <strong>SPACE</strong> to capture frame ‚Ä¢ <strong>ESC</strong> to exit</p>
            </div>
            <button onclick="closeFullscreenVideoModal()" class="text-white text-3xl font-bold hover:text-indigo-300 transition">√ó</button>
        </div>

        <!-- Main content area -->
        <div class="flex-1 flex gap-4 p-6 bg-black overflow-hidden">
            <!-- Video player (left/center) -->
            <div class="flex-1 flex flex-col items-center justify-center">
                <video id="fullscreenVideoPlayer" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" controls autoplay></video>
                <p class="text-white text-center mt-4 text-sm">Press SPACE to capture the current frame</p>
            </div>

            <!-- Thumbnail panel (right) -->
            <div class="w-64 bg-slate-900 rounded-lg shadow-2xl flex flex-col overflow-hidden border border-slate-700">
                <div class="bg-slate-800 p-4 border-b border-slate-700">
                    <h3 class="text-white font-semibold">Captured Frames (<span id="frameCount">0</span>)</h3>
                </div>
                <div id="fullscreenThumbnailPanel" class="flex-1 overflow-y-auto p-3 space-y-2">
                    <p class="text-slate-400 text-center text-sm mt-8">Captured frames appear here</p>
                </div>
            </div>
        </div>

        <!-- Footer with action buttons -->
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center border-t border-slate-700">
            <p class="text-sm text-slate-300">üí° Exiting will load <span id="frameCountFooter">0</span> frame(s) to your review pane</p>
            <div class="flex gap-3">
                <button onclick="clearCapturedFrames()" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg transition">Clear All</button>
                <button onclick="downloadCapturedFrames()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition">Download Frames</button>
                <button onclick="closeFullscreenVideoModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition">Exit & Load to Review</button>
            </div>
        </div>
    </div>
    <!-- END: Full-Screen Video Capture Modal -->

    <div id="privacyModal" class="modal-overlay hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm p-4 items-center justify-center" style="display: none;">
        <div class="modal-content bg-white m-auto p-6 sm:p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
            <span id="closeModal" class="close-btn absolute top-4 right-5 text-slate-400 text-3xl font-bold cursor-pointer hover:text-slate-600 transition">&times;</span>
            <h2 class="text-2xl font-bold text-slate-900 mb-6">Privacy Policy</h2>
            
<div class="space-y-6 text-slate-700">
    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
        <h3 class="text-lg font-semibold text-green-900 mb-2">1. Face Blurrer & File Processing</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>üö´ <strong class="font-semibold">No Server Uploads:</strong> Your images and videos are <strong class="font-semibold">NEVER</strong> uploaded to any server.</li>
            <li>üíª <strong class="font-semibold">100% Local Processing:</strong> All processing, including face detection, blurring, resizing, PDF/LaTeX/JSON report generation, and .zip file creation, happens entirely within your web browser on your own device using local libraries and models.</li>
            <li>üîí <strong class="font-semibold">Data Control:</strong> Your files and entered data (descriptions, hazards, controls) never leave your computer unless you explicitly download and share the ZIP or JSON files yourself. Data is stored temporarily in browser memory/cache; clear your browser to delete it.</li>
        </ul>
    </div>
  
    <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
        <h3 class="text-lg font-semibold text-amber-900 mb-2">2. AI Risk Assessment Generator</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>üì§ <strong class="font-semibold">External API Call:</strong> For AI-powered task breakdowns and recommendations, only text-based risk assessment data is sent to a third-party AI service (OpenRouter). This includes: step descriptions, hazard identifications, control measures, and user-provided ratings (Frequency, Severity, Likelihood). No images or videos are sent. Data is subject to <a href="https://openrouter.ai/privacy" target="_blank">OpenRouter's Privacy Policy</a>.</li>
            <li>üì¶ <strong class="font-semibold">Batching:</strong> Multiple assessment entries may be processed together in batches to improve efficiency.</li>
            <li>‚ö†Ô∏è <strong class="font-semibold">Do Not Include Sensitive Data:</strong> Avoid including personal info (names, addresses, employee names, etc.) in text fields, as it's processed externally.</li>
            <li><strong class="font-semibold">Anonymous Data:</strong> Text is not tied to your identity; however, the service may log IP addresses.</li>
        </ul>
    </div>
    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">3. Save/Load Project</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>üíæ <strong class="font-semibold">Local JSON Files:</strong> Saving projects creates a JSON file with your notes and base64-encoded images‚Äîall processed locally. Loading reads from your device only.</li>
            <li>‚ö†Ô∏è <strong class="font-semibold">Sharing Risks:</strong> If you share the JSON file, it includes your notes and images (encoded); review before sharing.</li>
        </ul>
    </div>
    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">4. Table Translation</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>üåê <strong class="font-semibold">Optional Feature:</strong> This is an optional feature that translates table columns into multiple languages using MyMemory Translation API.</li>
            <li><strong class="font-semibold">Data Sent:</strong> If used, only the text content from selected table columns (Steps, Hazard Source, Current Control) is sent to MyMemory's translation service. No images or sensitive identifiers are sent.</li>
            <li><strong class="font-semibold">Data Usage:</strong> MyMemory Translation API is a free, open-source service. Review <a href="https://mymemory.translated.net/" target="_blank">MyMemory's privacy information</a> for details on how they handle data.</li>
        </ul>
    </div>
    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
        <h3 class="text-lg font-semibold text-indigo-900 mb-2">5. External Libraries and Services</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>üìö <strong class="font-semibold">CDNs and Scripts:</strong> Libraries like Tailwind CSS, DOMPurify, face-api.js, JSZip, PDFKit, and blob-stream are loaded from CDNs/local for functionality. They may collect minimal data (e.g., IP for delivery). Review their policies if concerned.</li>
            <li>üìä <strong class="font-semibold">Google Charts:</strong> Used for dashboards; may send anonymized data to Google. See <a href="https://policies.google.com/privacy" target="_blank">Google's Policy</a>.</li>
        </ul>
    </div>
    <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
        <h3 class="text-lg font-semibold text-slate-900 mb-2">6. General</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>üç™ <strong class="font-semibold">No Cookies or Tracking:</strong> No cookies, trackers, or analytics are used.</li>
        </ul>
    </div>
    <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
        <h3 class="text-lg font-semibold text-purple-900 mb-2">7. Risks and Limitations</h3>
        <ul class="list-disc list-inside space-y-1">
            <li>‚ö†Ô∏è Browser extensions or malware could access local data‚Äîuse secure devices.</li>
            <li>ZIP/JSON files may contain metadata; remove if sensitive before sharing.</li>
            <li>AI outputs are suggestions; always verify for safety compliance.</li>
        </ul>
    </div>
   

</div>
        </div>
    </div>

    <!-- Best Practices Modal -->
    <div id="bestPracticesModal" class="modal-overlay hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm p-4 items-center justify-center" style="display: none;">
        <div class="modal-content bg-white m-auto p-6 sm:p-8 rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative">
            <span id="closeBestPracticesModal" class="close-btn absolute top-4 right-5 text-slate-400 text-3xl font-bold cursor-pointer hover:text-slate-600 transition">&times;</span>
            <h2 class="text-2xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                <span class="text-3xl">üí°</span>
                <span data-en-text="Best Practices: AI-Powered Collaborative Risk Assessment">Best Practices: AI-Powered Collaborative Risk Assessment</span>
            </h2>
            <p class="text-sm text-indigo-600 font-medium mb-6" data-en-text="Keeping the human element at the heart of safety">Keeping the human element at the heart of safety</p>

            <div class="space-y-5 text-slate-700">
                <!-- Core Principle -->
                <div class="p-4 bg-gradient-to-r from-indigo-50 to-blue-50 border-l-4 border-indigo-500 rounded-r-lg">
                    <h3 class="text-lg font-bold text-indigo-900 mb-2" data-en-text="üéØ Core Principle">üéØ Core Principle</h3>
                    <p class="text-sm" data-en-text="This tool, while powered by AI, stays true to one of the fundamental tenets of safety risk assessment: collaboration and engagement with the operational team. AI helps reduce administrative burden, but YOU and your team are the drivers of meaningful change. Blind automation will never bring actionable results.">This tool, while powered by AI, stays true to one of the fundamental tenets of safety risk assessment: <strong>collaboration and engagement with the operational team</strong>. AI helps reduce administrative burden, but <strong>YOU and your team are the drivers of meaningful change</strong>. Blind automation will never bring actionable results.</p>
                </div>

                <!-- Step 1 -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-green-900 mb-2" data-en-text="üìπ Step 1: Capture Your Process">üìπ Step 1: Capture Your Process</h3>
                    <p class="text-sm" data-en-text="Start by collecting rich media (video or photos) of your process from start to end. Split each process into respective task steps and document what can go wrong. This is your first collaborative touchpoint.">Start by collecting <strong>rich media</strong> (video or photos) of your process from start to end. Split each process into respective task steps and document what can go wrong. This is your <strong>first collaborative touchpoint</strong>.</p>
                </div>

                <!-- Step 2 -->
                <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-amber-900 mb-2" data-en-text="üë• Step 2: Engage Your Team">üë• Step 2: Engage Your Team</h3>
                    <p class="text-sm" data-en-text="Bring the operational team together. Ask them: What are the hazards? What could go wrong? What existing controls do you have? Share details about any previous incidents that the EHS team is aware of. This sparks great conversations and ideas ‚Äî the essence of effective risk assessment.">Bring the operational team together. Ask them: <em>What are the hazards? What could go wrong? What existing controls do you have?</em> Share details about any previous incidents that the EHS team is aware of. This sparks <strong>great conversations and ideas</strong> ‚Äî the essence of effective risk assessment.</p>
                </div>

                <!-- Step 3 -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2" data-en-text="ü§ñ Step 3: Generate AI Baseline">ü§ñ Step 3: Generate AI Baseline</h3>
                    <p class="text-sm" data-en-text="Once hazard identification is complete, use the AI to generate a baseline risk assessment. The AI analyzes your inputs and produces a structured table with hazard groups, risk scores, and categories. This saves hours of manual work.">Once hazard identification is complete, use the AI to generate a <strong>baseline risk assessment</strong>. The AI analyzes your inputs and produces a structured table with hazard groups, risk scores, and categories. This saves hours of manual work.</p>
                </div>

                <!-- Step 4 -->
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-purple-900 mb-2" data-en-text="üîç Step 4: Review and Re-evaluate">üîç Step 4: Review and Re-evaluate</h3>
                    <p class="text-sm" data-en-text="Click on the images or task steps to open the detailed review modal. Take time to re-evaluate the risk ratings with your team. During this collaborative review, Operations and EHS can propose multiple actions ‚Äî record them in the Actions panel.">Click on the images or task steps to open the detailed review modal. Take time to <strong>re-evaluate the risk ratings</strong> with your team. During this collaborative review, Operations and EHS can propose multiple actions ‚Äî record them in the <strong>Actions panel</strong>.</p>
                </div>

                <!-- Step 5 -->
                <div class="p-4 bg-teal-50 border border-teal-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-teal-900 mb-2" data-en-text="üìä Step 5: See Risk Evolution">üìä Step 5: See Risk Evolution</h3>
                    <p class="text-sm" data-en-text="Using safety science and math, each action is beautifully standardized to give you a predictive/projected risk rating. The Risk Evolution visualization shows the live impact your proposed actions could have ‚Äî transforming discussions into data-driven decisions.">Using <strong>safety science and math</strong>, each action is beautifully standardized to give you a predictive/projected risk rating. The <strong>Risk Evolution</strong> visualization shows the live impact your proposed actions could have ‚Äî transforming discussions into data-driven decisions.</p>
                </div>

                <!-- Step 6 -->
                <div class="p-4 bg-rose-50 border border-rose-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-rose-900 mb-2" data-en-text="üì• Step 6: Export and Track">üì• Step 6: Export and Track</h3>
                    <p class="text-sm" data-en-text="When you download the project file, you get the proposed actions as a CSV file which you can import into your existing tracking system. The collaboration extends from hazard identification to risk evaluation and action tracking.">When you download the project file, you get the proposed actions as a <strong>CSV file</strong> which you can import into your existing tracking system. The collaboration extends from hazard identification to risk evaluation and action tracking.</p>
                </div>

                <!-- Key Benefit -->
                <div class="p-4 bg-gradient-to-r from-emerald-50 to-green-50 border-2 border-emerald-300 rounded-lg">
                    <h3 class="text-lg font-bold text-emerald-900 mb-2" data-en-text="‚úÖ The Key Benefit">‚úÖ The Key Benefit</h3>
                    <p class="text-sm" data-en-text="Because actions are proposed by the operational team themselves, you get genuine buy-in and agreement. This tool extends traditional risk assessment into a powerful brainstorming and collaboration platform ‚Äî keeping the core tenets of Risk Assessment Methodology while leveraging AI's intelligence to offload administrative burden.">Because actions are proposed by the operational team themselves, you get <strong>genuine buy-in and agreement</strong>. This tool extends traditional risk assessment into a powerful <strong>brainstorming and collaboration platform</strong> ‚Äî keeping the core tenets of Risk Assessment Methodology while leveraging AI's intelligence to offload administrative burden.</p>
                </div>

                <!-- Remember -->
                <div class="p-3 bg-slate-100 rounded-lg text-center">
                    <p class="text-sm font-semibold text-slate-700" data-en-text="üí° Remember: You are the driver. AI is your co-pilot, not the captain.">üí° <strong>Remember:</strong> You are the driver. AI is your co-pilot, not the captain.</p>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="document.getElementById('bestPracticesModal').style.display='none'" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition" data-en-text="Got it!">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Translation Dialog Modal -->
    <div id="translationModal" class="modal-overlay hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm p-4 flex items-center justify-center" style="display: none;">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Translate Table Columns</h2>
            
            <!-- Language Selector -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">Target Language:</label>
                <select id="translationLangSelect" class="w-full p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 transition">
                    <option value="en">English (no translation)</option>
                    <option value="fr">Fran√ßais (French)</option>
                    <option value="de">Deutsch (German)</option>
                    <option value="es">Espa√±ol (Spanish)</option>
                    <option value="it">Italiano (Italian)</option>
                    <option value="pt">Portugu√™s (Portuguese)</option>
                </select>
            </div>

            <!-- Column Selection Checkboxes -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-3">Select columns to translate:</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="translateSteps" class="translation-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" checked>
                        <span class="ml-2 text-slate-700">Steps</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="translateHazardSource" class="translation-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" checked>
                        <span class="ml-2 text-slate-700">Hazard Source</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="translateCurrentControl" class="translation-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" checked>
                        <span class="ml-2 text-slate-700">Current Control</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2 flex-col">
                <div class="flex gap-2">
                    <button id="translateConfirmBtn" class="flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Translate</button>
                    <button id="translateCancelBtn" class="flex-1 bg-slate-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition duration-300">Cancel</button>
                </div>
                <button id="revertTranslationsBtn" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition duration-300" title="Revert all translations to original values">Revert All Translations</button>
            </div>
            <div id="translationStatus" class="mt-4 text-sm text-slate-600 text-center hidden"></div>
        </div>
    </div>
    </div>
    <div id="tableImageModal" class="modal-overlay hidden fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm p-4 items-center justify-center" style="display: none;">
    <div class="modal-content bg-white m-auto p-6 sm:p-8 rounded-lg shadow-2xl w-full max-w-6xl max-h-[92vh] overflow-hidden relative flex flex-col">
        <span id="closeTableImageModal" class="close-btn absolute top-4 right-5 text-slate-400 text-3xl font-bold cursor-pointer hover:text-slate-600 transition">&times;</span>

        <!-- Header -->
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-200 pr-10">
            <h2 id="modalTaskTitle" class="text-xl font-bold text-slate-800">Task Details</h2>
        </div>

        <!-- Main Content: Image (left) | Details (center) | Risk Reduction (right) -->
        <div class="flex gap-4 flex-1 overflow-hidden">
            <!-- Left: Image Preview -->
            <div class="flex-1 flex flex-col">
                <div class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-4 flex items-center justify-center">
                    <img id="modalEnlargedImage" src="" alt="Current task image" class="max-w-full max-h-[60vh] object-contain rounded border border-slate-300 bg-white">
                </div>
            </div>

            <!-- Center: Editable Details Form -->
            <div class="flex-1 flex flex-col overflow-hidden risk-panel-scroll">
                <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex-1 overflow-y-auto risk-panel-scroll">
                    <h3 class="text-base font-semibold text-slate-800 mb-3" data-en-text="Edit Task Details">Edit Task Details</h3>
                    <div id="modalEditableForm" class="space-y-3">
                        <!-- Form fields will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Right: Risk Reduction Analysis -->
            <div class="w-96 flex flex-col risk-panel-scroll">
                <details id="riskReductionPanel" class="bg-gradient-to-br from-blue-50 to-white border border-blue-200 rounded-xl shadow-sm">
                    <summary class="cursor-pointer p-5 flex items-center justify-between select-none hover:bg-blue-50 rounded-xl transition">
                        <h3 class="text-sm font-bold text-blue-900" data-en-text="üõ°Ô∏è Risk Reduction Strategy">üõ°Ô∏è Risk Reduction Strategy</h3>
                        <span class="text-blue-600 text-xs">‚ñº</span>
                    </summary>
                    <div class="px-5 pb-5 flex flex-col space-y-4 border-t border-blue-200">
                    
                    <!-- Hierarchy of Control Triangle -->
                    <div class="flex flex-col">
                        <label class="block text-xs font-semibold text-slate-700 mb-3 uppercase tracking-wide" data-en-text="Select Control Type">Select Control Type</label>
                        <div class="relative w-full h-40 mb-4" id="controlTriangle">
                            <!-- SVG Triangle will be generated here -->
                        </div>
                        <div id="selectedControlDisplay" class="text-center text-xs font-semibold text-blue-900 bg-blue-100 rounded px-3 py-3 min-h-8 border border-blue-300" data-en-text="Click a level to select">
                            Click a level to select
                        </div>
                        <!-- Hidden dropdown for fallback -->
                        <select id="counterMeasureLadder" class="w-full px-2 py-2 border border-slate-300 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent hidden">
                            <option value="">-- Select --</option>
                            <option value="Eliminate">6 : Eliminate</option>
                            <option value="Substitute">5 : Substitute</option>
                            <option value="Engineer">4 : Engineer</option>
                            <option value="Visual">3 : Visual</option>
                            <option value="Admin">2 : Admin</option>
                            <option value="Individual">1 : Individual</option>
                        </select>
                    </div>

                    <!-- Description Input -->
                    <div class="flex flex-col">
                        <label class="block text-xs font-semibold text-slate-700 mb-3 uppercase tracking-wide" data-en-text="Description">Description</label>
                        <textarea id="counterMeasureDescription" class="w-full h-16 px-3 py-2 border border-slate-300 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="Describe how this control will be implemented..." data-en-placeholder="Describe how this control will be implemented..."></textarea>
                        <button id="addCounterMeasureBtn" class="w-full mt-3 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg text-xs transition shadow-sm" data-en-text="+ Add Control">+ Add Control</button>
                    </div>

                    <!-- Selected Counter Measures List -->
                    <div class="min-h-0 flex flex-col">
                        <h4 class="text-xs font-semibold text-slate-700 mb-2 uppercase tracking-wide" data-en-text="Selected Controls">Selected Controls</h4>
                        <div id="selectedCounterMeasures" class="space-y-2 max-h-32 overflow-y-auto pr-1 risk-panel-scroll">
                            <!-- Controls will be added here dynamically -->
                        </div>
                        <div id="noControlsMessage" class="text-xs text-slate-500 italic text-center py-3" data-en-text="No controls added yet">No controls added yet</div>
                    </div>

                    <!-- Risk Reduction Visualization -->
                    <div id="riskReductionContainer" class="p-3 rounded-lg bg-blue-50 border border-blue-200">
                        <!-- Dynamic content will be generated here -->
                    </div>
                    
                    <!-- Collapsible Risk Calculation Explanation -->
                    <details class="mt-3 text-xs" style="direction: ltr;">
                        <summary class="cursor-pointer text-slate-500 hover:text-slate-700 font-medium flex items-center gap-1 select-none">
                            <span>‚ÑπÔ∏è</span> <span data-en-text="How is this calculated?">How is this calculated?</span>
                        </summary>
                        <div class="mt-2 p-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-600 space-y-2 leading-relaxed">
                            <p><strong class="text-slate-700" data-en-text="üéØ The Hierarchy of Controls (NIOSH/OSHA)">üéØ The Hierarchy of Controls (NIOSH/OSHA)</strong></p>
                            <p data-en-text="This tool uses the internationally recognized Hierarchy of Controls developed by NIOSH (National Institute for Occupational Safety and Health) and endorsed by OSHA. Controls at the top are most effective because they eliminate or reduce the hazard itself, while lower controls rely on human behavior.">This tool uses the internationally recognized Hierarchy of Controls developed by NIOSH (National Institute for Occupational Safety and Health) and endorsed by OSHA. Controls at the top are most effective because they eliminate or reduce the hazard itself, while lower controls rely on human behavior.</p>
                            
                            <p class="pt-2"><strong class="text-slate-700" data-en-text="üìä Control Effectiveness (Based on Safety Science)">üìä Control Effectiveness (Based on Safety Science)</strong></p>
                            <ul class="list-disc pl-4 space-y-1">
                                <li><strong data-en-text="Eliminate: Physically removes the hazard ‚Üí Risk becomes 0">Eliminate: Physically removes the hazard ‚Üí Risk becomes 0</strong></li>
                                <li><strong data-en-text="Substitute/Engineer: High-reliability controls ‚Üí Up to 80% reduction">Substitute/Engineer: High-reliability controls ‚Üí Up to 80% reduction</strong></li>
                                <li><strong data-en-text="Admin/Visual/PPE: Behavior-dependent controls ‚Üí Up to 55% reduction">Admin/Visual/PPE: Behavior-dependent controls ‚Üí Up to 55% reduction</strong></li>
                            </ul>
                            <p class="text-[10px] text-slate-500 italic" data-en-text="Note: Exact percentages are estimates based on the principle that engineering controls are significantly more reliable than administrative controls, as they don't depend on consistent human action.">Note: Exact percentages are estimates based on the principle that engineering controls are significantly more reliable than administrative controls, as they don't depend on consistent human action.</p>
                            
                            <p class="pt-2"><strong class="text-slate-700" data-en-text="‚öñÔ∏è Diminishing Returns Principle">‚öñÔ∏è Diminishing Returns Principle</strong></p>
                            <p data-en-text="Safety science recognizes that controls ranked higher in the hierarchy (Eliminate, Substitute, Engineer) provide greater protection. When implementing multiple controls of the same type, each additional control yields diminishing marginal benefit, with each layer adding progressively less protection. This is modeled using geometric decay factors.">Safety science recognizes that controls ranked higher in the hierarchy (Eliminate, Substitute, Engineer) provide greater protection. When implementing multiple controls of the same type, each additional control yields diminishing marginal benefit, with each layer adding progressively less protection. This is modeled using geometric decay factors.</p>
                            
                            <p class="pt-2"><strong class="text-slate-700" data-en-text="üõ°Ô∏è Defense in Depth">üõ°Ô∏è Defense in Depth</strong></p>
                            <p data-en-text="Best practice is to combine high-level controls (Substitute/Engineer) with administrative controls and PPE. This 'layered defense' approach ensures protection even if one control fails.">Best practice is to combine high-level controls (Substitute/Engineer) with administrative controls and PPE. This 'layered defense' approach ensures protection even if one control fails.</p>
                            
                            <p class="pt-3 border-t border-slate-200 mt-2"><strong class="text-slate-700" data-en-text="üìö References">üìö References</strong></p>
                            <ul class="list-none pl-0 space-y-1 text-[10px] text-slate-500">
                                <li data-en-text="‚Ä¢ NIOSH - Hierarchy of Controls (CDC/NIOSH)">‚Ä¢ NIOSH - Hierarchy of Controls (CDC/NIOSH)</li>
                                <li data-en-text="‚Ä¢ OSHA - Recommended Practices for Safety and Health Programs">‚Ä¢ OSHA - Recommended Practices for Safety and Health Programs</li>
                                <li data-en-text="‚Ä¢ Canadian Centre for Occupational Health & Safety (CCOHS)">‚Ä¢ Canadian Centre for Occupational Health & Safety (CCOHS)</li>
                                <li data-en-text="‚Ä¢ UK Health and Safety Executive (HSE)">‚Ä¢ UK Health and Safety Executive (HSE)</li>
                                <li data-en-text="‚Ä¢ Prevention through Design (PtD) Initiative">‚Ä¢ Prevention through Design (PtD) Initiative</li>
                            </ul>
                        </div>
                    </details>
                    </div>
                </details>
            </div>
        </div>

        <!-- Footer: Tip + Navigation -->
        <div class="flex flex-col md:flex-row md:items-center gap-4 mt-4 pt-4 border-t border-slate-200">
            <!-- Tip -->
            <div class="flex items-center gap-2 bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 flex-1 min-w-0">
                <span class="text-indigo-600 text-base">üí°</span>
                <p class="text-xs text-indigo-700 font-medium" data-en-text="Use ‚Üê ‚Üí arrow keys to navigate. Changes are auto saved!">Use ‚Üê ‚Üí arrow keys to navigate. Changes are auto saved!</p>
            </div>

            <!-- Navigation Controls -->
            <div class="flex items-center gap-3 flex-shrink-0">
                <button id="modalDeleteBtn" class="delete-btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition text-sm" title="Delete this task" data-en-text="üóëÔ∏è Delete">üóëÔ∏è Delete</button>
                <button id="modalCancelBtn" class="bg-slate-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition text-sm" data-en-text="Close">Close</button>
                <button id="modalFooterPrevBtn" class="min-w-[100px] bg-slate-200 text-slate-800 font-semibold py-2 px-3 rounded-lg hover:bg-slate-300 transition shadow-sm text-sm" title="Previous task (‚Üê arrow)" data-en-text="‚Üê Previous">‚Üê Previous</button>
                <span id="modalTaskCounter" class="text-slate-600 font-medium text-sm">1 / 1</span>
                <button id="modalFooterNextBtn" class="min-w-[100px] bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-indigo-700 transition shadow-sm text-sm" title="Next task (‚Üí arrow)" data-en-text="Next ‚Üí">Next ‚Üí</button>
            </div>
        </div>

        <!-- EHS Standards Reference (Collapsed) -->
        <div class="mt-6 border-t border-slate-300 pt-4">
            <button id="ehsRefToggleBtn" class="flex items-center gap-2 text-slate-700 hover:text-slate-900 font-semibold text-sm py-2 px-3 rounded-lg hover:bg-slate-100 transition">
                <span id="ehsRefToggleIcon">‚ñ∂Ô∏è</span>
                <span data-en-text="üìã EHS Standards - Frequency, Severity & Likelihood Definitions">üìã EHS Standards - Frequency, Severity & Likelihood Definitions</span>
            </button>
            
            <div id="ehsRefContent" class="hidden mt-4 bg-slate-50 border border-slate-200 rounded-lg p-4 overflow-y-auto max-h-96">
                <!-- Frequency Table -->
                <div class="mb-6">
                    <h4 class="font-bold text-slate-800 mb-3 text-sm">Frequency (F) Scale</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-yellow-400 font-bold">
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="F Value">F Value</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Category">Category</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Day">Day</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Week">Week</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Month">Month</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Year">Year</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-freq-row" data-freq-value="1">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">1</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="RARELY">RARELY</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="-">-</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="-">-</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="<0.5 day">&lt;0.5 day</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="1 day">1 day</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-freq-row" data-freq-value="1.25">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">1.25</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="OCCASIONAL">OCCASIONAL</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="<30 min">&lt;30 min</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="<2 hours">&lt;2 hours</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="<1 days">&lt;1 days</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="<5 days">&lt;5 days</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-freq-row" data-freq-value="1.5">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">1.5</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="INTERMEDIATE">INTERMEDIATE</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="30-120 min">30-120 min</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="2-8 hours">2-8 hours</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="1-4 days">1-4 days</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="5 days -2 months">5 days -2 months</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-freq-row" data-freq-value="1.75">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">1.75</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="FREQUENTLY">FREQUENTLY</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="2-5 hours">2-5 hours</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="1-3 days">1-3 days</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="4-15 days">4-15 days</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="2-5 months">2-5 months</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-freq-row" data-freq-value="2">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">2</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="PERMANENT">PERMANENT</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text=">5 hours">&gt;5 hours</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text=">3 days">&gt;3 days</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="> 15 days">&gt; 15 days</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="> 5 months">&gt; 5 months</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Severity Table -->
                <div class="mb-6">
                    <h4 class="font-bold text-slate-800 mb-3 text-sm">Severity (S) Scale</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-yellow-400 font-bold">
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="S Value">S Value</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Classification">Classification</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Most Probable Injury">Most Probable Injury</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-sev-row" data-sev-value="1">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">1</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="No potential of injury">No potential of injury</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="‚Ä¢ No treatment needed">‚Ä¢ No treatment needed</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-sev-row" data-sev-value="3">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">3</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="Potential of FIRST AID">Potential of FIRST AID</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="‚Ä¢ Non-prescription medication">‚Ä¢ Non-prescription medication<br/>‚Ä¢ Bandage, cold therapy<br/>‚Ä¢ Cleaning and flushing wounds<br/>‚Ä¢ Non-rigid means of support<br/>‚Ä¢ OSHA recordkeeping</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-sev-row" data-sev-value="5">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">5</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="Potential of MEDICAL TREATMENT">Potential of MEDICAL TREATMENT</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="‚Ä¢ Prescription medications">‚Ä¢ Prescription medications<br/>‚Ä¢ Wound closing devices<br/>‚Ä¢ Device with rigid support<br/>‚Ä¢ Removal of foreign objects from the eye<br/>(beyond simple flushing)</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-sev-row" data-sev-value="7">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">7</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="Potential of DART">Potential of DART</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="‚Ä¢ Temporary disability">‚Ä¢ Temporary disability<br/>‚Ä¢ Temporary hospitalization</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-sev-row" data-sev-value="9">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">9</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="Potential of SIA">Potential of SIA</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="‚Ä¢ Amputation">‚Ä¢ Amputation<br/>‚Ä¢ Disfigurement<br/>‚Ä¢ Loss of eyesight<br/>‚Ä¢ 3rd degree burns<br/>‚Ä¢ Life threatening/altering<br/>‚Ä¢ Long-term occupational disease</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-sev-row" data-sev-value="10">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">10</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold" data-en-text="Potential of Fatality">Potential of Fatality</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="‚Ä¢ Death">‚Ä¢ Death</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Likelihood Table -->
                <div>
                    <h4 class="font-bold text-slate-800 mb-3 text-sm">Likelihood (L) Scale</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-yellow-400 font-bold">
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="L Value">L Value</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Classification">Classification</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Machinery Related Risks">Machinery Related Risks</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Industrial Hygiene Risks">Industrial Hygiene Risks</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Other H&S Risks">Other H&amp;S Risks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-like-row" data-like-value="1">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">1</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold">Almost impossible</td>
                                    <td class="border border-slate-300 px-2 py-1">Hazard not reachable as per ISO 13857 (safety distance to hazard) and compliant with 13849 (new equipment with PLC, equipment failure scenarios, ...)</td>
                                    <td class="border border-slate-300 px-2 py-1">No Class 1<br/>Class 2/3 with CML 1, 2 and 3</td>
                                    <td class="border border-slate-300 px-2 py-1">CML 4 or 5 with no known record of event</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-like-row" data-like-value="3">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">3</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold">Very unlikely</td>
                                    <td class="border border-slate-300 px-2 py-1">Hazard not reachable as per ISO 13857 (safety distance to hazard)</td>
                                    <td class="border border-slate-300 px-2 py-1">Class 1 with CML 1, 2 and 3<br/>Class 2/3 with CML 1 and 3</td>
                                    <td class="border border-slate-300 px-2 py-1">CML 4 in place but 1 event over the past 5 years<br/>CML 1, 2 and 3 in place with no known record of event</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-like-row" data-like-value="5">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">5</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold">Possible to happen</td>
                                    <td class="border border-slate-300 px-2 py-1">Hazard reachable per ISO 13857/13849 and if ALL the following apply: - Speed &lt;250 cm/s<br/>- Obvious hazard<br/>- Room and time to escape<br/>- Low complexity task</td>
                                    <td class="border border-slate-300 px-2 py-1">Class 1 with CML 1 and 3<br/>Class 2/3 without CML</td>
                                    <td class="border border-slate-300 px-2 py-1">CML 1, 2 and 3 in place but 1 event over the past 3 years<br/>CML 1 and 2 in place with no known record of event</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-like-row" data-like-value="8">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">8</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold">Likely to happen</td>
                                    <td class="border border-slate-300 px-2 py-1">Hazard reachable per ISO 13857/13849 and if ALL the following apply: - Speed 251 to 100mm/s<br/>- Obvious hazard<br/>- Room and time to escape</td>
                                    <td class="border border-slate-300 px-2 py-1">Class 1 with CML 1 or higher</td>
                                    <td class="border border-slate-300 px-2 py-1">CML 1 OR 2 OR 3 in place with 1 event over the past 3 years</td>
                                </tr>
                                <tr class="bg-white hover:bg-blue-50 cursor-pointer ehs-like-row" data-like-value="10">
                                    <td class="border border-slate-300 px-2 py-1 font-bold text-blue-600 hover:bg-blue-200 select-ehs-value">10</td>
                                    <td class="border border-slate-300 px-2 py-1 text-blue-700 font-semibold">Very likely to happen</td>
                                    <td class="border border-slate-300 px-2 py-1">Hazard reachable per ISO 13857/13849 with: - Speed &gt;100mm/s OR<br/>- NO Room and time to escape</td>
                                    <td class="border border-slate-300 px-2 py-1">Record of confirmed occupational disease</td>
                                    <td class="border border-slate-300 px-2 py-1">2 or more events over the past 3 years</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Risk Rating Table -->
                <div class="mt-6">
                    <h4 class="font-bold text-slate-800 mb-3 text-sm" data-en-text="Risk Rating & Response">Risk Rating & Response</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-yellow-400 font-bold">
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Risk Score (F √ó S √ó L)">Risk Score (F √ó S √ó L)</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Interpretation">Interpretation</th>
                                    <th class="border border-yellow-600 px-2 py-1" data-en-text="Response Required">Response Required</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-green-100">
                                    <td class="border border-slate-300 px-2 py-1 font-bold">1-19</td>
                                    <td class="border border-slate-300 px-2 py-1 bg-green-400 text-white font-bold" data-en-text="LOW">LOW</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="Low priority - Further reduce risk if feasible.">Low priority - Further reduce risk if feasible.</td>
                                </tr>
                                <tr class="bg-yellow-100">
                                    <td class="border border-slate-300 px-2 py-1 font-bold">20-49</td>
                                    <td class="border border-slate-300 px-2 py-1 bg-yellow-400 text-black font-bold" data-en-text="MEDIUM">MEDIUM</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="Further reduce risk over time. Prioritize higher risks first.">Further reduce risk over time. Prioritize higher risks first.</td>
                                </tr>
                                <tr class="bg-orange-100">
                                    <td class="border border-slate-300 px-2 py-1 font-bold">50-71</td>
                                    <td class="border border-slate-300 px-2 py-1 bg-orange-400 text-white font-bold" data-en-text="HIGH">HIGH</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="Action plan to reduce this risk level as a lower priority.">Action plan to reduce this risk level as a lower priority.</td>
                                </tr>
                                <tr class="bg-red-100">
                                    <td class="border border-slate-300 px-2 py-1 font-bold">72-200</td>
                                    <td class="border border-slate-300 px-2 py-1 bg-red-600 text-white font-bold" data-en-text="CRITICAL">CRITICAL</td>
                                    <td class="border border-slate-300 px-2 py-1" data-en-text="Deploy interim protective measures and prioritize implementation of more secured permanent controls. Highlight to exposed associates the risk they are exposed to.">Deploy interim protective measures and prioritize implementation of more secured permanent controls. Highlight to exposed associates the risk they are exposed to.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
    </div><div id="toast-container" class="fixed top-4 right-4 z-[200] w-full max-w-xs space-y-3">
    </div>

<div id="confirmModal" class="modal-overlay hidden fixed inset-0 z-[150] bg-black/60 backdrop-blur-sm p-4 items-center justify-center" style="display: none;">
    <div class="modal-content bg-white m-auto p-6 rounded-lg shadow-2xl w-full max-w-sm">
        <h2 id="confirmTitle" class="text-lg font-semibold text-slate-900 mb-4">Are you sure?</h2>
        <p id="confirmMessage" class="text-slate-600 mb-6">This action cannot be undone.</p>
        <div class="flex justify-end gap-4">
            <button id="confirmCancelBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300 transition">
                Cancel
            </button>
            <button id="confirmOkBtn" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700 transition">
                Confirm
            </button>
        </div>
    </div>
</div>

<script>
    // --- Tab Switching Function (Modern UI) ---
    function switchTab(tabName) {
        // Hide all tab content
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(tab => tab.classList.add('hidden'));
        
        // Remove active state from all tab buttons
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(btn => {
            btn.classList.remove('bg-white/10', 'border-yellow-400');
            btn.classList.add('border-transparent');
        });
        
        // Show selected tab content
        const selectedContent = document.getElementById(`tab-content-${tabName}`);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }
        
        // Highlight selected tab button
        const selectedButton = document.getElementById(`tab-${tabName}`);
        if (selectedButton) {
            selectedButton.classList.add('bg-white/10', 'border-yellow-400');
            selectedButton.classList.remove('border-transparent');
        }
        
        console.debug(`Switched to tab: ${tabName}`);
    }

    // Initialize first tab on page load
    document.addEventListener('DOMContentLoaded', function() {
        switchTab('rich-media');
    });

    // Make switchTab globally accessible for other functions
    window.switchTab = switchTab;

    // --- Global Google Translate Initializer ---
    // Moved outside IIFEs to be globally accessible

    // --- Make deterministic filename generator global ---
    // Produces the same `final_###_sanitized.ext` name used when creating ZIP files.
    function createFinalFileName(originalFileName, index) {
        const lastDotIndex = (originalFileName || '').lastIndexOf('.');
        const baseName = lastDotIndex !== -1 ? originalFileName.substring(0, lastDotIndex) : (originalFileName || `image`);
        const extension = lastDotIndex !== -1 ? originalFileName.substring(lastDotIndex) : '.jpg';
        const sanitizedBase = baseName.replace(/[^a-zA-Z0-9_-]/g, '_') || 'image';
        return `final_${String(index + 1).padStart(3, '0')}_${sanitizedBase}${extension}`;
    }
    // --- APP 1 (RISK GENERATOR) SCRIPT ---
    (function() {

        const spinnerSVG = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        // --- FIX: Attach click listener to the 'Generate Task Breakdown' button ---
        document.addEventListener('DOMContentLoaded', () => {
            const genBtn = document.getElementById('generateTasksBtn');
            if (genBtn) {
                // We link it to window.processFreeText, which is defined just below
                genBtn.addEventListener('click', window.processFreeText);
            } else {
                console.error("Could not find 'generateTasksBtn' to attach listener.");
            }
        });
        // --- END FIX ---
        // --- CONFIGURATION ---
        
    // NOTE: API key included for testing in this local copy. For production,
    // move this key to a secure server-side proxy or environment variable.
    const API_KEY = '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';
        
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const PRIMARY_FREE_MODEL = 'mistralai/mistral-7b-instruct:free';
        const SECONDARY_FREE_MODEL = 'google/gemma-7b-it:free';
        const PAID_MODEL = 'openai/gpt-4o-mini'; // Faster model: ~3-5x speed vs gpt-4o, excellent for task breakdown

        // --- MULTILINGUAL TRANSLATIONS (English, French, German) ---
        const TRANSLATIONS = {
  en: {
    // Hazard Groups (English defaults)
    "Mechanical / Machinery hazards": "Mechanical / Machinery hazards",
    "Workplace / Infrastructure Design": "Workplace / Infrastructure Design",
    "Physical health hazards": "Physical health hazards",
    "Chemical hazards": "Chemical hazards",
    "Hazardous Energy": "Hazardous Energy",
    "Transportation": "Transportation",
    "Ergonomic hazards": "Ergonomic hazards",
    "Organizational and Psychosocial": "Organizational and Psychosocial",
    "Biological hazard": "Biological hazard",
    "Fire and explosion": "Fire and explosion",
    // Frequency Scale
    "RARELY (<30 min/day)": "RARELY (<30 min/day)",
    "OCCASIONAL (<2 hrs/wk)": "OCCASIONAL (<2 hrs/wk)",
    "INTERMEDIATE (2-8 hrs/wk)": "INTERMEDIATE (2-8 hrs/wk)",
    "FREQUENTLY (1-3 days/wk)": "FREQUENTLY (1-3 days/wk)",
    "PERMANENT (>3 days/wk)": "PERMANENT (>3 days/wk)",
    // Severity Scale
    "No potential of injury": "No potential of injury",
    "Potential of FIRST AID": "Potential of FIRST AID",
    "Potential of MEDICAL TREATMENT": "Potential of MEDICAL TREATMENT",
    "Potential of DART": "Potential of DART",
    "Potential of SIA": "Potential of SIA",
    "Potential of Fatality": "Potential of Fatality",
    // Likelihood Scale
    "Almost impossible": "Almost impossible",
    "Very unlikely": "Very unlikely",
    "Possible to happen": "Possible to happen",
    "Likely to happen": "Likely to happen",
    "Very likely to happen": "Very likely to happen",
    // Hazard List Items (English)
    "Hand tools (cut, impact, puncture, etc.)": "Hand tools (cut, impact, puncture, etc.)",
    "Powered tools": "Powered tools",
    "Pinch / nip points": "Pinch / nip points",
    "Rotating parts (entanglement)": "Rotating parts (entanglement)",
    "Moving parts (cutting)": "Moving parts (cutting)",
    "Moving parts (crushing)": "Moving parts (crushing)",
    "Ejection (parts, materials)": "Ejection (parts, materials)",
    "Angular, sharp and cutting elements": "Angular, sharp and cutting elements",
    "Degraded or malfunctioning equipment": "Degraded or malfunctioning equipment",
    "Equipment failure": "Equipment failure",
    "Improper use of tools/machines": "Improper use of tools/machines",
    "Inadequate guarding": "Inadequate guarding",
    "Use of lifting equipment and accessories": "Use of lifting equipment and accessories",
    "Use of suspension equipment (jacks, etc.)": "Use of suspension equipment (jacks, etc.)",
    "Acceleration / deceleration": "Acceleration / deceleration",
    "Slips, trips, and falls (same level or height)": "Slips, trips, and falls (same level or height)",
    "Slippery, uneven, unstable or damaged floor": "Slippery, uneven, unstable or damaged floor",
    "Congested or obstructed workplace": "Congested or obstructed workplace",
    "Clutter / Mess": "Clutter / Mess",
    "Protrusion (bump, puncture, cut, etc.)": "Protrusion (bump, puncture, cut, etc.)",
    "Hot surface": "Hot surface",
    "Cold surface": "Cold surface",
    "Rough surface": "Rough surface",
    "Unsecured items at height": "Unsecured items at height",
    "Work at height (<1.2m - <4 feet)": "Work at height (<1.2m - <4 feet)",
    "Work at height (‚â•1.2m - ‚â•4 feet)": "Work at height (‚â•1.2m - ‚â•4 feet)",
    "Poor ventilation": "Poor ventilation",
    "Extreme heat": "Extreme heat",
    "Extreme cold": "Extreme cold",
    "Snow or ice": "Snow or ice",
    "Extreme wind": "Extreme wind",
    "Other adverse weather conditions": "Other adverse weather conditions",
    "Confined spaces": "Confined spaces",
    "Lone work": "Lone work",
    "Temporary works or unstable structures": "Temporary works or unstable structures",
    "Engulfment": "Engulfment",
    "Inclined surface": "Inclined surface",
    "Poor visibility": "Poor visibility",
    "Coactivity area": "Coactivity area",
    "Noise exposure": "Noise exposure",
    "Vibration / Impact (hand-arm, whole-body)": "Vibration / Impact (hand-arm, whole-body)",
    "Heat stress": "Heat stress",
    "Cold stress": "Cold stress",
    "Poor lighting (intensity, glare, reflection)": "Poor lighting (intensity, glare, reflection)",
    "Electro-magnetic fields": "Electro-magnetic fields",
    "Ionizing radiation (X-rays, radioactive elements)": "Ionizing radiation (X-rays, radioactive elements)",
    "Non-ionizing radiation (UV, microwave, laser, welding radiations)": "Non-ionizing radiation (UV, microwave, laser, welding radiations)",
    "Severe draft (e.g. cold air current)": "Severe draft (e.g. cold air current)",
    "Smoke and fumes": "Smoke and fumes",
    "Physical health [Generic]": "Physical health [Generic]",
    "Explosive materials": "Explosive materials",
    "Flammable materials": "Flammable materials",
    "Oxidising materials": "Oxidising materials",
    "Corrosive materials": "Corrosive materials",
    "Acute toxicity materials": "Acute toxicity materials",
    "Health hazard, sensitizers, allergens materials": "Health hazard, sensitizers, allergens materials",
    "Carcinogens, mutagens, reprotoxic (CMRs) materials": "Carcinogens, mutagens, reprotoxic (CMRs) materials",
    "Gas under pressure": "Gas under pressure",
    "Asbestos": "Asbestos",
    "Fibers other than asbestos": "Fibers other than asbestos",
    "Oil": "Oil",
    "Crystalline silica": "Crystalline silica",
    "Organic peroxides": "Organic peroxides",
    "Nanomaterials": "Nanomaterials",
    "Endocrine disrupters": "Endocrine disrupters",
    "Lead-containing material": "Lead-containing material",
    "Particulate material (dust, smoke, fog, aerosol)": "Particulate material (dust, smoke, fog, aerosol)",
    "Improper labeling or storage": "Improper labeling or storage",
    "Incompatible chemical reactions": "Incompatible chemical reactions",
    "Chemical spills or leaks": "Chemical spills or leaks",
    "Water reactive substances": "Water reactive substances",
    "Shock / vibration sensitive substances": "Shock / vibration sensitive substances",
    "Chemicals [Generic]": "Chemicals [Generic]",
    "Electricity": "Electricity",
    "Electrostatic": "Electrostatic",
    "Electromagnetic fields": "Electromagnetic fields",
    "Arc flash": "Arc flash",
    "Magnetic": "Magnetic",
    "Equipment under pressure": "Equipment under pressure",
    "Compressed air": "Compressed air",
    "Vacuum": "Vacuum",
    "Hydraulic": "Hydraulic",
    "Pneumatic": "Pneumatic",
    "Thermal energy (steam, heated surfaces)": "Thermal energy (steam, heated surfaces)",
    "Kinetic energy": "Kinetic energy",
    "Gravity": "Gravity",
    "Stored energy (pneumatic, hydraulic, mechanical, electrical)": "Stored energy (pneumatic, hydraulic, mechanical, electrical)",
    "Exothermic chemical reaction": "Exothermic chemical reaction",
    "Hazardous Energy [Generic]": "Hazardous Energy [Generic]",
    "Interaction pedestrian/pedestrian": "Interaction pedestrian/pedestrian",
    "Interaction pedestrian/bicycle": "Interaction pedestrian/bicycle",
    "Interaction pedestrian/Vehicle": "Interaction pedestrian/Vehicle",
    "Interaction bicycle/bicycle": "Interaction bicycle/bicycle",
    "Interaction bicycle/Vehicle": "Interaction bicycle/Vehicle",
    "Interaction Vehicle/Vehicle": "Interaction Vehicle/Vehicle",
    "Interaction Vehicle/Stationary items": "Interaction Vehicle/Stationary items",
    "Poor road or yard conditions": "Poor road or yard conditions",
    "Unintentional vehicle movement": "Unintentional vehicle movement",
    "High speed vehicle, tire grip loss": "High speed vehicle, tire grip loss",
    "Inadequate load securing": "Inadequate load securing",
    "Traffic [Generic]": "Traffic [Generic]",
    "Postures (Hit list)": "Postures (Hit list)",
    "Force": "Force",
    "Lifting/Lowering": "Lifting/Lowering",
    "Pushing": "Pushing",
    "Pulling": "Pulling",
    "Carrying": "Carrying",
    "Soft tissue compression": "Soft tissue compression",
    "Ill-fitting gloves": "Ill-fitting gloves",
    "Standing or Sitting for long periods": "Standing or Sitting for long periods",
    "Computer workstation / Screen": "Computer workstation / Screen",
    "Inadequate tool or workstation design": "Inadequate tool or workstation design",
    "Poor ergonomics [Generic]": "Poor ergonomics [Generic]",
    "Ambiguity of the roles and responsibilities": "Ambiguity of the roles and responsibilities",
    "Inadequate staffing": "Inadequate staffing",
    "High job demands (physical or mental workload)": "High job demands (physical or mental workload)",
    "Low job control or autonomy": "Low job control or autonomy",
    "Monotonous or repetitive tasks": "Monotonous or repetitive tasks",
    "Unclear job roles or expectations": "Unclear job roles or expectations",
    "Job insecurity or precarious employment": "Job insecurity or precarious employment",
    "Long working hours or shift work": "Long working hours or shift work",
    "Unrealistic deadlines": "Unrealistic deadlines",
    "Coactivity": "Coactivity",
    "Unfamiliar work": "Unfamiliar work",
    "New hire / temporary worker": "New hire / temporary worker",
    "Insufficient / inadequate training": "Insufficient / inadequate training",
    "Violations of rules": "Violations of rules",
    "Misuse of computer systems / equipment": "Misuse of computer systems / equipment",
    "Lack of adherence to standard": "Lack of adherence to standard",
    "Lack of standard": "Lack of standard",
    "Disrupted sleep pattern (shift work)": "Disrupted sleep pattern (shift work)",
    "Incompatible simultaneous activities": "Incompatible simultaneous activities",
    "Distraction": "Distraction",
    "Isolation (especially in remote work or lone working roles)": "Isolation (especially in remote work or lone working roles)",
    "Workplace bullying or harassment": "Workplace bullying or harassment",
    "Discrimination (e.g. gender, race, age)": "Discrimination (e.g. gender, race, age)",
    "Poor supervisor or managerial support": "Poor supervisor or managerial support",
    "Inconsistent communication during organizational change": "Inconsistent communication during organizational change",
    "Lack of transparency or trust in leadership": "Lack of transparency or trust in leadership",
    "Poor organizational justice (unfair treatment)": "Poor organizational justice (unfair treatment)",
    "Lack of recognition or reward": "Lack of recognition or reward",
    "Lack of communication or feedback": "Lack of communication or feedback",
    "Lack of employee involvement in decision-making": "Lack of employee involvement in decision-making",
    "Dealing with aggressive or violent people": "Dealing with aggressive or violent people",
    "Exposure to distressing situations (e.g. emergency services, healthcare, customer complaints)": "Exposure to distressing situations (e.g. emergency services, healthcare, customer complaints)",
    "Lack of privacy or personal space": "Lack of privacy or personal space",
    "Inadequate rest areas": "Inadequate rest areas",
    "Overcrowded or chaotic workspaces": "Overcrowded or chaotic workspaces",
    "Remote Work Specific Hazards": "Remote Work Specific Hazards",
    "Work-Life Balance": "Work-Life Balance",
    "Employment restriction (e.g. Pregnant/breastfeeding, handicap)": "Employment restriction (e.g. Pregnant/breastfeeding, handicap)",
    "Viruses, bacteria, fungi": "Viruses, bacteria, fungi",
    "Legionella (specific bacteria)": "Legionella (specific bacteria)",
    "Molds or allergens": "Molds or allergens",
    "Handling human or animal bodily fluids": "Handling human or animal bodily fluids",
    "Bloodborne pathogens": "Bloodborne pathogens",
    "Contaminated waste or biological material": "Contaminated waste or biological material",
    "Potability of water": "Potability of water",
    "Food hygiene": "Food hygiene",
    "Animal or insect bites/stings": "Animal or insect bites/stings",
    "Animal waste": "Animal waste",
    "Hazardous vegetation": "Hazardous vegetation",
    "Flammable and combustible materials": "Flammable and combustible materials",
    "Ignition sources": "Ignition sources",
    "Ignition sources (open flames, sparks, static)": "Ignition sources (open flames, sparks, static)",
    "Dust explosions (e.g., coal, wood, metal dust)": "Dust explosions (e.g., coal, wood, metal dust)",
    "Oxygen-enriched environments": "Oxygen-enriched environments",
    // Risk/Consequences (English)
    "Abrasion, Scratches": "Abrasion, Scratches",
    "Allergic Reaction": "Allergic Reaction",
    "Amputation": "Amputation",
    "Asphyxiation": "Asphyxiation",
    "Burn - Chemical": "Burn - Chemical",
    "Burn - Electrical/Electrocution": "Burn - Electrical/Electrocution",
    "Burn or Scald (thermal)": "Burn or Scald (thermal)",
    "Chemical exposure": "Chemical exposure",
    "Concussion": "Concussion",
    "Contusion, Bruise": "Contusion, Bruise",
    "Crushing injury": "Crushing injury",
    "Laceration, Cut, Open wound": "Laceration, Cut, Open wound",
    "Fracture": "Fracture",
    "Frostbite / Hypothermia": "Frostbite / Hypothermia",
    "Hearing loss, or impairment": "Hearing loss, or impairment",
    "Heat Stress / Exhaustion / Stroke": "Heat Stress / Exhaustion / Stroke",
    "Hernia": "Hernia",
    "Mental Stress / Work-related Mental Health Condition": "Mental Stress / Work-related Mental Health Condition",
    "Musculoskeletal Disorder (MSD)": "Musculoskeletal Disorder (MSD)",
    "Poisoning": "Poisoning",
    "Puncture": "Puncture",
    "Repetitive motion injury": "Repetitive motion injury",
    "Respiratory irritation (e.g. Asthma)": "Respiratory irritation (e.g. Asthma)",
    "Sprain": "Sprain",
    "Strain": "Strain",
    // Instruction and Helper Text (English)
    "Upload media files. Faces will be automatically blurred. Click thumbnails to add risk descriptions, hazards, and controls.": "Upload media files. Faces will be automatically blurred. Click thumbnails to add risk descriptions, hazards, and controls.",
    "Write a detailed description of the work process. Mention any previous incidents for better risk scoring.": "Write a detailed description of the work process. Mention any previous incidents for better risk scoring.",
    "Upload an Excel file containing risk data. The system will parse and convert it to risk assessment format.": "Upload an Excel file containing risk data. The system will parse and convert it to risk assessment format.",
    "Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.": "Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.",
    "Uploaded videos will appear here...": "Uploaded videos will appear here...",
    "Processed images/frames will appear here...": "Processed images/frames will appear here...",
    "Click to select Excel file": "Click to select Excel file",
    "Supported: .xlsx, .xls, .csv": "Supported: .xlsx, .xls, .csv",
    "Finish uploading and describing your task/images": "Finish uploading and describing your task/images",
    "Review the risk assessment table": "Review the risk assessment table",
    "Generate AI recommendations": "Generate AI recommendations",
    "Download your complete report": "Download your complete report",
    "Mention past incidents for more accurate scoring": "Mention past incidents for more accurate scoring",
    "Add detailed hazard descriptions in notes": "Add detailed hazard descriptions in notes",
    "Review AI suggestions before finalizing": "Review AI suggestions before finalizing",
    "Export to PDF for stakeholder review": "Export to PDF for stakeholder review",
    "Loading AI models... üß†": "Loading AI models... üß†",
    // UI Buttons and Labels (English)
    "Process Files": "Process Files",
    "Download All Images and Reports as ZIP": "Download All Images and Reports as ZIP",
    "Generate AI Risk Assessment from Image Notes": "Generate AI Risk Assessment from Image Notes",
    "Save Project": "Save Project",
    "Load Project": "Load Project",
    "Generate Task Breakdown": "Generate Task Breakdown",
    "Translate Table": "Translate Table",
    "Download Project ZIP": "Download Project ZIP",
    "Print": "Print",
    "Privacy Policy": "Privacy Policy",
    "Generate AI Recommendations & Visuals": "Generate AI Recommendations & Visuals",
    "Advanced Import / Convert": "Advanced Import / Convert",
    "Click to upload or drag and drop": "Click to upload or drag and drop",
    "Images or Videos": "Images or Videos",
    "Overall Progress": "Overall Progress",
    "Uploaded Videos (Capture frames below)": "Uploaded Videos (Capture frames below)",
    "Upload Images & Videos": "Upload Images & Videos",
    "Describe Your Task": "Describe Your Task",
    "Import Excel File": "Import Excel File",
    "Description of step": "Description of step",
    "What can go wrong / spot hazards": "What can go wrong / spot hazards",
    "Any existing controls": "Any existing controls",
    "Language": "Language",
    "Frequency": "Frequency",
    "Severity": "Severity",
    "Likelihood": "Likelihood",
    "Not set": "Not set",
    // Speech Recognition (English)
    "Listening in": "Listening in",
    "Click mic again to stop.": "Click mic again to stop.",
    "No speech detected. Please speak into your microphone.": "No speech detected. Please speak into your microphone.",
    "No microphone found. Please ensure a microphone is connected.": "No microphone found. Please ensure a microphone is connected.",
    "Microphone access denied. Please allow microphone access in your browser.": "Microphone access denied. Please allow microphone access in your browser.",
    "Network error. Please check your internet connection.": "Network error. Please check your internet connection.",
    "Speech recognition error: ": "Speech recognition error: "
  },
  fr: {
    // Hazard Groups (French)
    "Mechanical / Machinery hazards": "Dangers m√©caniques / Machines",
    "Workplace / Infrastructure Design": "Conception du lieu de travail / Infrastructure",
    "Physical health hazards": "Dangers pour la sant√© physique",
    "Chemical hazards": "Dangers chimiques",
    "Hazardous Energy": "√ânergie dangereuse",
    "Transportation": "Transport",
    "Ergonomic hazards": "Dangers ergonomiques",
    "Organizational and Psychosocial": "Organisationnels et psychosociaux",
    "Biological hazard": "Dangers biologiques",
    "Fire and explosion": "Incendie et explosion",
    // Frequency Scale (French)
    "RARELY (<30 min/day)": "RAREMENT (<30 min/jour)",
    "OCCASIONAL (<2 hrs/wk)": "OCCASIONNEL (<2 hrs/sem)",
    "INTERMEDIATE (2-8 hrs/wk)": "INTERM√âDIAIRE (2-8 hrs/sem)",
    "FREQUENTLY (1-3 days/wk)": "FR√âQUEMMENT (1-3 jours/sem)",
    "PERMANENT (>3 days/wk)": "PERMANENT (>3 jours/sem)",
    // Severity Scale (French)
    "No potential of injury": "Pas de risque de blessure",
    "Potential of FIRST AID": "Potentiel de premiers secours",
    "Potential of MEDICAL TREATMENT": "Potentiel de traitement m√©dical",
    "Potential of DART": "Potentiel de DART",
    "Potential of SIA": "Potentiel de SIA",
    "Potential of Fatality": "Potentiel de d√©c√®s",
    // Likelihood Scale (French)
    "Almost impossible": "Presque impossible",
    "Very unlikely": "Tr√®s improbable",
    "Possible to happen": "Susceptible de se produire",
    "Likely to happen": "Susceptible de se produire",
    "Very likely to happen": "Tr√®s susceptible de se produire",
    // Hazard List Items (French)
    "Hand tools (cut, impact, puncture, etc.)": "Outils manuels (coupure, impact, perforation, etc.)",
    "Powered tools": "Outils motoris√©s",
    "Pinch / nip points": "Points de pincement / happement",
    "Rotating parts (entanglement)": "Pi√®ces en rotation (emm√™lement)",
    "Moving parts (cutting)": "Pi√®ces mobiles (coupure)",
    "Moving parts (crushing)": "Pi√®ces mobiles (√©crasement)",
    "Ejection (parts, materials)": "√âjection (pi√®ces, mat√©riaux)",
    "Angular, sharp and cutting elements": "√âl√©ments angulaires, tranchants et coupants",
    "Degraded or malfunctioning equipment": "√âquipement d√©grad√© ou d√©fectueux",
    "Equipment failure": "Panne d'√©quipement",
    "Improper use of tools/machines": "Utilisation incorrecte des outils/machines",
    "Inadequate guarding": "Protection inad√©quate",
    "Use of lifting equipment and accessories": "Utilisation d'√©quipements de levage et accessoires",
    "Use of suspension equipment (jacks, etc.)": "Utilisation d'√©quipements de suspension (crics, etc.)",
    "Acceleration / deceleration": "Acc√©l√©ration / d√©c√©l√©ration",
    "Slips, trips, and falls (same level or height)": "Glissades, tr√©buchements et chutes (de plain-pied ou de hauteur)",
    "Slippery, uneven, unstable or damaged floor": "Sol glissant, in√©gal, instable ou endommag√©",
    "Congested or obstructed workplace": "Lieu de travail encombr√© ou obstru√©",
    "Clutter / Mess": "Encombrement / D√©sordre",
    "Protrusion (bump, puncture, cut, etc.)": "Saillie (choc, perforation, coupure, etc.)",
    "Hot surface": "Surface chaude",
    "Cold surface": "Surface froide",
    "Rough surface": "Surface rugueuse",
    "Unsecured items at height": "Objets non s√©curis√©s en hauteur",
    "Work at height (<1.2m - <4 feet)": "Travail en hauteur (<1,2 m - <4 pieds)",
    "Work at height (‚â•1.2m - ‚â•4 feet)": "Travail en hauteur (‚â•1,2 m - ‚â•4 pieds)",
    "Poor ventilation": "Mauvaise ventilation",
    "Extreme heat": "Chaleur extr√™me",
    "Extreme cold": "Froid extr√™me",
    "Snow or ice": "Neige ou glace",
    "Extreme wind": "Vent extr√™me",
    "Other adverse weather conditions": "Autres conditions m√©t√©orologiques d√©favorables",
    "Confined spaces": "Espaces confin√©s",
    "Lone work": "Travail isol√©",
    "Temporary works or unstable structures": "Travaux temporaires ou structures instables",
    "Engulfment": "Engloutissement",
    "Inclined surface": "Surface inclin√©e",
    "Poor visibility": "Mauvaise visibilit√©",
    "Coactivity area": "Zone de coactivit√©",
    "Noise exposure": "Exposition au bruit",
    "Vibration / Impact (hand-arm, whole-body)": "Vibrations / Impacts (main-bras, corps entier)",
    "Heat stress": "Stress thermique (chaud)",
    "Cold stress": "Stress thermique (froid)",
    "Poor lighting (intensity, glare, reflection)": "√âclairage insuffisant (intensit√©, √©blouissement, r√©flexion)",
    "Electro-magnetic fields": "Champs √©lectromagn√©tiques",
    "Ionizing radiation (X-rays, radioactive elements)": "Rayonnements ionisants (rayons X, √©l√©ments radioactifs)",
    "Non-ionizing radiation (UV, microwave, laser, welding radiations)": "Rayonnements non ionisants (UV, micro-ondes, laser, radiations de soudage)",
    "Severe draft (e.g. cold air current)": "Courant d'air s√©v√®re (ex. courant d'air froid)",
    "Smoke and fumes": "Fum√©es et vapeurs",
    "Physical health [Generic]": "Sant√© physique [G√©n√©rique]",
    "Explosive materials": "Mat√©riaux explosifs",
    "Flammable materials": "Mat√©riaux inflammables",
    "Oxidising materials": "Mat√©riaux oxydants",
    "Corrosive materials": "Mat√©riaux corrosifs",
    "Acute toxicity materials": "Mat√©riaux toxiques aigus",
    "Health hazard, sensitizers, allergens materials": "Dangers pour la sant√©, sensibilisants, allerg√®nes",
    "Carcinogens, mutagens, reprotoxic (CMRs) materials": "Mat√©riaux canc√©rog√®nes, mutag√®nes, reprotoxiques (CMR)",
    "Gas under pressure": "Gaz sous pression",
    "Asbestos": "Amiante",
    "Fibers other than asbestos": "Fibres autres que l'amiante",
    "Oil": "Huile",
    "Crystalline silica": "Silice cristalline",
    "Organic peroxides": "Peroxydes organiques",
    "Nanomaterials": "Nanomat√©riaux",
    "Endocrine disrupters": "Perturbateurs endocriniens",
    "Lead-containing material": "Mat√©riau contenant du plomb",
    "Particulate material (dust, smoke, fog, aerosol)": "Mat√©riau particulaire (poussi√®re, fum√©e, brouillard, a√©rosol)",
    "Improper labeling or storage": "√âtiquetage ou stockage incorrect",
    "Incompatible chemical reactions": "R√©actions chimiques incompatibles",
    "Chemical spills or leaks": "D√©versements ou fuites chimiques",
    "Water reactive substances": "Substances r√©actives √† l'eau",
    "Shock / vibration sensitive substances": "Substances sensibles aux chocs / vibrations",
    "Chemicals [Generic]": "Produits chimiques [G√©n√©rique]",
    "Electricity": "√âlectricit√©",
    "Electrostatic": "√âlectrostatique",
    "Electromagnetic fields": "Champs √©lectromagn√©tiques",
    "Arc flash": "Arc √©lectrique",
    "Magnetic": "Magn√©tique",
    "Equipment under pressure": "√âquipement sous pression",
    "Compressed air": "Air comprim√©",
    "Vacuum": "Vide",
    "Hydraulic": "Hydraulique",
    "Pneumatic": "Pneumatique",
    "Thermal energy (steam, heated surfaces)": "√ânergie thermique (vapeur, surfaces chauff√©es)",
    "Kinetic energy": "√ânergie cin√©tique",
    "Gravity": "Gravit√©",
    "Stored energy (pneumatic, hydraulic, mechanical, electrical)": "√ânergie stock√©e (pneumatique, hydraulique, m√©canique, √©lectrique)",
    "Exothermic chemical reaction": "R√©action chimique exothermique",
    "Hazardous Energy [Generic]": "√ânergie dangereuse [G√©n√©rique]",
    "Interaction pedestrian/pedestrian": "Interaction pi√©ton/pi√©ton",
    "Interaction pedestrian/bicycle": "Interaction pi√©ton/v√©lo",
    "Interaction pedestrian/Vehicle": "Interaction pi√©ton/v√©hicule",
    "Interaction bicycle/bicycle": "Interaction v√©lo/v√©lo",
    "Interaction bicycle/Vehicle": "Interaction v√©lo/v√©hicule",
    "Interaction Vehicle/Vehicle": "Interaction v√©hicule/v√©hicule",
    "Interaction Vehicle/Stationary items": "Interaction v√©hicule/objets fixes",
    "Poor road or yard conditions": "Mauvaises conditions de route ou de cour",
    "Unintentional vehicle movement": "Mouvement involontaire du v√©hicule",
    "High speed vehicle, tire grip loss": "V√©hicule √† haute vitesse, perte d'adh√©rence des pneus",
    "Inadequate load securing": "Fixation inad√©quate de la charge",
    "Traffic [Generic]": "Circulation [G√©n√©rique]",
    "Postures (Hit list)": "Postures (liste des hits)",
    "Force": "Force",
    "Lifting/Lowering": "Levage/abaissement",
    "Pushing": "Pousser",
    "Pulling": "Tirer",
    "Carrying": "Porter",
    "Soft tissue compression": "Compression des tissus mous",
    "Ill-fitting gloves": "Gants mal ajust√©s",
    "Standing or Sitting for long periods": "Debout ou assis pendant de longues p√©riodes",
    "Computer workstation / Screen": "Poste de travail ordinateur / √âcran",
    "Inadequate tool or workstation design": "Conception inad√©quate de l'outil ou du poste de travail",
    "Poor ergonomics [Generic]": "Ergonomie faible [G√©n√©rique]",
    "Ambiguity of the roles and responsibilities": "Ambigu√Øt√© des r√¥les et responsabilit√©s",
    "Inadequate staffing": "Dotation insuffisante",
    "High job demands (physical or mental workload)": "Exigences √©lev√©es du travail (charge physique ou mentale)",
    "Low job control or autonomy": "Faible contr√¥le ou autonomie du travail",
    "Monotonous or repetitive tasks": "T√¢ches monotones ou r√©p√©titives",
    "Unclear job roles or expectations": "R√¥les ou attentes du travail non clairs",
    "Job insecurity or precarious employment": "Ins√©curit√© d'emploi ou emploi pr√©caire",
    "Long working hours or shift work": "Longues heures de travail ou travail post√©",
    "Unrealistic deadlines": "D√©lais irr√©alistes",
    "Coactivity": "Coactivit√©",
    "Unfamiliar work": "Travail inconnu",
    "New hire / temporary worker": "Nouvel embauch√© / Travailleur temporaire",
    "Insufficient / inadequate training": "Formation insuffisante / inad√©quate",
    "Violations of rules": "Violations des r√®gles",
    "Misuse of computer systems / equipment": "Mauvaise utilisation des syst√®mes / √©quipements informatiques",
    "Lack of adherence to standard": "Manque d'adh√©sion √† la norme",
    "Lack of standard": "Absence de norme",
    "Disrupted sleep pattern (shift work)": "Perturbation du sommeil (travail post√©)",
    "Incompatible simultaneous activities": "Activit√©s simultan√©es incompatibles",
    "Distraction": "Distraction",
    "Isolation (especially in remote work or lone working roles)": "Isolation (surtout en t√©l√©travail ou r√¥les isol√©s)",
    "Workplace bullying or harassment": "Intimidation ou harc√®lement au travail",
    "Discrimination (e.g. gender, race, age)": "Discrimination (ex. genre, race, √¢ge)",
    "Poor supervisor or managerial support": "Soutien insuffisant du superviseur ou de la direction",
    "Inconsistent communication during organizational change": "Communication incoh√©rente pendant le changement organisationnel",
    "Lack of transparency or trust in leadership": "Manque de transparence ou de confiance dans la direction",
    "Poor organizational justice (unfair treatment)": "Justice organisationnelle faible (traitement injuste)",
    "Lack of recognition or reward": "Manque de reconnaissance ou de r√©compense",
    "Lack of communication or feedback": "Manque de communication ou de feedback",
    "Lack of employee involvement in decision-making": "Manque d'implication des employ√©s dans la prise de d√©cision",
    "Dealing with aggressive or violent people": "Gestion de personnes agressives ou violentes",
    "Exposure to distressing situations (e.g. emergency services, healthcare, customer complaints)": "Exposition √† des situations distressantes (ex. services d'urgence, soins de sant√©, plaintes clients)",
    "Lack of privacy or personal space": "Manque de confidentialit√© ou d'espace personnel",
    "Inadequate rest areas": "Zones de repos inad√©quates",
    "Overcrowded or chaotic workspaces": "Espaces de travail surpeupl√©s ou chaotiques",
    "Remote Work Specific Hazards": "Risques sp√©cifiques au t√©l√©travail",
    "Work-Life Balance": "√âquilibre travail-vie",
    "Employment restriction (e.g. Pregnant/breastfeeding, handicap)": "Restriction d'emploi (ex. enceinte/allaitante, handicap)",
    "Viruses, bacteria, fungi": "Virus, bact√©ries, champignons",
    "Legionella (specific bacteria)": "L√©gionelle (bact√©rie sp√©cifique)",
    "Molds or allergens": "Moisissures ou allerg√®nes",
    "Handling human or animal bodily fluids": "Manipulation de fluides corporels humains ou animaux",
    "Bloodborne pathogens": "Pathog√®nes transmis par le sang",
    "Contaminated waste or biological material": "D√©chets contamin√©s ou mat√©riaux biologiques",
    "Potability of water": "Potabilit√© de l'eau",
    "Food hygiene": "Hygi√®ne alimentaire",
    "Animal or insect bites/stings": "Morsures/piq√ªres d'animaux ou d'insectes",
    "Animal waste": "D√©chets animaux",
    "Hazardous vegetation": "V√©g√©tation dangereuse",
    "Flammable and combustible materials": "Mat√©riaux inflammables et combustibles",
    "Ignition sources": "Sources d'allumage",
    "Ignition sources (open flames, sparks, static)": "Sources d'allumage (flammes ouvertes, √©tincelles, statique)",
    "Dust explosions (e.g., coal, wood, metal dust)": "Explosions de poussi√®res (ex. charbon, bois, poussi√®re m√©tallique)",
    "Oxygen-enriched environments": "Environnements enrichis en oxyg√®ne",
    // Risk/Consequences (French)
    "Abrasion, Scratches": "Abrasions, √©gratignures",
    "Allergic Reaction": "R√©action allergique",
    "Amputation": "Amputation",
    "Asphyxiation": "Asphyxie",
    "Burn - Chemical": "Br√ªlure - Chimique",
    "Burn - Electrical/Electrocution": "Br√ªlure - √âlectrique/√âlectrocution",
    "Burn or Scald (thermal)": "Br√ªlure ou √©bouillantement (thermique)",
    "Chemical exposure": "Exposition chimique",
    "Concussion": "Commotion c√©r√©brale",
    "Contusion, Bruise": "Contusion, ecchymose",
    "Crushing injury": "Blessure par √©crasement",
    "Laceration, Cut, Open wound": "Lac√©ration, coupure, plaie ouverte",
    "Fracture": "Fracture",
    "Frostbite / Hypothermia": "Engelures / Hypothermie",
    "Hearing loss, or impairment": "Perte auditive ou d√©ficience",
    "Heat Stress / Exhaustion / Stroke": "Stress thermique / √âpuisement / Coup de chaleur",
    "Hernia": "Hernie",
    "Mental Stress / Work-related Mental Health Condition": "Stress mental / Trouble mental li√© au travail",
    "Musculoskeletal Disorder (MSD)": "Trouble musculo-squelettique (TMS)",
    "Poisoning": "Empoisonnement",
    "Puncture": "Perforation",
    "Repetitive motion injury": "Blessure par mouvements r√©p√©titifs",
    "Respiratory irritation (e.g. Asthma)": "Irritation respiratoire (ex. Asthme)",
    "Sprain": "Entorse",
    "Strain": "Foulure",
    // Instruction and Helper Text (French)
    "Upload media files. Faces will be automatically blurred. Click thumbnails to add risk descriptions, hazards, and controls.": "T√©l√©chargez des fichiers m√©dias. Les visages seront automatiquement flout√©s. Cliquez sur les miniatures pour ajouter des descriptions de risques, des dangers et des contr√¥les.",
    "Write a detailed description of the work process. Mention any previous incidents for better risk scoring.": "√âcrivez une description d√©taill√©e du processus de travail. Mentionnez les incidents ant√©rieurs pour un meilleur calcul des risques.",
    "Upload an Excel file containing risk data. The system will parse and convert it to risk assessment format.": "T√©l√©chargez un fichier Excel contenant des donn√©es de risque. Le syst√®me l'analysera et le convertira au format d'√©valuation des risques.",
    "Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.": "Cliquez sur une miniature ci-dessous pour ouvrir l'aper√ßu agrandi pour le floutage manuel et pour ajouter des notes de risque. Vous pouvez √©galement glisser-d√©poser pour r√©organiser les images.",
    "Uploaded videos will appear here...": "Les vid√©os t√©l√©charg√©es appara√Ætront ici...",
    "Processed images/frames will appear here...": "Les images/images trait√©es appara√Ætront ici...",
    "Click to select Excel file": "Cliquez pour s√©lectionner le fichier Excel",
    "Supported: .xlsx, .xls, .csv": "Formats pris en charge: .xlsx, .xls, .csv",
    "Finish uploading and describing your task/images": "Terminez le t√©l√©chargement et la description de votre t√¢che/images",
    "Review the risk assessment table": "Examinez le tableau d'√©valuation des risques",
    "Generate AI recommendations": "G√©n√©rer les recommandations IA",
    "Download your complete report": "T√©l√©chargez votre rapport complet",
    "Mention past incidents for more accurate scoring": "Mentionnez les incidents pass√©s pour un calcul plus pr√©cis",
    "Add detailed hazard descriptions in notes": "Ajoutez des descriptions d√©taill√©es des dangers dans les notes",
    "Review AI suggestions before finalizing": "Examinez les suggestions IA avant de finaliser",
    "Export to PDF for stakeholder review": "Exporter au format PDF pour examen des parties prenantes",
    "Loading AI models... üß†": "Chargement des mod√®les IA... üß†",
    // UI Buttons and Labels (French)
    "Process Files": "Traiter les fichiers",
    "Download All Images and Reports as ZIP": "T√©l√©charger toutes les images et rapports en ZIP",
    "Generate AI Risk Assessment from Image Notes": "G√©n√©rer une √©valuation des risques IA √† partir des notes d'image",
    "Save Project": "Enregistrer le projet",
    "Load Project": "Charger le projet",
    "Generate Task Breakdown": "G√©n√©rer une ventilation des t√¢ches",
    "Translate Table": "Traduire le tableau",
    "Download Project ZIP": "T√©l√©charger ZIP du projet",
    "Print": "Imprimer",
    "Privacy Policy": "Politique de confidentialit√©",
    "Generate AI Recommendations & Visuals": "G√©n√©rer les recommandations et visuels IA",
    "Advanced Import / Convert": "Importation / Conversion avanc√©e",
    "Click to upload or drag and drop": "Cliquez pour t√©l√©charger ou glissez-d√©posez",
    "Images or Videos": "Images ou vid√©os",
    "Overall Progress": "Progr√®s global",
    "Uploaded Videos (Capture frames below)": "Vid√©os t√©l√©charg√©es (capturer les images ci-dessous)",
    "Upload Images & Videos": "T√©l√©charger des images et des vid√©os",
    "Describe Your Task": "D√©crivez votre t√¢che",
    "Import Excel File": "Importer un fichier Excel",
    "Description of step": "Description de l'√©tape",
    "What can go wrong / spot hazards": "Qu'est-ce qui pourrait mal tourner / rep√©rer les dangers",
    "Any existing controls": "Tous les contr√¥les existants",
    "Language": "Langue",
    "Frequency": "Fr√©quence",
    "Severity": "Gravit√©",
    "Likelihood": "Probabilit√©",
    "Not set": "Non d√©fini",
    // Speech Recognition (French)
    "Listening in": "√âcoute en",
    "Click mic again to stop.": "Cliquez √† nouveau sur le micro pour arr√™ter.",
    "No speech detected. Please speak into your microphone.": "Aucune parole d√©tect√©e. Veuillez parler dans votre microphone.",
    "No microphone found. Please ensure a microphone is connected.": "Aucun microphone trouv√©. Veuillez vous assurer qu'un microphone est connect√©.",
    "Microphone access denied. Please allow microphone access in your browser.": "Acc√®s au microphone refus√©. Veuillez autoriser l'acc√®s au microphone dans votre navigateur.",
    "Network error. Please check your internet connection.": "Erreur r√©seau. Veuillez v√©rifier votre connexion Internet.",
    "Speech recognition error: ": "Erreur de reconnaissance vocale : ",
    // Edit Task Modal (French)
    "Edit Task Details": "Modifier les d√©tails de la t√¢che",
    "üõ°Ô∏è Risk Reduction Strategy": "üõ°Ô∏è Strat√©gie de r√©duction des risques",
    "Select Control Type": "S√©lectionner le type de contr√¥le",
    "Click a level to select": "Cliquez sur un niveau pour s√©lectionner",
    "Description": "Description",
    "Describe how this control will be implemented...": "D√©crivez comment ce contr√¥le sera mis en ≈ìuvre...",
    "+ Add Control": "+ Ajouter un contr√¥le",
    "Selected Controls": "Contr√¥les s√©lectionn√©s",
    "No controls added yet": "Aucun contr√¥le ajout√© pour le moment",
    "How is this calculated?": "Comment est-ce calcul√© ?",
    "üéØ The Hierarchy of Controls (NIOSH/OSHA)": "üéØ La hi√©rarchie des contr√¥les (NIOSH/OSHA)",
    "This tool uses the internationally recognized Hierarchy of Controls developed by NIOSH (National Institute for Occupational Safety and Health) and endorsed by OSHA. Controls at the top are most effective because they eliminate or reduce the hazard itself, while lower controls rely on human behavior.": "Cet outil utilise la hi√©rarchie des contr√¥les internationalement reconnue d√©velopp√©e par le NIOSH (National Institute for Occupational Safety and Health) et approuv√©e par l'OSHA. Les contr√¥les en haut sont les plus efficaces car ils √©liminent ou r√©duisent le danger lui-m√™me, tandis que les contr√¥les inf√©rieurs d√©pendent du comportement humain.",
    "üìä Control Effectiveness (Based on Safety Science)": "üìä Efficacit√© des contr√¥les (bas√©e sur la science de la s√©curit√©)",
    "Eliminate: Physically removes the hazard ‚Üí Risk becomes 0": "√âliminer : Supprime physiquement le danger ‚Üí Le risque devient 0",
    "Substitute/Engineer: High-reliability controls ‚Üí Up to 80% reduction": "Substituer/Ing√©nierie : Contr√¥les haute fiabilit√© ‚Üí Jusqu'√† 80% de r√©duction",
    "Admin/Visual/PPE: Behavior-dependent controls ‚Üí Up to 55% reduction": "Admin/Visuel/EPI : Contr√¥les d√©pendants du comportement ‚Üí Jusqu'√† 55% de r√©duction",
    "Note: Exact percentages are estimates based on the principle that engineering controls are significantly more reliable than administrative controls, as they don't depend on consistent human action.": "Note : Les pourcentages exacts sont des estimations bas√©es sur le principe que les contr√¥les d'ing√©nierie sont consid√©rablement plus fiables que les contr√¥les administratifs, car ils ne d√©pendent pas d'une action humaine coh√©rente.",
    "‚öñÔ∏è Diminishing Returns Principle": "‚öñÔ∏è Principe des rendements d√©croissants",
    "Safety science recognizes that controls ranked higher in the hierarchy (Eliminate, Substitute, Engineer) provide greater protection. When implementing multiple controls of the same type, each additional control yields diminishing marginal benefit, with each layer adding progressively less protection. This is modeled using geometric decay factors.": "La science de la s√©curit√© reconna√Æt que les contr√¥les class√©s plus haut dans la hi√©rarchie (√âliminer, Substituer, Ing√©nierie) offrent une meilleure protection. Lors de la mise en ≈ìuvre de plusieurs contr√¥les du m√™me type, chaque contr√¥le suppl√©mentaire produit un b√©n√©fice marginal d√©croissant, chaque couche ajoutant progressivement moins de protection. Ceci est mod√©lis√© √† l'aide de facteurs de d√©croissance g√©om√©trique.",
    "üõ°Ô∏è Defense in Depth": "üõ°Ô∏è D√©fense en profondeur",
    "Best practice is to combine high-level controls (Substitute/Engineer) with administrative controls and PPE. This 'layered defense' approach ensures protection even if one control fails.": "La meilleure pratique consiste √† combiner des contr√¥les de haut niveau (Substituer/Ing√©nierie) avec des contr√¥les administratifs et des EPI. Cette approche de 'd√©fense en couches' garantit la protection m√™me si un contr√¥le √©choue.",
    "üìö References": "üìö R√©f√©rences",
    "‚Ä¢ NIOSH - Hierarchy of Controls (CDC/NIOSH)": "‚Ä¢ NIOSH - Hi√©rarchie des contr√¥les (CDC/NIOSH)",
    "‚Ä¢ OSHA - Recommended Practices for Safety and Health Programs": "‚Ä¢ OSHA - Pratiques recommand√©es pour les programmes de s√©curit√© et de sant√©",
    "‚Ä¢ Canadian Centre for Occupational Health & Safety (CCOHS)": "‚Ä¢ Centre canadien d'hygi√®ne et de s√©curit√© au travail (CCOHS)",
    "‚Ä¢ UK Health and Safety Executive (HSE)": "‚Ä¢ Health and Safety Executive du Royaume-Uni (HSE)",
    "‚Ä¢ Prevention through Design (PtD) Initiative": "‚Ä¢ Initiative Pr√©vention par le Design (PtD)",
    "Use ‚Üê ‚Üí arrow keys to navigate. Changes are auto saved!": "Utilisez les touches ‚Üê ‚Üí pour naviguer. Les modifications sont automatiquement sauvegard√©es !",
    "üóëÔ∏è Delete": "üóëÔ∏è Supprimer",
    "Close": "Fermer",
    "‚Üê Previous": "‚Üê Pr√©c√©dent",
    "Next ‚Üí": "Suivant ‚Üí",
    "‚Ü©Ô∏è Restore": "‚Ü©Ô∏è Restaurer",
    "This task has been deleted": "Cette t√¢che a √©t√© supprim√©e",
    "‚Ü©Ô∏è Restore Task": "‚Ü©Ô∏è Restaurer la t√¢che",
    "Risk Rating:": "√âvaluation du risque :",
    "Risk Score": "Score de risque",
    "Risk Category": "Cat√©gorie de risque",
    "üìã EHS Standards - Frequency, Severity & Likelihood Definitions": "üìã Normes EHS - D√©finitions de fr√©quence, gravit√© et probabilit√©",

    // Risk Rating Table translations
    "Risk Rating & Response": "√âvaluation du risque et r√©ponse",
    "Risk Score (F √ó S √ó L)": "Score de risque (F √ó S √ó L)",
    "Interpretation": "Interpr√©tation",
    "Response Required": "R√©ponse requise",
    "LOW": "FAIBLE",
    "MEDIUM": "MOYEN",
    "HIGH": "√âLEV√â",
    "CRITICAL": "CRITIQUE",
    "Low priority - Further reduce risk if feasible.": "Priorit√© faible - R√©duire davantage le risque si possible.",
    "Further reduce risk over time. Prioritize higher risks first.": "R√©duire davantage le risque au fil du temps. Prioriser d'abord les risques plus √©lev√©s.",
    "Action plan to reduce this risk level as a lower priority.": "Plan d'action pour r√©duire ce niveau de risque en priorit√© moindre.",
    "Deploy interim protective measures and prioritize implementation of more secured permanent controls. Highlight to exposed associates the risk they are exposed to.": "D√©ployer des mesures de protection interm√©diaires et prioriser la mise en ≈ìuvre de contr√¥les permanents plus s√©curis√©s. Mettre en √©vidence aupr√®s des associ√©s expos√©s le risque auquel ils sont expos√©s.",

    // Predicted Risk Card translations
    "Predicted Risk": "Risque pr√©vu",
    "control": "contr√¥le",
    "controls": "contr√¥les",
    "üéØ ELIMINATED:": "üéØ √âLIMIN√â :",
    "Hazard completely removed - no risk remains.": "Danger compl√®tement supprim√© - aucun risque ne subsiste.",
    "‚ö° STRONG CONTROLS:": "‚ö° CONTR√îLES FORTS :",
    "high-level controls (Substitute/Engineer) applied with": "contr√¥les de haut niveau (Substituer/Ing√©nierie) appliqu√©s avec",
    "max reduction.": "r√©duction maximale.",
    "‚ö° LAYERED DEFENSE:": "‚ö° D√âFENSE EN COUCHES :",
    "High-level control +": "Contr√¥le de haut niveau +",
    "administrative/PPE control": "contr√¥le administratif/EPI",
    "combined reduction).": "r√©duction combin√©e).",
    "‚ö° HIGH-LEVEL CONTROL:": "‚ö° CONTR√îLE DE HAUT NIVEAU :",
    "Substitution or Engineering control applied": "Contr√¥le de substitution ou d'ing√©nierie appliqu√©",
    "reduction).": "r√©duction).",
    "‚ö†Ô∏è LIMITED PROTECTION:": "‚ö†Ô∏è PROTECTION LIMIT√âE :",
    "lower-level controls only. Consider Substitution or Engineering controls.": "contr√¥les de niveau inf√©rieur uniquement. Envisager des contr√¥les de substitution ou d'ing√©nierie.",
    "üìã LOWER-LEVEL CONTROLS:": "üìã CONTR√îLES DE NIVEAU INF√âRIEUR :",
    "(Admin/Visual/PPE) -": "(Admin/Visuel/EPI) -",
    "Select controls from the hierarchy above to see risk projections...": "S√©lectionnez des contr√¥les dans la hi√©rarchie ci-dessus pour voir les projections de risque...",

    // Workflow and Tables (French)
    "Choose your workflow to get started": "Choisissez votre workflow pour commencer",
    "Rich Media": "M√©dias riches",
    "Free Text": "Texte libre",
    "Excel Sheet": "Feuille Excel",
    "Click to upload or drag and drop": "Cliquez pour t√©l√©charger ou glissez-d√©posez",
    "Images or Videos": "Images ou vid√©os",
    "Models loaded. Please select your images or videos.": "Mod√®les charg√©s. Veuillez s√©lectionner vos images ou vid√©os.",
    "Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.": "Cliquez sur une vignette ci-dessous pour ouvrir l'aper√ßu agrand√© pour le flou manuel et ajouter des notes de risque. Vous pouvez √©galement glisser-d√©poser pour r√©organiser les images.",
    "üí° Pro Tips": "üí° Conseils professionnels",
    "‚Ä¢ Mention past incidents for more accurate scoring": "‚Ä¢ Mentionner les incidents pass√©s pour un score plus pr√©cis",
    "‚Ä¢ Add detailed hazard descriptions in notes": "‚Ä¢ Ajouter des descriptions d√©taill√©es des dangers dans les notes",
    "‚Ä¢ Review AI suggestions before finalizing": "‚Ä¢ Examiner les suggestions IA avant la finalisation",
    "‚Ä¢ Save your Project and resume your work": "‚Ä¢ Enregistrer votre projet et reprendre votre travail",
    "F Value": "Valeur F",
    "Category": "Cat√©gorie",
    "Day": "Jour",
    "Week": "Semaine",
    "Month": "Mois",
    "Year": "Ann√©e",
    "RARELY": "RAREMENT",
    "<0.5 day": "<0,5 jour",
    "1 day": "1 jour",
    "OCCASIONAL": "OCCASIONNEL",
    "<30 min": "<30 min",
    "<2 hours": "<2 heures",
    "<1 days": "<1 jours",
    "<5 days": "<5 jours",
    "INTERMEDIATE": "INTERM√âDIAIRE",
    "30-120 min": "30-120 min",
    "2-8 hours": "2-8 heures",
    "1-4 days": "1-4 jours",
    "5 days -2 months": "5 jours -2 mois",
    "FREQUENTLY": "FR√âQUEMMENT",
    "2-5 hours": "2-5 heures",
    "1-3 days": "1-3 jours",
    "4-15 days": "4-15 jours",
    "2-5 months": "2-5 mois",
    "PERMANENT": "PERMANENT",
    ">5 hours": ">5 heures",
    ">3 days": ">3 jours",
    "> 15 days": "> 15 jours",
    "> 5 months": "> 5 mois",
    "S Value": "Valeur S",
    "Classification": "Classification",
    "Most Probable Injury": "Blessure la plus probable",
    "No potential of injury": "Aucun risque de blessure",
    "‚Ä¢ No treatment needed": "‚Ä¢ Aucun traitement n√©cessaire",
    "Potential of FIRST AID": "Potentiel de premiers secours",
    "‚Ä¢ Non-prescription medication": "‚Ä¢ M√©dicaments en vente libre",
    "Potential of MEDICAL TREATMENT": "Potentiel de traitement m√©dical",
    "‚Ä¢ Prescription medications": "‚Ä¢ M√©dicaments sur ordonnance",
    "Potential of DART": "Potentiel de DART",
    "‚Ä¢ Temporary disability": "‚Ä¢ Invalidit√© temporaire",
    "Potential of SIA": "Potentiel de SIA",
    "‚Ä¢ Amputation": "‚Ä¢ Amputation",
    "Potential of Fatality": "Potentiel de mortalit√©",
    "‚Ä¢ Death": "‚Ä¢ D√©c√®s",
    "L Value": "Valeur L",
    "Machinery Related Risks": "Risques li√©s aux machines",
    "Industrial Hygiene Risks": "Risques pour l'hygi√®ne industrielle",
    "Other H&S Risks": "Autres risques H&S",
    "-": "-",
    "Loading AI models...": "Chargement des modeles IA...",
    "Loading AI models from CDN... Please wait.": "Chargement des modeles IA depuis le CDN... Veuillez patienter.",
    "file(s) selected. Click 'Process Files' to continue.": "fichier(s) selectionne(s). Cliquez sur Traiter les fichiers pour continuer.",
    "Models loading...": "Chargement des modeles...",
    "file(s) selected. Please wait.": "fichier(s) selectionne(s). Veuillez patienter.",
    "Error loading AI models from CDN. Check your internet connection and the browser console for details.": "Erreur de chargement des modeles IA depuis le CDN. Verifiez votre connexion Internet et la console du navigateur pour plus de details.",
    // Best Practices Modal (French)
    "Best Practices: AI-Powered Collaborative Risk Assessment": "Bonnes Pratiques : √âvaluation Collaborative des Risques par IA",
    "Keeping the human element at the heart of safety": "Garder l'√©l√©ment humain au c≈ìur de la s√©curit√©",
    "üéØ Core Principle": "üéØ Principe Fondamental",
    "This tool, while powered by AI, stays true to one of the fundamental tenets of safety risk assessment: collaboration and engagement with the operational team. AI helps reduce administrative burden, but YOU and your team are the drivers of meaningful change. Blind automation will never bring actionable results.": "Cet outil, bien qu'aliment√© par l'IA, reste fid√®le √† l'un des principes fondamentaux de l'√©valuation des risques : la collaboration et l'engagement avec l'√©quipe op√©rationnelle. L'IA aide √† r√©duire la charge administrative, mais VOUS et votre √©quipe √™tes les moteurs du changement significatif. L'automatisation aveugle n'apportera jamais de r√©sultats exploitables.",
    "üìπ Step 1: Capture Your Process": "üìπ √âtape 1 : Capturez Votre Processus",
    "Start by collecting rich media (video or photos) of your process from start to end. Split each process into respective task steps and document what can go wrong. This is your first collaborative touchpoint.": "Commencez par collecter des m√©dias riches (vid√©o ou photos) de votre processus du d√©but √† la fin. Divisez chaque processus en √©tapes de t√¢ches respectives et documentez ce qui peut mal tourner. C'est votre premier point de collaboration.",
    "üë• Step 2: Engage Your Team": "üë• √âtape 2 : Impliquez Votre √âquipe",
    "Bring the operational team together. Ask them: What are the hazards? What could go wrong? What existing controls do you have? Share details about any previous incidents that the EHS team is aware of. This sparks great conversations and ideas ‚Äî the essence of effective risk assessment.": "R√©unissez l'√©quipe op√©rationnelle. Demandez-leur : Quels sont les dangers ? Qu'est-ce qui pourrait mal tourner ? Quels contr√¥les existants avez-vous ? Partagez les d√©tails des incidents pr√©c√©dents dont l'√©quipe EHS est au courant. Cela suscite d'excellentes conversations et id√©es ‚Äî l'essence d'une √©valuation des risques efficace.",
    "ü§ñ Step 3: Generate AI Baseline": "ü§ñ √âtape 3 : G√©n√©rer la Base IA",
    "Once hazard identification is complete, use the AI to generate a baseline risk assessment. The AI analyzes your inputs and produces a structured table with hazard groups, risk scores, and categories. This saves hours of manual work.": "Une fois l'identification des dangers termin√©e, utilisez l'IA pour g√©n√©rer une √©valuation de base des risques. L'IA analyse vos entr√©es et produit un tableau structur√© avec des groupes de dangers, des scores de risque et des cat√©gories. Cela fait gagner des heures de travail manuel.",
    "üîç Step 4: Review and Re-evaluate": "üîç √âtape 4 : R√©viser et R√©√©valuer",
    "Click on the images or task steps to open the detailed review modal. Take time to re-evaluate the risk ratings with your team. During this collaborative review, Operations and EHS can propose multiple actions ‚Äî record them in the Actions panel.": "Cliquez sur les images ou les √©tapes de t√¢ches pour ouvrir le modal de r√©vision d√©taill√©e. Prenez le temps de r√©√©valuer les √©valuations de risque avec votre √©quipe. Lors de cette r√©vision collaborative, les op√©rations et l'EHS peuvent proposer plusieurs actions ‚Äî enregistrez-les dans le panneau Actions.",
    "üìä Step 5: See Risk Evolution": "üìä √âtape 5 : Voir l'√âvolution du Risque",
    "Using safety science and math, each action is beautifully standardized to give you a predictive/projected risk rating. The Risk Evolution visualization shows the live impact your proposed actions could have ‚Äî transforming discussions into data-driven decisions.": "Gr√¢ce √† la science de la s√©curit√© et aux math√©matiques, chaque action est magnifiquement standardis√©e pour vous donner une √©valuation de risque pr√©dictive/projet√©e. La visualisation de l'√âvolution du Risque montre l'impact en direct que vos actions propos√©es pourraient avoir ‚Äî transformant les discussions en d√©cisions bas√©es sur les donn√©es.",
    "üì• Step 6: Export and Track": "üì• √âtape 6 : Exporter et Suivre",
    "When you download the project file, you get the proposed actions as a CSV file which you can import into your existing tracking system. The collaboration extends from hazard identification to risk evaluation and action tracking.": "Lorsque vous t√©l√©chargez le fichier de projet, vous obtenez les actions propos√©es sous forme de fichier CSV que vous pouvez importer dans votre syst√®me de suivi existant. La collaboration s'√©tend de l'identification des dangers √† l'√©valuation des risques et au suivi des actions.",
    "‚úÖ The Key Benefit": "‚úÖ L'Avantage Cl√©",
    "Because actions are proposed by the operational team themselves, you get genuine buy-in and agreement. This tool extends traditional risk assessment into a powerful brainstorming and collaboration platform ‚Äî keeping the core tenets of Risk Assessment Methodology while leveraging AI's intelligence to offload administrative burden.": "Parce que les actions sont propos√©es par l'√©quipe op√©rationnelle elle-m√™me, vous obtenez une adh√©sion et un accord authentiques. Cet outil √©tend l'√©valuation traditionnelle des risques en une puissante plateforme de brainstorming et de collaboration ‚Äî conservant les principes fondamentaux de la m√©thodologie d'√©valuation des risques tout en tirant parti de l'intelligence de l'IA pour d√©charger la charge administrative.",
    "üí° Remember: You are the driver. AI is your co-pilot, not the captain.": "üí° N'oubliez pas : Vous √™tes le conducteur. L'IA est votre copilote, pas le capitaine.",
    "Got it!": "Compris !"
  },
  de: {
    // Hazard Groups (German)
    "Mechanical / Machinery hazards": "Mechanische / Maschinenrisiken",
    "Workplace / Infrastructure Design": "Arbeitsplatz / Infrastrukturdesign",
    "Physical health hazards": "Physische Gesundheitsrisiken",
    "Chemical hazards": "Chemische Risiken",
    "Hazardous Energy": "Gef√§hrliche Energie",
    "Transportation": "Transport",
    "Ergonomic hazards": "Ergonomische Risiken",
    "Organizational and Psychosocial": "Organisatorisch und psychosozial",
    "Biological hazard": "Biologische Risiken",
    "Fire and explosion": "Feuer und Explosion",
    // Frequency Scale (German)
    "RARELY (<30 min/day)": "SELTEN (<30 min/Tag)",
    "OCCASIONAL (<2 hrs/wk)": "GELEGENTLICH (<2 Stunden/Wo)",
    "INTERMEDIATE (2-8 hrs/wk)": "ZWISCHENDURCH (2-8 Stunden/Wo)",
    "FREQUENTLY (1-3 days/wk)": "H√ÑUFIG (1-3 Tage/Wo)",
    "PERMANENT (>3 days/wk)": "DAUERHAFT (>3 Tage/Wo)",
    // Severity Scale (German)
    "No potential of injury": "Keine Verletzungsgefahr",
    "Potential of FIRST AID": "Potenzial der Ersten Hilfe",
    "Potential of MEDICAL TREATMENT": "Potenzial der √§rztlichen Behandlung",
    "Potential of DART": "Potenzial von DART",
    "Potential of SIA": "Potenzial von SIA",
    "Potential of Fatality": "Potenzial f√ºr Todesfall",
    // Likelihood Scale (German)
    "Almost impossible": "Fast unm√∂glich",
    "Very unlikely": "Sehr unwahrscheinlich",
    "Possible to happen": "M√∂glich",
    "Likely to happen": "Wahrscheinlich",
    "Very likely to happen": "Sehr wahrscheinlich",
    // Hazard List Items (German)
    "Hand tools (cut, impact, puncture, etc.)": "Handwerkzeuge (Schnitt, Sto√ü, Stich usw.)",
    "Powered tools": "Elektrische Werkzeuge",
    "Pinch / nip points": "Quetsch- / Einklemmstellen",
    "Rotating parts (entanglement)": "Rotierende Teile (Verfangen)",
    "Moving parts (cutting)": "Bewegliche Teile (Schneiden)",
    "Moving parts (crushing)": "Bewegliche Teile (Quetschen)",
    "Ejection (parts, materials)": "Auswurf (Teile, Materialien)",
    "Angular, sharp and cutting elements": "Winklige, scharfe und schneidende Elemente",
    "Degraded or malfunctioning equipment": "Verschlei√ütes oder defektes Ger√§t",
    "Equipment failure": "Ger√§teausfall",
    "Improper use of tools/machines": "Falsche Verwendung von Werkzeugen/Maschinen",
    "Inadequate guarding": "Unzureichender Schutz",
    "Use of lifting equipment and accessories": "Verwendung von Hebezeugen und Zubeh√∂r",
    "Use of suspension equipment (jacks, etc.)": "Verwendung von Aufh√§ngeger√§ten (Heber usw.)",
    "Acceleration / deceleration": "Beschleunigung / Verz√∂gerung",
    "Slips, trips, and falls (same level or height)": "Ausrutschen, Stolpern und St√ºrze (gleiche Ebene oder H√∂he)",
    "Slippery, uneven, unstable or damaged floor": "Rutschiger, unebener, instabiler oder besch√§digter Boden",
    "Congested or obstructed workplace": "√úberf√ºllter oder behinderter Arbeitsplatz",
    "Clutter / Mess": "Unordnung / Chaos",
    "Protrusion (bump, puncture, cut, etc.)": "Vorsprung (Sto√ü, Stich, Schnitt usw.)",
    "Hot surface": "Hei√üe Oberfl√§che",
    "Cold surface": "Kalte Oberfl√§che",
    "Rough surface": "Raue Oberfl√§che",
    "Unsecured items at height": "Ungesicherte Gegenst√§nde in der H√∂he",
    "Work at height (<1.2m - <4 feet)": "Arbeit in H√∂he (<1,2 m - <4 Fu√ü)",
    "Work at height (‚â•1.2m - ‚â•4 feet)": "Arbeit in H√∂he (‚â•1,2 m - ‚â•4 Fu√ü)",
    "Poor ventilation": "Schlechte Bel√ºftung",
    "Extreme heat": "Extreme Hitze",
    "Extreme cold": "Extreme K√§lte",
    "Snow or ice": "Schnee oder Eis",
    "Extreme wind": "Extremer Wind",
    "Other adverse weather conditions": "Andere widrige Witterungsbedingungen",
    "Confined spaces": "Enge R√§ume",
    "Lone work": "Alleinige Arbeit",
    "Temporary works or unstable structures": "Vorl√§ufige Arbeiten oder instabile Strukturen",
    "Engulfment": "Verschluckung",
    "Inclined surface": "Geneigte Oberfl√§che",
    "Poor visibility": "Schlechte Sicht",
    "Coactivity area": "Koaktivit√§t Bereich",
    "Noise exposure": "L√§rmbelastung",
    "Vibration / Impact (hand-arm, whole-body)": "Vibration / Sto√ü (Hand-Arm, Ganzk√∂rper)",
    "Heat stress": "Hitzestress",
    "Cold stress": "K√§ltestress",
    "Poor lighting (intensity, glare, reflection)": "Schlechte Beleuchtung (Intensit√§t, Blendung, Reflexion)",
    "Electro-magnetic fields": "Elektromagnetische Felder",
    "Ionizing radiation (X-rays, radioactive elements)": "Ionisierende Strahlung (R√∂ntgenstrahlen, radioaktive Elemente)",
    "Non-ionizing radiation (UV, microwave, laser, welding radiations)": "Nicht-ionisierende Strahlung (UV, Mikrowelle, Laser, Schwei√üstrahlung)",
    "Severe draft (e.g. cold air current)": "Starker Zug (z.B. kalter Luftstrom)",
    "Smoke and fumes": "Rauch und D√§mpfe",
    "Physical health [Generic]": "Physische Gesundheit [Generisch]",
    "Explosive materials": "Explosive Materialien",
    "Flammable materials": "Entz√ºndliche Materialien",
    "Oxidising materials": "Oxidierende Materialien",
    "Corrosive materials": "Korrosive Materialien",
    "Acute toxicity materials": "Akut toxische Materialien",
    "Health hazard, sensitizers, allergens materials": "Gesundheitsgefahr, Sensibilisatoren, Allergene Materialien",
    "Carcinogens, mutagens, reprotoxic (CMRs) materials": "Karzinogene, mutagene, reprotoxische (CMR) Materialien",
    "Gas under pressure": "Gas unter Druck",
    "Asbestos": "Asbest",
    "Fibers other than asbestos": "Fasern au√üer Asbest",
    "Oil": "√ñl",
    "Crystalline silica": "Kristallines Siliziumdioxid",
    "Organic peroxides": "Organische Peroxide",
    "Nanomaterials": "Nanomaterialien",
    "Endocrine disrupters": "Endokrine Disruptoren",
    "Lead-containing material": "Blei-haltiges Material",
    "Particulate material (dust, smoke, fog, aerosol)": "Partikelmaterial (Staub, Rauch, Nebel, Aerosol)",
    "Improper labeling or storage": "Falsche Kennzeichnung oder Lagerung",
    "Incompatible chemical reactions": "Inkompatible chemische Reaktionen",
    "Chemical spills or leaks": "Chemische Versch√ºttungen oder Lecks",
    "Water reactive substances": "Wasserreaktive Substanzen",
    "Shock / vibration sensitive substances": "Sto√ü / vibrationsempfindliche Substanzen",
    "Chemicals [Generic]": "Chemikalien [Generisch]",
    "Electricity": "Elektrizit√§t",
    "Electrostatic": "Elektrostatisch",
    "Electromagnetic fields": "Elektromagnetische Felder",
    "Arc flash": "Lichtbogenblitz",
    "Magnetic": "Magnetisch",
    "Equipment under pressure": "Ger√§t unter Druck",
    "Compressed air": "Druckluft",
    "Vacuum": "Vakuum",
    "Hydraulic": "Hydraulik",
    "Pneumatic": "Pneumatik",
    "Thermal energy (steam, heated surfaces)": "Thermische Energie (Dampf, erhitzte Oberfl√§chen)",
    "Kinetic energy": "Kinetische Energie",
    "Gravity": "Schwerkraft",
    "Stored energy (pneumatic, hydraulic, mechanical, electrical)": "Gespeicherte Energie (pneumatisch, hydraulisch, mechanisch, elektrisch)",
    "Exothermic chemical reaction": "Exotherme chemische Reaktion",
    "Hazardous Energy [Generic]": "Gef√§hrliche Energie [Generisch]",
    "Interaction pedestrian/pedestrian": "Interaktion Fu√üg√§nger/Fu√üg√§nger",
    "Interaction pedestrian/bicycle": "Interaktion Fu√üg√§nger/Fahrrad",
    "Interaction pedestrian/Vehicle": "Interaktion Fu√üg√§nger/Fahrzeug",
    "Interaction bicycle/bicycle": "Interaktion Fahrrad/Fahrrad",
    "Interaction bicycle/Vehicle": "Interaktion Fahrrad/Fahrzeug",
    "Interaction Vehicle/Vehicle": "Interaktion Fahrzeug/Fahrzeug",
    "Interaction Vehicle/Stationary items": "Interaktion Fahrzeug/Station√§re Gegenst√§nde",
    "Poor road or yard conditions": "Schlechte Stra√üen- oder Hofbedingungen",
    "Unintentional vehicle movement": "Unbeabsichtigte Fahrzeugbewegung",
    "High speed vehicle, tire grip loss": "Hochgeschwindigkeitsfahrzeug, Verlust der Reifenhaftung",
    "Inadequate load securing": "Unzureichende Ladungssicherung",
    "Traffic [Generic]": "Verkehr [Generisch]",
    "Postures (Hit list)": "Haltungen (Hit-Liste)",
    "Force": "Kraft",
    "Lifting/Lowering": "Heben/Senken",
    "Pushing": "Schieben",
    "Pulling": "Ziehen",
    "Carrying": "Tragen",
    "Soft tissue compression": "Weichgewebekompression",
    "Ill-fitting gloves": "Schlecht passende Handschuhe",
    "Standing or Sitting for long periods": "Langes Stehen oder Sitzen",
    "Computer workstation / Screen": "Computerarbeitsplatz / Bildschirm",
    "Inadequate tool or workstation design": "Unzureichende Werkzeug- oder Arbeitsplatzgestaltung",
    "Poor ergonomics [Generic]": "Schlechte Ergonomie [Generisch]",
    "Ambiguity of the roles and responsibilities": "Unklarheit der Rollen und Verantwortlichkeiten",
    "Inadequate staffing": "Unzureichendes Personal",
    "High job demands (physical or mental workload)": "Hohe Arbeitsanforderungen (physisch oder mental)",
    "Low job control or autonomy": "Wenig Kontrolle oder Autonomie am Arbeitsplatz",
    "Monotonous or repetitive tasks": "Monotone oder repetitive Aufgaben",
    "Unclear job roles or expectations": "Unklare Arbeitsrollen oder Erwartungen",
    "Job insecurity or precarious employment": "Arbeitsplatzunsicherheit oder prek√§re Besch√§ftigung",
    "Long working hours or shift work": "Lange Arbeitszeiten oder Schichtarbeit",
    "Unrealistic deadlines": "Unrealistische Fristen",
    "Coactivity": "Koaktivit√§t",
    "Unfamiliar work": "Unbekannte Arbeit",
    "New hire / temporary worker": "Neueingestellter / Tempor√§rer Arbeiter",
    "Insufficient / inadequate training": "Unzureichende / unangemessene Schulung",
    "Violations of rules": "Verst√∂√üe gegen Regeln",
    "Misuse of computer systems / equipment": "Missbrauch von Computersystemen / -ger√§ten",
    "Lack of adherence to standard": "Mangelnde Einhaltung des Standards",
    "Lack of standard": "Fehlender Standard",
    "Disrupted sleep pattern (shift work)": "Gest√∂rtes Schlafmuster (Schichtarbeit)",
    "Incompatible simultaneous activities": "Inkompatible gleichzeitige Aktivit√§ten",
    "Distraction": "Ablenkung",
    "Isolation (especially in remote work or lone working roles)": "Isolation (besonders bei Fernarbeit oder Alleinarbeit)",
    "Workplace bullying or harassment": "Mobbing oder Bel√§stigung am Arbeitsplatz",
    "Discrimination (e.g. gender, race, age)": "Diskriminierung (z.B. Geschlecht, Rasse, Alter)",
    "Poor supervisor or managerial support": "Schlechte Unterst√ºtzung durch Vorgesetzte oder Management",
    "Inconsistent communication during organizational change": "Inkonsistente Kommunikation w√§hrend organisatorischer Ver√§nderungen",
    "Lack of transparency or trust in leadership": "Mangel an Transparenz oder Vertrauen in die F√ºhrung",
    "Poor organizational justice (unfair treatment)": "Schlechte organisatorische Gerechtigkeit (unfaire Behandlung)",
    "Lack of recognition or reward": "Mangel an Anerkennung oder Belohnung",
    "Lack of communication or feedback": "Mangel an Kommunikation oder Feedback",
    "Lack of employee involvement in decision-making": "Mangel an Beteiligung der Mitarbeiter an Entscheidungsfindung",
    "Dealing with aggressive or violent people": "Umgang mit aggressiven oder gewaltt√§tigen Personen",
    "Exposure to distressing situations (e.g. emergency services, healthcare, customer complaints)": "Belastende Situationen (z.B. Notdienste, Gesundheitswesen, Kundenbeschwerden)",
    "Lack of privacy or personal space": "Mangel an Privatsph√§re oder pers√∂nlichem Raum",
    "Inadequate rest areas": "Unzureichende Ruhebereiche",
    "Overcrowded or chaotic workspaces": "√úberf√ºllte oder chaotische Arbeitspl√§tze",
    "Remote Work Specific Hazards": "Spezifische Risiken f√ºr Fernarbeit",
    "Work-Life Balance": "Work-Life-Balance",
    "Employment restriction (e.g. Pregnant/breastfeeding, handicap)": "Besch√§ftigungsbeschr√§nkung (z.B. Schwangere/Stillende, Behinderung)",
    "Viruses, bacteria, fungi": "Viren, Bakterien, Pilze",
    "Legionella (specific bacteria)": "Legionella (spezifisches Bakterium)",
    "Molds or allergens": "Schimmel oder Allergene",
    "Handling human or animal bodily fluids": "Umgang mit menschlichen oder tierischen K√∂rperfl√ºssigkeiten",
    "Bloodborne pathogens": "Blut√ºbertragbare Erreger",
    "Contaminated waste or biological material": "Kontaminierter Abfall oder biologisches Material",
    "Potability of water": "Trinkbarkeit von Wasser",
    "Food hygiene": "Lebensmittelhygiene",
    "Animal or insect bites/stings": "Tier- oder Insektenbisse/Stiche",
    "Animal waste": "Tierabfall",
    "Hazardous vegetation": "Gef√§hrliche Vegetation",
    "Flammable and combustible materials": "Entz√ºndliche und brennbare Materialien",
    "Ignition sources": "Z√ºndquellen",
    "Ignition sources (open flames, sparks, static)": "Z√ºndquellen (offene Flammen, Funken, statisch)",
    "Dust explosions (e.g., coal, wood, metal dust)": "Staubexplosionen (z.B. Kohle, Holz, Metalstaub)",
    "Oxygen-enriched environments": "Sauerstoffangereicherte Umgebungen",
    // Risk/Consequences (German)
    "Abrasion, Scratches": "Abrasionen, Kratzer",
    "Allergic Reaction": "Allergische Reaktion",
    "Amputation": "Amputation",
    "Asphyxiation": "Erstickung",
    "Burn - Chemical": "Verbrennung - Chemisch",
    "Burn - Electrical/Electrocution": "Verbrennung - Elektrisch/Stromschlag",
    "Burn or Scald (thermal)": "Verbrennung oder Verbr√ºhung (thermisch)",
    "Chemical exposure": "Chemische Exposition",
    "Concussion": "Gehirnersch√ºtterung",
    "Contusion, Bruise": "Prellung, Bluterguss",
    "Crushing injury": "Quetschverletzung",
    "Laceration, Cut, Open wound": "Schnittverletzung, Schnitt, Offene Wunde",
    "Fracture": "Fraktur",
    "Frostbite / Hypothermia": "Erfrierung / Hypothermie",
    "Hearing loss, or impairment": "H√∂rverlust oder Beeintr√§chtigung",
    "Heat Stress / Exhaustion / Stroke": "Hitzestress / Ersch√∂pfung / Schlaganfall",
    "Hernia": "Hernie",
    "Mental Stress / Work-related Mental Health Condition": "Mentale Belastung / Arbeitsbedingte psychische Erkrankung",
    "Musculoskeletal Disorder (MSD)": "Muskel-Skelett-Erkrankung (MSE)",
    "Poisoning": "Vergiftung",
    "Puncture": "Stichverletzung",
    "Repetitive motion injury": "Verletzung durch repetitive Bewegungen",
    "Respiratory irritation (e.g. Asthma)": "Atemwegsreizung (z.B. Asthma)",
    "Sprain": "Verstauchung",
    "Strain": "Zerrung",
    // Instruction and Helper Text (German)
    "Upload media files. Faces will be automatically blurred. Click thumbnails to add risk descriptions, hazards, and controls.": "Laden Sie Mediendateien hoch. Gesichter werden automatisch unkenntlich gemacht. Klicken Sie auf Miniaturansichten, um Risikobeschreibungen, Gefahren und Kontrollen hinzuzuf√ºgen.",
    "Write a detailed description of the work process. Mention any previous incidents for better risk scoring.": "Schreiben Sie eine detaillierte Beschreibung des Arbeitsprozesses. Erw√§hnen Sie fr√ºhere Vorf√§lle f√ºr eine bessere Risikobewertung.",
    "Upload an Excel file containing risk data. The system will parse and convert it to risk assessment format.": "Laden Sie eine Excel-Datei mit Risikodaten hoch. Das System analysiert und konvertiert sie in das Risikobewertungsformat.",
    "Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.": "Klicken Sie unten auf eine Miniaturansicht, um die gro√üe Vorschau zum manuellen Unkenntlichmachen zu √∂ffnen und Risikonotizen hinzuzuf√ºgen. Sie k√∂nnen auch Bilder per Drag-and-Drop neu anordnen.",
    "Uploaded videos will appear here...": "Hochgeladene Videos werden hier angezeigt...",
    "Processed images/frames will appear here...": "Verarbeitete Bilder/Frames werden hier angezeigt...",
    "Click to select Excel file": "Klicken Sie, um die Excel-Datei auszuw√§hlen",
    "Supported: .xlsx, .xls, .csv": "Unterst√ºtzte Formate: .xlsx, .xls, .csv",
    "Finish uploading and describing your task/images": "Beenden Sie das Hochladen und Beschreiben Ihrer Aufgabe/Bilder",
    "Review the risk assessment table": "√úberpr√ºfen Sie die Risikobewertungstabelle",
    "Generate AI recommendations": "KI-Empfehlungen generieren",
    "Download your complete report": "Laden Sie Ihren vollst√§ndigen Bericht herunter",
    "Mention past incidents for more accurate scoring": "Erw√§hnen Sie fr√ºhere Vorf√§lle f√ºr genauere Bewertungen",
    "Add detailed hazard descriptions in notes": "F√ºgen Sie detaillierte Gefahrenbeschreibungen in Notizen hinzu",
    "Review AI suggestions before finalizing": "√úberpr√ºfen Sie KI-Vorschl√§ge vor der Finalisierung",
    "Export to PDF for stakeholder review": "Als PDF exportieren zur √úberpr√ºfung durch Interessentr√§ger",
    "Loading AI models... üß†": "KI-Modelle werden geladen... üß†",
    // UI Buttons and Labels (German)
    "Process Files": "Dateien verarbeiten",
    "Download All Images and Reports as ZIP": "Alle Bilder und Berichte als ZIP herunterladen",
    "Generate AI Risk Assessment from Image Notes": "KI-Risikobewertung aus Bildnotizen generieren",
    "Save Project": "Projekt speichern",
    "Load Project": "Projekt laden",
    "Generate Task Breakdown": "Aufgabenaufschl√ºsselung generieren",
    "Translate Table": "Tabelle √ºbersetzen",
    "Download Project ZIP": "Projekt-ZIP herunterladen",
    "Print": "Drucken",
    "Privacy Policy": "Datenschutzrichtlinie",
    "Generate AI Recommendations & Visuals": "KI-Empfehlungen und Grafiken generieren",
    "Advanced Import / Convert": "Erweiterter Import / Konvertierung",
    "Click to upload or drag and drop": "Klicken zum Hochladen oder Ziehen und Ablegen",
    "Images or Videos": "Bilder oder Videos",
    "Overall Progress": "Gesamtfortschritt",
    "Uploaded Videos (Capture frames below)": "Hochgeladene Videos (Bilder unten erfassen)",
    "Upload Images & Videos": "Bilder und Videos hochladen",
    "Describe Your Task": "Beschreiben Sie Ihre Aufgabe",
    "Import Excel File": "Excel-Datei importieren",
    "Description of step": "Beschreibung des Schritts",
    "What can go wrong / spot hazards": "Was kann schiefgehen / Gefahren erkennen",
    "Any existing controls": "Alle vorhandenen Steuerungen",
    "Language": "Sprache",
    "Frequency": "H√§ufigkeit",
    "Severity": "Schweregrad",
    "Likelihood": "Wahrscheinlichkeit",
    "Not set": "Nicht gesetzt",
    // Speech Recognition (German)
    "Listening in": "H√∂rt zu auf",
    "Click mic again to stop.": "Klicken Sie erneut auf das Mikrofon zum Stoppen.",
    "No speech detected. Please speak into your microphone.": "Keine Sprache erkannt. Bitte sprechen Sie in Ihr Mikrofon.",
    "No microphone found. Please ensure a microphone is connected.": "Kein Mikrofon gefunden. Bitte stellen Sie sicher, dass ein Mikrofon angeschlossen ist.",
    "Microphone access denied. Please allow microphone access in your browser.": "Mikrofonzugriff verweigert. Bitte erlauben Sie den Mikrofonzugriff in Ihrem Browser.",
    "Network error. Please check your internet connection.": "Netzwerkfehler. Bitte √ºberpr√ºfen Sie Ihre Internetverbindung.",
    "Speech recognition error: ": "Spracherkennungsfehler: ",
    // Edit Task Modal (German)
    "Edit Task Details": "Aufgabendetails bearbeiten",
    "üõ°Ô∏è Risk Reduction Strategy": "üõ°Ô∏è Risikominderungsstrategie",
    "Select Control Type": "Steuerungstyp ausw√§hlen",
    "Click a level to select": "Klicken Sie auf eine Ebene, um auszuw√§hlen",
    "Description": "Beschreibung",
    "Describe how this control will be implemented...": "Beschreiben Sie, wie diese Steuerung implementiert wird...",
    "+ Add Control": "+ Steuerung hinzuf√ºgen",
    "Selected Controls": "Ausgew√§hlte Steuerungen",
    "No controls added yet": "Noch keine Steuerungen hinzugef√ºgt",
    "How is this calculated?": "Wie wird das berechnet?",
    "üéØ The Hierarchy of Controls (NIOSH/OSHA)": "üéØ Die Hierarchie der Steuerungen (NIOSH/OSHA)",
    "This tool uses the internationally recognized Hierarchy of Controls developed by NIOSH (National Institute for Occupational Safety and Health) and endorsed by OSHA. Controls at the top are most effective because they eliminate or reduce the hazard itself, while lower controls rely on human behavior.": "Dieses Tool verwendet die international anerkannte Hierarchie der Steuerungen, die vom NIOSH (National Institute for Occupational Safety and Health) entwickelt und von der OSHA unterst√ºtzt wird. Steuerungen an der Spitze sind am effektivsten, da sie die Gefahr selbst eliminieren oder reduzieren, w√§hrend untere Steuerungen vom menschlichen Verhalten abh√§ngen.",
    "üìä Control Effectiveness (Based on Safety Science)": "üìä Steuerungseffektivit√§t (basierend auf Sicherheitswissenschaft)",
    "Eliminate: Physically removes the hazard ‚Üí Risk becomes 0": "Eliminieren: Entfernt die Gefahr physisch ‚Üí Risiko wird 0",
    "Substitute/Engineer: High-reliability controls ‚Üí Up to 80% reduction": "Substituieren/Ingenieur: Hochzuverl√§ssige Steuerungen ‚Üí Bis zu 80% Reduktion",
    "Admin/Visual/PPE: Behavior-dependent controls ‚Üí Up to 55% reduction": "Admin/Visuell/PPE: Verhaltensabh√§ngige Steuerungen ‚Üí Bis zu 55% Reduktion",
    "Note: Exact percentages are estimates based on the principle that engineering controls are significantly more reliable than administrative controls, as they don't depend on consistent human action.": "Hinweis: Die genauen Prozents√§tze sind Sch√§tzungen basierend auf dem Prinzip, dass Ingenieursteuerungen deutlich zuverl√§ssiger sind als administrative Steuerungen, da sie nicht von konsistentem menschlichem Handeln abh√§ngen.",
    "‚öñÔ∏è Diminishing Returns Principle": "‚öñÔ∏è Prinzip der abnehmenden Ertr√§ge",
    "Safety science recognizes that controls ranked higher in the hierarchy (Eliminate, Substitute, Engineer) provide greater protection. When implementing multiple controls of the same type, each additional control yields diminishing marginal benefit, with each layer adding progressively less protection. This is modeled using geometric decay factors.": "Die Sicherheitswissenschaft erkennt, dass Steuerungen, die h√∂her in der Hierarchie (Eliminieren, Ersetzen, Technik) eingestuft sind, einen besseren Schutz bieten. Bei der Implementierung mehrerer Steuerungen desselben Typs bringt jede zus√§tzliche Steuerung einen abnehmenden marginalen Nutzen mit sich, wobei jede Schicht progressiv weniger Schutz bietet. Dies wird mit geometrischen Zerfallsfaktoren modelliert.",
    "üõ°Ô∏è Defense in Depth": "üõ°Ô∏è Tiefenverteidigung",
    "Best practice is to combine high-level controls (Substitute/Engineer) with administrative controls and PPE. This 'layered defense' approach ensures protection even if one control fails.": "Bew√§hrte Praxis ist es, Steuerungen auf hohem Niveau (Substituieren/Ingenieur) mit administrativen Steuerungen und PSA zu kombinieren. Dieser 'mehrschichtige Verteidigungsansatz' gew√§hrleistet Schutz, auch wenn eine Steuerung ausf√§llt.",
    "üìö References": "üìö Referenzen",
    "‚Ä¢ NIOSH - Hierarchy of Controls (CDC/NIOSH)": "‚Ä¢ NIOSH - Hierarchie der Steuerungen (CDC/NIOSH)",
    "‚Ä¢ OSHA - Recommended Practices for Safety and Health Programs": "‚Ä¢ OSHA - Empfohlene Praktiken f√ºr Sicherheits- und Gesundheitsprogramme",
    "‚Ä¢ Canadian Centre for Occupational Health & Safety (CCOHS)": "‚Ä¢ Kanadisches Zentrum f√ºr Arbeitsgesundheit und Sicherheit (CCOHS)",
    "‚Ä¢ UK Health and Safety Executive (HSE)": "‚Ä¢ Health and Safety Executive Gro√übritannien (HSE)",
    "‚Ä¢ Prevention through Design (PtD) Initiative": "‚Ä¢ Prevention through Design (PtD) Initiative",
    "Use ‚Üê ‚Üí arrow keys to navigate. Changes are auto saved!": "Verwenden Sie die ‚Üê ‚Üí Pfeiltasten zur Navigation. √Ñnderungen werden automatisch gespeichert!",
    "üóëÔ∏è Delete": "üóëÔ∏è L√∂schen",
    "Close": "Schlie√üen",
    "‚Üê Previous": "‚Üê Vorherige",
    "Next ‚Üí": "N√§chste ‚Üí",
    "‚Ü©Ô∏è Restore": "‚Ü©Ô∏è Wiederherstellen",
    "This task has been deleted": "Diese Aufgabe wurde gel√∂scht",
    "‚Ü©Ô∏è Restore Task": "‚Ü©Ô∏è Aufgabe wiederherstellen",
    "Risk Rating:": "Risikobewertung:",
    "Risk Score": "Risikowert",
    "Risk Category": "Risikokategorie",
    "üìã EHS Standards - Frequency, Severity & Likelihood Definitions": "üìã EHS-Standards - Definitionen von H√§ufigkeit, Schweregrad und Wahrscheinlichkeit",

    // Risk Rating Table translations
    "Risk Rating & Response": "Risikobewertung und Reaktion",
    "Risk Score (F √ó S √ó L)": "Risikowert (F √ó S √ó L)",
    "Interpretation": "Interpretation",
    "Response Required": "Erforderliche Reaktion",
    "LOW": "NIEDRIG",
    "MEDIUM": "MITTEL",
    "HIGH": "HOCH",
    "CRITICAL": "KRITISCH",
    "Low priority - Further reduce risk if feasible.": "Niedrige Priorit√§t - Risiko weiter reduzieren, falls m√∂glich.",
    "Further reduce risk over time. Prioritize higher risks first.": "Risiko im Laufe der Zeit weiter reduzieren. H√∂here Risiken zuerst priorisieren.",
    "Action plan to reduce this risk level as a lower priority.": "Aktionsplan zur Reduzierung dieses Risikoniveaus mit niedrigerer Priorit√§t.",
    "Deploy interim protective measures and prioritize implementation of more secured permanent controls. Highlight to exposed associates the risk they are exposed to.": "Zwischenma√ünahmen zum Schutz einsetzen und die Implementierung sichererer dauerhafter Kontrollen priorisieren. Den exponierten Mitarbeitern das Risiko, dem sie ausgesetzt sind, hervorheben.",

    // Predicted Risk Card translations
    "Predicted Risk": "Vorhergesagtes Risiko",
    "control": "Steuerung",
    "controls": "Steuerungen",
    "üéØ ELIMINATED:": "üéØ ELIMINIERT:",
    "Hazard completely removed - no risk remains.": "Gefahr vollst√§ndig beseitigt - kein Risiko verbleibt.",
    "‚ö° STRONG CONTROLS:": "‚ö° STARKE STEUERUNGEN:",
    "high-level controls (Substitute/Engineer) applied with": "Steuerungen auf hohem Niveau (Substituieren/Ingenieur) angewendet mit",
    "max reduction.": "maximale Reduktion.",
    "‚ö° LAYERED DEFENSE:": "‚ö° MEHRSCHICHTIGE VERTEIDIGUNG:",
    "High-level control +": "Steuerung auf hohem Niveau +",
    "administrative/PPE control": "administrative/PSA-Steuerung",
    "combined reduction).": "kombinierte Reduktion).",
    "‚ö° HIGH-LEVEL CONTROL:": "‚ö° STEUERUNG AUF HOHEM NIVEAU:",
    "Substitution or Engineering control applied": "Substitutions- oder Ingenieursteuerung angewendet",
    "reduction).": "Reduktion).",
    "‚ö†Ô∏è LIMITED PROTECTION:": "‚ö†Ô∏è BEGRENZTER SCHUTZ:",
    "lower-level controls only. Consider Substitution or Engineering controls.": "nur Steuerungen auf niedrigerem Niveau. Erw√§gen Sie Substitutions- oder Ingenieursteuerungen.",
    "üìã LOWER-LEVEL CONTROLS:": "üìã STEUERUNGEN AUF NIEDRIGEREM NIVEAU:",
    "(Admin/Visual/PPE) -": "(Admin/Visuell/PSA) -",
    "Select controls from the hierarchy above to see risk projections...": "W√§hlen Sie Steuerungen aus der obigen Hierarchie, um Risikoprognosen zu sehen...",

    // Workflow and Tables (German)
    "Choose your workflow to get started": "W√§hlen Sie Ihren Arbeitsablauf aus, um zu beginnen",
    "Rich Media": "Rich Media",
    "Free Text": "Freitext",
    "Excel Sheet": "Excel-Arbeitsblatt",
    "Click to upload or drag and drop": "Klicken Sie zum Hochladen oder ziehen Sie per Drag-and-Drop",
    "Images or Videos": "Bilder oder Videos",
    "Models loaded. Please select your images or videos.": "Modelle geladen. Bitte w√§hlen Sie Ihre Bilder oder Videos.",
    "Click a thumbnail below to open the large preview for manual blurring and to add risk notes. You can also drag-and-drop to reorder images.": "Klicken Sie auf eine Miniaturansicht unten, um die gro√üe Vorschau zum manuellen Unsch√§rfen zu √∂ffnen und Risikohinweise hinzuzuf√ºgen. Sie k√∂nnen auch Drag-and-Drop verwenden, um Bilder neu anzuordnen.",
    "üí° Pro Tips": "üí° Profi-Tipps",
    "‚Ä¢ Mention past incidents for more accurate scoring": "‚Ä¢ Erw√§hnen Sie vergangene Vorf√§lle f√ºr genauere Bewertungen",
    "‚Ä¢ Add detailed hazard descriptions in notes": "‚Ä¢ F√ºgen Sie in Notizen detaillierte Gefahrenbeschreibungen hinzu",
    "‚Ä¢ Review AI suggestions before finalizing": "‚Ä¢ √úberpr√ºfen Sie KI-Vorschl√§ge vor der Fertigstellung",
    "‚Ä¢ Save your Project and resume your work": "‚Ä¢ Speichern Sie Ihr Projekt und setzen Sie Ihre Arbeit fort",
    "F Value": "F-Wert",
    "Category": "Kategorie",
    "Day": "Tag",
    "Week": "Woche",
    "Month": "Monat",
    "Year": "Jahr",
    "RARELY": "SELTEN",
    "<0.5 day": "<0,5 Tag",
    "1 day": "1 Tag",
    "OCCASIONAL": "GELEGENTLICH",
    "<30 min": "<30 min",
    "<2 hours": "<2 Stunden",
    "<1 days": "<1 Tage",
    "<5 days": "<5 Tage",
    "INTERMEDIATE": "ZWISCHENDURCH",
    "30-120 min": "30-120 min",
    "2-8 hours": "2-8 Stunden",
    "1-4 days": "1-4 Tage",
    "5 days -2 months": "5 Tage -2 Monate",
    "FREQUENTLY": "H√ÑUFIG",
    "2-5 hours": "2-5 Stunden",
    "1-3 days": "1-3 Tage",
    "4-15 days": "4-15 Tage",
    "2-5 months": "2-5 Monate",
    "PERMANENT": "DAUERHAFT",
    ">5 hours": ">5 Stunden",
    ">3 days": ">3 Tage",
    "> 15 days": "> 15 Tage",
    "> 5 months": "> 5 Monate",
    "S Value": "S-Wert",
    "Classification": "Klassifizierung",
    "Most Probable Injury": "Wahrscheinlichste Verletzung",
    "No potential of injury": "Kein Verletzungspotenzial",
    "‚Ä¢ No treatment needed": "‚Ä¢ Keine Behandlung erforderlich",
    "Potential of FIRST AID": "Potenzial f√ºr Erste Hilfe",
    "‚Ä¢ Non-prescription medication": "‚Ä¢ Freiverk√§ufliche Medikamente",
    "Potential of MEDICAL TREATMENT": "Potenzial f√ºr √§rztliche Behandlung",
    "‚Ä¢ Prescription medications": "‚Ä¢ Verschreibungspflichtige Medikamente",
    "Potential of DART": "Potenzial f√ºr DART",
    "‚Ä¢ Temporary disability": "‚Ä¢ Vor√ºbergehende Behinderung",
    "Potential of SIA": "Potenzial f√ºr SIA",
    "‚Ä¢ Amputation": "‚Ä¢ Amputation",
    "Potential of Fatality": "Todesfallpotenzial",
    "‚Ä¢ Death": "‚Ä¢ Tod",
    "L Value": "L-Wert",
    "Machinery Related Risks": "Maschinenbezogene Risiken",
    "Industrial Hygiene Risks": "Risiken der Arbeitshygiene",
    "Other H&S Risks": "Sonstige Arbeitsschutzrisiken",
    "-": "-",
    "Loading AI models...": "KI-Modelle werden geladen...",
    "Loading AI models from CDN... Please wait.": "KI-Modelle werden vom CDN geladen... Bitte warten.",
    "file(s) selected. Click 'Process Files' to continue.": "Datei(en) ausgewaehlt. Klicken Sie auf Dateien verarbeiten um fortzufahren.",
    "Models loading...": "Modelle werden geladen...",
    "file(s) selected. Please wait.": "Datei(en) ausgewaehlt. Bitte warten.",
    "Error loading AI models from CDN. Check your internet connection and the browser console for details.": "Fehler beim Laden der KI-Modelle vom CDN. Ueberpruefen Sie Ihre Internetverbindung und die Browser-Konsole fuer Details.",
    // Best Practices Modal (German)
    "Best Practices: AI-Powered Collaborative Risk Assessment": "Best Practices: KI-gest√ºtzte Kollaborative Risikobewertung",
    "Keeping the human element at the heart of safety": "Den menschlichen Faktor im Mittelpunkt der Sicherheit bewahren",
    "üéØ Core Principle": "üéØ Grundprinzip",
    "This tool, while powered by AI, stays true to one of the fundamental tenets of safety risk assessment: collaboration and engagement with the operational team. AI helps reduce administrative burden, but YOU and your team are the drivers of meaningful change. Blind automation will never bring actionable results.": "Dieses Tool bleibt, obwohl es von KI angetrieben wird, einem der grundlegenden Prinzipien der Sicherheitsrisikobewertung treu: Zusammenarbeit und Einbindung des operativen Teams. KI hilft, den administrativen Aufwand zu reduzieren, aber SIE und Ihr Team sind die Treiber f√ºr bedeutsame Ver√§nderungen. Blinde Automatisierung wird niemals umsetzbare Ergebnisse bringen.",
    "üìπ Step 1: Capture Your Process": "üìπ Schritt 1: Erfassen Sie Ihren Prozess",
    "Start by collecting rich media (video or photos) of your process from start to end. Split each process into respective task steps and document what can go wrong. This is your first collaborative touchpoint.": "Beginnen Sie damit, reichhaltige Medien (Video oder Fotos) Ihres Prozesses von Anfang bis Ende zu sammeln. Teilen Sie jeden Prozess in die jeweiligen Arbeitsschritte auf und dokumentieren Sie, was schiefgehen kann. Dies ist Ihr erster kollaborativer Ber√ºhrungspunkt.",
    "üë• Step 2: Engage Your Team": "üë• Schritt 2: Binden Sie Ihr Team ein",
    "Bring the operational team together. Ask them: What are the hazards? What could go wrong? What existing controls do you have? Share details about any previous incidents that the EHS team is aware of. This sparks great conversations and ideas ‚Äî the essence of effective risk assessment.": "Bringen Sie das operative Team zusammen. Fragen Sie sie: Was sind die Gefahren? Was k√∂nnte schiefgehen? Welche bestehenden Kontrollen haben Sie? Teilen Sie Details √ºber fr√ºhere Vorf√§lle, die dem EHS-Team bekannt sind. Das entfacht gro√üartige Gespr√§che und Ideen ‚Äî das Wesen einer effektiven Risikobewertung.",
    "ü§ñ Step 3: Generate AI Baseline": "ü§ñ Schritt 3: KI-Baseline generieren",
    "Once hazard identification is complete, use the AI to generate a baseline risk assessment. The AI analyzes your inputs and produces a structured table with hazard groups, risk scores, and categories. This saves hours of manual work.": "Sobald die Gefahrenidentifikation abgeschlossen ist, verwenden Sie die KI, um eine Basis-Risikobewertung zu generieren. Die KI analysiert Ihre Eingaben und erstellt eine strukturierte Tabelle mit Gefahrengruppen, Risikobewertungen und Kategorien. Das spart Stunden manueller Arbeit.",
    "üîç Step 4: Review and Re-evaluate": "üîç Schritt 4: √úberpr√ºfen und Neu bewerten",
    "Click on the images or task steps to open the detailed review modal. Take time to re-evaluate the risk ratings with your team. During this collaborative review, Operations and EHS can propose multiple actions ‚Äî record them in the Actions panel.": "Klicken Sie auf die Bilder oder Arbeitsschritte, um das detaillierte √úberpr√ºfungsmodal zu √∂ffnen. Nehmen Sie sich Zeit, die Risikobewertungen mit Ihrem Team neu zu bewerten. W√§hrend dieser kollaborativen √úberpr√ºfung k√∂nnen Betrieb und EHS mehrere Ma√ünahmen vorschlagen ‚Äî erfassen Sie diese im Ma√ünahmen-Panel.",
    "üìä Step 5: See Risk Evolution": "üìä Schritt 5: Risikoentwicklung sehen",
    "Using safety science and math, each action is beautifully standardized to give you a predictive/projected risk rating. The Risk Evolution visualization shows the live impact your proposed actions could have ‚Äî transforming discussions into data-driven decisions.": "Mit Sicherheitswissenschaft und Mathematik wird jede Ma√ünahme sch√∂n standardisiert, um Ihnen eine pr√§diktive/prognostizierte Risikobewertung zu geben. Die Risikoentwicklungs-Visualisierung zeigt die Live-Auswirkungen, die Ihre vorgeschlagenen Ma√ünahmen haben k√∂nnten ‚Äî und verwandelt Diskussionen in datengest√ºtzte Entscheidungen.",
    "üì• Step 6: Export and Track": "üì• Schritt 6: Exportieren und Verfolgen",
    "When you download the project file, you get the proposed actions as a CSV file which you can import into your existing tracking system. The collaboration extends from hazard identification to risk evaluation and action tracking.": "Wenn Sie die Projektdatei herunterladen, erhalten Sie die vorgeschlagenen Ma√ünahmen als CSV-Datei, die Sie in Ihr bestehendes Tracking-System importieren k√∂nnen. Die Zusammenarbeit erstreckt sich von der Gefahrenidentifikation √ºber die Risikobewertung bis zur Ma√ünahmenverfolgung.",
    "‚úÖ The Key Benefit": "‚úÖ Der Hauptvorteil",
    "Because actions are proposed by the operational team themselves, you get genuine buy-in and agreement. This tool extends traditional risk assessment into a powerful brainstorming and collaboration platform ‚Äî keeping the core tenets of Risk Assessment Methodology while leveraging AI's intelligence to offload administrative burden.": "Da Ma√ünahmen vom operativen Team selbst vorgeschlagen werden, erhalten Sie echte Zustimmung und √úbereinstimmung. Dieses Tool erweitert die traditionelle Risikobewertung zu einer leistungsstarken Brainstorming- und Kollaborationsplattform ‚Äî und bewahrt die Kernprinzipien der Risikobewertungsmethodik, w√§hrend die Intelligenz der KI genutzt wird, um den administrativen Aufwand zu entlasten.",
    "üí° Remember: You are the driver. AI is your co-pilot, not the captain.": "üí° Denken Sie daran: Sie sind der Fahrer. KI ist Ihr Kopilot, nicht der Kapit√§n.",
    "Got it!": "Verstanden!"
  }
};

        // --- GLOBAL LANGUAGE STATE ---
        // Load language from localStorage or default to 'en'
        let currentLang = localStorage.getItem('appLanguage') || 'en';

        // --- TRANSLATION FUNCTION ---
        const t = (englishText) => {
            if (!TRANSLATIONS[currentLang] || !TRANSLATIONS[currentLang][englishText]) {
                return englishText; // Fallback to English if translation not found
            }
            return TRANSLATIONS[currentLang][englishText];
        };

        // --- UPDATE MODAL TRANSLATIONS ---
        const updateModalTranslations = () => {
            // Update modal header
            const modalHeader = document.querySelector('#tableImageModal h3');
            if (modalHeader && modalHeader.getAttribute('data-en-text')) {
                modalHeader.innerHTML = t(modalHeader.getAttribute('data-en-text'));
            }

            // Update Risk Reduction Strategy header
            const riskStrategyHeader = document.querySelector('#riskReductionPanel summary h3');
            if (riskStrategyHeader && riskStrategyHeader.getAttribute('data-en-text')) {
                riskStrategyHeader.innerHTML = t(riskStrategyHeader.getAttribute('data-en-text'));
            }

            // Update summary text spans - both outer and nested details
            const allSummarySpans = document.querySelectorAll('details summary span[data-en-text]');
            allSummarySpans.forEach(span => {
                const englishText = span.getAttribute('data-en-text');
                span.innerText = t(englishText);
            })

            // Update all translatable elements in the modal
            const allModalElements = document.querySelectorAll('#tableImageModal [data-en-text], #riskReductionPanel [data-en-text]:not(summary span[data-en-text])');
            allModalElements.forEach(el => {
                const englishText = el.getAttribute('data-en-text');
                if (englishText) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        if (el.hasAttribute('placeholder')) {
                            el.placeholder = t(englishText);
                        }
                    } else {
                        el.innerText = t(englishText);
                    }
                }
            });
        };

        // --- UPDATE UI TEXT WHEN LANGUAGE CHANGES ---
        const updateUIText = () => {
            // Update button text by their IDs
            const buttonIds = [
                'processBtn', 'downloadBtn', 'generateAiReportBtn', 'saveProjectBtn', 'saveProjectBtn2',
                'loadProjectBtn', 'generateTasksBtn', 'translateTableBtn', 'downloadProjectZipBtn',
                'privacyBtn'
            ];
            
            buttonIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    const englishText = btn.getAttribute('data-en-text') || btn.innerText;
                    btn.innerText = t(englishText);
                    btn.setAttribute('data-en-text', englishText);
                }
            });

            // Update label text
            const labels = document.querySelectorAll('label[for="stepDescription"], label[for="spotHazards"], label[for="existingControls"], label[for="langSelect"]');
            labels.forEach(label => {
                const englishText = label.getAttribute('data-en-text') || label.innerText;
                label.innerText = t(englishText);
                label.setAttribute('data-en-text', englishText);
            });

            // Update placeholder text
            const placeholders = document.querySelectorAll('[placeholder]');
            placeholders.forEach(el => {
                const englishText = el.getAttribute('data-en-placeholder') || el.placeholder;
                el.placeholder = t(englishText);
                el.setAttribute('data-en-placeholder', englishText);
            });

            // Update h2 and h3 headers
            const headers = document.querySelectorAll('h2, h3');
            headers.forEach(header => {
                const englishText = header.getAttribute('data-en-text') || header.innerText;
                const translated = t(englishText);
                if (translated !== englishText) {
                    header.innerText = translated;
                    header.setAttribute('data-en-text', englishText);
                }
            });

            // Update paragraph instruction text (tab introductions and helper text)
            const paragraphs = document.querySelectorAll('p.text-slate-600');
            paragraphs.forEach(p => {
                const englishText = p.getAttribute('data-en-text') || p.innerText;
                const translated = t(englishText);
                if (translated !== englishText) {
                    p.innerText = translated;
                    p.setAttribute('data-en-text', englishText);
                }
            });

            // Update span text in info boxes (like manual blur info)
            const infoBoxes = document.querySelectorAll('[id*="info"]');
            infoBoxes.forEach(box => {
                const englishText = box.getAttribute('data-en-text') || box.innerText;
                const translated = t(englishText);
                if (translated !== englishText) {
                    box.innerText = translated;
                    box.setAttribute('data-en-text', englishText);
                }
            });

            // Update placeholder-like text in empty states
            const emptyStates = document.querySelectorAll('p.text-slate-500');
            emptyStates.forEach(p => {
                const englishText = p.getAttribute('data-en-text') || p.innerText;
                const translated = t(englishText);
                if (translated !== englishText) {
                    p.innerText = translated;
                    p.setAttribute('data-en-text', englishText);
                }
            });

            // Update modal content if it's currently open
            updateModalTranslations();

            // Update risk rating table
            const tableCells = document.querySelectorAll('td[data-en-text], th[data-en-text]');
            tableCells.forEach(cell => {
                const englishText = cell.getAttribute('data-en-text');
                if (englishText) {
                    cell.innerText = t(englishText);
                }
            });

            // Update risk rating table header
            const tableHeaders = document.querySelectorAll('h4[data-en-text]');
            tableHeaders.forEach(header => {
                const englishText = header.getAttribute('data-en-text');
                if (englishText) {
                    header.innerText = t(englishText);
                }
            });

            // Update ALL elements with data-en-text attribute (comprehensive update)
            const allTranslatableElements = document.querySelectorAll('[data-en-text]');
            allTranslatableElements.forEach(el => {
                const englishText = el.getAttribute('data-en-text');
                if (englishText) {
                    // Handle buttons that contain SVGs - only update text nodes
                    if (el.tagName === 'BUTTON' && el.querySelector('svg')) {
                        // Find and update only the text node (not the SVG)
                        const childNodes = el.childNodes;
                        for (let i = 0; i < childNodes.length; i++) {
                            if (childNodes[i].nodeType === Node.TEXT_NODE && childNodes[i].textContent.trim()) {
                                childNodes[i].textContent = ' ' + t(englishText) + ' ';
                                break; // Only update the first non-empty text node
                            }
                        }
                    } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        if (el.hasAttribute('placeholder')) {
                            el.placeholder = t(englishText);
                        }
                    } else if (el.tagName === 'TD' || el.tagName === 'TH' || el.tagName === 'H4') {
                        // Skip - already handled above
                    } else {
                        el.innerText = t(englishText);
                    }
                }
            });
        };

        // --- MASTER HAZARD & CONSEQUENCE REGISTRIES ---
        //const HAZARD_REGISTRY = { "Hand tools (cut, impact, puncture, etc.)": { group: "Mechanical / Machinery hazards", severity: 5, likelihood: 5 }, "Powered tools": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 4 }, "Pinch / nip points": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 5 }, "Rotating parts (entanglement)": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 3 }, "Moving parts (cutting)": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 4 }, "Moving parts (crushing)": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 4 }, "Ejection (parts, materials)": { group: "Mechanical / Machinery hazards", severity: 5, likelihood: 5 }, "Angular, sharp and cutting elements": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 5 }, "Slips, trips, and falls (same level or height)": { group: "Workplace / Infrastructure Design", severity: 3, likelihood: 8 }, "Slippery, eneven, unstable or damaged floor": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 7 }, "Congested or obstructed workplace": { group: "Workplace / Infrastructure Design", severity: 3, likelihood: 8 }, "Noise exposure": { group: "Physical health hazards", severity: 3, likelihood: 9 }, "Vibration / Impact (hand-arm, whole-body)": { group: "Physical health hazards", severity: 5, likelihood: 8 }, "Heat stress": { group: "Physical health hazards", severity: 5, likelihood: 5 }, "Cold stress": { group: "Physical health hazards", severity: 5, likelihood: 5 }, "Flammable materials": { group: "Chemical hazards", severity: 10, likelihood: 1 }, "Corrosive materials": { group: "Chemical hazards", severity: 7, likelihood: 3 }, "Electricity": { group: "Hazardous Energy", severity: 10, likelihood: 2 }, "Gravity": { group: "Hazardous Energy", severity: 7, likelihood: 5 }, "Hydraulic": { group: "Hazardous Energy", severity: 7, likelihood: 3 }, "Pneumatic": { group: "Hazardous Energy", severity: 5, likelihood: 3 }, "Interraction pedestrian/Vehicle": { group: "Transportation", severity: 7, likelihood: 3 }, "Postures (Hit list)": { group: "Ergonomic hazards", severity: 3, likelihood: 9 }, "Force": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, "Lifting/Lowering": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, "Pushing": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, "Pulling": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, "Carrying": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, "High job demands": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, "Low job control or autonomy": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, "Monotonous or repetitive tasks": { group: "Organizational and Psychosocial", severity: 3, likelihood: 9 }, "Viruses, bacteria, fungi": { group: "Biological hazard", severity: 7, likelihood: 3 }, "Flammable and combustible materials": { group: "Fire and explosion", severity: 10, likelihood: 2 }, "Ignition sources": { group: "Fire and explosion", severity: 10, likelihood: 2 } };
        const HAZARD_REGISTRY = { 
    "Hand tools (cut, impact, puncture, etc.)": { group: "Mechanical / Machinery hazards", severity: 5, likelihood: 5 }, 
    "Powered tools": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 4 }, 
    "Pinch / nip points": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 5 }, 
    "Rotating parts (entanglement)": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 3 }, 
    "Moving parts (cutting)": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 4 }, 
    "Moving parts (crushing)": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 4 }, 
    "Ejection (parts, materials)": { group: "Mechanical / Machinery hazards", severity: 5, likelihood: 5 }, 
    "Angular, sharp and cutting elements": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 5 }, 
    "Degraded or malfunctioning equipment": { group: "Mechanical / Machinery hazards", severity: 8, likelihood: 4 }, 
    "Equipment failure": { group: "Mechanical / Machinery hazards", severity: 9, likelihood: 3 }, 
    "Improper use of tools/machines": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 6 }, 
    "Inadequate guarding": { group: "Mechanical / Machinery hazards", severity: 8, likelihood: 4 }, 
    "Use of lifting equipment and accessories": { group: "Mechanical / Machinery hazards", severity: 7, likelihood: 5 }, 
    "Use of suspension equipment (jacks, etc.)": { group: "Mechanical / Machinery hazards", severity: 8, likelihood: 4 }, 
    "Acceleration / deceleration": { group: "Mechanical / Machinery hazards", severity: 6, likelihood: 5 }, 
    "Slips, trips, and falls (same level or height)": { group: "Workplace / Infrastructure Design", severity: 3, likelihood: 8 }, 
    "Slippery, uneven, unstable or damaged floor": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 7 }, 
    "Congested or obstructed workplace": { group: "Workplace / Infrastructure Design", severity: 3, likelihood: 8 }, 
    "Clutter / Mess": { group: "Workplace / Infrastructure Design", severity: 4, likelihood: 7 }, 
    "Protrusion (bump, puncture, cut, etc.)": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 6 }, 
    "Hot surface": { group: "Workplace / Infrastructure Design", severity: 6, likelihood: 5 }, 
    "Cold surface": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 5 }, 
    "Rough surface": { group: "Workplace / Infrastructure Design", severity: 4, likelihood: 6 }, 
    "Unsecured items at height": { group: "Workplace / Infrastructure Design", severity: 7, likelihood: 4 }, 
    "Work at height (<1.2m - <4 feet)": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 6 }, 
    "Work at height (‚â•1.2m - ‚â•4 feet)": { group: "Workplace / Infrastructure Design", severity: 8, likelihood: 5 }, 
    "Poor ventilation": { group: "Workplace / Infrastructure Design", severity: 4, likelihood: 7 }, 
    "Extreme heat": { group: "Workplace / Infrastructure Design", severity: 6, likelihood: 4 }, 
    "Extreme cold": { group: "Workplace / Infrastructure Design", severity: 6, likelihood: 4 }, 
    "Snow or ice": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 5 }, 
    "Extreme wind": { group: "Workplace / Infrastructure Design", severity: 6, likelihood: 3 }, 
    "Other adverse weather conditions": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 4 }, 
    "Confined spaces": { group: "Workplace / Infrastructure Design", severity: 8, likelihood: 3 }, 
    "Lone work": { group: "Workplace / Infrastructure Design", severity: 6, likelihood: 5 }, 
    "Temporary works or unstable structures": { group: "Workplace / Infrastructure Design", severity: 7, likelihood: 4 }, 
    "Engulfment": { group: "Workplace / Infrastructure Design", severity: 9, likelihood: 3 }, 
    "Inclined surface": { group: "Workplace / Infrastructure Design", severity: 5, likelihood: 6 }, 
    "Poor visibility": { group: "Workplace / Infrastructure Design", severity: 4, likelihood: 7 }, 
    "Coactivity area": { group: "Workplace / Infrastructure Design", severity: 6, likelihood: 6 }, 
    "Noise exposure": { group: "Physical health hazards", severity: 3, likelihood: 9 }, 
    "Vibration / Impact (hand-arm, whole-body)": { group: "Physical health hazards", severity: 5, likelihood: 8 }, 
    "Heat stress": { group: "Physical health hazards", severity: 5, likelihood: 5 }, 
    "Cold stress": { group: "Physical health hazards", severity: 5, likelihood: 5 }, 
    "Poor lighting (intensity, glare, reflection)": { group: "Physical health hazards", severity: 4, likelihood: 7 }, 
    "Electro-magnetic fields": { group: "Physical health hazards", severity: 6, likelihood: 3 }, 
    "Ionizing radiation (X-rays, radioactive elements)": { group: "Physical health hazards", severity: 9, likelihood: 2 }, 
    "Non-ionizing radiation (UV, microwave, laser, welding radiations)": { group: "Physical health hazards", severity: 7, likelihood: 4 }, 
    "Severe draft (e.g. cold air current)": { group: "Physical health hazards", severity: 5, likelihood: 5 }, 
    "Smoke and fumes": { group: "Physical health hazards", severity: 6, likelihood: 6 }, 
    "Physical health [Generic]": { group: "Physical health hazards", severity: 5, likelihood: 5 }, 
    "Explosive materials": { group: "Chemical hazards", severity: 10, likelihood: 1 }, 
    "Flammable materials": { group: "Chemical hazards", severity: 10, likelihood: 1 }, 
    "Oxidising materials": { group: "Chemical hazards", severity: 9, likelihood: 2 }, 
    "Corrosive materials": { group: "Chemical hazards", severity: 7, likelihood: 3 }, 
    "Acute toxicity materials": { group: "Chemical hazards", severity: 8, likelihood: 3 }, 
    "Health hazard, sensitizers, allergens materials": { group: "Chemical hazards", severity: 6, likelihood: 5 }, 
    "Carcinogens, mutagens, reprotoxic (CMRs) materials": { group: "Chemical hazards", severity: 9, likelihood: 2 }, 
    "Gas under pressure": { group: "Chemical hazards", severity: 7, likelihood: 3 }, 
    "Asbestos": { group: "Chemical hazards", severity: 9, likelihood: 2 }, 
    "Fibers other than asbestos": { group: "Chemical hazards", severity: 7, likelihood: 3 }, 
    "Oil": { group: "Chemical hazards", severity: 5, likelihood: 4 }, 
    "Crystalline silica": { group: "Chemical hazards", severity: 8, likelihood: 3 }, 
    "Organic peroxides": { group: "Chemical hazards", severity: 9, likelihood: 2 }, 
    "Nanomaterials": { group: "Chemical hazards", severity: 6, likelihood: 3 }, 
    "Endocrine disrupters": { group: "Chemical hazards", severity: 7, likelihood: 4 }, 
    "Lead-containing material": { group: "Chemical hazards", severity: 8, likelihood: 3 }, 
    "Particulate material (dust, smoke, fog, aerosol)": { group: "Chemical hazards", severity: 6, likelihood: 6 }, 
    "Improper labeling or storage": { group: "Chemical hazards", severity: 7, likelihood: 5 }, 
    "Incompatible chemical reactions": { group: "Chemical hazards", severity: 8, likelihood: 4 }, 
    "Chemical spills or leaks": { group: "Chemical hazards", severity: 7, likelihood: 5 }, 
    "Water reactive substances": { group: "Chemical hazards", severity: 8, likelihood: 3 }, 
    "Shock / vibration sensitive substances": { group: "Chemical hazards", severity: 9, likelihood: 2 }, 
    "Chemicals [Generic]": { group: "Chemical hazards", severity: 5, likelihood: 5 }, 
    "Electricity": { group: "Hazardous Energy", severity: 10, likelihood: 2 }, 
    "Electrostatic": { group: "Hazardous Energy", severity: 7, likelihood: 3 }, 
    "Electromagnetic fields": { group: "Hazardous Energy", severity: 6, likelihood: 3 }, 
    "Arc flash": { group: "Hazardous Energy", severity: 10, likelihood: 2 }, 
    "Magnetic": { group: "Hazardous Energy", severity: 6, likelihood: 3 }, 
    "Equipment under pressure": { group: "Hazardous Energy", severity: 8, likelihood: 3 }, 
    "Compressed air": { group: "Hazardous Energy", severity: 7, likelihood: 4 }, 
    "Vacuum": { group: "Hazardous Energy", severity: 6, likelihood: 3 }, 
    "Hydraulic": { group: "Hazardous Energy", severity: 7, likelihood: 3 }, 
    "Pneumatic": { group: "Hazardous Energy", severity: 5, likelihood: 3 }, 
    "Thermal energy (steam, heated surfaces)": { group: "Hazardous Energy", severity: 7, likelihood: 4 }, 
    "Kinetic energy": { group: "Hazardous Energy", severity: 7, likelihood: 5 }, 
    "Gravity": { group: "Hazardous Energy", severity: 7, likelihood: 5 }, 
    "Stored energy (pneumatic, hydraulic, mechanical, electrical)": { group: "Hazardous Energy", severity: 8, likelihood: 4 }, 
    "Exothermic chemical reaction": { group: "Hazardous Energy", severity: 9, likelihood: 3 }, 
    "Hazardous Energy [Generic]": { group: "Hazardous Energy", severity: 7, likelihood: 4 }, 
    "Interaction pedestrian/pedestrian": { group: "Transportation", severity: 4, likelihood: 6 }, 
    "Interaction pedestrian/bicycle": { group: "Transportation", severity: 5, likelihood: 5 }, 
    "Interaction pedestrian/Vehicle": { group: "Transportation", severity: 7, likelihood: 3 }, 
    "Interaction bicycle/bicycle": { group: "Transportation", severity: 5, likelihood: 4 }, 
    "Interaction bicycle/Vehicle": { group: "Transportation", severity: 8, likelihood: 4 }, 
    "Interaction Vehicle/Vehicle": { group: "Transportation", severity: 9, likelihood: 3 }, 
    "Interaction Vehicle/Stationary items": { group: "Transportation", severity: 7, likelihood: 4 }, 
    "Poor road or yard conditions": { group: "Transportation", severity: 6, likelihood: 5 }, 
    "Unintentional vehicle movement": { group: "Transportation", severity: 8, likelihood: 3 }, 
    "High speed vehicle, tire grip loss": { group: "Transportation", severity: 9, likelihood: 3 }, 
    "Inadequate load securing": { group: "Transportation", severity: 7, likelihood: 4 }, 
    "Traffic [Generic]": { group: "Transportation", severity: 6, likelihood: 5 }, 
    "Postures (Hit list)": { group: "Ergonomic hazards", severity: 3, likelihood: 9 }, 
    "Force": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, 
    "Lifting/Lowering": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, 
    "Pushing": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, 
    "Pulling": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, 
    "Carrying": { group: "Ergonomic hazards", severity: 5, likelihood: 8 }, 
    "Soft tissue compression": { group: "Ergonomic hazards", severity: 5, likelihood: 7 }, 
    "Ill-fitting gloves": { group: "Ergonomic hazards", severity: 4, likelihood: 6 }, 
    "Standing or Sitting for long periods": { group: "Ergonomic hazards", severity: 4, likelihood: 8 }, 
    "Computer workstation / Screen": { group: "Ergonomic hazards", severity: 4, likelihood: 9 }, 
    "Inadequate tool or workstation design": { group: "Ergonomic hazards", severity: 5, likelihood: 7 }, 
    "Poor ergonomics [Generic]": { group: "Ergonomic hazards", severity: 5, likelihood: 7 }, 
    "Ambiguity of the roles and responsibilities": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, 
    "Inadequate staffing": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "High job demands (physical or mental workload)": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, 
    "Low job control or autonomy": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, 
    "Monotonous or repetitive tasks": { group: "Organizational and Psychosocial", severity: 3, likelihood: 9 }, 
    "Unclear job roles or expectations": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, 
    "Job insecurity or precarious employment": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Long working hours or shift work": { group: "Organizational and Psychosocial", severity: 4, likelihood: 8 }, 
    "Unrealistic deadlines": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, 
    "Coactivity": { group: "Organizational and Psychosocial", severity: 4, likelihood: 6 }, 
    "Unfamiliar work": { group: "Organizational and Psychosocial", severity: 4, likelihood: 5 }, 
    "New hire / temporary worker": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, 
    "Insufficient / inadequate training": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Violations of rules": { group: "Organizational and Psychosocial", severity: 5, likelihood: 6 }, 
    "Misuse of computer systems / equipment": { group: "Organizational and Psychosocial", severity: 4, likelihood: 6 }, 
    "Lack of adherence to standard": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Lack of standard": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Disrupted sleep pattern (shift work)": { group: "Organizational and Psychosocial", severity: 4, likelihood: 8 }, 
    "Incompatible simultaneous activities": { group: "Organizational and Psychosocial", severity: 4, likelihood: 6 }, 
    "Distraction": { group: "Organizational and Psychosocial", severity: 3, likelihood: 9 }, 
    "Isolation (especially in remote work or lone working roles)": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Workplace bullying or harassment": { group: "Organizational and Psychosocial", severity: 5, likelihood: 6 }, 
    "Discrimination (e.g. gender, race, age)": { group: "Organizational and Psychosocial", severity: 5, likelihood: 5 }, 
    "Poor supervisor or managerial support": { group: "Organizational and Psychosocial", severity: 4, likelihood: 8 }, 
    "Inconsistent communication during organizational change": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, 
    "Lack of transparency or trust in leadership": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Poor organizational justice (unfair treatment)": { group: "Organizational and Psychosocial", severity: 4, likelihood: 6 }, 
    "Lack of recognition or reward": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, 
    "Lack of communication or feedback": { group: "Organizational and Psychosocial", severity: 3, likelihood: 8 }, 
    "Lack of employee involvement in decision-making": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, 
    "Dealing with aggressive or violent people": { group: "Organizational and Psychosocial", severity: 5, likelihood: 5 }, 
    "Exposure to distressing situations (e.g. emergency services, healthcare, customer complaints)": { group: "Organizational and Psychosocial", severity: 5, likelihood: 6 }, 
    "Lack of privacy or personal space": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, 
    "Inadequate rest areas": { group: "Organizational and Psychosocial", severity: 3, likelihood: 7 }, 
    "Overcrowded or chaotic workspaces": { group: "Organizational and Psychosocial", severity: 4, likelihood: 7 }, 
    "Remote Work Specific Hazards": { group: "Organizational and Psychosocial", severity: 4, likelihood: 8 }, 
    "Work-Life Balance": { group: "Organizational and Psychosocial", severity: 4, likelihood: 9 }, 
    "Employment restriction (e.g. Pregnant/breastfeeding, handicap)": { group: "Organizational and Psychosocial", severity: 5, likelihood: 5 }, 
    "Viruses, bacteria, fungi": { group: "Biological hazard", severity: 7, likelihood: 3 }, 
    "Legionella (specific bacteria)": { group: "Biological hazard", severity: 8, likelihood: 3 }, 
    "Molds or allergens": { group: "Biological hazard", severity: 5, likelihood: 5 }, 
    "Handling human or animal bodily fluids": { group: "Biological hazard", severity: 7, likelihood: 4 }, 
    "Bloodborne pathogens": { group: "Biological hazard", severity: 8, likelihood: 3 }, 
    "Contaminated waste or biological material": { group: "Biological hazard", severity: 6, likelihood: 4 }, 
    "Potability of water": { group: "Biological hazard", severity: 6, likelihood: 4 }, 
    "Food hygiene": { group: "Biological hazard", severity: 6, likelihood: 5 }, 
    "Animal or insect bites/stings": { group: "Biological hazard", severity: 5, likelihood: 5 }, 
    "Animal waste": { group: "Biological hazard", severity: 6, likelihood: 4 }, 
    "Hazardous vegetation": { group: "Biological hazard", severity: 4, likelihood: 4 }, 
    "Flammable and combustible materials": { group: "Fire and explosion", severity: 10, likelihood: 2 }, 
    "Ignition sources": { group: "Fire and explosion", severity: 10, likelihood: 2 }, 
    "Ignition sources (open flames, sparks, static)": { group: "Fire and explosion", severity: 10, likelihood: 2 },  // NEW
    "Dust explosions (e.g., coal, wood, metal dust)": { group: "Fire and explosion", severity: 10, likelihood: 2 },  // NEW
    "Oxygen-enriched environments": { group: "Fire and explosion", severity: 9, likelihood: 2 }  // NEW
};
        const CONSEQUENCE_REGISTRY = [ "Abrasion, Scratches", "Allergic Reaction", "Amputation", "Asphyxiation", "Burn - Chemical", "Burn - Electrical/Electrocution", "Burn or Scald (thermal)", "Chemical exposure", "Concussion", "Contusion, Bruise", "Crushing injury", "Laceration, Cut, Open wound", "Fracture", "Frostbite / Hypothermia", "Hearing loss, or impairment", "Heat Stress / Exhaustion / Stroke", "Hernia", "Mental Stress / Work-related Mental Health Condition", "Musculoskeletal Disorder (MSD)", "Poisoning", "Puncture", "Repetitive motion injury", "Respiratory irritation (e.g. Asthma)", "Sprain", "Strain" ];
        const FREQUENCY_SCALE = { "1": "RARELY (<30 min/day)", "1.25": "OCCASIONAL (<2 hrs/wk)", "1.5": "INTERMEDIATE (2-8 hrs/wk)", "1.75": "FREQUENTLY (1-3 days/wk)", "2": "PERMANENT (>3 days/wk)" };
        const SEVERITY_SCALE = { "1": "No potential of injury", "3": "Potential of FIRST AID", "5": "Potential of MEDICAL TREATMENT", "7": "Potential of DART", "9": "Potential of SIA", "10": "Potential of Fatality" };
        const LIKELIHOOD_SCALE = { "1": "Almost impossible", "3": "Very unlikely", "5": "Possible to happen", "8": "Likely to happen", "10": "Very likely to happen" };
        const HAZARD_GROUPS = [...new Set(Object.values(HAZARD_REGISTRY).map(item => item.group))].sort();
        // --- NEW: Moved helper functions and classes to IIFE scope ---
        // --- NEW: Helper function to split an array into chunks ---
        const chunkArray = (arr, size) =>
            Array.from({ length: Math.ceil(arr.length / size) }, (v, i) =>
                arr.slice(i * size, i * size + size)
            );

        // (createFinalFileName is defined in the global scope above so other modules can use it)
            
        // --- Moved helper functions and classes to IIFE scope ---
        const selectClasses = "w-full p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 transition";
        const inputClasses = "w-full p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 transition";

        const createDropdown = (options, selectedValue, onChange) => {
            // Define sequential order for frequency scale
            const frequencyOrder = ["1", "1.25", "1.5", "1.75", "2"];
            
            let entries;
            if (options === FREQUENCY_SCALE) {
                // Use explicit order for frequency scale
                entries = frequencyOrder.map(key => [key, options[key]]);
            } else {
                // Use default order for other scales
                entries = Object.entries(options);
            }
            
            let optionsHTML = entries.map(([value, text]) => {
                const translatedText = t(text);
                return `<option value="${value}" ${value == selectedValue ? 'selected' : ''}>${value} - ${translatedText}</option>`;
            }).join('');
            return `<select class="${selectClasses}" onchange="${onChange}">${optionsHTML}</select>`;
        };
        
        const createTextDropdown = (options, selectedValue, onChange) => {
            // Ensure selectedValue exists in options, add if not (AI might hallucinate)
            let currentOptions = [...options]; // Copy
            if (!currentOptions.includes(selectedValue) && selectedValue) {
                currentOptions.unshift(selectedValue); // Add to beginning
            }
            let optionsHTML = currentOptions.map(optionName => {
                const translatedName = t(optionName);
                return `<option value="${optionName}" ${optionName === selectedValue ? 'selected' : ''}>${translatedName}</option>`;
            }).join('');
            return `<select class="${selectClasses}" onchange="${onChange}">${optionsHTML}</select>`;
        };
        
        const createHazardGroupDropdown = (selectedValue) => {
             // Ensure selectedValue exists in options, add if not
             let currentGroups = [...HAZARD_GROUPS]; // Copy
             if (!currentGroups.includes(selectedValue) && selectedValue) {
                   currentGroups.unshift(selectedValue); // Add to beginning
             }
            let optionsHTML = currentGroups.map(groupName => {
                const translatedGroup = t(groupName);
                return `<option value="${groupName}" ${groupName === selectedValue ? 'selected' : ''}>${translatedGroup}</option>`;
            }).join('');
            const isUnknown = selectedValue === 'Unknown' ? 'border-red-500 text-red-600' : '';
            return `<select class="${selectClasses} ${isUnknown}" onchange="this.className = this.value === 'Unknown' ? '${selectClasses} border-red-500 text-red-600' : '${selectClasses}'">${optionsHTML}</select>`;
        };
        // --- END NEW ---

        // --- Make dropdown functions globally accessible for language change listener ---
        window.createDropdown = createDropdown;
        window.createHazardGroupDropdown = createHazardGroupDropdown;
        window.createTextDropdown = createTextDropdown;

        // Make functions global so inline HTML onclicks can find them
        window.processFreeText = async function() {
            const userInput = document.getElementById('freeTextInput').value;
            const generateBtn = document.getElementById('generateTasksBtn');
            if (!userInput.trim()) {
                showCustomAlert("Please describe the task first.", 'info');
                return;
            }
            generateBtn.disabled = true;
           generateBtn.innerHTML = `${spinnerSVG} Analyzing Description...`;
            
            const tableContainer = document.getElementById('table-container');
            tableContainer.innerHTML = "<p class='text-center p-8 text-slate-600 italic'>Generating task breakdown... This may take a moment.</p>";
            document.getElementById('dashboard-container').style.display = 'block';
            
            // Split large input into batches to avoid losing data
            // Batch strategy: split on sentence boundaries (~1200 chars per batch for efficiency)
            const batches = splitTextIntoBatches(userInput, 1200);
            
            if (batches.length > 1) {
                // Use batch processing for better analysis
                console.debug(`Input is large (${userInput.length} chars). Processing in ${batches.length} batches...`);
                await processBatchesAndPopulateTable(batches);
            } else {
                // Small input: process directly
                const breakdownPrompt = `
                You are a world-class safety and risk assessment expert. Your task is to analyze the user's description of a work process and break it down into a structured JSON array for a detailed risk assessment table. You must be thorough.
                **Your Knowledge Base (Use these exact values for matching):**
                - Hazard List Registry: ${JSON.stringify(Object.keys(HAZARD_REGISTRY))}
                - Consequence Registry: ${JSON.stringify(CONSEQUENCE_REGISTRY)}
                - Frequency Scale: ${JSON.stringify(FREQUENCY_SCALE)}
                - Severity Scale: ${JSON.stringify(SEVERITY_SCALE)}
                - Likelihood Scale: ${JSON.stringify(LIKELIHOOD_SCALE)}
                **User's Input:** "${userInput}"
                **Your Instructions (Critical: Follow these for EACH task/step you identify):**
                1. **Identify the Step:** Clearly state the task or sub-task in the "Steps" field.
                2. **Comprehensive Hazard Identification (Most Important Rule):**
                   * For each step, identify ALL plausible direct, indirect, and hidden hazards.
                   * For EACH identified hazard, create a separate JSON object. The same "Steps" value will appear in multiple objects if a step has multiple hazards.
                3. **Match Hazard:** Select the single most appropriate "Hazard List" item from the Registry.
                4. **Match Consequence:** Select the single most appropriate "Risk/Consequences" item from the Registry.
                5. **Infer Details:** Infer "Hazard Source," suggest "Current Control," and classify "Routine/Non-Routine/Emergency Situation".
                6. **Select F, S, L Values:** Select the most appropriate NUMERIC value for "Frequency," "Severity," and "Likelihood" from the scales.
                7. **Consider Past Incidents:** If the user's input mentions previous incidents, near misses, or accidents related to a specific step or hazard, you MUST increase the 'Likelihood' score for that specific hazard object accordingly (e.g., move from 5 'Possible' to 8 'Likely' or from 8 'Likely' to 10 'Very likely') to reflect the known history. Clearly state in the "Hazard Source" if a past incident influenced the score (e.g., "Manual lifting - Past back strain incident reported").
                8. **Link Image ID:** The user's input may contain (ImageID: xxx). If you see this, you MUST add this exact ID to your JSON object for that step using the key "imageId". If no ID is provided for a step, output imageId: null.
                **Final Output:** Your response MUST ONLY be a valid JSON array of objects. Do not include any text outside the JSON. Each object MUST have these keys: "Steps", "Hazard List", "Risk/Consequences", "Hazard Source", "Current Control", "Routine/Non-Routine/Emergency Situation", "Frequency", "Severity", "Likelihood".

                `;
                
                try {
                    console.debug("Attempting task generation with primary (paid) model:", PAID_MODEL);
                    const response = await callAPI(PAID_MODEL, breakdownPrompt);
                    const taskData = parseAndCleanData(response);
                    
                    buildTableFromData(taskData);
                    initializeDashboard();
                } catch (error) {
                    console.error("AI task generation failed.", error);
                    tableContainer.innerHTML = `<p class="text-center p-8 text-red-600 font-medium">Error: ${error.message}. The AI failed to generate a valid task list. Please try rephrasing your description.</p>`;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = "Generate Task Breakdown";
                }
            }
        }

        async function processBatchesAndPopulateTable(batches) {
    const generateBtn = document.getElementById('generateTasksBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = `${spinnerSVG} Analyzing in batches...`;

    const tableContainer = document.getElementById('table-container');
    tableContainer.innerHTML = `<div class='text-center p-8'>
        <div class='inline-flex items-center gap-3'>
            <svg class='animate-spin h-6 w-6 text-indigo-600' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'>
                <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
                <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'></path>
            </svg>
            <p class='text-slate-600 font-medium'>Analyzing in ${batches.length} batches... This may take a moment.</p>
        </div>
    </div>`;

    // Auto-scroll to bottom of page
    setTimeout(() => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }, 100);

    let allTaskData = [];  // Combined results from all batches

    // Process batches in parallel with concurrency limit (3 at a time)
    const concurrencyLimit = 3;
    const batchPromises = batches.map((batchText, index) => 
        processBatchSafely(batchText, index)
    );

    // Execute with concurrency limit
    const results = await executeWithConcurrencyLimit(batchPromises, concurrencyLimit);
    
    // Merge all results
    results.forEach(result => {
        if (result && result.data) {
            allTaskData = allTaskData.concat(result.data);
        }
        if (result && result.error) {
            console.error(result.error);
            showCustomAlert(`${result.error}`, 'error');
        }
    });

    if (allTaskData.length > 0) {
        buildTableFromData(allTaskData);
        initializeDashboard();
        // Auto-scroll to table after generation completes
        setTimeout(() => {
            const table = document.querySelector('#table-container table');
            if (table) table.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 500);
    } else {
        tableContainer.innerHTML = `<p class="text-center p-8 text-red-600 font-medium">Error: All batches failed. Please try again.</p>`;
    }

    generateBtn.disabled = false;
    generateBtn.innerHTML = "Generate Task Breakdown";
}

    // Helper: Process single batch safely
    async function processBatchSafely(batchText, batchIndex) {
        const batchPrompt = `
   Process each --- ENTRY --- block separately and generate JSON objects only for that entry before moving to the next.
    You are a world-class safety and risk assessment expert. Analyze this high-risk batch of image notes and break it down into a structured JSON array for a risk assessment table. You must be thorough.
    **Your Knowledge Base (Use these exact values for matching):**
    - Hazard List Registry: ${JSON.stringify(Object.keys(HAZARD_REGISTRY))}
    - Consequence Registry: ${JSON.stringify(CONSEQUENCE_REGISTRY)}
    - Frequency Scale: ${JSON.stringify(FREQUENCY_SCALE)}
    - Severity Scale: ${JSON.stringify(SEVERITY_SCALE)}
    - Likelihood Scale: ${JSON.stringify(LIKELIHOOD_SCALE)}
    **User's Input:** "${batchText}"
    **Your Instructions (Critical: Follow these for EACH task/step you identify):**
   - For all JSON objects generated from a single --- ENTRY ---, use the exact ImageID from that ENTRY's (ImageID: xxx) in the "imageId" key.
   - Use the exact text after "STEP/DESCRIPTION:" as the "Steps" value, without rephrasing or modification.
    1. **Identify the Step:** Clearly state the task or sub-task in the "Steps" field.
    2. **User Pre-Rated Hazards (HIGHEST PRIORITY):**
       * If the user has provided USER RATINGS (Frequency, Severity, Likelihood) in the ENTRY, you MUST preserve these exact numeric values in the JSON objects for any hazards they have identified.
       * When a user specifies F/S/L ratings, this indicates they have pre-assessed certain hazards. Keep their ratings as the primary values.
       * After preserving user-rated hazards, identify ANY ADDITIONAL hazards they may have missed based on the description, and generate separate JSON objects for those.
    3. **Comprehensive Hazard Identification (Most Important Rule):**
       * For each step, identify ALL plausible direct, indirect, and hidden hazards.
       * For EACH identified hazard, create a separate JSON object. The same "Steps" value will appear in multiple objects if a step has multiple hazards.
    4. **Match Hazard:** Select the single most appropriate "Hazard List" item from the Registry.
    5. **Match Consequence:** Select the single most appropriate "Risk/Consequences" item from the Registry.
    6. **Infer Details:** Infer "Hazard Source," suggest "Current Control," and classify "Routine/Non-Routine/Emergency Situation".
    7. **Select F, S, L Values:** For user pre-rated hazards, use their provided values. For newly identified hazards, select the most appropriate NUMERIC value from the scales.
    8. **Consider Past Incidents:** If the user's input mentions previous incidents, near misses, or accidents related to a specific step or hazard, you MUST increase the 'Likelihood' score for that specific hazard object accordingly (e.g., move from 5 'Possible' to 8 'Likely' or from 8 'Likely' to 10 'Very likely') to reflect the known history. Clearly state in the "Hazard Source" if a past incident influenced the score (e.g., "Manual lifting - Past back strain incident reported").
    9. **Link Image ID:** The user's input contains (ImageID: xxx) for each ENTRY. You MUST add this exact ID to EVERY JSON object generated from that ENTRY using the key "imageId". If no ID, use null.
    Process ONLY this batch. Output a JSON array that can be merged with others.
    **Final Output:** Your response MUST ONLY be a valid JSON array of objects. Do not include any text outside the JSON. Each object MUST have these keys: "Steps", "Hazard List", "Risk/Consequences", "Hazard Source", "Current Control", "Routine/Non-Routine/Emergency Situation", "Frequency", "Severity", "Likelihood".
`;

        try {
            const response = await callAPI(PAID_MODEL, batchPrompt);
            const batchData = parseAndCleanData(response);
            return { data: batchData, error: null };
        } catch (error) {
            return { data: [], error: `Batch ${batchIndex + 1} failed: ${error.message}` };
        }
    }

    // Helper: Execute promises with concurrency limit
    async function executeWithConcurrencyLimit(promises, limit) {
        const results = [];
        const executing = [];
        
        for (const promise of promises) {
            const p = promise.then(result => {
                executing.splice(executing.indexOf(p), 1);
                return result;
            });
            results.push(p);
            executing.push(p);
            
            if (executing.length >= limit) {
                await Promise.race(executing);
            }
        }
        
        return Promise.all(results);
    }

window.processBatchesAndPopulateTable = processBatchesAndPopulateTable;

        // Helper function: Split text into logical batches to avoid data loss
        function splitTextIntoBatches(text, maxBatchSize = 500) {
            const batches = [];
            let currentBatch = '';
            
            // Split by sentence boundaries (period, question mark, exclamation mark)
            const sentences = text.split(/(?<=[.!?])\s+/);
            
            for (let sentence of sentences) {
                // If adding this sentence would exceed limit, start a new batch
                if ((currentBatch + ' ' + sentence).length > maxBatchSize && currentBatch.length > 0) {
                    batches.push(currentBatch.trim());
                    currentBatch = sentence;
                } else {
                    currentBatch += (currentBatch ? ' ' : '') + sentence;
                }
            }
            
            // Add any remaining text
            if (currentBatch.trim()) {
                batches.push(currentBatch.trim());
            }
            
            return batches.length > 0 ? batches : [text]; // Return at least the original text
        }

        function buildTableFromData(data) {
            const tableContainer = document.getElementById('table-container');
            if (!data || data.length === 0) {
                tableContainer.innerHTML = "<p class='text-center p-8 text-slate-600 italic'>The AI could not identify any tasks. Please try a different description.</p>";
                return;
            }
            
            // --- MODIFICATION: Added "Picture", "AI", "Actions" and "Delete" headers ---
            const headers = ["Picture", "AI", "Steps", "Hazard Group", "Hazard List", "Risk/Consequences", "Frequency", "Severity", "Likelihood", "Risk Score", "Risk Category", "Hazard Source", "Current Control", "Routine/Non-Routine/Emergency Situation", "Actions", "Delete"];
            // --- END MODIFICATION ---
            
            // Tailwind classes for table
            const tableClasses = "w-full text-sm";
            const thClasses = "p-3 text-left font-semibold text-slate-700 uppercase tracking-wider";
            const tdClasses = "p-3 border-b border-slate-200 text-slate-700 align-top";
            
            let tableHTML = `<div class="p-6 sm:p-8"><table class="${tableClasses}">
                                <thead><tr>`;
            headers.forEach(header => { tableHTML += `<th class="${thClasses}">${header}</th>`; });
            tableHTML += "</tr></thead><tbody>";
           
data.forEach((row, index) => {
                // Ensure defaults for potentially missing AI output
                const hazardListValue = row['Hazard List'] || Object.keys(HAZARD_REGISTRY)[0];
                const consequenceValue = row['Risk/Consequences'] || CONSEQUENCE_REGISTRY[0];
                const frequencyValue = parseFloat(row.Frequency) || 1;
                const severityValue = parseFloat(row.Severity);
                const likelihoodValue = parseFloat(row.Likelihood);
                
                // VALIDATION: Ensure frequency is within the valid range (1 to 2)
                const validFrequencies = Object.keys(FREQUENCY_SCALE).map(parseFloat);
                const validSeverities = Object.keys(SEVERITY_SCALE).map(parseFloat);
                const validLikelihoods = Object.keys(LIKELIHOOD_SCALE).map(parseFloat);
                
                // Check if values exceed max and log a warning
                if (frequencyValue > 2) {
                    console.warn(`‚ö†Ô∏è Row ${index}: Frequency value ${frequencyValue} exceeds max (2). This may be from AI doubling. Using max value of 2.`);
                }
                if (severityValue > 10) {
                    console.warn(`‚ö†Ô∏è Row ${index}: Severity value ${severityValue} exceeds max (10). This may be from AI doubling. Using max value of 10.`);
                }
                if (likelihoodValue > 10) {
                    console.warn(`‚ö†Ô∏è Row ${index}: Likelihood value ${likelihoodValue} exceeds max (10). This may be from AI doubling. Using max value of 10.`);
                }
                
                // Clamp values to valid ranges
                const clampedFrequency = Math.min(frequencyValue, 2);
                const clampedSeverity = Math.min(severityValue || 1, 10);
                const clampedLikelihood = Math.min(likelihoodValue || 1, 10);
               
    const hazardDetails = HAZARD_REGISTRY[hazardListValue] || { group: 'Unknown', severity: clampedSeverity, likelihood: clampedLikelihood };
    const frequency = clampedFrequency;
    const severity = clampedSeverity || hazardDetails.severity;
    const likelihood = clampedLikelihood || hazardDetails.likelihood;
    
    // Use saved Risk Score if available, otherwise calculate
    const savedRiskScore = row['Risk Score'] ? parseFloat(row['Risk Score']) : null;
    const riskScore = savedRiskScore !== null && !isNaN(savedRiskScore) ? savedRiskScore : (frequency * severity * likelihood);
    
    // Use saved Hazard Group if available, otherwise use registry lookup
    const hazardGroup = row['Hazard Group'] || hazardDetails.group;
   
    // --- MODIFICATION: Added empty picture cell with class ---
    // --- NEW, ROBUST CODE ---
    // Extract imageId from AI data or try to match by step text
    const imageId = row.imageId || findImageByStepText(row.Steps) || '';
    console.debug(`Row ${index}: Step="${row.Steps}", imageId from AI="${row.imageId}", final imageId="${imageId}" (match method: ${row.imageId ? 'AI direct' : (imageId ? 'text match' : 'none')})`);
    const matchedImage = document.getElementById(imageId);
    const originalFileName = matchedImage ? (window.originalFileNames && window.originalFileNames.get(imageId)) : '';
    
    // --- NEW: Detect if this is an AI-added row (not matching user ratings) ---
    const userRiskData = imageId && window.riskAssessmentData ? window.riskAssessmentData.get(imageId) : null;
    const isAIAddition = userRiskData && (
        (userRiskData.userFrequency && String(userRiskData.userFrequency) !== String(frequency)) ||
        (userRiskData.userSeverity && String(userRiskData.userSeverity) !== String(severity)) ||
        (userRiskData.userLikelihood && String(userRiskData.userLikelihood) !== String(likelihood))
    );
    const rowBgClass = isAIAddition ? 'bg-blue-50' : '';
    const aiBadge = isAIAddition ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">ü§ñ AI</span>` : '';
    
    // Preserve deleted state from loaded project
    const isDeleted = row.isDeleted === true || row.isDeleted === 'true';
    const deletedClass = isDeleted ? 'deleted-row' : '';
    const deletedAttr = isDeleted ? 'data-deleted="true"' : '';
                   
                tableHTML += `<tr data-row-index="${index}" data-image-id="${imageId}" ${deletedAttr} class="hover:bg-slate-100 transition ${rowBgClass} ${deletedClass}">
                    <td class="${tdClasses} picture-cell cursor-pointer modern-hover-cell" data-step="${row.Steps || ''}" data-hazard="${hazardListValue}" data-filename="${originalFileName || ''}"></td>
                    <td class="${tdClasses} text-center">${aiBadge}</td>
                    <td class="${tdClasses} cursor-pointer modern-hover-cell" onclick="openTableImageModal('', ${index})">${row.Steps || ''}</td>
                    <td class="${tdClasses} group">${createHazardGroupDropdown(hazardGroup)}</td>
                    <td class="${tdClasses} hazard-list-cell">${createTextDropdown(Object.keys(HAZARD_REGISTRY), hazardListValue, `recalculateRow(${index}, 'hazard')`)}</td>
                    <td class="${tdClasses} consequence-cell">${createTextDropdown(CONSEQUENCE_REGISTRY, consequenceValue, `recalculateRow(${index})`)}</td>
                    <td class="${tdClasses}">${createDropdown(FREQUENCY_SCALE, frequency, `recalculateRow(${index})`)}</td>
                    <td class="${tdClasses}">${createDropdown(SEVERITY_SCALE, severity, `recalculateRow(${index})`)}</td>
                    <td class="${tdClasses}">${createDropdown(LIKELIHOOD_SCALE, likelihood, `recalculateRow(${index})`)}</td>
                    <td class="${tdClasses} score font-bold">${riskScore.toFixed(2)}</td>
                    <td class="${tdClasses} cat font-semibold">${getRiskCategory(riskScore)}</td>
                    <td class="${tdClasses}"><input type="text" value="${DOMPurify.sanitize(row['Hazard Source'] || '')}" class="${inputClasses}"></td>
                    <td class="${tdClasses}"><input type="text" value="${DOMPurify.sanitize(row['Current Control'] || '')}" class="${inputClasses}"></td>
                    <td class="${tdClasses}"><input type="text" value="${DOMPurify.sanitize(row['Routine/Non-Routine/Emergency Situation'] || '')}" class="${inputClasses}"></td>
                    <td class="${tdClasses} text-center actions-cell"></td>
                    <td class="${tdClasses} text-center"><button onclick="toggleRowDelete(${index}, this)" class="${isDeleted ? 'restore-btn' : 'delete-btn'}" title="${isDeleted ? 'Restore row' : 'Delete row'}">${isDeleted ? 'Restore' : 'üóë'}</button></td>
                </tr>`;
                // --- END MODIFICATION ---
            });
            tableHTML += `</tbody></table></div>`;
            tableContainer.innerHTML = tableHTML;
            
            // Auto-scroll to bottom while table is being populated
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

                // Mark hazard list dropdowns that are not in the standard registry
                const hazardListCells = tableContainer.querySelectorAll('.hazard-list-cell select');
                hazardListCells.forEach(sel => {
                    if (!HAZARD_REGISTRY[sel.value]) {
                        sel.classList.add('hazard-invalid');
                    } else {
                        sel.classList.remove('hazard-invalid');
                    }
                });

                // Mark consequence dropdowns that are not in the standard registry
                const consequenceCells = tableContainer.querySelectorAll('.consequence-cell select');
                consequenceCells.forEach(sel => {
                    if (!CONSEQUENCE_REGISTRY.includes(sel.value)) {
                        sel.classList.add('hazard-invalid');
                    } else {
                        sel.classList.remove('hazard-invalid');
                    }
                });
            
            // Re-apply risk category colors after table build
            updateAllCategoryColors();
            
            // --- NEW: Call function to add images and ensure rows have valid imageIds ---
            populatePictureColumn();
            
            // Update control measure indicators on all rows
            updateAllControlIndicators();
            // --- END NEW ---
        }

        // Function to update control measures indicator on table row
        function updateControlIndicator(rowIndex) {
            const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
            if (!row) return;
            
            // Check if row has counter measures
            let hasControls = false;
            let controlCount = 0;
            
            if (row.dataset.counterMeasures) {
                try {
                    const controls = JSON.parse(row.dataset.counterMeasures);
                    if (controls && controls.length > 0) {
                        hasControls = true;
                        controlCount = controls.length;
                    }
                } catch (e) {}
            } else if (window.selectedControlsMap && window.selectedControlsMap[`row_${rowIndex}`]) {
                const controls = window.selectedControlsMap[`row_${rowIndex}`];
                if (controls && controls.length > 0) {
                    hasControls = true;
                    controlCount = controls.length;
                }
            }
            
            // Find the Actions cell (uses class actions-cell)
            const actionsCell = row.querySelector('.actions-cell');
            if (!actionsCell) return;
            
            // Clear existing content
            actionsCell.innerHTML = '';
            
            // Add badge if has controls
            if (hasControls) {
                const badge = document.createElement('span');
                badge.className = 'control-badge inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 cursor-pointer hover:bg-green-200 transition';
                badge.title = `${controlCount} control measure${controlCount > 1 ? 's' : ''} added - Click to view/edit`;
                badge.innerHTML = `üõ°Ô∏è ${controlCount}`;
                badge.onclick = () => openTableImageModal('', parseInt(rowIndex));
                actionsCell.appendChild(badge);
            } else {
                // Show a subtle "add" indicator
                const addBtn = document.createElement('span');
                addBtn.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-400 cursor-pointer hover:bg-slate-200 hover:text-slate-600 transition';
                addBtn.title = 'Click to add control measures';
                addBtn.innerHTML = '+ Add';
                addBtn.onclick = () => openTableImageModal('', parseInt(rowIndex));
                actionsCell.appendChild(addBtn);
            }
        }
        
        // Update all control indicators (called after table build or project load)
        function updateAllControlIndicators() {
            const rows = document.querySelectorAll('#table-container tbody tr');
            rows.forEach(row => {
                const rowIndex = row.dataset.rowIndex;
                if (rowIndex !== undefined) {
                    updateControlIndicator(rowIndex);
                }
            });
        }

        // Helper: Try to find a matching image by looking at step text and image descriptions
        function findImageByStepText(stepText) {
            if (!stepText) return null;
            //const normalizedStep = stepText.toLowerCase().trim();
            const normalizedStep = stepText.toLowerCase().trim().replace(/\s+/g, ' '); // Normalize whitespace
            
            // Get all gallery images and their descriptions
            const galleryImages = Array.from(document.querySelectorAll('.gallery-item img'));
            for (const img of galleryImages) {
                const imgId = img.id;
                const riskData = window.riskAssessmentData && window.riskAssessmentData.get(imgId);
                if (riskData) {
                    // Try exact matches first
                    //if (riskData.description && riskData.description.toLowerCase().trim() === normalizedStep) {
                    const normDesc = riskData.description ? riskData.description.toLowerCase().trim().replace(/\s+/g, ' ') : '';
                   if (normDesc && normDesc === normalizedStep) { // Exact after normalize
                        return imgId;
                    }
                    // Then try partial matches
                    //if (riskData.description && (
                       // riskData.description.toLowerCase().includes(normalizedStep) ||
                       // normalizedStep.includes(riskData.description.toLowerCase())
                       if (normDesc && (normDesc.includes(normalizedStep) || normalizedStep.includes(normDesc))) { // Partial
                        return imgId;
                    }
                    // If no description matches, try hazards/controls
                    const normHaz = riskData.hazards ? riskData.hazards.toLowerCase().trim().replace(/\s+/g, ' ') : '';
                    if (riskData.hazards && riskData.hazards.toLowerCase().includes(normalizedStep)) {
                        return imgId;
                    }
                }
            }
            return null;
        }

        // --- UPDATED with Debugging & Click Handler: Function to add thumbnails to the table ---
        function populatePictureColumn() {
    console.debug("Attempting to populate picture column (Robust Method)...");

    const tableRows = document.querySelectorAll('#table-container table tbody tr');
    if (tableRows.length === 0) {
        console.debug("Table not found or empty.");
        return;
    }

    tableRows.forEach((row, rowIndex) => {
        // 1. Get the imageId we stored in the row
        const imageId = row.dataset.imageId;

        // 2. If the row has no associated imageId, skip it
        if (!imageId) {
        console.debug(`Row ${rowIndex}: No imageId found, skipping.`);
            return;
        }

        // 3. Find the original image element in the gallery
        const originalImageElement = document.getElementById(imageId);
        const pictureCell = row.querySelector('.picture-cell');

        if (originalImageElement && pictureCell) {
            // 4. Found it! Get its thumbnail URL
            const thumbnailUrl = originalImageElement.src;
            const originalFileName = window.originalFileNames.get(imageId) || '';
            console.debug(`Row ${rowIndex}: Match found! Adding image ${imageId}`);
            
            // 5. Populate the cell
            pictureCell.innerHTML = `<img src="${thumbnailUrl}" 
                                         alt="Thumbnail for step" 
                                         class="w-16 h-16 object-cover rounded shadow cursor-pointer hover:scale-105 transition-transform" 
                                         onclick="openTableImageModal('${thumbnailUrl}', ${rowIndex})">`;
            pictureCell.dataset.filename = originalFileName;
        } else {
            // This might happen if the image was deleted after the AI ran
            console.debug(`Row ${rowIndex}: Had imageId ${imageId}, but could not find matching image in gallery or picture cell.`);
            if (pictureCell) pictureCell.innerHTML = ''; // Ensure cell is empty
        }
    });

    console.debug("Finished populating picture column.");
}
        // --- END UPDATED with Debugging ---
        // --- END NEW ---
        window.recalculateRow = function(rowIndex, changedType) {
            // --- MODIFICATION: This selector now correctly targets the table inside #table-container ---
            const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
            // --- END MODIFICATION ---
            
            if (!row) {
                console.error(`recalculateRow: Could not find row with index ${rowIndex}`);
                return;
            }
            
            if (changedType === 'hazard') {
                // Find the Hazard List dropdown by looking through all select elements
                // Column order: Picture, AI, Steps, Hazard Group, Hazard List, Risk/Consequences, Frequency, Severity, Likelihood, ...
                const allSelects = Array.from(row.querySelectorAll('select'));
                
                // Get all td elements
                const allTds = Array.from(row.querySelectorAll('td'));
                
                // Find indices of important columns
                let hazardGroupIndex = -1;
                let hazardListIndex = -1;
                
                // Hazard Group column has class "group"
                hazardGroupIndex = allTds.findIndex(td => td.classList.contains('group'));
                
                // Hazard List is usually the next data column after Hazard Group
                // We'll find it by trying to identify it - it contains hazard names
                allTds.forEach((td, idx) => {
                    const select = td.querySelector('select');
                    if (select && idx > hazardGroupIndex) {
                        // Check if this select contains hazard registry keys
                        for (let i = 0; i < select.options.length; i++) {
                            if (HAZARD_REGISTRY[select.options[i].value]) {
                                hazardListIndex = idx;
                                break;
                            }
                        }
                    }
                });
                
                // Fallback to nth-child if not found (for backward compatibility)
                if (hazardListIndex === -1) {
                    hazardListIndex = 4; // 0-indexed, so this is the 5th column
                }
                
                const hazardDropdown = allTds[hazardListIndex]?.querySelector('select');
                if (!hazardDropdown) {
                    console.error(`recalculateRow: Could not find Hazard List dropdown`);
                    return;
                }
                
                const selectedHazardName = hazardDropdown.value;
                const hazardDetails = HAZARD_REGISTRY[selectedHazardName] || { group: 'Unknown', severity: 1, likelihood: 1 };

                // Flag non-standard hazard list selections
                if (!HAZARD_REGISTRY[selectedHazardName]) {
                    hazardDropdown.classList.add('hazard-invalid');
                } else {
                    hazardDropdown.classList.remove('hazard-invalid');
                }
                
                const groupDropdown = allTds[hazardGroupIndex]?.querySelector('select');
                if (!groupDropdown) {
                    console.error(`recalculateRow: Could not find Hazard Group dropdown`);
                    return;
                }
                
                // Make sure the group exists in the dropdown options
                let groupExists = false;
                for (let i = 0; i < groupDropdown.options.length; i++) {
                    if (groupDropdown.options[i].value === hazardDetails.group) {
                        groupExists = true;
                        break;
                    }
                }
                if (!groupExists && hazardDetails.group !== 'Unknown') { // Add if not present and not 'Unknown'
                     const newOption = document.createElement('option');
                     newOption.value = hazardDetails.group;
                     newOption.text = t(hazardDetails.group); // Use translation function
                     groupDropdown.add(newOption);
                 }
                groupDropdown.value = hazardDetails.group;
                // Update class based on unknown status
                const selectClasses = "w-full p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 transition"; // Re-get base classes
                groupDropdown.className = hazardDetails.group === 'Unknown' ? `${selectClasses} border-red-500 text-red-600` : selectClasses;
                
                // Find Severity and Likelihood dropdowns by column index
                // Column order: Picture(0), AI(1), Steps(2), Hazard Group(3), Hazard List(4), Risk/Consequences(5), Frequency(6), Severity(7), Likelihood(8)
                const severityTd = allTds[7]; // 0-indexed
                const likelihoodTd = allTds[8]; // 0-indexed
                
                if (severityTd) {
                    const severitySelect = severityTd.querySelector('select');
                    if (severitySelect) {
                        severitySelect.value = hazardDetails.severity;
                    }
                }
                
                if (likelihoodTd) {
                    const likelihoodSelect = likelihoodTd.querySelector('select');
                    if (likelihoodSelect) {
                        likelihoodSelect.value = hazardDetails.likelihood;
                    }
                }
            }
            
            // Get all td elements for finding the correct columns
            const allTds = Array.from(row.querySelectorAll('td'));
            
            // Column order: Picture(0), AI(1), Steps(2), Hazard Group(3), Hazard List(4), Risk/Consequences(5), Frequency(6), Severity(7), Likelihood(8), Risk Score(9), Risk Category(10)
            const frequencyTd = allTds[6];
            const severityTd = allTds[7];
            const likelihoodTd = allTds[8];
            
            // Get the select elements
            const freqSelect = frequencyTd?.querySelector('select');
            const sevSelect = severityTd?.querySelector('select');
            const likeSelect = likelihoodTd?.querySelector('select');
            
            if (!freqSelect || !sevSelect || !likeSelect) {
                console.warn(`recalculateRow: Could not find frequency, severity, or likelihood dropdowns`);
                return;
            }
            
            // Parse the numeric values from the dropdowns
            const freq = parseFloat(freqSelect.value) || 1;
            const sev = parseFloat(sevSelect.value) || 1;
            const like = parseFloat(likeSelect.value) || 1;
            
            // Calculate new risk score
            const newScore = freq * sev * like;
            const newCategory = getRiskCategory(newScore);
            
            // Column order: Picture(0), AI(1), Steps(2), Hazard Group(3), Hazard List(4), Risk/Consequences(5), Frequency(6), Severity(7), Likelihood(8), Risk Score(9), Risk Category(10)
            const scoreCell = allTds[9];
            const categoryCell = allTds[10];
            
            if (scoreCell) {
                scoreCell.textContent = newScore.toFixed(2);
            }
            
            if (categoryCell) {
                categoryCell.textContent = newCategory;
                updateCategoryColor(categoryCell, newCategory);
            }
            
            // Update consequence cell validation (index 5 is Risk/Consequences column)
            const consequenceTd = allTds[5];
            if (consequenceTd) {
                const consequenceSelect = consequenceTd.querySelector('select');
                if (consequenceSelect) {
                    if (CONSEQUENCE_REGISTRY.includes(consequenceSelect.value)) {
                        consequenceSelect.classList.remove('hazard-invalid');
                    } else {
                        consequenceSelect.classList.add('hazard-invalid');
                    }
                }
            }
            
            updateDashboardMetrics();
        }
        // --- NEW: Function to recalculate RESIDUAL row ---
        window.recalculateResidualRow = function(rowIndex) {
            const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
            if (!row) return;

            // Find cells by their new helper classes
            const freqEl = row.querySelector('.res-freq select');
            const sevEl = row.querySelector('.res-sev select');
            const likeEl = row.querySelector('.res-like select');

            if (!freqEl || !sevEl || !likeEl) {
                console.warn(`Could not find residual dropdowns for row ${rowIndex}`);
                return;
            }

            const freq = parseFloat(freqEl.value);
            const sev = parseFloat(sevEl.value);
            const like = parseFloat(likeEl.value);
            
            const newScore = freq * sev * like;
            const newCategory = getRiskCategory(newScore);
            
            // Find score/cat cells by class
            const scoreCell = row.querySelector('.res-score');
            const catCell = row.querySelector('.res-cat');

            if (scoreCell) scoreCell.textContent = newScore.toFixed(2);
            if (catCell) {
                catCell.textContent = newCategory;
                updateCategoryColor(catCell, newCategory); // Update color
            }
        }
        // --- END NEW ---
        function getRiskCategory(score) {
            if (score >= 72) return "CRITICAL"; if (score >= 50) return "HIGH"; if (score >= 20) return "MEDIUM"; return "LOW";
        }
        
        function getRiskCategoryColor(category) {
            switch(category) {
                case "CRITICAL": return "text-red-700";
                case "HIGH": return "text-orange-600";
                case "MEDIUM": return "text-amber-600";
                case "LOW": return "text-green-700";
                default: return "text-slate-700";
            }
        }

        function updateRecDropdown(riskCount) {
    const select = document.getElementById('recCountSelect');
    if (!select) return;

    const currentValue = select.value; // Save what the user last selected
    select.innerHTML = ''; // Clear all old options

    if (riskCount === 0) {
        select.options.add(new Option("No High/Medium risks", "0"));
        select.disabled = true;
        return;
    }
    
    select.disabled = false;
    
    // Add "Top 5"
    select.options.add(new Option("Top 5 Risks", "5"));
    
    // Add "Top 10"
    select.options.add(new Option("Top 10 Risks", "10"));
    
    // Add "All"
    select.options.add(new Option(`All ${riskCount} High/Medium Risks`, "all"));
    
    // Disable options that are larger than the total count
    select.querySelector('option[value="5"]').disabled = riskCount < 5;
    select.querySelector('option[value="10"]').disabled = riskCount < 10;
    
    // Try to re-select the user's last value, if it's still valid
    if (currentValue && select.querySelector(`option[value="${currentValue}"]`) && !select.querySelector(`option[value="${currentValue}"]`).disabled) {
        select.value = currentValue;
    } else if (riskCount >= 5) {
        select.value = "5"; // Default to Top 5
    } else {
        select.value = "all"; // Default to 'all' if less than 5 risks
    }
}
        
        function updateCategoryColor(element, category) {
            if (!element) return;
            const colorClasses = ["text-red-700", "text-orange-600", "text-amber-600", "text-green-700", "text-slate-700"];
            element.classList.remove(...colorClasses);
            element.classList.add(getRiskCategoryColor(category));
        }
        function updateAllCategoryColors() {
             document.querySelectorAll('#risk-generator-app .cat').forEach(el => {
                 updateCategoryColor(el, el.textContent);
             });
        }
        function initializeDashboard() {
            updateDashboardMetrics();
        }
        function updateDashboardMetrics() {
            // const tableData = extractTableData(); // Original data from AI
            // if (!tableData || tableData.rows.length === 0) return;
            const scores = [];
            const riskCategories = {};
            const hazardGroups = {};
            const currentTableRows = document.querySelectorAll('#risk-generator-app table tbody tr'); // Use current DOM state
            if (currentTableRows.length === 0) {
                 document.getElementById('avgScore').textContent = 'N/A';
                 document.getElementById('highestCard').innerHTML = 'N/A';
                 document.getElementById('lastReviewed').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                 loadCharts({}, {}); // Clear charts
                 return;
             }
            let maxScore = -Infinity;
            let maxRowDetails = { score: 'N/A', category: 'N/A', steps: 'N/A'};
            currentTableRows.forEach((tr, index) => {
                const scoreElement = tr.querySelector('.score');
                const categoryElement = tr.querySelector('.cat');
                const groupSelectElement = tr.querySelector('td.group select');
                const stepsElement = tr.querySelector('td:first-child');
                if (scoreElement) {
                    const score = parseFloat(scoreElement.textContent);
                    if (!isNaN(score)) {
                        scores.push(score);
                        if (score > maxScore) {
                            maxScore = score;
                            maxRowDetails.score = score.toFixed(2);
                            maxRowDetails.category = categoryElement ? categoryElement.textContent.trim() : 'N/A';
                            maxRowDetails.steps = stepsElement ? stepsElement.textContent.trim() : 'N/A';
                        }
                    }
                }
                if (categoryElement) {
                    const category = categoryElement.textContent.trim();
                    if (category) riskCategories[category] = (riskCategories[category] || 0) + 1;
                }
                if (groupSelectElement) {
                    const groupValue = groupSelectElement.value;
                    if (groupValue) hazardGroups[groupValue] = (hazardGroups[groupValue] || 0) + 1;
                }
            });
            if (scores.length > 0) {
                document.getElementById('avgScore').textContent = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
                if (maxScore > -Infinity) {
                     document.getElementById('highestCard').innerHTML = DOMPurify.sanitize(`<strong class="text-xl ${getRiskCategoryColor(maxRowDetails.category)}">${maxRowDetails.score} - ${maxRowDetails.category}</strong><br><small class="text-slate-600">${maxRowDetails.steps}</small>`);
                 } else {
                     document.getElementById('highestCard').innerHTML = 'N/A';
                 }
            } else {
                document.getElementById('avgScore').textContent = 'N/A';
                document.getElementById('highestCard').innerHTML = 'N/A';
            }
            document.getElementById('lastReviewed').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            loadCharts(riskCategories, hazardGroups);
        }
       window.generateRecommendations = async function() {
    const recBtn = document.querySelector('button[onclick="generateRecommendations()"]');    
    const recommendationsDiv = document.getElementById('recommendations');
    //recommendationsDiv.innerHTML = `<p class="text-slate-500 italic">ü§ñ Analyzing risks...</p>`;
    if (recBtn) { recBtn.disabled = true; recBtn.innerHTML = `${spinnerSVG} Analyzing...`; }
    
    try {
        const tableData = extractTableData();
        
        const getRiskInfo = (row) => {
            const score = parseFloat(row['Risk Score']);
            const category = (row['Risk Category'] || '').toUpperCase();
            // We need the data-row-index here
            return { row, score, category, isValid: !isNaN(score) };
        };

        const allRisks = tableData.rows.map(getRiskInfo).filter(r => r.isValid);

        // Filter for High/Medium/Critical
        let topRisksData = allRisks.filter(r => ['CRITICAL', 'HIGH', 'MEDIUM'].includes(r.category));
        
        // --- NEW: Call dropdown updater ---
        updateRecDropdown(topRisksData.length);
        // --- END NEW ---

        // 3. Sort the final list
        const sortedRisksData = topRisksData.sort((a, b) => b.score - a.score);

        // --- NEW: Read dropdown and determine which risks to process ---
        const riskCountSelect = document.getElementById('recCountSelect');
        const riskCount = riskCountSelect.value;
        
        if (riskCount === "0") {
            recommendationsDiv.innerHTML = `<p class="text-slate-500 italic">No 'Critical', 'High', or 'Medium' risk tasks found to generate recommendations for.</p>`;
            
            if (recBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† recBtn.disabled = false;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† recBtn.innerHTML = 'Generate AI Recommendations & Visuals';
¬† ¬† ¬† ¬† ¬† ¬† }
            return;
        }

        let risksToProcessData; // This is the full list of risks that *should* have recs
        if (riskCount === 'all') {
            risksToProcessData = sortedRisksData;
        } else {
            const count = parseInt(riskCount, 10);
            risksToProcessData = sortedRisksData.slice(0, count);
        }
        
        // --- NEW: Filter this list down to only ones that need processing ---
        const headers = Array.from(document.querySelectorAll('#table-container thead th')).map(th => th.textContent.trim());
        const recColIndex = headers.indexOf("Recommendation");
        
        let risksToSendToAI; // This is the list we send to the AI
        
        if (recColIndex === -1) {
            // Recommendations haven't been run before, so process all
            risksToSendToAI = risksToProcessData;
        } else {
            // Filter out risks that *already have* a recommendation
            risksToSendToAI = risksToProcessData.filter(riskInfo => {
                const rowIndex = riskInfo.row['data-row-index'];
                if (rowIndex === undefined) return true; // Failsafe
                
                const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
                if (!row || !row.cells[recColIndex]) return true; // Failsafe
                
                // Only process if the recommendation cell is empty
                return row.cells[recColIndex].textContent.trim() === '';
            });
        }
        
        if (risksToSendToAI.length === 0) {
            recommendationsDiv.innerHTML = `<p class="text-slate-500 italic">All selected risks (${riskCountSelect.options[riskCountSelect.selectedIndex].text}) already have recommendations.</p>`;
            // Still apply highlights to the target risks
            applyVisualsAndRecommendationsToTable([], risksToProcessData); 
            return;
        }
        // --- END NEW LOGIC ---

        // 5. --- BATCHING LOGIC (Process 'risksToSendToAI') ---
        // Batch size of 2 for more detailed AI analysis (smaller batches = deeper focus per group)
        const BATCH_SIZE = 2; 
        const allBatches = chunkArray(risksToSendToAI.map(r => r.row), BATCH_SIZE); // Map back to row data
        let allRecommendations = [];
        let failedBatches = [];
        let modelNote = '';

    console.debug(`Processing ${risksToSendToAI.length} new risks in ${allBatches.length} batches.`);

        for (let i = 0; i < allBatches.length; i++) {
            const batch = allBatches[i];
            const batchNumber = i + 1;
            recommendationsDiv.innerHTML = `<p class="text-slate-500 italic">ü§ñ Generating recommendations... (Batch ${batchNumber} of ${allBatches.length})</p>`;

            const prompt = `
                Analyze these high-risk tasks. For each, provide a concise, actionable recommendation.
                Then, estimate the new Frequency, Severity, and Likelihood values if the recommendation is implemented.
                Format your response ONLY as a JSON array of objects. Each object must have these exact keys:
                "step": "exact step name from input",
                "hazard": "exact hazard from input",
                "recommendation": "Your full recommendation text",
                "newFrequency": new_frequency_number,
                "newSeverity": new_severity_number,
                "newLikelihood": new_likelihood_number
                
                Tasks: ${JSON.stringify(batch.map(r => ({step: r.Steps, hazard: r['Hazard List'], Frequency: r.Frequency, Severity: r.Severity, Likelihood: r.Likelihood})), null, 2)}
            `;

            try {
                const paidResponse = await callAPI(PAID_MODEL, prompt);
                const parsedBatchRecs = parseAndCleanData(paidResponse);
                allRecommendations.push(...parsedBatchRecs); 
                modelNote = `(Generated using ${PAID_MODEL})`;
            } catch (error) {
                console.error(`Error processing batch ${batchNumber}:`, error);
                failedBatches.push(batchNumber);
                
            }
            if (recBtn) { recBtn.disabled = false; recBtn.innerHTML = 'Generate AI Recommendations & Visuals'; }
        }
        // --- END BATCHING LOGIC ---

        if (allRecommendations.length === 0 && failedBatches.length > 0) {
            recommendationsDiv.innerHTML = `<p class="text-red-600 font-medium">Error: AI failed to return any recommendations for ${allBatches.length} batches.</p>`;
            return;
        }

        allRecommendations.forEach(rec => {
            rec.newRiskScore = (rec.newFrequency || 1) * (rec.newSeverity || 1) * (rec.newLikelihood || 1);
        });
        
        // Find the original full task data for the summary table
        const originalTasksForSummary = risksToSendToAI.map(r => r.row);
        let summaryHtml = formatRecommendationsAsTable(allRecommendations, originalTasksForSummary) + `<p class="text-sm text-slate-500 italic mt-4">${modelNote}</p>`;
        
        if (failedBatches.length > 0) {
            summaryHtml += `<p class="text-red-600 font-medium mt-2">Warning: AI failed to process batch(es): ${failedBatches.join(', ')}. Some recommendations may be missing.</p>`;
        }
        
        recommendationsDiv.innerHTML = summaryHtml;
        
        // --- MODIFIED: Pass the full list of risks that should be highlighted ---
        applyVisualsAndRecommendationsToTable(allRecommendations, risksToProcessData);

    } catch (error) {
        recommendationsDiv.innerHTML = `<p class="text-red-600 font-medium">Error: ${error.message}.</p>`;
    }
}
        // --- MAJOR REWRITE: This function now adds new columns ---
        // --- CORRECTED LOGIC: Applies recommendations to ALL matching rows ---
        // --- CORRECTED LOGIC V2: Removed 'break' to apply to ALL matching rows ---
// --- CORRECTED LOGIC V3: Properly matches step AND hazard ---
        function applyVisualsAndRecommendationsToTable(recommendations, targetRisks) { // <-- MODIFIED ARGS
    const table = document.querySelector('#table-container table');
    if (!table) return;

    // Get column indices, including the crucial 'Hazard List'
    let headers = Array.from(table.querySelector('thead tr').children).map(th => th.textContent.trim());
    const colIndices = {
        steps: headers.indexOf('Steps'),
        hazard: headers.indexOf('Hazard List')
    };

    if (colIndices.steps === -1 || colIndices.hazard === -1) {
        console.error("Critical Error: Could not find 'Steps' or 'Hazard List' column.");
        return;
    }
    
    const thClasses = "p-3 text-left font-semibold text-slate-700 uppercase tracking-wider";
    const tdClasses = "p-3 border-b border-slate-200 text-slate-700 align-top";

    // Define new headers
    const newHeaders = [
        "Recommendation", 
        "Residual Frequency", 
        "Residual Severity", 
        "Residual Likelihood", 
        "Residual Risk Score", 
        "Residual Risk Category"
    ];

    // --- Add new headers if they don't exist (this logic is unchanged) ---
    if (!headers.includes("Recommendation")) {
        newHeaders.forEach(headerText => {
            table.querySelector('thead tr').insertAdjacentHTML('beforeend', `<th class="${thClasses}">${headerText}</th>`);
        });
        table.querySelectorAll('tbody tr').forEach(row => {
            newHeaders.forEach(() => {
                row.insertAdjacentHTML('beforeend', `<td class="${tdClasses}"></td>`);
            });
        });
        // Re-read headers *after* adding new ones
        headers = Array.from(table.querySelector('thead tr').children).map(th => th.textContent.trim());
    }

    // Find new column indices
    const recColIndex = headers.indexOf("Recommendation");
    const resFreqColIndex = headers.indexOf("Residual Frequency");
    const resSevColIndex = headers.indexOf("Residual Severity");
    const resLikeColIndex = headers.indexOf("Residual Likelihood");
    const resScoreColIndex = headers.indexOf("Residual Risk Score");
    const resCatColIndex = headers.indexOf("Residual Risk Category");
    
    // --- MODIFIED: Clear only highlights, not data ---
    const allRows = Array.from(table.querySelectorAll('tbody tr'));
    allRows.forEach(row => {
        row.classList.remove('bg-amber-50');
    });
    // --- END MODIFICATION ---

    // --- NEW: Highlight all target rows based on the targetRisks list ---
    if (targetRisks && targetRisks.length > 0) {
        // We get the set of row indices that *should* be highlighted
        const targetRowIndices = new Set(targetRisks.map(r => r.row['data-row-index']));
        allRows.forEach(row => {
            if (targetRowIndices.has(row.dataset.rowIndex)) {
                row.classList.add('bg-amber-50');
            }
        });
    }
    // --- END NEW ---

    // --- CORRECTED LOOP: Match each *new* recommendation to its specific row ---
    // This loop now only runs for *newly* generated recommendations
    recommendations.forEach(rec => {
        let rowMatched = false; 

        for (const targetRow of allRows) { 
            const stepText = targetRow.cells[colIndices.steps]?.textContent.trim();
            const hazardCell = targetRow.cells[colIndices.hazard];
            const hazardValue = hazardCell?.querySelector('select')?.value; 

            if (hazardValue !== undefined && stepText === rec.step && hazardValue === rec.hazard) {
                // targetRow.classList.add('bg-amber-50'); // Highlight is now done above
                const rowIndex = targetRow.dataset.rowIndex;

                const newFreq = rec.newFrequency || 1;
                const newSev = rec.newSeverity || 1;
                const newLike = rec.newLikelihood || 1;
                const newScore = rec.newRiskScore !== undefined ? rec.newRiskScore : (newFreq * newSev * newLike);
                const newCategory = getRiskCategory(newScore);

                // Populate all the new cells for THIS specific row
                if (recColIndex > -1 && targetRow.cells[recColIndex]) {
                    targetRow.cells[recColIndex].textContent = rec.recommendation;
                }
                if (resFreqColIndex > -1 && targetRow.cells[resFreqColIndex]) {
                    targetRow.cells[resFreqColIndex].innerHTML = createDropdown(FREQUENCY_SCALE, newFreq, `recalculateResidualRow(${rowIndex})`);
                    targetRow.cells[resFreqColIndex].className = `${tdClasses} res-freq`; // Add class
                }
                if (resSevColIndex > -1 && targetRow.cells[resSevColIndex]) {
                    targetRow.cells[resSevColIndex].innerHTML = createDropdown(SEVERITY_SCALE, newSev, `recalculateResidualRow(${rowIndex})`);
                    targetRow.cells[resSevColIndex].className = `${tdClasses} res-sev`; // Add class
                }
                if (resLikeColIndex > -1 && targetRow.cells[resLikeColIndex]) {
                    targetRow.cells[resLikeColIndex].innerHTML = createDropdown(LIKELIHOOD_SCALE, newLike, `recalculateResidualRow(${rowIndex})`);
                    targetRow.cells[resLikeColIndex].className = `${tdClasses} res-like`; // Add class
                }
                if (resScoreColIndex > -1 && targetRow.cells[resScoreColIndex]) {
                    targetRow.cells[resScoreColIndex].textContent = newScore.toFixed(2);
                    targetRow.cells[resScoreColIndex].className = `${tdClasses} res-score font-bold`; // Add class
                }
                if (resCatColIndex > -1 && targetRow.cells[resCatColIndex]) {
                    const catCell = targetRow.cells[resCatColIndex];
                    catCell.textContent = newCategory;
                    catCell.className = `${tdClasses} res-cat font-semibold`; // Add class
                    updateCategoryColor(catCell, newCategory); // Apply color
                }
                
                rowMatched = true; 
                break; 
            }
        } // End inner loop through rows

        if (!rowMatched) {
            console.warn(`Could not find a row matching step: "${rec.step}" AND hazard: "${rec.hazard}" to apply recommendation.`);
        }
    }); // End outer loop through recommendations
}
        // --- END MAJOR REWRITE ---
        function getRiskColor(score) {
            if (score >= 72) return { main: '#dc2626', light: '#fee2e2' }; // red
            if (score >= 50) return { main: '#f97316', light: '#ffedd5' }; // orange
            if (score >= 20) return { main: '#eab308', light: '#fef9c3' }; // amber
            return { main: '#16a34a', light: '#dcfce7' }; // green
        }
        function generateVisualizationCard(originalFreq, originalSev, originalLike, newFreq, newSev, newLike, riskScore, newRiskScore) {
            if (isNaN(riskScore)) return '';
            
            const formatFactor = (label, originalVal, newVal) => {
                if (originalVal != newVal && newVal !== undefined) {
                    return `${label}: ${originalVal} ‚ûî <span class="font-bold text-indigo-700">${newVal}</span>`;
                }
                return `${label}: ${originalVal}`;
            };
            const freqHtml = formatFactor('F', originalFreq, newFreq);
            const sevHtml = formatFactor('S', originalSev, newSev);
            const likeHtml = formatFactor('L', originalLike, newLike);
            const originalColor = getRiskColor(riskScore);
            const newColor = getRiskColor(newRiskScore);
            const getBarStyle = (score, max, color) => `width: ${Math.min(100, (score / max * 100))}%; background-color: ${color};`;
            const maxBarScore = Math.max(riskScore, newRiskScore, 50); // Set a reasonable max for the bar
            
            return `<div class="text-xs p-2 bg-white rounded-md shadow-inner border border-slate-200 space-y-2">
                <div>
                    <span class="font-semibold text-slate-700">${freqHtml} | ${sevHtml} | ${likeHtml}</span>
                </div>
                <div>
                    <span class="font-semibold text-slate-700">Risk: ${riskScore.toFixed(2)} ‚ûî <span class="font-bold text-indigo-700">${newRiskScore.toFixed(2)}</span></span>
                    <div class="relative h-2.5 bg-slate-200 rounded-full overflow-hidden border border-slate-300 mt-1">
                        <div class="absolute top-0 left-0 h-full transition-all" style="${getBarStyle(riskScore, maxBarScore, originalColor.light)}"></div>
                        <div class="absolute top-0 left-0 h-full transition-all" style="${getBarStyle(newRiskScore, maxBarScore, newColor.main)}"></div>
                    </div>
                </div>
            </div>`;
        }
        function formatRecommendationsAsTable(recommendations, topRisks) {
            if (!recommendations || recommendations.length === 0) return '<p class="text-slate-500 italic">No recommendations available.</p>';
            let html = `<table class="w-full text-sm mt-4"><thead class="bg-slate-100"><tr><th class="p-3 text-left">Step</th><th class="p-3 text-left">Recommendation</th><th class="p-3 text-left">Score Change</th></tr></thead><tbody>`;

            recommendations.forEach(rec => {
                // Safely compute original score from topRisks if possible
                let originalScore = 0;
                try {
                    if (Array.isArray(topRisks) && topRisks.length > 0) {
                        const matches = topRisks.filter(t => (t.Steps || t.Steps === '') && rec.step && (t.Steps === rec.step || t.Steps === rec.step));
                        const vals = matches.map(t => parseFloat(t['Risk Score']) || 0);
                        if (vals.length > 0) originalScore = Math.max(...vals);
                    }
                } catch (e) { /* ignore and leave originalScore as 0 */ }

                const newScore = typeof rec.newRiskScore === 'number' ? rec.newRiskScore : (parseFloat(rec.newRiskScore) || 0);
                html += `<tr>
                    <td class="p-3 align-top">${DOMPurify.sanitize(rec.step || '')}</td>
                    <td class="p-3 align-top">${DOMPurify.sanitize(rec.recommendation || '')}</td>
                    <td class="p-3 align-top whitespace-nowrap">Score: ${originalScore.toFixed(2)} ‚ûî <strong class="text-indigo-700">${newScore.toFixed(2)}</strong></td>
                </tr>`;
            });

            return html + '</tbody></table>';
        }
        function parseAndCleanData(rawJson) {
            try {
                // More robust JSON parsing: Find first '[' and last ']'
                 const startIndex = rawJson.indexOf('[');
                 const endIndex = rawJson.lastIndexOf(']');
                 if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
                       throw new Error("Valid JSON array boundaries not found in the AI response.");
                 }
                 const jsonString = rawJson.substring(startIndex, endIndex + 1);
                const parsed = JSON.parse(jsonString);
                
                // DEBUG: Log the raw AI values to inspect
                if (Array.isArray(parsed) && parsed.length > 0) {
                    console.log('AI returned values - Sample row:', {
                        Steps: parsed[0].Steps,
                        Frequency: parsed[0].Frequency,
                        Severity: parsed[0].Severity,
                        Likelihood: parsed[0].Likelihood
                    });
                }
                
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Failed to parse AI response. Raw data:', rawJson, 'Error:', e);
                throw new Error("AI response was in an invalid format.");
            }
        }
        async function callAPI(model, prompt) {
            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) throw new Error('API Key is not configured. Please add your key to the script, or preferably, set up a secure server-side proxy.');
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model, messages: [{ role: 'user', content: prompt }], max_tokens: 2048 }), });
            if (!response.ok) { const errorText = await response.text(); throw new Error(`API request for ${model} failed: ${errorText}`); }
            const data = await response.json();
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message || !data.choices[0].message.content) {
                 throw new Error(`API response for ${model} was empty or invalid.`);
             }
            return data.choices[0].message.content;
        }
        function extractTableData() {
            // --- FIX: Selector now points to the correct table inside #table-container ---
            const table = document.querySelector('#table-container table'); 
            // --- END FIX ---
            
            if (!table) return { headers: [], rows: [] };
            
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = [];
            
            table.querySelectorAll('tbody tr').forEach(tr => {
                const rowData = {};
                rowData['data-row-index'] = tr.dataset.rowIndex;
                rowData['imageId'] = tr.dataset.imageId || null;
                rowData['isDeleted'] = tr.classList.contains('deleted-row') || tr.dataset.deleted === 'true';
                
                tr.querySelectorAll('td').forEach((td, index) => {
                    const header = headers[index];
                    if (header && header !== 'Picture' && header !== 'Delete') {
                        const select = td.querySelector('select');
                        const input = td.querySelector('input');
                        if (select) {
                            rowData[header] = select.value;
                        } else if (input) {
                            rowData[header] = input.value;
                        } else {
                            // Capture all text content for text-based columns
                            rowData[header] = td.textContent.trim();
                        }
                    }
                });
                rows.push(rowData);
            });
            return { headers, rows };
        }
        function loadCharts(riskData, hazardData) {
            // Clear previous errors/charts
             document.getElementById('chartError').style.display = 'none';
             document.getElementById('hazardChartError').style.display = 'none';
             document.getElementById('riskChart').innerHTML = ''; // Clear previous chart SVG
             document.getElementById('hazardChart').innerHTML = '';
            if (typeof google === 'undefined' || !google.charts) {
                console.error("Google Charts library not loaded.");
                 document.getElementById('chartError').textContent = 'Google Charts library failed to load.';
                 document.getElementById('hazardChartError').textContent = 'Google Charts library failed to load.';
                 document.getElementById('chartError').style.display = 'block';
                 document.getElementById('hazardChartError').style.display = 'block';
                return;
            }
            // Ensure charts library is loaded before drawing
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                try {
                    // --- MODIFIED CHART OPTIONS ---
                    const chartOptions = {
                        pieHole: 0.4,
                        backgroundColor: 'transparent',
                        chartArea: {width: '90%', height: '80%'},
                        legend: {position: 'bottom', textStyle: { color: '#475569', fontSize: 12, fontName: 'Segoe UI' }},
                        titleTextStyle: { color: '#334155', fontSize: 16, fontName: 'Segoe UI', bold: true },
                        pieSliceTextStyle: { color: '#ffffff', fontName: 'Segoe UI', bold: true, fontSize: 13 }
                    };
                    // --- END OF MODIFICATION ---

                    if (Object.keys(riskData).length > 0) {
                         drawRiskChart(riskData, chartOptions);
                    } else {
                         document.getElementById('chartError').textContent = 'No risk category data available to display.';
                         document.getElementById('chartError').style.display = 'block';
                    }
                    if (Object.keys(hazardData).length > 0) {
                        drawHazardChart(hazardData, chartOptions);
                    } else {
                         document.getElementById('hazardChartError').textContent = 'No hazard group data available to display.';
                         document.getElementById('hazardChartError').style.display = 'block';
                    }
                } catch (e) {
                    console.error("Error drawing charts:", e);
                    document.getElementById('chartError').textContent = 'Error drawing risk chart.';
                    document.getElementById('hazardChartError').textContent = 'Error drawing hazard chart.';
                    document.getElementById('chartError').style.display = 'block';
                    document.getElementById('hazardChartError').style.display = 'block';
                }
            });
        }
        // Global filter state
        let activeFilterType = null; // 'risk' or 'hazard'
        let activeFilterValue = null; // The selected category/group

        function clearTableFilter() {
            activeFilterType = null;
            activeFilterValue = null;
            showAllTableRows();
            updateFilterBadge();
            showCustomAlert('‚úÖ Filter cleared - showing all rows', 'success');
        }

        function filterTableByRiskCategory(category) {
            activeFilterType = 'risk';
            activeFilterValue = category;
            const allRows = document.querySelectorAll('#table-container table tbody tr');
            allRows.forEach(row => {
                const riskCat = row.querySelector('.cat').textContent.trim();
                if (riskCat === category) {
                    row.style.display = 'table-row'; // Explicitly set to table-row
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterBadge();
            showCustomAlert(`üìä Filtering by Risk Category: ${category}`, 'success');
        }

        function filterTableByHazardGroup(groupName) {
            activeFilterType = 'hazard';
            activeFilterValue = groupName;
            const allRows = document.querySelectorAll('#table-container table tbody tr');
            allRows.forEach(row => {
                const groupDropdown = row.querySelector('.group select');
                if (groupDropdown && groupDropdown.value === groupName) {
                    row.style.display = 'table-row'; // Explicitly set to table-row
                } else {
                    row.style.display = 'none';
                }
            });
            updateFilterBadge();
            showCustomAlert(`üìä Filtering by Hazard Group: ${groupName}`, 'success');
        }

        function showAllTableRows() {
            const allRows = document.querySelectorAll('#table-container table tbody tr');
            allRows.forEach(row => {
                row.style.display = 'table-row'; // Explicitly set to table-row instead of empty string
            });
        }

        function updateFilterBadge() {
            let badge = document.getElementById('filterBadge');
            
            if (!activeFilterType) {
                if (badge) {
                    badge.remove();
                }
                return;
            }

            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'filterBadge';
                badge.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3 animate-pulse';
                document.body.appendChild(badge);
            }

            const filterLabel = activeFilterType === 'risk' ? 'üî¥ Risk:' : '‚ö†Ô∏è Hazard:';
            badge.innerHTML = `
                <span>${filterLabel} <strong>${activeFilterValue}</strong></span>
                <button class="clearFilterBtn ml-2 bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-sm font-semibold transition cursor-pointer">Clear</button>
            `;
            
            // Attach event listener to the clear button
            const clearBtn = badge.querySelector('.clearFilterBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    clearTableFilter();
                });
            }
        }

        function drawRiskChart(data, options) {
            try {
                const chartData = new google.visualization.DataTable();
                chartData.addColumn('string', 'Risk Category');
                chartData.addColumn('number', 'Count');
                const categories = Object.keys(data).sort((a, b) => { // Sort low to critical
                     const order = { "LOW": 1, "MEDIUM": 2, "HIGH": 3, "CRITICAL": 4 };
                     return (order[a] || 5) - (order[b] || 5);
                 });
                const colorMap = { 'LOW': '#16a34a', 'MEDIUM': '#eab308', 'HIGH': '#f97316', 'CRITICAL': '#dc2626' };
                chartData.addRows(categories.map(cat => [cat, data[cat]]));
                const riskOptions = {
                    ...options,
                    title: 'Risk Category Distribution (Click to filter)',
                    colors: categories.map(cat => colorMap[cat.toUpperCase()] || '#6c757d')
                };
                const chartElement = document.getElementById('riskChart');
                 if (!chartElement) throw new Error("riskChart element not found");
                 chartElement.innerHTML = ''; // Clear previous chart
                const chart = new google.visualization.PieChart(chartElement);
                
                // Add click event listener
                google.visualization.events.addListener(chart, 'select', function() {
                    const selection = chart.getSelection();
                    if (selection.length > 0) {
                        const selectedRow = selection[0].row;
                        const selectedCategory = chartData.getValue(selectedRow, 0);
                        filterTableByRiskCategory(selectedCategory);
                    }
                });
                
                chart.draw(chartData, riskOptions);
             } catch (e) {
                 console.error("Error in drawRiskChart:", e);
                 const errorEl = document.getElementById('chartError');
                 if(errorEl) {
                     errorEl.textContent = 'Error drawing risk chart: ' + e.message;
                     errorEl.style.display = 'block';
                 }
             }
        }
        function drawHazardChart(data, options) {
             try {
                const chartData = new google.visualization.DataTable();
                chartData.addColumn('string', 'Hazard Group');
                chartData.addColumn('number', 'Count');
                // Sort categories alphabetically for consistency
                const categories = Object.keys(data).sort();
                const displayLabels = categories.map(cat => cat.length > 25 ? cat.substring(0, 22) + '...' : cat); // Slightly longer labels allowed
                chartData.addRows(categories.map((cat, i) => [displayLabels[i], data[cat]]));
                const hazardOptions = {
                    ...options,
                    title: 'Hazard Group Distribution (Click to filter)',
                    colors: generateColors(categories.length),
                };
                 const chartElement = document.getElementById('hazardChart');
                 if (!chartElement) throw new Error("hazardChart element not found");
                 chartElement.innerHTML = ''; // Clear previous chart
                const chart = new google.visualization.PieChart(chartElement);
                
                // Add click event listener
                google.visualization.events.addListener(chart, 'select', function() {
                    const selection = chart.getSelection();
                    if (selection.length > 0) {
                        const selectedRow = selection[0].row;
                        const selectedLabel = chartData.getValue(selectedRow, 0);
                        // Map display label back to full category name
                        const selectedCategory = categories[selection[0].row];
                        filterTableByHazardGroup(selectedCategory);
                    }
                });
                
                chart.draw(chartData, hazardOptions);
             } catch (e) {
                 console.error("Error in drawHazardChart:", e);
                 const errorEl = document.getElementById('hazardChartError');
                  if(errorEl) {
                     errorEl.textContent = 'Error drawing hazard chart: ' + e.message;
                     errorEl.style.display = 'block';
                 }
             }
        }
        function generateColors(count) {
            const baseColors = ['#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#3b82f6', '#22c55e', '#eab308', '#ec4899'];
            const colors = []; for (let i = 0; i < count; i++) { colors.push(baseColors[i % baseColors.length]); } return colors;
        }
        // --- Enhanced Table Image Modal with Editable Fields ---
        let currentModalRowIndex = 0;
        let allModalRowIndices = [];
        let modalFieldValues = {}; // Track edited values in modal
        
        // Helper to check if current modal row is deleted (global scope)
        window.isCurrentModalRowDeleted = function() {
            const currentRowIndex = allModalRowIndices[currentModalRowIndex];
            const row = document.querySelector(`#table-container tr[data-row-index="${currentRowIndex}"]`);
            return row && (row.classList.contains('deleted-row') || row.dataset.deleted === 'true');
        };
        
        window.openTableImageModal = function(imageUrl, rowIndex) {
            // Get ALL rows for navigation (including deleted ones)
            const allRows = document.querySelectorAll('#table-container tbody tr');
            allModalRowIndices = Array.from(allRows).map((row, i) => parseInt(row.dataset.rowIndex || i));
            currentModalRowIndex = allModalRowIndices.indexOf(rowIndex);
            
            if (currentModalRowIndex === -1) {
                currentModalRowIndex = 0;
            }
            
            loadModalTaskDetails(allModalRowIndices[currentModalRowIndex]);
            document.getElementById('tableImageModal').style.display = 'flex';
        };
        
        // --- RENDER HIERARCHY OF CONTROL TRIANGLE ---
        function renderControlTriangle() {
            const triangleContainer = document.getElementById('controlTriangle');
            if (!triangleContainer) return;
            
            // Control hierarchy from top (best) to bottom (worst)
            // Inverted triangle: widest at top (Eliminate), narrowest at bottom (Individual)
            // Safety gradient: Green (safest) ‚Üí Yellow/Orange ‚Üí Red (highest risk)
            const controls = [
                { level: 'Eliminate', color: '#059669', lightColor: '#10b981', hex: '6' },
                { level: 'Substitute', color: '#16a34a', lightColor: '#22c55e', hex: '5' },
                { level: 'Engineer', color: '#ca8a04', lightColor: '#eab308', hex: '4' },
                { level: 'Visual', color: '#ea580c', lightColor: '#fb923c', hex: '3' },
                { level: 'Admin', color: '#dc2626', lightColor: '#ef4444', hex: '2' },
                { level: 'Individual', color: '#b91c1c', lightColor: '#dc2626', hex: '1' }
            ];
            
            // Create SVG triangle - inverted (wide at top)
            const svgWidth = 300;
            const svgHeight = 280;
            const paddingTop = 5;
            const paddingBottom = 15;
            const usableHeight = svgHeight - paddingTop - paddingBottom;
            
            let svgHTML = `<svg viewBox="0 0 ${svgWidth} ${svgHeight}" style="width:100%; height:100%; display:block; background:transparent;">
                <defs>
                    ${controls.map((control, idx) => `
                        <linearGradient id="grad${idx}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:${control.lightColor};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${control.color};stop-opacity:1" />
                        </linearGradient>
                    `).join('')}
                </defs>
            `;
            
            // Draw trapezoid sections for each level (inverted: top is widest)
            controls.forEach((control, idx) => {
                const totalLevels = controls.length;
                
                // For inverted triangle: width decreases as we go down
                const topWidth = (svgWidth - 20) * ((totalLevels - idx) / totalLevels);
                const bottomWidth = (svgWidth - 20) * ((totalLevels - idx - 1) / totalLevels);
                
                const y1 = (usableHeight / totalLevels) * idx + paddingTop;
                const y2 = (usableHeight / totalLevels) * (idx + 1) + paddingTop;
                
                const x1_left = (svgWidth - topWidth) / 2;
                const x1_right = x1_left + topWidth;
                const x2_left = (svgWidth - bottomWidth) / 2;
                const x2_right = x2_left + bottomWidth;
                
                // Trapezoid path (inverted)
                const points = `${x1_left},${y1} ${x1_right},${y1} ${x2_right},${y2} ${x2_left},${y2}`;
                
                const centerX = svgWidth / 2;
                const centerY = (y1 + y2) / 2 + 4;
                
                svgHTML += `
                    <polygon 
                        points="${points}" 
                        class="control-level" 
                        data-control="${control.level}"
                        fill="url(#grad${idx})" 
                        stroke="none"
                        opacity="1"
                        style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));">
                    </polygon>
                    <text 
                        x="${centerX}"
                        y="${centerY}"
                        class="control-label"
                        text-anchor="middle"
                        fill="white"
                        font-size="13"
                        font-weight="700"
                        style="text-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: none; user-select: none; letter-spacing: 0.3px;">
                        ${control.hex} : ${control.level}
                    </text>
                `;
            });
            
            svgHTML += `</svg>`;
            triangleContainer.innerHTML = svgHTML;
            
            // Add click handlers to polygons
            const levels = triangleContainer.querySelectorAll('.control-level');
            levels.forEach(level => {
                level.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const selectedControl = this.dataset.control;
                    selectControlType(selectedControl);
                });
                level.addEventListener('mouseover', function() {
                    this.style.filter = 'brightness(1.15)';
                    this.style.opacity = '1';
                });
                level.addEventListener('mouseout', function() {
                    // Check if any level is selected
                    const hasSelection = triangleContainer.querySelector('.control-level.selected');
                    if (this.classList.contains('selected')) {
                        this.style.filter = 'brightness(1)';
                        this.style.opacity = '1';
                    } else if (hasSelection) {
                        // Grey out non-selected items when there's a selection
                        this.style.filter = 'grayscale(0.7) brightness(0.7)';
                        this.style.opacity = '0.5';
                    } else {
                        this.style.filter = 'brightness(1)';
                        this.style.opacity = '1';
                    }
                });
            });
        }
        
        function selectControlType(controlType) {
            // Update dropdown value
            document.getElementById('counterMeasureLadder').value = controlType;
            
            // Update visual selection on triangle
            const triangleContainer = document.getElementById('controlTriangle');
            const levels = triangleContainer.querySelectorAll('.control-level');
            levels.forEach(level => {
                if (level.dataset.control === controlType) {
                    level.classList.add('selected');
                    level.style.filter = 'brightness(1)';
                    level.style.opacity = '1';
                } else {
                    level.classList.remove('selected');
                    level.style.filter = 'grayscale(0.7) brightness(0.7)';
                    level.style.opacity = '0.5';
                }
            });
            
            // Update display text
            const display = document.getElementById('selectedControlDisplay');
            if (display) {
                display.textContent = `‚úì Selected: ${controlType}`;
                display.style.background = '#dbeafe';
                display.style.color = '#1e40af';
                display.style.fontWeight = 'bold';
            }
        }
        
        function loadModalTaskDetails(rowIndex) {
            const modal = document.getElementById('tableImageModal');
            const enlargedImage = document.getElementById('modalEnlargedImage');
            const editableForm = document.getElementById('modalEditableForm');
            const taskTitle = document.getElementById('modalTaskTitle');
            const taskCounter = document.getElementById('modalTaskCounter');
            
            if (!modal || !enlargedImage || !editableForm) {
                console.error("Modal elements not found!");
                return;
            }
            
            // Get the corresponding table row
            const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
            if (!row) {
                editableForm.innerHTML = '<p class="text-red-600">Error: Could not find table row data.</p>';
                return;
            }
            
            // Check if row is deleted
            const isRowDeleted = row.classList.contains('deleted-row') || row.dataset.deleted === 'true';
            
            // Extract headers and row data
            const headers = Array.from(document.querySelectorAll('#table-container thead th')).map(th => th.textContent.trim());
            const rowData = {};
            const allCells = row.querySelectorAll('td');
            
            allCells.forEach((td, index) => {
                const header = headers[index];
                if (header && header !== 'Picture') {
                    const select = td.querySelector('select');
                    const input = td.querySelector('input');
                    if (select) {
                        rowData[header] = select.value;
                        rowData[header + '_text'] = select.options[select.selectedIndex]?.text || select.value;
                    } else if (input) {
                        rowData[header] = input.value || '';
                    } else {
                        rowData[header] = td.textContent.trim() || '';
                    }
                }
            });
            
            // Get image from first img in row (if exists)
            const imgInRow = row.querySelector('img');
            if (imgInRow) {
                enlargedImage.src = imgInRow.src;
            }
            
            // Build prominent hazard source badge for quick context
            const hazardSource = DOMPurify.sanitize(rowData['Hazard Source'] || '‚Äî');

            const hazardBadge = `<div class="mt-2 inline-flex items-center">
                    <span class="px-3 py-1.5 rounded-lg text-sm font-bold border-2 border-[#991b1b] shadow-md" style="background-color: #fee2e2; color: #991b1b;" title="Hazard Source">
                        ‚ö†Ô∏è ${hazardSource}
                    </span>
                </div>`;

            // Update title and counter
            if (isRowDeleted) {
                taskTitle.innerHTML = `<div><span class="line-through opacity-60">Task ${currentModalRowIndex + 1}: ${DOMPurify.sanitize(rowData['Steps'] || 'Untitled')}</span> <span class="ml-2 text-red-500 text-sm font-normal">(Deleted)</span></div>${hazardBadge}`;
            } else {
                taskTitle.innerHTML = `<div>Task ${currentModalRowIndex + 1}: ${DOMPurify.sanitize(rowData['Steps'] || 'Untitled')}</div>${hazardBadge}`;
            }
            taskCounter.textContent = `${currentModalRowIndex + 1} / ${allModalRowIndices.length}`;
            
            // Update modal delete button state
            const modalDeleteBtn = document.getElementById('modalDeleteBtn');
            if (modalDeleteBtn) {
                if (isRowDeleted) {
                    modalDeleteBtn.textContent = t('‚Ü©Ô∏è Restore');
                    modalDeleteBtn.setAttribute('data-en-text', '‚Ü©Ô∏è Restore');
                    modalDeleteBtn.className = 'restore-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm';
                    modalDeleteBtn.title = 'Restore this task';
                } else {
                    modalDeleteBtn.textContent = t('üóëÔ∏è Delete');
                    modalDeleteBtn.setAttribute('data-en-text', 'üóëÔ∏è Delete');
                    modalDeleteBtn.className = 'delete-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm';
                    modalDeleteBtn.title = 'Delete this task';
                }
            }
            let formHtml = '';
            
            // Show deleted banner with restore button if row is deleted
            if (isRowDeleted) {
                formHtml += `<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-red-500 text-lg">üóëÔ∏è</span>
                            <span class="text-red-700 font-medium text-sm" data-en-text="This task has been deleted">This task has been deleted</span>
                        </div>
                        <button onclick="restoreRowFromModal(${rowIndex})" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold rounded-lg transition shadow-sm" data-en-text="‚Ü©Ô∏è Restore Task">
                            ‚Ü©Ô∏è Restore Task
                        </button>
                    </div>
                </div>`;
            }
            
            const editableFields = [
                'Steps', 'Hazard Group', 'Hazard List', 'Risk/Consequences',
                'Hazard Source', 'Current Control', 'Recommendation',
                'Routine/Non-Routine/Emergency Situation'
            ];
            
            editableFields.forEach(field => {
                if (rowData[field] !== undefined) {
                    const isSelect = headers.includes(field) && row.querySelector(`td:nth-child(${headers.indexOf(field) + 1}) select`);
                    const fieldId = `modal-${field.replace(/\//g, '-').replace(/\s/g, '_')}`;
                    const disabledAttr = isRowDeleted ? 'disabled' : '';
                    const deletedClass = isRowDeleted ? 'opacity-50 line-through bg-slate-100' : '';
                    
                    if (isSelect) {
                        // Get dropdown options
                        const selectOptions = row.querySelector(`td:nth-child(${headers.indexOf(field) + 1}) select`);
                        if (selectOptions) {
                            formHtml += `<div class="form-group ${isRowDeleted ? 'opacity-60' : ''}">
                                <label class="block text-sm font-medium text-slate-700 mb-1 ${isRowDeleted ? 'line-through' : ''}" data-en-text="${field}">${field}:</label>
                                <select id="${fieldId}" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm ${isRowDeleted ? 'bg-slate-100 cursor-not-allowed' : ''}" ${disabledAttr}>`;
                            
                            Array.from(selectOptions.options).forEach(opt => {
                                const selected = opt.value === rowData[field] ? 'selected' : '';
                                formHtml += `<option value="${opt.value}" ${selected}>${opt.text}</option>`;
                            });
                            
                            formHtml += `</select></div>`;
                        }
                    } else {
                        // Text area for text fields - Steps and Current Control get more rows
                        const rowCount = (field === 'Steps' || field === 'Current Control' || field === 'Hazard Source') ? 4 : 2;
                        formHtml += `<div class="form-group ${isRowDeleted ? 'opacity-60' : ''}">
                            <label class="block text-sm font-medium text-slate-700 mb-1 ${isRowDeleted ? 'line-through' : ''}" data-en-text="${field}">${field}:</label>
                            <textarea id="${fieldId}" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm resize-y ${isRowDeleted ? 'bg-slate-100 cursor-not-allowed' : ''}" rows="${rowCount}" ${disabledAttr}>${DOMPurify.sanitize(rowData[field])}</textarea>
                        </div>`;
                    }
                }
            });

            // Add Frequency, Severity, Likelihood dropdowns (horizontal layout)
            const ratingFields = ['Frequency', 'Severity', 'Likelihood'];
            formHtml += `<div class="form-group mt-4 pt-3 border-t border-slate-200">
                <label class="block text-sm font-medium text-slate-700 mb-2" data-en-text="Risk Rating:">Risk Rating:</label>
                <div class="grid grid-cols-3 gap-2">`;
            
            ratingFields.forEach(field => {
                const fieldId = `modal-${field}`;
                const selectEl = row.querySelector(`td:nth-child(${headers.indexOf(field) + 1}) select`);
                const disabledAttr = isRowDeleted ? 'disabled' : '';
                if (selectEl) {
                    formHtml += `<div class="${isRowDeleted ? 'opacity-60' : ''}">
                        <label class="block text-[10px] uppercase tracking-wide text-slate-500 mb-1 ${isRowDeleted ? 'line-through' : ''}" data-en-text="${field}">${field}</label>
                        <select id="${fieldId}" class="w-full p-1.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-xs ${isRowDeleted ? 'bg-slate-100 cursor-not-allowed' : ''}" ${disabledAttr}>`;
                    Array.from(selectEl.options).forEach(opt => {
                        const selected = opt.value === rowData[field] ? 'selected' : '';
                        formHtml += `<option value="${opt.value}" ${selected}>${opt.text}</option>`;
                    });
                    formHtml += `</select></div>`;
                }
            });
            
            formHtml += `</div></div>`;

            // Add Risk Score and Risk Category display
            const riskScore = rowData['Risk Score'] || '‚Äî';
            const riskCategory = rowData['Risk Category'] || '‚Äî';
            formHtml += `<div class="form-group mt-3 pt-3 border-t border-slate-200 ${isRowDeleted ? 'opacity-60' : ''}">
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase tracking-wide text-slate-500 mb-1 ${isRowDeleted ? 'line-through' : ''}" data-en-text="Risk Score">Risk Score</label>
                        <div id="modal-risk-score" class="text-lg font-bold text-slate-800 ${isRowDeleted ? 'line-through' : ''}">${riskScore}</div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase tracking-wide text-slate-500 mb-1 ${isRowDeleted ? 'line-through' : ''}" data-en-text="Risk Category">Risk Category</label>
                        <div id="modal-risk-category" class="text-sm font-semibold px-2 py-1 rounded inline-block ${isRowDeleted ? 'line-through' : ''}">${riskCategory}</div>
                    </div>
                </div>
            </div>`;
            
            // Add Risk Evolution visualization container
            formHtml += `<div id="riskEvolutionContainer" class="form-group mt-4 pt-4 border-t-2 border-dashed border-slate-300 ${isRowDeleted ? 'opacity-60' : ''}">
                <!-- Risk Evolution will be dynamically populated -->
            </div>`;
            
            editableForm.innerHTML = formHtml;

            // Apply category color styling
            const categoryEl = document.getElementById('modal-risk-category');
            if (categoryEl) {
                const cat = riskCategory.toLowerCase();
                if (cat.includes('critical')) {
                    categoryEl.classList.add('bg-red-100', 'text-red-700');
                } else if (cat.includes('high')) {
                    categoryEl.classList.add('bg-orange-100', 'text-orange-700');
                } else if (cat.includes('medium')) {
                    categoryEl.classList.add('bg-yellow-100', 'text-yellow-700');
                } else if (cat.includes('low')) {
                    categoryEl.classList.add('bg-green-100', 'text-green-700');
                } else {
                    categoryEl.classList.add('bg-slate-100', 'text-slate-700');
                }
            }
            
            // Auto-expand/collapse Risk Reduction Strategy based on risk category
            const riskReductionPanel = document.getElementById('riskReductionPanel');
            if (riskReductionPanel) {
                const cat = riskCategory.toLowerCase();
                // Expand for Critical and High, collapse for Medium and Low
                if (cat.includes('critical') || cat.includes('high')) {
                    riskReductionPanel.setAttribute('open', '');
                } else {
                    riskReductionPanel.removeAttribute('open');
                }
            }

            // Add listeners to recalculate risk score when F/S/L change
            const recalcModalRisk = () => {
                const freqSelect = document.getElementById('modal-Frequency');
                const sevSelect = document.getElementById('modal-Severity');
                const likeSelect = document.getElementById('modal-Likelihood');
                if (freqSelect && sevSelect && likeSelect) {
                    const f = parseFloat(freqSelect.value) || 1;
                    const s = parseFloat(sevSelect.value) || 1;
                    const l = parseFloat(likeSelect.value) || 1;
                    const score = f * s * l;
                    const scoreEl = document.getElementById('modal-risk-score');
                    const catEl = document.getElementById('modal-risk-category');
                    if (scoreEl) scoreEl.textContent = score.toFixed(2);
                    if (catEl) {
                        const newCat = getRiskCategory(score);
                        catEl.textContent = newCat;
                        catEl.className = 'text-sm font-semibold px-2 py-1 rounded inline-block';
                        const c = newCat.toLowerCase();
                        if (c.includes('critical')) catEl.classList.add('bg-red-100', 'text-red-700');
                        else if (c.includes('high')) catEl.classList.add('bg-orange-100', 'text-orange-700');
                        else if (c.includes('medium')) catEl.classList.add('bg-yellow-100', 'text-yellow-700');
                        else if (c.includes('low')) catEl.classList.add('bg-green-100', 'text-green-700');
                        else catEl.classList.add('bg-slate-100', 'text-slate-700');
                    }
                    
                    // UPDATE RISK EVOLUTION DYNAMICALLY
                    const evolutionContainer = document.getElementById('riskEvolutionContainer');
                    if (evolutionContainer) {
                        // Get the current controls from the selectedControlsMap
                        const controlKey = `row_${rowIndex}`;
                        const selectedControls = (window.selectedControlsMap && window.selectedControlsMap[controlKey]) || [];
                        const controlTypes = selectedControls.map(c => c.controlType);
                        
                        // Calculate projected score based on new risk score and existing controls
                        const projectedScore = calculateProjectedRiskScore(score, controlTypes);
                        
                        // Update the Risk Evolution visualization with the new scores
                        evolutionContainer.innerHTML = generateRiskEvolutionVisualization(
                            score,  // Use the new current score as baseline
                            score,  // Current is the new score
                            projectedScore, 
                            controlTypes.length
                        );
                    }
                }
            };
            ['modal-Frequency', 'modal-Severity', 'modal-Likelihood'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', recalcModalRisk);
            });

            // Highlight unknown/empty hazard group
            const hazardSelect = document.getElementById('modal-Hazard_Group');
            const hazardListSelect = document.getElementById('modal-Hazard_List');
            if (hazardSelect) {
                const value = hazardSelect.value?.toLowerCase() || '';
                const text = hazardSelect.selectedOptions[0]?.text?.toLowerCase() || '';
                if (!value || value === 'unknown' || text.includes('unknown')) {
                    hazardSelect.classList.add('modal-hazard-invalid');
                } else {
                    hazardSelect.classList.remove('modal-hazard-invalid');
                }
                hazardSelect.addEventListener('change', () => {
                    const v = hazardSelect.value?.toLowerCase() || '';
                    const t = hazardSelect.selectedOptions[0]?.text?.toLowerCase() || '';
                    if (!v || v === 'unknown' || t.includes('unknown')) {
                        hazardSelect.classList.add('modal-hazard-invalid');
                    } else {
                        hazardSelect.classList.remove('modal-hazard-invalid');
                    }
                });
            }

            // Keep hazard group in sync when hazard list changes inside the modal
            if (hazardListSelect && hazardSelect) {
                const applyHazardListValidity = () => {
                    if (!HAZARD_REGISTRY[hazardListSelect.value]) {
                        hazardListSelect.classList.add('modal-hazard-invalid');
                    } else {
                        hazardListSelect.classList.remove('modal-hazard-invalid');
                    }
                };
                applyHazardListValidity();
                hazardListSelect.addEventListener('change', () => {
                    const selectedHazard = hazardListSelect.value;
                    const hazardDetails = HAZARD_REGISTRY[selectedHazard];
                    const nextGroup = hazardDetails?.group || 'Unknown';
                    // Ensure the group option exists; if not, prepend it
                    const hasOption = Array.from(hazardSelect.options).some(opt => opt.value === nextGroup);
                    if (!hasOption && nextGroup !== 'Unknown') {
                        const opt = document.createElement('option');
                        opt.value = nextGroup;
                        opt.text = t(nextGroup);
                        hazardSelect.add(opt, 0);
                    }
                    hazardSelect.value = nextGroup;
                    const v = hazardSelect.value?.toLowerCase() || '';
                    const tText = hazardSelect.selectedOptions[0]?.text?.toLowerCase() || '';
                    if (!v || v === 'unknown' || tText.includes('unknown')) {
                        hazardSelect.classList.add('modal-hazard-invalid');
                    } else {
                        hazardSelect.classList.remove('modal-hazard-invalid');
                    }
                    applyHazardListValidity();
                });
            }

            // Highlight non-standard Risk/Consequences in modal
            const consequenceSelect = document.getElementById('modal-Risk-Consequences');
            if (consequenceSelect) {
                const applyConsequenceValidity = () => {
                    if (!CONSEQUENCE_REGISTRY.includes(consequenceSelect.value)) {
                        consequenceSelect.classList.add('modal-hazard-invalid');
                    } else {
                        consequenceSelect.classList.remove('modal-hazard-invalid');
                    }
                };
                applyConsequenceValidity();
                consequenceSelect.addEventListener('change', applyConsequenceValidity);
            }
            // --- RISK REDUCTION CALCULATION ---
            const riskReductionContainer = document.getElementById('riskReductionContainer');
            const counterMeasureLadder = document.getElementById('counterMeasureLadder');
            const counterMeasureDescription = document.getElementById('counterMeasureDescription');
            const addCounterMeasureBtn = document.getElementById('addCounterMeasureBtn');
            const selectedCounterMeasures = document.getElementById('selectedCounterMeasures');
            const noControlsMessage = document.getElementById('noControlsMessage');
            
            // Render the control hierarchy triangle
            renderControlTriangle();
            
            if (riskReductionContainer && counterMeasureLadder) {
                // Get current risk score from the actual table cell (not modal display)
                const riskScoreCell = row.querySelector('td.score');
                const currentRiskScore = riskScoreCell ? parseFloat(riskScoreCell.textContent.trim()) || 0 : (parseInt(rowData['Risk Score']) || 0);
                
                // For initial score, we use the current score as baseline (in this context, current IS the initial)
                // If you have a separate "initial" score stored, use that instead
                const initialRiskScore = currentRiskScore;
                
                // Store selected controls with descriptions (per row)
                // Structure: { controlType, description }
                window.selectedControlsMap = window.selectedControlsMap || {};
                const controlKey = `row_${rowIndex}`;
                if (!window.selectedControlsMap[controlKey]) {
                    window.selectedControlsMap[controlKey] = [];
                    
                    // Try to restore saved counter measures from row's data attribute
                    if (row.dataset.counterMeasures) {
                        try {
                            const savedControls = JSON.parse(row.dataset.counterMeasures);
                            window.selectedControlsMap[controlKey] = savedControls;
                        } catch (e) {
                            console.warn('Could not parse saved counter measures:', e);
                        }
                    }
                }
                const selectedControls = window.selectedControlsMap[controlKey];
                
                const updateRiskReduction = () => {
                    // Extract just the control types for calculation
                    const controlTypes = selectedControls.map(c => c.controlType);
                    const riskReductionHTML = generateRiskReductionVisualization(currentRiskScore, controlTypes, rowIndex);
                    riskReductionContainer.innerHTML = riskReductionHTML;
                    
                    // Calculate projected score for Risk Evolution
                    const projectedScore = calculateProjectedRiskScore(currentRiskScore, controlTypes);
                    
                    // Update Risk Evolution container
                    const evolutionContainer = document.getElementById('riskEvolutionContainer');
                    if (evolutionContainer) {
                        evolutionContainer.innerHTML = generateRiskEvolutionVisualization(
                            initialRiskScore, 
                            currentRiskScore, 
                            projectedScore, 
                            controlTypes.length
                        );
                    }
                    
                    // Update controls list visibility
                    if (selectedControls.length === 0) {
                        selectedCounterMeasures.innerHTML = '';
                        noControlsMessage.classList.remove('hidden');
                    } else {
                        noControlsMessage.classList.add('hidden');
                        selectedCounterMeasures.innerHTML = selectedControls.map((control, idx) => `
                            <div class="bg-white border border-blue-200 rounded-lg p-2 mb-2 text-xs">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-semibold text-slate-700">${control.controlType}</span>
                                    <button onclick="removeCounterMeasure(${rowIndex}, ${idx})" class="text-red-600 hover:text-red-800 font-bold text-sm" title="Remove this control">√ó</button>
                                </div>
                                ${control.description ? `<p class="text-slate-600 italic text-xs border-t border-blue-100 pt-1 mt-1">${DOMPurify.sanitize(control.description)}</p>` : ''}
                            </div>
                        `).join('');
                    }
                };
                
                // Add counter measure button click - remove old listeners by cloning
                const newAddBtn = addCounterMeasureBtn.cloneNode(true);
                addCounterMeasureBtn.parentNode.replaceChild(newAddBtn, addCounterMeasureBtn);
                
                newAddBtn.addEventListener('click', () => {
                    const selected = document.getElementById('counterMeasureLadder').value;
                    const description = document.getElementById('counterMeasureDescription').value.trim();
                    
                    if (!selected) {
                        showCustomAlert('Please select a control type from the hierarchy', 'warning');
                        return;
                    }
                    
                    selectedControls.push({ controlType: selected, description: description });
                    document.getElementById('counterMeasureLadder').value = ''; // Reset dropdown
                    document.getElementById('counterMeasureDescription').value = ''; // Reset description
                    document.getElementById('selectedControlDisplay').textContent = 'Click a level to select';
                    document.getElementById('selectedControlDisplay').style.background = '';
                    document.getElementById('selectedControlDisplay').style.color = '';
                    document.getElementById('selectedControlDisplay').style.fontWeight = '';
                    
                    // Clear triangle selection and reset all levels to normal
                    const triangleContainer = document.getElementById('controlTriangle');
                    const levels = triangleContainer.querySelectorAll('.control-level');
                    levels.forEach(level => {
                        level.classList.remove('selected');
                        level.style.filter = 'brightness(1)';
                        level.style.opacity = '1';
                    });
                    
                    updateRiskReduction();
                });
                
                // Make remove function global
                window.removeCounterMeasure = function(idx, controlIdx) {
                    const controlKey = `row_${idx}`;
                    if (window.selectedControlsMap[controlKey]) {
                        window.selectedControlsMap[controlKey].splice(controlIdx, 1);
                        
                        // Also update the row's dataset
                        const row = document.querySelector(`#table-container tr[data-row-index="${idx}"]`);
                        if (row) {
                            if (window.selectedControlsMap[controlKey].length === 0) {
                                // If all controls removed, clear the dataset and map entry
                                delete row.dataset.counterMeasures;
                                delete window.selectedControlsMap[controlKey];
                            } else {
                                // Update dataset with remaining controls
                                row.dataset.counterMeasures = JSON.stringify(window.selectedControlsMap[controlKey]);
                            }
                            // Update the actions indicator on the table
                            updateControlIndicator(idx);
                        }
                        
                        // Reload modal to update display
                        loadModalTaskDetails(idx);
                    }
                };
                
                // Initial rendering
                updateRiskReduction();
            }
            
            // Toggle EHS Standards section based on deleted state
            const ehsRefContent = document.getElementById('ehsRefContent');
            if (ehsRefContent) {
                if (isRowDeleted) {
                    ehsRefContent.classList.add('opacity-50', 'pointer-events-none');
                    ehsRefContent.style.filter = 'grayscale(0.5)';
                } else {
                    ehsRefContent.classList.remove('opacity-50', 'pointer-events-none');
                    ehsRefContent.style.filter = '';
                }
            }
            
            // Update next task preview if exists
            // Next task preview removed - no longer needed
            
            // Apply translations to modal content
            updateModalTranslations();
        }
        
        function updateNextTaskPreview() {
            // Function kept for compatibility but no longer displays preview
            // Elements were removed from modal footer
            return;
        }
        
        function saveModalChanges() {
            const row = document.querySelector(`#table-container tr[data-row-index="${allModalRowIndices[currentModalRowIndex]}"]`);
            if (!row) return;
            
            const headers = Array.from(document.querySelectorAll('#table-container thead th')).map(th => th.textContent.trim());
            const editableFields = [
                'Steps', 'Hazard Group', 'Hazard List', 'Risk/Consequences',
                'Hazard Source', 'Current Control', 'Recommendation',
                'Routine/Non-Routine/Emergency Situation'
            ];
            
            editableFields.forEach(field => {
                const fieldId = `modal-${field.replace(/\//g, '-').replace(/\s/g, '_')}`;
                const inputElement = document.getElementById(fieldId);
                
                if (inputElement) {
                    const headerIndex = headers.indexOf(field);
                    if (headerIndex >= 0) {
                        const cellElement = row.querySelectorAll('td')[headerIndex];
                        if (cellElement) {
                            const select = cellElement.querySelector('select');
                            const input = cellElement.querySelector('input');
                            
                            if (select) {
                                select.value = inputElement.value;
                            } else if (input) {
                                input.value = inputElement.value;
                            } else {
                                cellElement.textContent = inputElement.value;
                            }
                        }
                    }
                    // If hazard list changed, re-run linkage to auto-set parent hazard group/severity/likelihood
                    if (field === 'Hazard List') {
                        recalculateRow(allModalRowIndices[currentModalRowIndex], 'hazard');
                    }
                }
            });

            // Save Frequency, Severity, Likelihood
            ['Frequency', 'Severity', 'Likelihood'].forEach(field => {
                const modalEl = document.getElementById(`modal-${field}`);
                if (modalEl) {
                    const headerIndex = headers.indexOf(field);
                    if (headerIndex >= 0) {
                        const cellElement = row.querySelectorAll('td')[headerIndex];
                        const select = cellElement?.querySelector('select');
                        if (select) {
                            select.value = modalEl.value;
                        }
                    }
                }
            });

            // Recalculate the row's risk score and category
            recalculateRow(allModalRowIndices[currentModalRowIndex]);
            
            // Save counter measures with descriptions to the row's data
            const rowIndex = allModalRowIndices[currentModalRowIndex];
            const controlKey = `row_${rowIndex}`;
            if (window.selectedControlsMap && window.selectedControlsMap[controlKey]) {
                const controls = window.selectedControlsMap[controlKey];
                if (controls.length > 0) {
                    // Store controls as JSON string in a data attribute
                    row.dataset.counterMeasures = JSON.stringify(controls);
                    
                    // Also store in a readable summary in the Recommendation field
                    const summaryText = controls.map((c, idx) => {
                        return `${idx + 1}. [${c.controlType}] ${c.description || 'No description'}`;
                    }).join('\n\n');
                    
                    const recField = headers.indexOf('Recommendation');
                    if (recField >= 0) {
                        const recCell = row.querySelectorAll('td')[recField];
                        if (recCell) {
                            const recInput = recCell.querySelector('input');
                            if (recInput) {
                                recInput.value = summaryText;
                            }
                        }
                    }
                }
            }
            
            // Update control indicator on main table
            updateControlIndicator(allModalRowIndices[currentModalRowIndex]);
            
            showCustomAlert('Changes saved successfully!', 'success');
        }
        
        function navigateModal(direction) {
            // Save current changes before moving
            saveModalChanges();
            
            if (direction === 'next' && currentModalRowIndex < allModalRowIndices.length - 1) {
                currentModalRowIndex++;
                loadModalTaskDetails(allModalRowIndices[currentModalRowIndex]);
            } else if (direction === 'prev' && currentModalRowIndex > 0) {
                currentModalRowIndex--;
                loadModalTaskDetails(allModalRowIndices[currentModalRowIndex]);
            }
        }

        function closeTableImageModal() {
            const modal = document.getElementById('tableImageModal');
            if (modal) {
                // Save changes before closing
                saveModalChanges();
                modal.style.display = 'none';
                // Clear content
                document.getElementById('modalEnlargedImage').src = ""; 
                document.getElementById('modalEditableForm').innerHTML = "";
            }
        }

        // Add event listeners for closing the new modal
        document.addEventListener('DOMContentLoaded', () => {
             // Set language selector to saved value and apply translations
             const langSelect = document.getElementById('langSelect');
             if (langSelect) {
                 langSelect.value = currentLang;
                 updateUIText(); // Apply translations on page load
             }

             const closeBtn = document.getElementById('closeTableImageModal');
             const modal = document.getElementById('tableImageModal');
             if (closeBtn) {
                 closeBtn.onclick = closeTableImageModal;
             }
             
             // Modal button listeners
             const modalPrevBtn = document.getElementById('modalPrevBtn');
             const modalNextBtn = document.getElementById('modalNextBtn');
             const modalCancelBtn = document.getElementById('modalCancelBtn');
             const modalFooterPrevBtn = document.getElementById('modalFooterPrevBtn');
             const modalFooterNextBtn = document.getElementById('modalFooterNextBtn');
             const modalDeleteBtn = document.getElementById('modalDeleteBtn');
             
             if (modalPrevBtn) modalPrevBtn.addEventListener('click', () => navigateModal('prev'));
             if (modalNextBtn) modalNextBtn.addEventListener('click', () => navigateModal('next'));
             if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeTableImageModal);
             if (modalFooterPrevBtn) modalFooterPrevBtn.addEventListener('click', () => navigateModal('prev'));
             if (modalFooterNextBtn) modalFooterNextBtn.addEventListener('click', () => navigateModal('next'));
             if (modalDeleteBtn) modalDeleteBtn.addEventListener('click', function() {
                 if (currentModalRowIndex >= 0 && currentModalRowIndex < allModalRowIndices.length) {
                     const rowIndex = allModalRowIndices[currentModalRowIndex];
                     toggleRowDelete(rowIndex, modalDeleteBtn);
                     // Reload modal to show updated state
                     loadModalTaskDetails(rowIndex);
                 }
             });
             
             // EHS Reference Toggle
             const ehsRefToggleBtn = document.getElementById('ehsRefToggleBtn');
             const ehsRefContent = document.getElementById('ehsRefContent');
             const ehsRefToggleIcon = document.getElementById('ehsRefToggleIcon');
             
             if (ehsRefToggleBtn && ehsRefContent) {
                 ehsRefToggleBtn.addEventListener('click', () => {
                     ehsRefContent.classList.toggle('hidden');
                     // Change icon direction
                     if (ehsRefContent.classList.contains('hidden')) {
                         ehsRefToggleIcon.textContent = '‚ñ∂Ô∏è';
                     } else {
                         ehsRefToggleIcon.textContent = '‚ñºÔ∏è';
                         // Auto-scroll the modal form container to bottom to show Risk Rating section
                         setTimeout(() => {
                             const editableForm = document.getElementById('modalEditableForm');
                             if (editableForm && editableForm.parentElement) {
                                 const scrollContainer = editableForm.parentElement.parentElement;
                                 scrollContainer.scrollTop = scrollContainer.scrollHeight;
                             }
                         }, 100);
                     }
                 });
             }
             
             // EHS Table Click Handlers - Select and populate modal dropdowns
             const ehsFreqRows = document.querySelectorAll('.ehs-freq- earow');
             const ehsSevRows = document.querySelectorAll('.ehs-sev-row');
             const ehsLikeRows = document.querySelectorAll('.ehs-like-row');
             
             ehsFreqRows.forEach(row => {
                 row.addEventListener('click', () => {
                     if (window.isCurrentModalRowDeleted()) {
                         showCustomAlert('‚ö†Ô∏è Cannot modify a deleted task. Restore it first.', 'warning');
                         return;
                     }
                     const freqValue = row.getAttribute('data-freq-value');
                     // Find frequency dropdown in modal form
                     const freqSelect = document.querySelector('#modal-Frequency');
                     if (freqSelect && !freqSelect.disabled) {
                         freqSelect.value = freqValue;
                         freqSelect.dispatchEvent(new Event('change'));
                         showCustomAlert(`‚úÖ Frequency set to: ${freqValue}`, 'success');
                     } else {
                         console.warn('Frequency dropdown not found in modal or is disabled');
                     }
                 });
             });
             
             ehsSevRows.forEach(row => {
                 row.addEventListener('click', () => {
                     if (window.isCurrentModalRowDeleted()) {
                         showCustomAlert('‚ö†Ô∏è Cannot modify a deleted task. Restore it first.', 'warning');
                         return;
                     }
                     const sevValue = row.getAttribute('data-sev-value');
                     // Find severity dropdown in modal form
                     const sevSelect = document.querySelector('#modal-Severity');
                     if (sevSelect && !sevSelect.disabled) {
                         sevSelect.value = sevValue;
                         sevSelect.dispatchEvent(new Event('change'));
                         showCustomAlert(`‚úÖ Severity set to: ${sevValue}`, 'success');
                     } else {
                         console.warn('Severity dropdown not found in modal or is disabled');
                     }
                 });
             });
             
             ehsLikeRows.forEach(row => {
                 row.addEventListener('click', () => {
                     if (window.isCurrentModalRowDeleted()) {
                         showCustomAlert('‚ö†Ô∏è Cannot modify a deleted task. Restore it first.', 'warning');
                         return;
                     }
                     const likeValue = row.getAttribute('data-like-value');
                     // Find likelihood dropdown in modal form
                     const likeSelect = document.querySelector('#modal-Likelihood');
                     if (likeSelect && !likeSelect.disabled) {
                         likeSelect.value = likeValue;
                         likeSelect.dispatchEvent(new Event('change'));
                         showCustomAlert(`‚úÖ Likelihood set to: ${likeValue}`, 'success');
                     } else {
                         console.warn('Likelihood dropdown not found in modal or is disabled');
                     }
                 });
             });
             
             // Keyboard navigation for modal
             document.addEventListener('keydown', (event) => {
                 if (modal.style.display === 'flex') {
                     if (event.key === 'ArrowRight') {
                         event.preventDefault();
                         navigateModal('next');
                     } else if (event.key === 'ArrowLeft') {
                         event.preventDefault();
                         navigateModal('prev');
                     } else if (event.key === 'Escape') {
                         closeTableImageModal();
                     }
                 }
             });
             
             // Close if clicking outside the modal content
             if (modal) {
                 modal.addEventListener('click', (event) => {
                     if (event.target === modal) { // Check if the click was directly on the overlay
                         closeTableImageModal();
                     }
                 });
             }

             // --- LANGUAGE SELECTOR LISTENER ---
             const langSelect2 = document.getElementById('langSelect');
             if (langSelect2) {
                 langSelect2.addEventListener('change', (e) => {
                     currentLang = e.target.value;
                     localStorage.setItem('appLanguage', currentLang); // Save to localStorage
                     console.log(`Language changed to: ${currentLang}`);
                     updateUIText(); // Update all UI text
                     updateModalTranslations(); // Update modal text if modal is open
                     // Refresh all table dropdowns when language changes
                     const tableContainer = document.getElementById('table-container');
                     if (tableContainer) {
                         // Re-render all dropdowns by replacing their HTML
                         const allSelects = tableContainer.querySelectorAll('select');
                         allSelects.forEach(select => {
                             const parent = select.parentElement;
                             const onChange = select.getAttribute('onchange');
                             const currentValue = select.value;
                             const headerCells = tableContainer.querySelector('table thead tr').children;
                             const cellIndex = Array.from(select.closest('tr').children).indexOf(parent);
                             const headerText = cellIndex < headerCells.length ? headerCells[cellIndex].textContent.trim() : '';
                             
                             // Determine dropdown type and rebuild
                             if (parent.className.includes('group')) {
                                 // Hazard Group dropdown
                                 parent.innerHTML = window.createHazardGroupDropdown(currentValue);
                             } else if (headerText === 'Frequency') {
                                 parent.innerHTML = window.createDropdown(FREQUENCY_SCALE, currentValue, onChange);
                             } else if (headerText === 'Severity') {
                                 parent.innerHTML = window.createDropdown(SEVERITY_SCALE, currentValue, onChange);
                             } else if (headerText === 'Likelihood') {
                                 parent.innerHTML = window.createDropdown(LIKELIHOOD_SCALE, currentValue, onChange);
                             } else if (headerText === 'Hazard List') {
                                 // Hazard list dropdown - rebuild with translations
                                 parent.innerHTML = window.createTextDropdown(Object.keys(HAZARD_REGISTRY), currentValue, onChange);
                             } else if (headerText === 'Risk/Consequences') {
                                 // Risk/Consequences dropdown - rebuild with translations
                                 parent.innerHTML = window.createTextDropdown(CONSEQUENCE_REGISTRY, currentValue, onChange);
                             }
                         });
                         // Update risk category colors with current language
                         updateAllCategoryColors();
                     }
                     // Refresh open modal form to reflect translated dropdown text
                     const tableImageModal = document.getElementById('tableImageModal');
                     if (tableImageModal && tableImageModal.style.display === 'flex' &&
                         typeof currentModalRowIndex !== 'undefined' && allModalRowIndices?.length) {
                         // Preserve any edits by saving first, then reload UI in the new language
                         saveModalChanges();
                         loadModalTaskDetails(allModalRowIndices[currentModalRowIndex]);
                     }
                     // Toggle "How to Use This App" sections based on language
                     const howToUseEn = document.getElementById('howToUse-en');
                     const howToUseFr = document.getElementById('howToUse-fr');
                     const howToUseDe = document.getElementById('howToUse-de');
                     if (howToUseEn && howToUseFr && howToUseDe) {
                         howToUseEn.style.display = currentLang === 'en' ? 'block' : 'none';
                         howToUseFr.style.display = currentLang === 'fr' ? 'block' : 'none';
                         howToUseDe.style.display = currentLang === 'de' ? 'block' : 'none';
                     }
                 });
             }
             // --- END LANGUAGE SELECTOR LISTENER ---
        });
        // --- END NEW Modal Functions ---
        // --- DELETE your entire window.convertToCSV function ---

/**
¬†* Reusable helper to generate the Risk Assessment Table CSV content.
 * @param {Map<string, string>} [imageNameMap=new Map()] A map of imageId -> sanitizedFileName.
¬†* @returns {string} The CSV content as a string.
¬†*/
function generateRiskTableCSV(imageNameMap = new Map()) {
    const table = document.querySelector('#table-container table');
    if (!table) {
        console.error("CSV Export Error: Could not find the risk assessment table.");
        throw new Error("Could not find the table data to export.");
    }
    // Build a merged image name map (originalFileNames + provided imageNameMap)
    try {
        const merged = new Map();
        const galleryImgs = Array.from(document.querySelectorAll('.gallery-item img'));
        if (window.originalFileNames) {
            window.originalFileNames.forEach((orig, id) => {
                const idx = Math.max(0, galleryImgs.findIndex(img => img.id === id));
                merged.set(id, createFinalFileName(orig, idx));
            });
        }
        if (imageNameMap && imageNameMap.size > 0) {
            imageNameMap.forEach((fname, id) => merged.set(id, fname));
        }
        imageNameMap = merged;
        console.log('imageNameMap for CSV:', Array.from(imageNameMap)); // Log the full map
    } catch (e) {
        console.warn('Error while building imageNameMap for CSV export:', e);
    }
    const headerCells = Array.from(table.querySelector('thead tr').querySelectorAll('th'));
    const headers = headerCells.map(th => th.innerText.trim());
    console.log('Table headers:', headers); // Log headers to check case
    const csv = [];
    csv.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','));
    const galleryImages = Array.from(document.querySelectorAll('.gallery-item img'));
    table.querySelectorAll('tbody tr').forEach(row => {
        // Skip rows the user has marked deleted (struck-through)
        if (row.classList.contains('deleted-row') || row.dataset.deleted === 'true') {
            console.debug(`Skipping deleted row ${row.dataset.rowIndex}`);
            return; // skip this row in CSV
        }
        const cells = row.querySelectorAll('td');
        const parts = [];
        headers.forEach((header, colIndex) => {
            const cell = cells[colIndex];
            if (!cell) { parts.push('""'); return; }
            if (header.toLowerCase() === 'picture') { // Case-insensitive
                console.log(`Processing Picture for row ${row.dataset.rowIndex}: imageId=${row.dataset.imageId}`);
                const imageId = row.dataset.imageId || '';
                let filename = '';
                // 1) direct mapping from merged map
                if (imageId && imageNameMap && imageNameMap.has(imageId)) {
                    filename = imageNameMap.get(imageId);
                    console.log(`  Fallback 1 (map): ${filename}`);
                }
                // 2) originalFileNames fallback
                if (!filename && window.originalFileNames && window.originalFileNames.has(imageId)) {
                    const orig = window.originalFileNames.get(imageId);
                    const idx = Math.max(0, galleryImages.findIndex(img => img.id === imageId));
                    filename = createFinalFileName(orig, idx);
                    console.log(`  Fallback 2 (originalFileNames): ${filename}`);
                }
                // 3) picture cell dataset (set when table was populated)
                if (!filename) {
                    const pictureCell = row.querySelector('.picture-cell');
                    if (pictureCell && pictureCell.dataset && pictureCell.dataset.filename) {
                        const orig = pictureCell.dataset.filename;
                        const idx = parseInt(row.dataset.rowIndex, 10) || 0;
                        filename = createFinalFileName(orig, idx);
                        console.log(`  Fallback 3 (cell dataset): ${filename}`);
                    }
                }
                // 4) try to match by thumbnail src
                if (!filename) {
                    const pictureCell = row.querySelector('.picture-cell');
                    const imgTag = pictureCell ? pictureCell.querySelector('img') : null;
                    if (imgTag && imgTag.src) {
                        const match = galleryImages.find(g => g.src === imgTag.src || g.src === imgTag.getAttribute('data-src'));
                        if (match) {
                            const matchedId = match.id;
                            filename = (imageNameMap && imageNameMap.get(matchedId)) || (window.originalFileNames && window.originalFileNames.get(matchedId)) || matchedId;
                            if (window.originalFileNames && window.originalFileNames.get(matchedId)) {
                                filename = createFinalFileName(window.originalFileNames.get(matchedId), Math.max(0, galleryImages.indexOf(match)));
                            }
                            console.log(`  Fallback 4 (thumbnail src): ${filename}`);
                        }
                    }
                }
                // 5) final fallback: synthesize from first gallery image or imageId
                if (!filename) {
                    if (galleryImages.length > 0) {
                        const g0 = galleryImages[0];
                        const orig = (window.originalFileNames && window.originalFileNames.get(g0.id)) || g0.id || imageId || '';
                        filename = orig ? createFinalFileName(orig, 0) : '';
                        console.log(`  Fallback 5 (synthesize from first image): ${filename}`);
                    }
                }
                // 6) ultimate fallback: use row index + cellFilename if available
                if (!filename) {
                    const pictureCell = row.querySelector('.picture-cell');
                    const orig = pictureCell?.dataset.filename || `row_${row.dataset.rowIndex}`;
                    const idx = parseInt(row.dataset.rowIndex, 10) || 0;
                    filename = createFinalFileName(orig, idx);
                    console.log(`  Fallback 6 (row index + cellFilename): ${filename}`);
                }
                parts.push(`"${(filename || '').replace(/"/g, '""')}"`);
                return;
            }
            // Generic cell types: select, input, textarea, or plain text
            let value = '';
            const sel = cell.querySelector('select');
            const inp = cell.querySelector('input');
            const ta = cell.querySelector('textarea');
            if (sel) value = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : sel.value;
            else if (inp) value = inp.value;
            else if (ta) value = ta.value;
            else value = cell.innerText.trim();
            parts.push(`"${(value || '').replace(/\r?\n|\r/g, ' ').replace(/"/g, '""')}"`);
        });
        csv.push(parts.join(','));
    });
    if (csv.length <= 1) throw new Error('No data available in the table to export.');
    return csv.join('\n');
}

// New function to generate the arranged CSV
function generateArrangedRiskCSV(imageNameMap = new Map()) {
    const { headers, rows } = extractTableData();
    if (rows.length === 0) {
        return "No risk table data available.";
    }
    
    // Translate CSV headers based on current language
    const csvHeaders = ["Sequence", "Task Steps", "Hazard Group", "Hazard List", "Risk/Consequences", "Picture Name", "Hazard Source", "Current Controls", "Routine", "Frequency", "Severity", "Likelihood", "Risk Score"];
    const translatedHeaders = csvHeaders.map(h => t(h));
    
    const csv = [translatedHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',')];
    
    // Get deleted row indices to skip them
    const deletedRowIndices = new Set();
    try {
        const deletedRows = document.querySelectorAll('#table-container tbody tr.deleted-row, #table-container tbody tr[data-deleted="true"]');
        deletedRows.forEach(row => {
            const idx = row.dataset.rowIndex;
            if (idx !== undefined) deletedRowIndices.add(parseInt(idx, 10));
        });
    } catch (e) {
        console.warn('Could not determine deleted rows for arranged CSV:', e);
    }
    
    // Group rows by 'Steps' while preserving order
    let currentStep = null;
    let stepNum = 0;
    let subNum = 0;
    
    rows.forEach((row, originalRowIndex) => {
        // Skip deleted rows
        if (deletedRowIndices.has(originalRowIndex)) {
            console.debug(`Skipping deleted row ${originalRowIndex} from arranged CSV`);
            return;
        }

        const thisStep = row.Steps || '';
        if (thisStep !== currentStep) {
            stepNum++;
            subNum = 0;
            currentStep = thisStep;
        }
        subNum += 10; // Increment by 10 for sub-numbers like .10, .20
        const sequence = `${stepNum}.${subNum.toString().padStart(2, '0')}`;
        
        const imageId = row.imageId || '';
        let pictureName = '';
        if (imageId && imageNameMap.has(imageId)) {
            pictureName = imageNameMap.get(imageId);
        } else if (imageId && window.originalFileNames.has(imageId)) {
            // Fallback to original name if map misses it
            const orig = window.originalFileNames.get(imageId);
            const idx = rows.indexOf(row); // Approximate index
            pictureName = createFinalFileName(orig, idx);
        }
        
        // Translate dropdown values based on current language
        const frequency = row.Frequency ? t(row.Frequency.split(' - ')[1] || row.Frequency) : '';
        const severity = row.Severity ? t(row.Severity.split(' - ')[1] || row.Severity) : '';
        const likelihood = row.Likelihood ? t(row.Likelihood.split(' - ')[1] || row.Likelihood) : '';
        const hazardGroup = row["Hazard Group"] ? t(row["Hazard Group"]) : '';
        const hazardList = row["Hazard List"] ? t(row["Hazard List"]) : '';
        const consequence = row["Risk/Consequences"] ? t(row["Risk/Consequences"]) : '';
        
        const parts = [
            sequence,
            row.Steps || '',
            hazardGroup,
            hazardList,
            consequence,
            pictureName || '',
            row["Hazard Source"] || '',
            row["Current Control"] || '', // Assuming this is the field; adjust if named differently
            row["Routine/Non-Routine/Emergency Situation"] || '',
            frequency,
            severity,
            likelihood,
            row["Risk Score"] || ''
        ].map(v => `"${(v + '').replace(/"/g, '""')}"`).join(',');
        
        csv.push(parts);
    });
    
    return csv.join('\n');
}

/**
 * Generates CSV content from the global window.riskAssessmentData.
 * @returns {string} The CSV content as a string.
 */
/**
¬†* Generates CSV content from the provided imageDataArray.
¬†* @param {Array} imageDataArray - The array of image data objects.
¬†* @returns {string} The CSV content as a string.
¬†*/
function createImageNotesCSV(imageDataArray) {
¬† ¬† // Check if the passed array is empty or invalid
¬† ¬† if (!imageDataArray || imageDataArray.length === 0) {
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // --- FALLBACK ---
¬† ¬† ¬† ¬† // If the array is empty, try reading from the global state one last time.
¬† ¬† ¬† ¬† if (!window.riskAssessmentData || window.riskAssessmentData.size === 0) {
¬† ¬† ¬† ¬† ¬† ¬† return "No image notes found."; // Truly no notes
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // If global state has data, build CSV from that
¬† ¬† ¬† ¬† let csv_fallback = [];
¬† ¬† ¬† ¬† csv_fallback.push('"ImageID","OriginalFileName","Description","Hazards","Controls"');
¬† ¬† ¬† ¬† window.riskAssessmentData.forEach((data, imgId) => {
¬† ¬† ¬† ¬† ¬† ¬† const fileName = window.originalFileNames.get(imgId) || 'N/A';
¬† ¬† ¬† ¬† ¬† ¬† const sanitize = (text) => `"${(text || '').replace(/"/g, '""').replace(/\r?\n|\r/g, " ")}"`;
¬† ¬† ¬† ¬† ¬† ¬† let row = [];
¬† ¬† ¬† ¬† ¬† ¬† row.push(`"${imgId}"`);
¬† ¬† ¬† ¬† ¬† ¬† row.push(`"${fileName.replace(/"/g, '""')}"`);
¬† ¬† ¬† ¬† ¬† ¬† row.push(sanitize(data.description));
¬† ¬† ¬† ¬† ¬† ¬† row.push(sanitize(data.hazards));
¬† ¬† ¬† ¬† ¬† ¬† row.push(sanitize(data.controls));
¬† ¬† ¬† ¬† ¬† ¬† csv_fallback.push(row.join(','));
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† return csv_fallback.join('\n');
¬† ¬† ¬† ¬† // --- END FALLBACK ---
¬† ¬† }

¬† ¬† // --- Primary Logic (using the passed array) ---
¬† ¬† let csv = [];
¬† ¬† csv.push('"DownloadFileName","Description","Hazards","Controls"'); // <<< CHANGED
¬† ¬†¬†
¬† ¬† imageDataArray.forEach((item) => {
¬† ¬† ¬† ¬† const data = item.riskData;
¬† ¬† ¬† ¬† const fileName = item.fileName || 'N/A'; // <<< CHANGED
¬† ¬† ¬† ¬† const sanitize = (text) => `"${(text || '').replace(/"/g, '""').replace(/\r?\n|\r/g, " ")}"`;
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† let row = [];
¬† ¬† ¬† ¬† row.push(`"${fileName.replace(/"/g, '""')}"`);
¬† ¬† ¬† ¬† row.push(sanitize(data.description));
¬† ¬† ¬† ¬† row.push(sanitize(data.hazards));
¬† ¬† ¬† ¬† row.push(sanitize(data.controls));
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† csv.push(row.join(','));
¬† ¬† });

¬† ¬† return csv.join('\n');
}


/**
¬†* Main function to generate and download the complete project ZIP.
¬†*/
/**
 * Main function to generate and download the complete project ZIP.
 */
/**
 * Generate CSV file for proposed action items / counter measures
 */
function generateActionsCSV() {
    const rows = document.querySelectorAll('#table-container tbody tr');
    const headers = Array.from(document.querySelectorAll('#table-container thead th')).map(th => th.textContent.trim());
    
    const csvHeaders = ['Row_ID','Task_Step','Hazard_Description','Current_Risk_Score','Control_Type','Control_Description','Projected_Risk_Score','Risk_Reduction_Percent','Status'];
    let csvRows = [csvHeaders.map(h => `"${h}"`).join(',')];
    
    const controlEffectiveness = {'Eliminate': 1.00, 'Substitute': 0.65, 'Engineer': 0.55, 'Visual': 0.45, 'Admin': 0.30, 'Individual': 0.15};
    
    rows.forEach((row, index) => {
        if (row.classList.contains('deleted-row') || row.dataset.deleted === 'true') return;
        
        const rowIndex = row.getAttribute('data-row-index') || index;
        let counterMeasures = [];
        
        if (row.dataset.counterMeasures) {
            try { counterMeasures = JSON.parse(row.dataset.counterMeasures); } catch (e) {}
        }
        if (window.selectedControlsMap && window.selectedControlsMap[`row_${rowIndex}`]) {
            counterMeasures = window.selectedControlsMap[`row_${rowIndex}`];
        }
        if (counterMeasures.length === 0) return;
        
        const cells = row.querySelectorAll('td');
        const stepsIndex = headers.indexOf('Steps');
        const hazardSourceIndex = headers.indexOf('Hazard Source');
        const riskScoreIndex = headers.indexOf('Risk Score');
        
        const taskStep = stepsIndex >= 0 && cells[stepsIndex] ? cells[stepsIndex].textContent.trim() : '';
        const hazardDesc = hazardSourceIndex >= 0 && cells[hazardSourceIndex] ? (cells[hazardSourceIndex].querySelector('input')?.value || cells[hazardSourceIndex].textContent.trim()) : '';
        const currentRiskScore = riskScoreIndex >= 0 && cells[riskScoreIndex] ? parseInt(cells[riskScoreIndex].textContent.trim()) || 0 : 0;
        
        const hardControls = counterMeasures.filter(c => ['Substitute', 'Engineer'].includes(c.controlType || c));
        const softControls = counterMeasures.filter(c => ['Admin', 'Visual', 'Individual'].includes(c.controlType || c));
        const hasEliminate = counterMeasures.some(c => (c.controlType || c) === 'Eliminate');
        
        let projectedScore = currentRiskScore;
        if (hasEliminate) {
            projectedScore = 0;
        } else {
            let hardMult = 1, softMult = 1;
            hardControls.forEach((ctrl, i) => { hardMult *= (1 - (controlEffectiveness[ctrl.controlType || ctrl] || 0) * Math.pow(0.4, i)); });
            softControls.forEach((ctrl, i) => { softMult *= (1 - (controlEffectiveness[ctrl.controlType || ctrl] || 0) * Math.pow(0.5, i)); });
            projectedScore = Math.round(currentRiskScore * Math.max(hardMult, 0.35) * Math.max(softMult, 0.50));
        }
        
        const reductionPercent = currentRiskScore > 0 ? Math.round(100 * (currentRiskScore - projectedScore) / currentRiskScore) : 0;
        const sanitize = (text) => `"${(text || '').replace(/"/g, '""').replace(/\r?\n|\r/g, " ")}"`;
        
        counterMeasures.forEach((control) => {
            csvRows.push([`"${rowIndex}"`, sanitize(taskStep), sanitize(hazardDesc), `"${currentRiskScore}"`, sanitize(control.controlType || control), sanitize(control.description || ''), `"${projectedScore}"`, `"${reductionPercent}%"`, `"Proposed"`].join(','));
        });
    });
    
    if (csvRows.length === 1) csvRows.push('"--","No proposed actions have been added yet","--","--","--","--","--","--","--"');
    return csvRows.join('\n');
}

async function downloadProjectZip() {
    const btn = document.getElementById('downloadProjectZipBtn');
    if (!btn) return;
    
    if (typeof JSZip === 'undefined' || typeof window.addImagesToZip === 'undefined') {
        showCustomAlert("Error: Critical download libraries (JSZip, addImagesToZip) are not available.", 'error');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Zipping...';
    
    try {
        const zip = new JSZip();

        // 1. Get image data, promises, AND the new imageNameMap
        const { imageDataArray, fetchPromises, imageNameMap } = await window.addImagesToZip(zip);
        
        // 2. WAIT for all images to be fetched AND for imageDataArray to be populated
        await Promise.all(fetchPromises);

        // 3. Pass the populated imageDataArray to the image_notes.csv function
        const imageNotesCSV = createImageNotesCSV(imageDataArray); 
        // FIX: Prepend \uFEFF so Excel recognizes it as UTF-8
        zip.file("image_notes.csv", "\uFEFF" + imageNotesCSV);
        
        // 4. Add the Arranged Risk Table CSV (passing the new map, excludes deleted rows)
        try {
            zip.file("arranged_risk_table.csv", "\uFEFF" + generateArrangedRiskCSV(imageNameMap)); 
        } catch (e) {
            zip.file("arranged_risk_table.csv", `Error: ${e.message}`);
        }

        // 5. Generate Shareable HTML Report (NEW!)
        try {
            if (typeof window.generateShareableHTML === 'function') {
                const shareableHTML = await window.generateShareableHTML(imageNameMap);
                if (shareableHTML) {
                    zip.file("Risk_Assessment_Report.html", shareableHTML);
                    console.log("‚úÖ Shareable HTML report added to ZIP");
                }
            }
        } catch (e) {
            console.warn("Could not generate shareable HTML:", e);
        }

        // 6. Add Proposed Actions CSV (Counter Measures)
        try {
            const actionsCSV = generateActionsCSV();
            zip.file("proposed_actions.csv", "\uFEFF" + actionsCSV);
            console.log("‚úÖ Proposed actions CSV added to ZIP");
        } catch (e) {
            console.warn("Could not generate actions CSV:", e);
            zip.file("proposed_actions.csv", "\uFEFF\"Error\",\"Could not generate actions CSV: " + e.message + "\"");
        }

        // 7. Generate and Download
        const content = await zip.generateAsync({ type: "blob" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = "Complete_Risk_Project.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);

    } catch (error) {
        console.error("Error generating project ZIP:", error);
        showCustomAlert(`An error occurred: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Download Project ZIP';
    }
}

// Attach the listener for the new button
document.addEventListener('DOMContentLoaded', () => {
    const projectZipBtn = document.getElementById('downloadProjectZipBtn');
    if (projectZipBtn) {
        projectZipBtn.addEventListener('click', downloadProjectZip);
    }
});

// --- RISK EVOLUTION VISUALIZATION ---
function generateRiskEvolutionVisualization(initialScore, currentScore, projectedScore, controlCount) {
    // Ensure scores are valid numbers (but allow 0 for eliminated risk)
    initialScore = parseFloat(initialScore) || 0;
    currentScore = parseFloat(currentScore) || 0;
    projectedScore = (projectedScore !== null && projectedScore !== undefined) ? parseFloat(projectedScore) : currentScore;
    
    // Color function based on score
    const getColorForScore = (score) => {
        if (score <= 19) return '#16a34a'; // Low - Green
        if (score <= 49) return '#eab308'; // Medium - Yellow
        if (score <= 71) return '#f97316'; // High - Orange
        return '#dc2626'; // Critical - Red
    };
    
    const initColor = getColorForScore(initialScore);
    const projColor = getColorForScore(projectedScore);
    
    // Calculate reduction percentage (initial to projected)
    const totalReduction = initialScore > 0 ? Math.round(((initialScore - projectedScore) / initialScore) * 100) : 0;
    
    const hasControls = controlCount > 0;
    const showProjected = hasControls && projectedScore !== initialScore;
    
    let html = `
        <div style="font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
            üìä Risk Evolution
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
            
            <!-- Initial Risk (Solid) -->
            <div style="flex: 1; min-width: 90px; background: ${initColor}; border-radius: 8px; padding: 10px 8px; text-align: center; color: white; position: relative; box-shadow: 0 2px 8px ${initColor}40;">
                <div style="font-size: 9px; font-weight: 700; text-transform: uppercase;">Initial</div>
                <div style="font-size: 24px; font-weight: 900;">${Math.round(initialScore)}</div>
            </div>`;
    
    // Only show projected if controls are added
    if (showProjected) {
        html += `
            <!-- Arrow -->
            <div style="color: #3b82f6; font-size: 18px; font-weight: bold;">‚ûú</div>
            
            <!-- Projected/Target Risk -->
            <div style="flex: 1; min-width: 90px; border: 3px solid ${projColor}; background: linear-gradient(135deg, #eff6ff, #ffffff); border-radius: 8px; padding: 10px 8px; text-align: center; position: relative; box-shadow: 0 2px 8px ${projColor}30;">
                <div style="font-size: 9px; font-weight: 700; color: #1e40af; text-transform: uppercase;">Target</div>
                <div style="font-size: 24px; font-weight: 900; color: ${projColor};">${Math.round(projectedScore)}</div>
                ${totalReduction > 0 ? `<div style="position: absolute; top: -8px; right: -8px; background: #dcfce7; color: #15803d; border: 2px solid #22c55e; font-size: 9px; font-weight: 800; padding: 2px 5px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">-${totalReduction}%</div>` : ''}
                <div style="position: absolute; bottom: -18px; left: 0; width: 100%; font-size: 9px; color: #3b82f6; font-weight: 600; white-space: nowrap;">(${controlCount} pending)</div>
            </div>`;
    } else if (!hasControls) {
        html += `
            <!-- Placeholder for no controls -->
            <div style="color: #cbd5e1; font-size: 18px; font-weight: bold;">‚ûú</div>
            <div style="flex: 1; min-width: 90px; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 10px 8px; text-align: center; background: #f8fafc;">
                <div style="font-size: 9px; font-weight: 600; color: #94a3b8; text-transform: uppercase;">Target</div>
                <div style="font-size: 12px; color: #94a3b8; font-style: italic;">Add controls ‚Üí</div>
            </div>`;
    }
    
    html += `</div>`;
    
    // Add total reduction summary if there are controls
    if (showProjected && totalReduction > 0) {
        html += `
        <div style="margin-top: 16px; padding: 8px 12px; background: linear-gradient(135deg, #ecfdf5, #f0fdf4); border: 1px solid #a7f3d0; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
            <div style="font-size: 11px; color: #047857; font-weight: 600;">
                üìâ Total Risk Reduction
            </div>
            <div style="font-size: 16px; font-weight: 800; color: #15803d;">
                -${totalReduction}%
            </div>
        </div>`;
    }
    
    return html;
}

// Helper function to calculate projected risk score (used by Risk Evolution)
function calculateProjectedRiskScore(currentRiskScore, selectedControls) {
    currentRiskScore = parseFloat(currentRiskScore) || 0;
    
    if (!Array.isArray(selectedControls)) {
        selectedControls = selectedControls ? [selectedControls] : [];
    }
    
    const controlHierarchy = {
        'hard': ['Substitute', 'Engineer'],
        'soft': ['Admin', 'Visual', 'Individual']
    };
    
    let hardControls = selectedControls.filter(c => controlHierarchy.hard.includes(c));
    let softControls = selectedControls.filter(c => controlHierarchy.soft.includes(c));
    let eliminateSelected = selectedControls.includes('Eliminate');
    
    const cntHard = hardControls.length;
    const cntSoft = softControls.length;
    
    // Calculate diminishing returns using geometric decay
    const calculateMultiplier = (count, baseReduction, decayFactor) => {
        if (count === 0) return 1;
        let product = 1;
        for (let n = 1; n <= count; n++) {
            const impact = baseReduction * Math.pow(decayFactor, n - 1);
            product *= (1 - impact);
        }
        return product;
    };
    
    const hardMult = calculateMultiplier(cntHard, 0.65, 0.4);
    const softMult = calculateMultiplier(cntSoft, 0.35, 0.6);
    
    const hardCap = Math.max(hardMult, 0.20);
    const softCap = Math.max(softMult, 0.45);
    
    let projectedScore;
    if (eliminateSelected) {
        projectedScore = 0;
    } else if (cntHard > 0 || cntSoft > 0) {
        projectedScore = Math.round(currentRiskScore * hardCap * softCap);
    } else {
        projectedScore = currentRiskScore;
    }
    
    return projectedScore;
}

// --- RISK REDUCTION VISUALIZATION & CALCULATION (MULTIPLE CONTROLS) ---
function generateRiskReductionVisualization(currentRiskScore, selectedControls, rowIndex) {
    // Ensure currentRiskScore is a valid number
    currentRiskScore = parseFloat(currentRiskScore) || 0;
    
    // Define counter measure effectiveness
    const effectivenessMap = {
        'Eliminate': 1.0,
        'Substitute': 0.80,
        'Engineer': 0.65,
        'Visual': 0.45,
        'Admin': 0.30,
        'Individual': 0.15
    };

    const controlHierarchy = {
        'hard': ['Substitute', 'Engineer'],
        'soft': ['Admin', 'Visual', 'Individual']
    };

    // Ensure selectedControls is an array
    if (!Array.isArray(selectedControls)) {
        selectedControls = selectedControls ? [selectedControls] : [];
    }

    // Count hard and soft controls in selection
    let hardControls = selectedControls.filter(c => controlHierarchy.hard.includes(c));
    let softControls = selectedControls.filter(c => controlHierarchy.soft.includes(c));
    let eliminateSelected = selectedControls.includes('Eliminate');

    const cntHard = hardControls.length;
    const cntSoft = softControls.length;
    const totalControls = selectedControls.length;

    // Calculate diminishing returns using geometric decay for multiple controls
    const calculateMultiplier = (count, baseReduction, decayFactor) => {
        if (count === 0) return 1;
        let product = 1;
        for (let n = 1; n <= count; n++) {
            const impact = baseReduction * Math.pow(decayFactor, n - 1);
            product *= (1 - impact);
        }
        return product;
    };

    // Calculate multipliers for hard and soft controls
    const hardMult = calculateMultiplier(cntHard, 0.65, 0.4);
    const softMult = calculateMultiplier(cntSoft, 0.35, 0.6);

    // Apply caps
    const hardCap = Math.max(hardMult, 0.20); // Max 80% reduction
    const softCap = Math.max(softMult, 0.45); // Max 55% reduction

    // Calculate projected score considering all selected controls
    let projectedScore;
    if (eliminateSelected) {
        // If Eliminate is selected, risk goes to zero
        projectedScore = 0;
    } else if (cntHard > 0 || cntSoft > 0) {
        // Apply combined effectiveness of all controls
        projectedScore = Math.round(currentRiskScore * hardCap * softCap);
    } else {
        // No controls selected
        projectedScore = currentRiskScore;
    }

    const reduction = currentRiskScore - projectedScore;
    const reductionPercent = currentRiskScore > 0 ? Math.round(100 * reduction / currentRiskScore) : 0;

    // Determine color based on projected score
    const getColorForScore = (score) => {
        if (score <= 19) return '#16a34a'; // Low - Green
        if (score <= 49) return '#eab308'; // Medium - Yellow
        if (score <= 71) return '#f97316'; // High - Orange
        return '#dc2626'; // Critical - Red
    };

    const projectedColor = getColorForScore(projectedScore);

    // Generate dynamic message based on selected controls
    let message = '';
    if (eliminateSelected) {
        message = `<b>${t('üéØ ELIMINATED:')}</b> ${t('Hazard completely removed - no risk remains.')}`;
    } else if (cntHard > 1) {
        message = `<b>${t('‚ö° STRONG CONTROLS:')}</b> ${cntHard} ${t('high-level controls (Substitute/Engineer) applied with')} ${Math.round((1 - hardCap) * 100)}% ${t('max reduction.')}`;
    } else if (cntHard === 1 && cntSoft > 0) {
        message = `<b>${t('‚ö° LAYERED DEFENSE:')}</b> ${t('High-level control +')} ${cntSoft} ${t('administrative/PPE control')}${cntSoft > 1 ? 's' : ''} (${Math.round((1 - softCap) * 100)}% ${t('combined reduction).')}`;
    } else if (cntHard === 1) {
        message = `<b>${t('‚ö° HIGH-LEVEL CONTROL:')}</b> ${t('Substitution or Engineering control applied')} (${Math.round((1 - hardCap) * 100)}% ${t('reduction).')}`;
    } else if (cntSoft > 3) {
        message = `<b>${t('‚ö†Ô∏è LIMITED PROTECTION:')}</b> ${cntSoft} ${t('lower-level controls only. Consider Substitution or Engineering controls.')}`;
    } else if (cntSoft > 0) {
        message = `<b>${t('üìã LOWER-LEVEL CONTROLS:')}</b> ${cntSoft} ${t(cntSoft > 1 ? 'controls' : 'control')} ${t('(Admin/Visual/PPE) -')} ${Math.round((1 - softCap) * 100)}% ${t('max reduction.')}`;
    } else {
        message = `<i>${t('Select controls from the hierarchy above to see risk projections...')}</i>`;
    }

    // Build HTML
    let html = `
        <div style="border: 1px solid #bfdbfe; border-radius: 8px; padding: 10px; background: linear-gradient(to right, #eff6ff, #ffffff); box-shadow: 0 2px 4px rgba(59,130,246,0.1); font-size: 11px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div>
                    <div style="font-size: 9px; font-weight: 700; color: #1e40af; text-transform: uppercase;">${t('Predicted Risk')}</div>
                    <div style="font-size: 9px; color: #60a5fa;">${totalControls} ${t(totalControls !== 1 ? 'controls' : 'control')}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 28px; font-weight: 800; color: #94a3b8; opacity: 0.6;">${currentRiskScore}</div>
                    <div style="font-size: 18px; color: #3b82f6;">‚Üí</div>
                    <div style="position: relative;">
                        <div style="font-size: 32px; font-weight: 900; color: ${projectedColor};">${projectedScore}</div>
                        ${reduction > 0 ? `<div style="position: absolute; top: -8px; right: -16px; background: #dcfce7; color: #166534; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 10px; border: 2px solid #86efac;">-${reductionPercent}%</div>` : ''}
                    </div>
                </div>
            </div>
            ${totalControls > 0 ? `<div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #0ea5e9; font-size: 10px; color: #1e40af; line-height: 1.4;">${message}</div>` : `<div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 6px; font-size: 10px; color: #6b7280; text-align: center;">${message}</div>`}
        </div>
    `;

    return html;
}

// --- NEW: Toggle delete / restore on table rows ---
window.toggleRowDelete = function(rowIndex, btn) {
    const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
    if (!row) return;
    const isDeleted = row.classList.toggle('deleted-row');
    row.dataset.deleted = isDeleted ? 'true' : 'false';

    // Find the actual delete button in the table row (not the modal button)
    const tableRowBtn = row.querySelector('button[onclick*="toggleRowDelete"]');
    
    // Update button UI on both modal button and table row button
    const buttonsToUpdate = [btn, tableRowBtn].filter(b => b);
    buttonsToUpdate.forEach(button => {
        try {
            if (isDeleted) {
                button.textContent = 'Restore';
                button.className = 'restore-btn';
                button.title = 'Restore row';
            } else {
                button.textContent = 'üóë';
                button.className = 'delete-btn';
                button.title = 'Delete row';
            }
        } catch (e) { /* ignore UI update issues */ }
    });

    // Disable/enable interactive elements in the row except the delete/restore button
    try {
        const controls = Array.from(row.querySelectorAll('select, input, textarea, button'));
        controls.forEach(control => {
            // Skip the delete/restore button itself
            if (control === btn || control === tableRowBtn) return;
            if (isDeleted) {
                control.setAttribute('disabled', 'true');
                control.style.opacity = '0.6';
                control.style.pointerEvents = 'none';
            } else {
                control.removeAttribute('disabled');
                control.style.opacity = '';
                control.style.pointerEvents = '';
            }
        });
    } catch (e) {
        console.warn('Error updating row controls for delete toggle:', e);
    }
}

// --- Restore row from modal ---
window.restoreRowFromModal = function(rowIndex) {
    const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
    if (!row) return;
    
    // Remove deleted status
    row.classList.remove('deleted-row');
    row.dataset.deleted = 'false';
    
    // Find and update the delete button in that row
    const btn = row.querySelector('.restore-btn, .delete-btn');
    if (btn) {
        btn.textContent = 'üóë';
        btn.className = 'delete-btn';
        btn.title = 'Delete row';
    }
    
    // Re-enable all controls in the row
    const controls = Array.from(row.querySelectorAll('select, input, textarea, button'));
    controls.forEach(control => {
        control.removeAttribute('disabled');
        control.style.opacity = '';
        control.style.pointerEvents = '';
    });
    
    // Refresh the modal view to update UI
    loadModalTaskDetails(rowIndex);
}

// --- Translation Storage to track original values ---
window.translationHistory = {};

// --- Translation Function ---
window.translateTableColumns = async function() {
    const targetLang = document.getElementById('translationLangSelect')?.value || 'en';
    const translateSteps = document.getElementById('translateSteps')?.checked;
    const translateHazardSource = document.getElementById('translateHazardSource')?.checked;
    const translateCurrentControl = document.getElementById('translateCurrentControl')?.checked;
    
    console.log(`[Translation] Starting translation: lang=${targetLang}, steps=${translateSteps}, source=${translateHazardSource}, control=${translateCurrentControl}`);
    
    if (targetLang === 'en') {
        alert('Please select a language other than English for translation.');
        return;
    }
    
    if (!translateSteps && !translateHazardSource && !translateCurrentControl) {
        alert('Please select at least one column to translate.');
        return;
    }
    
    const translationStatus = document.getElementById('translationStatus');
    const translateConfirmBtn = document.getElementById('translateConfirmBtn');
    translationStatus.classList.remove('hidden');
    translationStatus.textContent = 'Translating...';
    translateConfirmBtn.disabled = true;
    
    try {
        const rows = document.querySelectorAll('#table-container tbody tr');
        console.log(`[Translation] Found ${rows.length} rows to process`);
        let translatedCount = 0;
        let cellsUpdated = 0;
        
        for (const row of rows) {
            // Skip deleted rows
            if (row.classList.contains('deleted-row')) {
                console.log('[Translation] Skipping deleted row');
                continue;
            }
            
            const cells = row.querySelectorAll('td');
            const rowIndex = row.getAttribute('data-row-index');
            console.log(`[Translation] Row ${rowIndex} has ${cells.length} cells`);
            
            // Find column headers to dynamically locate columns
            const headerRow = document.querySelector('#table-container thead tr');
            const headers = Array.from(headerRow?.querySelectorAll('th') || []).map(th => th.textContent.trim());
            console.log(`[Translation] Headers: ${headers.join(', ')}`);
            
            const stepsIndex = headers.indexOf('Steps');
            const hazardSourceIndex = headers.indexOf('Hazard Source');
            const currentControlIndex = headers.indexOf('Current Control');
            
            console.log(`[Translation] Column indices - Steps: ${stepsIndex}, Hazard Source: ${hazardSourceIndex}, Current Control: ${currentControlIndex}`);
            
            // Initialize storage for this row if not exists
            if (!window.translationHistory[rowIndex]) {
                window.translationHistory[rowIndex] = {};
            }
            
            // Translate Steps
            if (translateSteps && stepsIndex >= 0 && cells[stepsIndex]) {
                const currentText = cells[stepsIndex].textContent.trim();
                if (currentText && currentText.length > 0) {
                    // Store original if not already stored
                    if (!window.translationHistory[rowIndex].steps) {
                        window.translationHistory[rowIndex].steps = currentText;
                    }
                    console.log(`[Translation] Translating Steps [${stepsIndex}]: "${currentText}"`);
                    const translated = await window.translateText(currentText, targetLang);
                    console.log(`[Translation] Result: "${translated}"`);
                    cells[stepsIndex].textContent = translated;
                    cellsUpdated++;
                }
            }
            
            // Translate Hazard Source (inside input field)
            if (translateHazardSource && hazardSourceIndex >= 0 && cells[hazardSourceIndex]) {
                const inputEl = cells[hazardSourceIndex].querySelector('input');
                if (inputEl) {
                    const currentText = inputEl.value.trim();
                    if (currentText && currentText.length > 0) {
                        // Store original if not already stored
                        if (!window.translationHistory[rowIndex].hazardSource) {
                            window.translationHistory[rowIndex].hazardSource = currentText;
                        }
                        console.log(`[Translation] Translating Hazard Source [${hazardSourceIndex}]: "${currentText}"`);
                        const translated = await window.translateText(currentText, targetLang);
                        console.log(`[Translation] Result: "${translated}"`);
                        inputEl.value = translated;
                        cellsUpdated++;
                    }
                }
            }
            
            // Translate Current Control (inside input field)
            if (translateCurrentControl && currentControlIndex >= 0 && cells[currentControlIndex]) {
                const inputEl = cells[currentControlIndex].querySelector('input');
                if (inputEl) {
                    const currentText = inputEl.value.trim();
                    if (currentText && currentText.length > 0) {
                        // Store original if not already stored
                        if (!window.translationHistory[rowIndex].currentControl) {
                            window.translationHistory[rowIndex].currentControl = currentText;
                        }
                        console.log(`[Translation] Translating Current Control [${currentControlIndex}]: "${currentText}"`);
                        const translated = await window.translateText(currentText, targetLang);
                        console.log(`[Translation] Result: "${translated}"`);
                        inputEl.value = translated;
                        cellsUpdated++;
                    }
                }
            }
            
            translatedCount++;
        }
        
        console.log(`[Translation] Complete: ${translatedCount} rows processed, ${cellsUpdated} cells updated`);
        translationStatus.innerHTML = `‚úì Translated ${cellsUpdated} cells in ${translatedCount} rows successfully!<br><small>You can revert using the Revert button if needed.</small>`;
        setTimeout(() => {
            document.getElementById('translationModal').style.display = 'none';
            translationStatus.classList.add('hidden');
            translationStatus.classList.remove('text-red-600');
            translationStatus.innerHTML = '';
        }, 4000);
    } catch (error) {
        console.error('[Translation] Error:', error);
        translationStatus.textContent = '‚úó Translation failed. Please check console.';
        translationStatus.classList.add('text-red-600');
    } finally {
        translateConfirmBtn.disabled = false;
    }
};

// --- Revert Translation Function ---
window.revertTranslations = function() {
    if (Object.keys(window.translationHistory).length === 0) {
        alert('No translations to revert.');
        return;
    }
    
    const confirmed = confirm('Are you sure you want to revert all translations to original values?');
    if (!confirmed) return;
    
    try {
        for (const rowIndex in window.translationHistory) {
            const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
            if (!row) continue;
            
            const cells = row.querySelectorAll('td');
            const headerRow = document.querySelector('#table-container thead tr');
            const headers = Array.from(headerRow?.querySelectorAll('th') || []).map(th => th.textContent.trim());
            
            const stepsIndex = headers.indexOf('Steps');
            const hazardSourceIndex = headers.indexOf('Hazard Source');
            const currentControlIndex = headers.indexOf('Current Control');
            
            const history = window.translationHistory[rowIndex];
            
            // Revert Steps
            if (history.steps && stepsIndex >= 0 && cells[stepsIndex]) {
                cells[stepsIndex].textContent = history.steps;
            }
            
            // Revert Hazard Source (from input field)
            if (history.hazardSource && hazardSourceIndex >= 0 && cells[hazardSourceIndex]) {
                const inputEl = cells[hazardSourceIndex].querySelector('input');
                if (inputEl) {
                    inputEl.value = history.hazardSource;
                }
            }
            
            // Revert Current Control (from input field)
            if (history.currentControl && currentControlIndex >= 0 && cells[currentControlIndex]) {
                const inputEl = cells[currentControlIndex].querySelector('input');
                if (inputEl) {
                    inputEl.value = history.currentControl;
                }
            }
        }
        
        console.log('[Translation] All translations reverted to original values');
        alert('‚úì All translations have been reverted to original values!');
        window.translationHistory = {}; // Clear history
    } catch (error) {
        console.error('[Translation] Revert error:', error);
        alert('‚úó Revert failed. Please check console.');
    }
};

// Helper function to translate text using MyMemory Translation API (free, CORS-enabled)
window.translateText = async function(text, targetLang) {
    if (!text || text.length === 0) return text;
    
    try {
        console.log(`[Translation] Translating to ${targetLang}: "${text.substring(0, 50)}..."`);
        
        // MyMemory API endpoint - CORS enabled, free, no API key needed
        // Converts language codes: fr->fr, de->de, es->es, it->it, pt->pt
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${targetLang}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            console.warn(`[Translation] API error: ${response.status}`);
            return text;
        }
        
        const data = await response.json();
        
        if (data && data.responseData && data.responseData.translatedText) {
            const translated = data.responseData.translatedText;
            console.log(`[Translation] Result: "${translated.substring(0, 50)}..."`);
            return translated;
        }
        
        console.warn(`[Translation] Unexpected response:`, data);
        return text;
    } catch (error) {
        console.error(`[Translation] Translation failed:`, error);
        return text;
    }
};
// --- End Translation Function ---

window.extractTableData = extractTableData;
window.buildTableFromData = buildTableFromData;
window.initializeDashboard = initializeDashboard;
window.updateDashboardMetrics = updateDashboardMetrics;  
window.updateAllCategoryColors = updateAllCategoryColors;  
window.populatePictureColumn = populatePictureColumn;
    })(); // End of App 1's isolated scope
    // --- APP 2 (FACE BLURRER) SCRIPT ---
    (function() {
        const fileUpload = document.getElementById('imageUpload');
        const processBtn = document.getElementById('processBtn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progress-container');
        const resultsDiv = document.getElementById('results');
        const galleryDiv = document.getElementById('imageGallery');
        const videoSection = document.getElementById('videoSection');
        const videoGallery = document.getElementById('videoGallery');
        const manualBlurCanvas = document.getElementById('manualBlurCanvas');
        const manualBlurCtx = manualBlurCanvas.getContext('2d');
        const downloadBtn = document.getElementById('downloadBtn');
        const privacyModal = document.getElementById('privacyModal');
        const privacyBtn = document.getElementById('privacyBtn');
        const closeModal = document.getElementById('closeModal');
        const lightboxModal = document.getElementById('lightboxModal');
        const lightboxImage = document.getElementById('lightboxImage');
        const closeLightbox = document.getElementById('closeLightbox');
        const undoBlurBtn = document.getElementById('undoBlurBtn');
        const deleteLightboxBtn = document.getElementById('deleteLightboxBtn');
        // --- NEW: Replace Image References ---
        const replaceImageBtn = document.getElementById('replaceImageBtn');
        const replaceImageInput = document.getElementById('replaceImageInput');
        // --- END NEW ---
        const prevArrow = document.getElementById('prevArrow');
        const nextArrow = document.getElementById('nextArrow');
        const lightboxGallery = document.getElementById('lightboxGallery');
        const stepDescription = document.getElementById('stepDescription');
        const spotHazards = document.getElementById('spotHazards');
        const existingControls = document.getElementById('existingControls');
        const SD_MAX_WIDTH = 640;
        const MANUAL_BLUR_RADIUS = 30; // Base radius, scaling applied later
        const MANUAL_BLUR_INTENSITY = 10;
        let modelsLoaded = false;
        
        // Globally accessible for integration
        window.originalFileNames = new Map();
        window.riskAssessmentData = new Map();
        
        let undoHistory = new Map();
        let currentLightboxImageId = null;
        let imageResults = [];
        // Privacy Modal Triggers
        privacyBtn.onclick = () => privacyModal.style.display = 'flex';
        closeModal.onclick = () => privacyModal.style.display = 'none';
        window.addEventListener('click', (event) => {
            if (event.target == privacyModal) privacyModal.style.display = 'none';
        });

        // Best Practices Modal Triggers
        const bestPracticesModal = document.getElementById('bestPracticesModal');
        const bestPracticesBtn = document.getElementById('bestPracticesBtn');
        const closeBestPracticesModal = document.getElementById('closeBestPracticesModal');
        
        if (bestPracticesBtn && bestPracticesModal) {
            bestPracticesBtn.onclick = () => {
                bestPracticesModal.style.display = 'flex';
                // Update translations for the modal content
                updateBestPracticesModalTranslations();
            };
        }
        if (closeBestPracticesModal && bestPracticesModal) {
            closeBestPracticesModal.onclick = () => bestPracticesModal.style.display = 'none';
        }
        window.addEventListener('click', (event) => {
            if (event.target == bestPracticesModal) bestPracticesModal.style.display = 'none';
        });

        // Function to update Best Practices modal translations
        function updateBestPracticesModalTranslations() {
            const elements = bestPracticesModal.querySelectorAll('[data-en-text]');
            elements.forEach(el => {
                const englishText = el.getAttribute('data-en-text');
                if (englishText) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = t(englishText);
                    } else {
                        // Preserve HTML formatting for text with <strong>, <em> etc
                        const translatedText = t(englishText);
                        if (el.innerHTML.includes('<strong>') || el.innerHTML.includes('<em>')) {
                            el.innerHTML = translatedText;
                        } else {
                            el.innerText = translatedText;
                        }
                    }
                }
            });
        }

        // Translation Modal Triggers
        const translationModal = document.getElementById('translationModal');
        const translateTableBtn = document.getElementById('translateTableBtn');
        const translateCancelBtn = document.getElementById('translateCancelBtn');
        const translateConfirmBtn = document.getElementById('translateConfirmBtn');
        
        if (translateTableBtn) {
            translateTableBtn.onclick = () => translationModal.style.display = 'flex';
        }
        
        if (translateCancelBtn) {
            translateCancelBtn.onclick = () => translationModal.style.display = 'none';
        }
        
        window.addEventListener('click', (event) => {
            if (event.target == translationModal) translationModal.style.display = 'none';
        });

        if (translateConfirmBtn) {
            translateConfirmBtn.onclick = window.translateTableColumns;
        }
        
        const revertTranslationsBtn = document.getElementById('revertTranslationsBtn');
        if (revertTranslationsBtn) {
            revertTranslationsBtn.onclick = window.revertTranslations;
        }
        
        // --- Event listener for file selection feedback ---
        fileUpload.addEventListener('change', (event) => {
    const files = event.target.files;
    if (!files || files.length === 0) {
        if (modelsLoaded) {
            statusDiv.innerText = t('Models loaded. Please select your images or videos.');
        } else {
            statusDiv.innerText = t('Loading AI models...') + ' üß†'; // Or error state if needed
        }
        return;
    }
    if (modelsLoaded) {
        statusDiv.innerText = `${files.length} ` + t('file(s) selected. Click \'Process Files\' to continue.');
    } else {
         statusDiv.innerText = t('Models loading...') + ` ${files.length} ` + t('file(s) selected. Please wait.');
    }
});
        // --- End of event listener ---
        function showLightboxImage(imageId) {
            const thumbnailElement = document.getElementById(imageId);
            if (!thumbnailElement) return;
            currentLightboxImageId = imageId;
            lightboxImage.src = thumbnailElement.src;
            // Add error handling for image loading
            lightboxImage.onerror = () => {
                 console.error(`Failed to load lightbox image for ID: ${imageId}`);
                 showCustomAlert("Error loading the preview image.", 'error');
                 closeLightboxFunc(); // Close if image fails
             }
            undoBlurBtn.disabled = !undoHistory.has(currentLightboxImageId);
            const data = window.riskAssessmentData.get(currentLightboxImageId) || {};
            stepDescription.value = data.description || '';
            spotHazards.value = data.hazards || '';
            existingControls.value = data.controls || '';
            document.getElementById('userFrequency').value = data.userFrequency || '';
            document.getElementById('userSeverity').value = data.userSeverity || '';
            document.getElementById('userLikelihood').value = data.userLikelihood || '';
            updateLightboxGallery();
        }
        function updateLightboxGallery() {
            lightboxGallery.innerHTML = '';
            const galleryImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
            galleryImages.forEach(img => {
                const thumb = document.createElement('img');
                thumb.src = img.src;
                thumb.id = `thumb-${img.id}`;
                thumb.className = `w-16 h-16 object-cover rounded-md cursor-pointer border-2 transition ${img.id === currentLightboxImageId ? 'border-indigo-500' : 'border-transparent hover:border-slate-400'}`;
                thumb.draggable = true;
                thumb.onclick = () => showLightboxImage(img.id);
                lightboxGallery.appendChild(thumb);
            });
        }
        function closeLightboxFunc() {
            lightboxModal.style.display = 'none';
            currentLightboxImageId = null;
            lightboxGallery.innerHTML = '';
            stepDescription.value = '';
            spotHazards.value = '';
            existingControls.value = '';
        }
        closeLightbox.onclick = closeLightboxFunc;
        
        // --- NEW: Full-Screen Video Capture Functions ---
        let fullscreenVideoCurrentFile = null;
        let fullscreenCapturedFrames = []; // Store captured frame blobs and info
        let fullscreenSpacebarListener = null;

        window.openFullscreenVideoCapture = function(videoElement) {
            if (!videoElement || !videoElement.src) {
                showCustomAlert('No video to capture from.', 'error');
                return;
            }

            // Get video file name from the button's parent or from the videoElement
            const videoContainer = videoElement.closest('[data-video-name]');
            const videoName = videoContainer?.dataset.videoName || 'video_frame';
            fullscreenVideoCurrentFile = videoName;
            fullscreenCapturedFrames = []; // Reset frames

            // Set up the fullscreen modal
            const modal = document.getElementById('fullscreenVideoModal');
            const player = document.getElementById('fullscreenVideoPlayer');

            // Clone the video element to fullscreen player
            player.src = videoElement.src;
            player.currentTime = videoElement.currentTime;
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent scrolling

            // Add space bar listener
            fullscreenSpacebarListener = (e) => {
                if (e.code === 'Space' || e.key === ' ') {
                    e.preventDefault(); // Prevent page scroll
                    captureFullscreenFrame();
                }
                // ESC to close
                if (e.key === 'Escape') {
                    closeFullscreenVideoModal();
                }
            };
            document.addEventListener('keydown', fullscreenSpacebarListener);

            // Update thumbnail count
            updateFrameCount();
        };

        window.captureFullscreenFrame = async function() {
            const player = document.getElementById('fullscreenVideoPlayer');
            if (!player.src) return;

            // Create canvas and capture frame
            const canvas = document.createElement('canvas');
            canvas.width = player.videoWidth;
            canvas.height = player.videoHeight;
            canvas.getContext('2d').drawImage(player, 0, 0);

            try {
                // Process frame with face blurring
                const result = await processCanvas(canvas);
                
                if (result.blob) {
                    // Create file name with timestamp
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/:/g, '-').replace(/\./g, '_');
                    const frameNumber = fullscreenCapturedFrames.length + 1;
                    const frameName = `${fullscreenVideoCurrentFile}_frame_${frameNumber}_${timestamp}.jpg`;

                    // Store frame info
                    fullscreenCapturedFrames.push({
                        blob: result.blob,
                        name: frameName,
                        timestamp: now.getTime()
                    });

                    // Add thumbnail to panel
                    addFullscreenThumbnail(result.blob, frameName, fullscreenCapturedFrames.length - 1);
                    updateFrameCount();
                    
                    // Visual feedback
                    showCustomAlert(`Frame ${frameNumber} captured!`, 'success');
                }
            } catch (error) {
                console.error('Error processing frame:', error);
                showCustomAlert('Error processing frame.', 'error');
            }
        };

        function addFullscreenThumbnail(blob, name, index) {
            const panel = document.getElementById('fullscreenThumbnailPanel');
            
            // Clear placeholder text if this is the first frame
            if (index === 0) {
                panel.innerHTML = '';
            }

            const url = URL.createObjectURL(blob);
            const thumb = document.createElement('div');
            thumb.className = 'relative group';
            thumb.innerHTML = `
                <img src="${url}" alt="Frame ${index + 1}" class="w-full h-auto rounded shadow-md cursor-pointer hover:scale-105 transition-transform">
                <button onclick="removeFullscreenThumbnail(${index})" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 text-xs font-bold opacity-0 group-hover:opacity-100 transition">√ó</button>
                <p class="text-white text-xs mt-1 text-center">${name.substring(0, 20)}...</p>
            `;
            panel.appendChild(thumb);
        }

        window.removeFullscreenThumbnail = function(index) {
            fullscreenCapturedFrames.splice(index, 1);
            const panel = document.getElementById('fullscreenThumbnailPanel');
            const thumbs = panel.querySelectorAll('.relative');
            if (thumbs[index]) {
                thumbs[index].remove();
            }
            
            // Re-render all thumbnails to maintain correct indices
            panel.innerHTML = '';
            fullscreenCapturedFrames.forEach((frame, i) => {
                addFullscreenThumbnail(frame.blob, frame.name, i);
            });

            if (fullscreenCapturedFrames.length === 0) {
                panel.innerHTML = '<p class="text-slate-400 text-center text-sm mt-8">Captured frames appear here</p>';
            }
            updateFrameCount();
        };

        function updateFrameCount() {
            document.getElementById('frameCount').textContent = fullscreenCapturedFrames.length;
            document.getElementById('frameCountFooter').textContent = fullscreenCapturedFrames.length;
        }

        window.downloadCapturedFrames = async function() {
            if (fullscreenCapturedFrames.length === 0) {
                showCustomAlert('No frames to download.', 'info');
                return;
            }

            try {
                const zip = new JSZip();
                
                // Add each frame to zip
                fullscreenCapturedFrames.forEach((frame, index) => {
                    zip.file(frame.name, frame.blob);
                });

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `captured_frames_${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showCustomAlert('Frames downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error downloading frames:', error);
                showCustomAlert('Error downloading frames.', 'error');
            }
        };

        window.clearCapturedFrames = function() {
            fullscreenCapturedFrames = [];
            const panel = document.getElementById('fullscreenThumbnailPanel');
            panel.innerHTML = '<p class="text-slate-400 text-center text-sm mt-8">Captured frames appear here</p>';
            updateFrameCount();
            showCustomAlert('All frames cleared.', 'info');
        };

        window.closeFullscreenVideoModal = function() {
            const modal = document.getElementById('fullscreenVideoModal');
            const player = document.getElementById('fullscreenVideoPlayer');
            
            // Stop video playback
            player.pause();
            player.src = '';
            
            // Remove event listener
            if (fullscreenSpacebarListener) {
                document.removeEventListener('keydown', fullscreenSpacebarListener);
                fullscreenSpacebarListener = null;
            }

            // Hide modal
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling

            // --- NEW: Add captured frames to gallery and open for review ---
            if (fullscreenCapturedFrames.length > 0) {
                addCapturedFramesToGallery();
                // Auto-open the first frame for immediate review
                setTimeout(() => {
                    const firstFrameId = `fullscreen-frame-${fullscreenCapturedFrames[0].timestamp}`;
                    if (document.getElementById(firstFrameId)) {
                        showLightboxImage(firstFrameId);
                    }
                }, 300); // Small delay to ensure DOM is updated
            }

            // Reset
            fullscreenVideoCurrentFile = null;
            fullscreenCapturedFrames = [];
            updateFrameCount();
        };

        // --- NEW: Function to add captured frames to gallery ---
        async function addCapturedFramesToGallery() {
            for (const frame of fullscreenCapturedFrames) {
                try {
                    // Create unique ID using timestamp
                    const fileId = `fullscreen-frame-${frame.timestamp}`;
                    const imageUrl = URL.createObjectURL(frame.blob);

                    // Store file name mapping
                    window.originalFileNames.set(fileId, frame.name);

                    // Create gallery container
                    const container = document.createElement('div');
                    container.className = 'gallery-item relative w-full pt-[100%] h-0 cursor-grab';
                    container.id = `gallery-item-${fileId}`;
                    container.draggable = true;

                    // Create image element
                    const imgElement = document.createElement('img');
                    imgElement.src = imageUrl;
                    imgElement.alt = frame.name;
                    imgElement.id = fileId;
                    imgElement.className = "absolute top-0 left-0 w-full h-full object-cover rounded-lg shadow-md cursor-pointer transition-transform duration-200 hover:scale-105";

                    // Create delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn absolute top-1.5 right-1.5 z-10 bg-black/60 text-white w-5 h-5 rounded-full text-xs font-bold leading-none flex items-center justify-center hover:bg-red-600 transition';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Delete this image';

                    container.appendChild(imgElement);
                    container.appendChild(deleteBtn);

                    // Clear placeholder if needed
                    if (galleryDiv.querySelector('p')) {
                        galleryDiv.innerHTML = '';
                    }

                    // Add to gallery
                    galleryDiv.appendChild(container);

                    // Show download/report buttons
                    downloadBtn.style.display = 'block';
                    document.getElementById('generateAiReportBtn').style.display = 'block';
                    document.getElementById('saveProjectBtn').style.display = 'block';

                    // Add to drag-and-drop system
                    setupDragAndDrop(container, imgElement);

                    // Make image clickable to open lightbox
                    imgElement.addEventListener('click', () => showLightboxImage(fileId));

                    // Make delete button functional
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // The gallery's event delegation will handle this
                        // since we have the delete-btn class
                        deleteBtn.click(); // Trigger the existing gallery click handler
                    });

                    console.debug(`Added captured frame to gallery: ${fileId}`);
                } catch (error) {
                    console.error('Error adding captured frame to gallery:', error);
                    showCustomAlert('Error adding frame to gallery.', 'error');
                }
            }

            // Show confirmation
            showCustomAlert(`‚úÖ ${fullscreenCapturedFrames.length} frame(s) added to review pane!`, 'success');
        }

        // --- NEW: Setup drag and drop for newly added images ---
        function setupDragAndDrop(container, imgElement) {
            container.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', container.innerHTML);
                container.classList.add('dragging');
                draggedElement = container;
            });

            container.addEventListener('dragend', (e) => {
                container.classList.remove('dragging');
                draggedElement = null;
            });
        }
        // --- END: Setup drag and drop ---
        // --- END: Full-Screen Video Capture Functions ---

        function saveRiskData() {
            if (!currentLightboxImageId) return;
            const userFrequency = document.getElementById('userFrequency').value;
            const userSeverity = document.getElementById('userSeverity').value;
            const userLikelihood = document.getElementById('userLikelihood').value;
            
            window.riskAssessmentData.set(currentLightboxImageId, {
                description: stepDescription.value,
                hazards: spotHazards.value,
                controls: existingControls.value,
                userFrequency: userFrequency || null,
                userSeverity: userSeverity || null,
                userLikelihood: userLikelihood || null
            });
        }
        stepDescription.addEventListener('input', saveRiskData);
        spotHazards.addEventListener('input', saveRiskData);
        existingControls.addEventListener('input', saveRiskData);
        document.getElementById('userFrequency').addEventListener('change', saveRiskData);
        document.getElementById('userSeverity').addEventListener('change', saveRiskData);
        document.getElementById('userLikelihood').addEventListener('change', saveRiskData);
        function showNextImage() {
            if (!currentLightboxImageId) return;
            const galleryImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
            if (galleryImages.length === 0) return;
            const currentIndex = galleryImages.findIndex(img => img.id === currentLightboxImageId);
            const nextIndex = (currentIndex + 1) % galleryImages.length;
            showLightboxImage(galleryImages[nextIndex].id);
        }
        function showPreviousImage() {
            if (!currentLightboxImageId) return;
            const galleryImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
            if (galleryImages.length === 0) return;
            const currentIndex = galleryImages.findIndex(img => img.id === currentLightboxImageId);
            const prevIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
            showLightboxImage(galleryImages[prevIndex].id);
        }
        function getDragAfterElement(container, x, isLightbox = false) {
            const selector = isLightbox ? '#lightboxGallery img:not(.dragging)' : '.gallery-item:not(.dragging)';
            const draggableElements = [...container.querySelectorAll(selector)];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                }
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        // --- FIX: Load models from CDN ---
        async function loadModels() {
            // Try local models first, then fall back to CDN
            const MODEL_URLS = [
                './models/',  // Local models folder
                'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'  // CDN fallback
            ];
            
            let modelLoaded = false;
            let lastError = null;
            
            for (const MODEL_URL of MODEL_URLS) {
                try {
                    console.log('Attempting to load models from:', MODEL_URL);
                    if (typeof faceapi === 'undefined') {
                        throw new Error("face-api.js script not loaded. Please ensure it's included correctly, perhaps via CDN.");
                    }
                    statusDiv.innerText = 'Loading AI models from CDN... Please wait.';
                    
                    // Load the specific model needed (ssdMobilenetv1)
                    console.log('Loading ssdMobilenetv1...');
                    await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                    console.log('Models loaded successfully from:', MODEL_URL);
                    
                    modelLoaded = true;
                    break; // Success, exit loop
                } catch (error) {
                    lastError = error;
                    console.warn(`Failed to load from ${MODEL_URL}:`, error.message);
                    // Continue to next URL
                }
            }
            
            if (!modelLoaded) {
                throw lastError || new Error('Failed to load models from all sources');
            }
            
            // Optional: Load other models if needed later, e.g., faceLandmark68Net, faceRecognitionNet
            // await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            // await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            
            modelsLoaded = true;
            console.log('modelsLoaded flag set to true');
            
            // Update status based on whether files are already selected
             const files = fileUpload.files;
             if (files && files.length > 0) {
                 statusDiv.innerText = `${files.length} file(s) selected. Click 'Process Files' to continue.`;
             } else {
                 statusDiv.innerText = 'Models loaded. Please select your images or videos.';
             }
            processBtn.disabled = false;
        }
        // --- END FIX ---

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const missingLibs = [];
                // Check for faceapi again, as it might fail even if script tag exists
                if (typeof faceapi === 'undefined') missingLibs.push('face-api.js (Check script tag)'); 
                if (typeof JSZip === 'undefined') missingLibs.push('JSZip (lib/jszip.min.js)');
                if (typeof PDFDocument === 'undefined') missingLibs.push('pdfkit (lib/pdfkit.min.js)');
                if (typeof blobStream === 'undefined') missingLibs.push('blob-stream (lib/blob-stream.min.js)');
                if (missingLibs.length > 0) {
                    const errorMsg = `Error: Failed to load essential libraries: ${missingLibs.join(', ')}. Please ensure local files are in the ./lib/ directory or check CDN links, and refresh.`;
                    console.error(errorMsg);
                    statusDiv.innerText = errorMsg;
                    statusDiv.classList.add('text-red-600', 'font-bold');
                    return; // Stop further execution if libs are missing
                }
                // If all libs seem present, attempt to load models
                loadModels().catch(error => {
                    console.error('Error in loadModels:', error);
                    statusDiv.innerText = 'Error loading AI models. Check your internet connection and the browser console for details.';
                    statusDiv.classList.add('text-red-600', 'font-bold');
                });
            }, 500); // Slight delay to ensure scripts might have loaded

            // Rest of the DOMContentLoaded event listeners...
           galleryDiv.addEventListener('click', async (event) => {
                if (event.target.classList.contains('delete-btn')) {
                    const item = event.target.closest('.gallery-item');
                    if (!item) return;
                    const img = item.querySelector('img');
                    if (!img) return;
                    if (!await showCustomConfirm('Are you sure you want to delete this image?')) return;
                    const imgId = img.id;
                    const imgUrl = img.src;
                    const fileName = window.originalFileNames.get(imgId);
                    if (fileName) {
                        const resultIndex = imageResults.findIndex(res => res.fileName === fileName);
                        if (resultIndex > -1) imageResults.splice(resultIndex, 1);
                    }
                    window.originalFileNames.delete(imgId);
                    const undoUrl = undoHistory.get(imgId);
                    if (undoUrl) URL.revokeObjectURL(undoUrl);
                    undoHistory.delete(imgId);
                    window.riskAssessmentData.delete(imgId);
                    item.remove();
                    updateResults();
                    if (currentLightboxImageId === imgId) closeLightboxFunc();
                    if (galleryDiv.children.length === 0 || (galleryDiv.children.length === 1 && galleryDiv.querySelector('p'))) {
                        galleryDiv.innerHTML = '<p class="text-slate-500 col-span-full text-center">Processed images/frames will appear here...</p>';
                        downloadBtn.style.display = 'none';
                        document.getElementById('generateAiReportBtn').style.display = 'none';
                        document.getElementById('manual-blur-info').style.display = 'none';
                    }
                } else if (event.target.tagName === 'IMG') {
                    lightboxModal.style.display = 'flex';
                    showLightboxImage(event.target.id);
                }
            });
            // Track drag state for visual feedback
            let dragOverTarget = null;
            let lastClientY = 0;
            let dropPlaceholder = null;
            
            galleryDiv.addEventListener('dragstart', (event) => {
                const galleryItem = event.target.closest('.gallery-item');
                if (galleryItem) {
                    event.dataTransfer.setData('text/plain', galleryItem.id);
                    galleryItem.classList.add('dragging');
                    event.dataTransfer.effectAllowed = 'move';
                }
            });
            
            galleryDiv.addEventListener('dragend', (event) => {
                const galleryItem = event.target.closest('.gallery-item');
                if (galleryItem) {
                    galleryItem.classList.remove('dragging');
                }
                // Clear all visual feedback
                document.querySelectorAll('.gallery-item.drop-target').forEach(item => {
                    item.classList.remove('drop-target');
                });
                // Remove placeholder
                if (dropPlaceholder) {
                    dropPlaceholder.remove();
                    dropPlaceholder = null;
                }
                dragOverTarget = null;
            });
            
            galleryDiv.addEventListener('dragover', (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                lastClientY = event.clientY;
            });
            
            galleryDiv.addEventListener('dragenter', (event) => {
                event.preventDefault();
                const galleryItem = event.target.closest('.gallery-item');
                const draggingItem = galleryDiv.querySelector('.gallery-item.dragging');
                
                if (!galleryItem || !draggingItem || galleryItem === draggingItem) return;
                
                // Only update if we moved to a different item
                if (dragOverTarget === galleryItem) return;
                
                // Clear previous visual feedback
                if (dragOverTarget) {
                    dragOverTarget.classList.remove('drop-target');
                }
                if (dropPlaceholder) {
                    dropPlaceholder.remove();
                    dropPlaceholder = null;
                }
                
                // Add visual feedback to new target
                dragOverTarget = galleryItem;
                galleryItem.classList.add('drop-target');
                
                // Create placeholder with same dimensions as gallery item
                const galleryItemRect = galleryItem.getBoundingClientRect();
                dropPlaceholder = document.createElement('div');
                dropPlaceholder.className = 'drop-position-placeholder';
                dropPlaceholder.style.width = galleryItemRect.width + 'px';
                dropPlaceholder.style.height = galleryItemRect.height + 'px';
                dropPlaceholder.style.cursor = 'grabbing';
                
                // Get the position relative to drop target
                const targetBox = galleryItem.getBoundingClientRect();
                const containerBox = galleryDiv.getBoundingClientRect();
                const isDropBefore = lastClientY < (targetBox.top + targetBox.height / 2);
                
                // Insert placeholder before or after target
                if (isDropBefore) {
                    galleryItem.parentNode.insertBefore(dropPlaceholder, galleryItem);
                } else {
                    if (galleryItem.nextSibling) {
                        galleryItem.parentNode.insertBefore(dropPlaceholder, galleryItem.nextSibling);
                    } else {
                        galleryItem.parentNode.appendChild(dropPlaceholder);
                    }
                }
            });
            
            galleryDiv.addEventListener('drop', (event) => {
                event.preventDefault();
                
                const draggedId = event.dataTransfer.getData('text/plain');
                const draggedItem = document.getElementById(draggedId);
                if (!draggedItem) return;
                
                // Clear visual feedback and placeholder
                if (dragOverTarget) {
                    dragOverTarget.classList.remove('drop-target');
                }
                document.querySelectorAll('.gallery-item.drop-target').forEach(item => {
                    item.classList.remove('drop-target');
                });
                
                // Get placeholder position and drop there
                if (dropPlaceholder && dropPlaceholder.parentNode) {
                    dropPlaceholder.parentNode.insertBefore(draggedItem, dropPlaceholder);
                    dropPlaceholder.remove();
                    dropPlaceholder = null;
                } else {
                    // Fallback: use the target item
                    const targetItem = event.target.closest('.gallery-item');
                    if (targetItem && targetItem !== draggedItem) {
                        const targetBox = targetItem.getBoundingClientRect();
                        const targetCenterY = targetBox.top + targetBox.height / 2;
                        
                        if (event.clientY < targetCenterY) {
                            galleryDiv.insertBefore(draggedItem, targetItem);
                        } else {
                            if (targetItem.nextSibling) {
                                galleryDiv.insertBefore(draggedItem, targetItem.nextSibling);
                            } else {
                                galleryDiv.appendChild(draggedItem);
                            }
                        }
                    }
                }
                
                dragOverTarget = null;
                updateLightboxGallery();
            });
            lightboxGallery.addEventListener('dragstart', (event) => {
                if (event.target.tagName === 'IMG') {
                    event.dataTransfer.setData('text/plain', event.target.id);
                    event.target.classList.add('dragging');
                    event.dataTransfer.effectAllowed = 'move';
                }
            });
            lightboxGallery.addEventListener('dragend', (event) => {
                if (event.target.tagName === 'IMG') event.target.classList.remove('dragging');
            });
            lightboxGallery.addEventListener('dragover', (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                // Add visual feedback for drag target in lightbox
                const afterElement = getDragAfterElement(lightboxGallery, event.clientX, true);
                const draggingItem = lightboxGallery.querySelector('img.dragging');
                if (afterElement && draggingItem && afterElement !== draggingItem) {
                    lightboxGallery.insertBefore(draggingItem, afterElement);
                } else if (draggingItem && !afterElement) {
                    lightboxGallery.appendChild(draggingItem);
                }
            });
            lightboxGallery.addEventListener('drop', (event) => {
                event.preventDefault();
                const draggedId = event.dataTransfer.getData('text/plain');
                const draggedThumb = document.getElementById(draggedId);
                if (!draggedThumb) return;
                const afterElement = getDragAfterElement(lightboxGallery, event.clientX, true);
                const mainGalleryItemId = draggedThumb.id.replace('thumb-', '');
                const mainGalleryItem = document.getElementById(mainGalleryItemId)?.closest('.gallery-item');
                const mainAfterElement = afterElement ? document.getElementById(afterElement.id.replace('thumb-', ''))?.closest('.gallery-item') : null;
                
                if (mainGalleryItem) {
                    if (mainAfterElement) {
                        galleryDiv.insertBefore(mainGalleryItem, mainAfterElement);
                    } else {
                        galleryDiv.appendChild(mainGalleryItem);
                    }
                }
                if (afterElement) {
                    lightboxGallery.insertBefore(draggedThumb, afterElement);
                } else {
                    lightboxGallery.appendChild(draggedThumb);
                }
                updateLightboxGallery();
            });
        });
        
        processBtn.addEventListener('click', async () => {
            const files = fileUpload.files;
            // Max file check moved to the 'change' event listener
            if (!files.length) { statusDiv.innerText = 'Please select at least one file.'; return; }
            if (!modelsLoaded) { statusDiv.innerText = 'AI models not loaded.'; return; }
            processBtn.disabled = true; processBtn.innerText = 'Processing...';
            downloadBtn.style.display = 'none';
            document.getElementById('generateAiReportBtn').style.display = 'none';
            progressContainer.style.display = 'block';
            resultsDiv.style.display = 'none'; resultsDiv.innerHTML = '';
           // galleryDiv.innerHTML = '<p class="text-slate-500 col-span-full text-center">Processing files...</p>';
            videoGallery.innerHTML = '<p class="text-slate-500">Uploaded videos will appear here...</p>';
            document.getElementById('manual-blur-info').style.display = 'none';
            progressBar.value = 0;
            let imageFiles = [];
            let videoFiles = [];
            
            // Check if file is a video by MIME type or file extension
            const isVideoFile = (file) => {
                const videoExtensions = ['mp4', 'mov', 'avi', 'mkv', 'webm', 'flv', 'wmv', 'm4v', '3gp'];
                const extension = file.name.split('.').pop().toLowerCase();
                return file.type.startsWith('video/') || videoExtensions.includes(extension);
            };
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    imageFiles.push(file);
                } else if (isVideoFile(file)) {
                    videoFiles.push(file);
                }
            }
            progressBar.max = imageFiles.length;
            let processedCount = 0;
            imageResults = [];
           // window.originalFileNames.clear();
           // undoHistory.clear();
           // window.riskAssessmentData.clear();
            const processingPromises = imageFiles.length > 0 ? imageFiles.map(async (file, i) => {
                const fileId = `img-${Date.now()}-${i}`;
                statusDiv.innerText = `Processing image ${i + 1} of ${imageFiles.length}...`;
                try {
                    const result = await processImage(file);
                    imageResults.push({ fileName: file.name, faceCount: result.faceCount });
                    if (result.blob) {
                        const imageUrl = URL.createObjectURL(result.blob);
                        window.originalFileNames.set(fileId, file.name);
                        const container = document.createElement('div');
                        container.className = 'gallery-item relative w-full pt-[100%] h-0 cursor-grab';
                        container.id = `gallery-item-${fileId}`;
                        container.draggable = true;
                        
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrl;
                        imgElement.alt = `Processed ${file.name}`;
                        imgElement.id = fileId;
                        imgElement.className = "absolute top-0 left-0 w-full h-full object-cover rounded-lg shadow-md cursor-pointer transition-transform duration-200 hover:scale-105";
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn absolute top-1.5 right-1.5 z-10 bg-black/60 text-white w-5 h-5 rounded-full text-xs font-bold leading-none flex items-center justify-center hover:bg-red-600 transition';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.title = 'Delete this image';
                        
                        container.appendChild(imgElement);
                        container.appendChild(deleteBtn);
                        if (galleryDiv.querySelector('p')) galleryDiv.innerHTML = '';
                        galleryDiv.appendChild(container);
                    }
                } catch (error) {
                    console.error(`Error processing file ${file.name}:`, error);
                    imageResults.push({ fileName: file.name, faceCount: 'Error' });
                }
                processedCount++;
                progressBar.value = processedCount;
            }) : [];
            await Promise.all(processingPromises);
            if (videoFiles.length > 0) {
                videoSection.style.display = 'block';
                videoGallery.innerHTML = '';
                videoFiles.forEach((file, i) => {
                    const vidContainer = document.createElement('div');
                    vidContainer.className = 'vid-container flex flex-col items-center max-w-sm mx-auto';
                    vidContainer.dataset.videoName = file.name;
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = true;
                    video.id = `vid-${Date.now()}-${i}`;
                    video.className = "w-full h-auto rounded-lg shadow-md";
                    
                    // Button container for two buttons side by side
                    const btnContainer = document.createElement('div');
                    btnContainer.className = 'flex gap-2 mt-2 w-full';
                    
                    const captureBtn = document.createElement('button');
                    captureBtn.textContent = 'Capture Frame';
                    captureBtn.className = "flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300";
                    captureBtn.onclick = () => captureAndProcessFrame(video, file.name);
                    
                    // NEW: Full-screen capture button
                    const fullscreenBtn = document.createElement('button');
                    fullscreenBtn.textContent = '‚õ∂ Full-Screen';
                    fullscreenBtn.className = "flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300";
                    fullscreenBtn.onclick = () => openFullscreenVideoCapture(video);
                    
                    vidContainer.appendChild(video);
                    btnContainer.appendChild(captureBtn);
                    btnContainer.appendChild(fullscreenBtn);
                    vidContainer.appendChild(btnContainer);
                    videoGallery.appendChild(vidContainer);
                });
            } else {
                videoSection.style.display = 'none';
            }
            if (processedCount === 0 && videoFiles.length === 0) {
                 galleryDiv.innerHTML = '<p class="text-slate-500 col-span-full text-center">No image files were processed. Upload videos will appear above.</p>';
            }
            updateResults();
            statusDiv.innerText = 'Processing Complete.';
            document.getElementById('manual-blur-info').style.display = 'block';
            progressContainer.style.display = 'none';
            processBtn.disabled = false;
            processBtn.innerText = 'Process More Files';
            fileUpload.value = ""; // Clear file input after processing
            if (galleryDiv.querySelectorAll('.gallery-item img').length > 0) {
                downloadBtn.style.display = 'block';
                document.getElementById('generateAiReportBtn').style.display = 'block';
                document.getElementById('saveProjectBtn').style.display = 'block';
            }
        });
        function updateResults() {
            let resultsHTML = '<ul class="space-y-1">' + imageResults.map(res => {
                let countText = res.faceCount === 'Error' ? '<span class="font-semibold text-red-600">Error</span>' : `<span class="font-semibold text-indigo-700">${res.faceCount} face(s) detected</span>`;
                let displayName = res.fileName.length > 40 ? res.fileName.substring(0, 37) + '...' : res.fileName;
                return `<li class="flex justify-between items-center text-slate-700"><span>${displayName}:</span> ${countText}</li>`;
            }).join('') + '</ul>';
            resultsDiv.innerHTML = resultsHTML;
            resultsDiv.style.display = 'block';
        }
        async function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = async () => {
                        try {
                            let newWidth = img.width;
                            let newHeight = img.height;
                            if (newWidth > SD_MAX_WIDTH) {
                                const aspectRatio = img.height / img.width;
                                newWidth = SD_MAX_WIDTH;
                                newHeight = Math.round(newWidth * aspectRatio);
                            }
                            const canvas = document.createElement('canvas');
                            canvas.width = newWidth; canvas.height = newHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, newWidth, newHeight);
                            const detections = await faceapi.detectAllFaces(canvas, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 }));
                            if (detections.length > 0) {
                                detections.forEach(detection => {
                                    const { x, y, width, height } = detection.box;
                                    if (width <= 0 || height <= 0) return;
                                    const blurAmount = Math.max(5, Math.round(Math.max(width, height) / 5));
                                    ctx.save();
                                    ctx.filter = `blur(${blurAmount}px)`;
                                    ctx.drawImage(canvas, x, y, width, height, x, y, width, height);
                                    ctx.restore();
                                });
                            }
                            canvas.toBlob(blob => {
                                resolve({ blob, faceCount: detections.length, width: newWidth, height: newHeight });
                            }, 'image/jpeg', 0.9);
                        } catch (error) { reject(error); }
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        async function processCanvas(inputCanvas) {
            return new Promise(async (resolve, reject) => {
                try {
                    const imgWidth = inputCanvas.width;
                    const imgHeight = inputCanvas.height;
                    const aspectRatio = imgHeight / imgWidth;
                    let newWidth = imgWidth;
                    let newHeight = imgHeight;
                    if (newWidth > SD_MAX_WIDTH) {
                        newWidth = SD_MAX_WIDTH;
                        newHeight = Math.round(newWidth * aspectRatio);
                    }
                    const resizedCanvas = document.createElement('canvas');
                    resizedCanvas.width = newWidth;
                    resizedCanvas.height = newHeight;
                    const ctx = resizedCanvas.getContext('2d');
                    ctx.drawImage(inputCanvas, 0, 0, newWidth, newHeight);
                    const detections = await faceapi.detectAllFaces(resizedCanvas, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 }));
                    if (detections.length > 0) {
                        detections.forEach(detection => {
                            const { x, y, width, height } = detection.box;
                            if (width <= 0 || height <= 0) return;
                            const blurAmount = Math.max(5, Math.round(Math.max(width, height) / 5));
                            ctx.save();
                            ctx.filter = `blur(${blurAmount}px)`;
                            ctx.drawImage(resizedCanvas, x, y, width, height, x, y, width, height);
                            ctx.restore();
                        });
                    }
                    resizedCanvas.toBlob(blob => {
                        resolve({ blob, faceCount: detections.length });
                    }, 'image/jpeg', 0.9);
                } catch (error) { reject(error); }
            });
        }
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        async function captureAndProcessFrame(video, videoName) {
            video.pause();
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            captureCanvas.getContext('2d').drawImage(video, 0, 0);
            statusDiv.innerText = 'Processing captured frame...';
            try {
                const result = await processCanvas(captureCanvas);
                const fileId = `frame-${Date.now()}`;
                const now = new Date();
                const timestamp = now.toISOString().replace(/:/g, '-').replace(/\./g, '_');
                const baseName = videoName.replace(/\.[^/.]+$/, "");
                const frameNumber = now.getTime();
                const frameName = `${baseName}_frame_${timestamp}_${frameNumber}.jpg`;
                imageResults.push({ fileName: frameName, faceCount: result.faceCount });
                if (result.blob) {
                    const imageUrl = URL.createObjectURL(result.blob);
                    window.originalFileNames.set(fileId, frameName);
                    
                    const container = document.createElement('div');
                    container.className = 'gallery-item relative w-full pt-[100%] h-0 cursor-grab';
                    container.id = `gallery-item-${fileId}`;
                    container.draggable = true;
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = imageUrl;
                    imgElement.alt = `Processed frame from ${videoName}`;
                    imgElement.id = fileId;
                    imgElement.className = "absolute top-0 left-0 w-full h-full object-cover rounded-lg shadow-md cursor-pointer transition-transform duration-200 hover:scale-105";
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn absolute top-1.5 right-1.5 z-10 bg-black/60 text-white w-5 h-5 rounded-full text-xs font-bold leading-none flex items-center justify-center hover:bg-red-600 transition';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Delete this image';
                    
                    container.appendChild(imgElement);
                    container.appendChild(deleteBtn);
                    
                    if (galleryDiv.querySelector('p')) galleryDiv.innerHTML = '';
                    galleryDiv.appendChild(container);
                    downloadBtn.style.display = 'block';
                    document.getElementById('generateAiReportBtn').style.display = 'block';
                    document.getElementById('saveProjectBtn').style.display = 'block';
                }
                updateResults();
                statusDiv.innerText = 'Frame processed and added to gallery.';
            } catch (error) {
                console.error(`Error processing frame from ${videoName}:`, error);
                statusDiv.innerText = 'Error processing frame.';
            }
        }
        
        // --- FIX: This function now correctly calculates coordinates for 'object-contain' ---
        async function handleManualBlurOnLightbox(event) {
            const largeImage = event.target;
            const thumbnail = document.getElementById(currentLightboxImageId);
            
            // Ensure image and its natural dimensions are loaded/available
            if (!thumbnail || !largeImage.naturalWidth || largeImage.naturalWidth === 0) {
                console.warn("Manual blur cancelled: Lightbox image not fully loaded or has zero dimensions.");
                return;
            }

            // --- NEW COORDINATE LOGIC for 'object-contain' ---
            
            const {
                naturalWidth, naturalHeight, // Actual dimensions of the image file
                clientWidth, clientHeight     // Dimensions of the <img> element on screen
            } = largeImage;

            const rect = largeImage.getBoundingClientRect(); // Position of the <img> element

            // 1. Get aspect ratios
            const imageAspectRatio = naturalWidth / naturalHeight;
            const boxAspectRatio = clientWidth / clientHeight;

            let renderedWidth, renderedHeight, offsetX, offsetY;

            // 2. Compare ratios to find rendered size and offsets (letterboxing/pillarboxing)
            if (imageAspectRatio > boxAspectRatio) {
                // Image is wider than the box, constrained by width (letterboxed)
                renderedWidth = clientWidth;
                renderedHeight = clientWidth / imageAspectRatio;
                offsetX = 0;
                offsetY = (clientHeight - renderedHeight) / 2;
            } else {
                // Image is taller than or same as the box, constrained by height (pillarboxed)
                renderedHeight = clientHeight;
                renderedWidth = clientHeight * imageAspectRatio;
                offsetX = (clientWidth - renderedWidth) / 2;
                offsetY = 0;
            }

            // 3. Get click relative to the <img> element's box
            const clickX_relativeToBox = event.clientX - rect.left;
            const clickY_relativeToBox = event.clientY - rect.top;

            // 4. Get click relative to the *rendered image* inside the box
            const clickX_relativeToImage = clickX_relativeToBox - offsetX;
            const clickY_relativeToImage = clickY_relativeToBox - offsetY;

            // 5. Check if click was in the letterbox/pillarbox (outside the image)
            if (clickX_relativeToImage < 0 || clickX_relativeToImage > renderedWidth ||
                clickY_relativeToImage < 0 || clickY_relativeToImage > renderedHeight) {
                console.debug("Click was outside the image (in the letterbox area).");
                return; // Don't blur
            }

            // 6. Calculate scaling factor (from rendered image to natural image)
            // (We only need one, as aspect ratio is maintained)
            const scale = naturalWidth / renderedWidth; 
            
            // 7. Calculate final coordinates on the *natural, full-res* image
            const x = clickX_relativeToImage * scale;
            const y = clickY_relativeToImage * scale;

            // --- END NEW COORDINATE LOGIC ---
            
            // Save current state for undo
            const urlToRevoke = undoHistory.get(currentLightboxImageId);
            undoHistory.set(currentLightboxImageId, largeImage.src);
            undoBlurBtn.disabled = false;
            
            // Perform blur on canvas
            const tempImg = new Image();
            tempImg.crossOrigin = "anonymous"; // Handle potential canvas tainting if using object URLs
            
            tempImg.onload = () => {
                 try { // Wrap canvas operations in try-catch
                     manualBlurCanvas.width = tempImg.naturalWidth;
                     manualBlurCanvas.height = tempImg.naturalHeight;
                     manualBlurCtx.drawImage(tempImg, 0, 0); // Draw current image onto canvas
                     manualBlurCtx.filter = `blur(${MANUAL_BLUR_INTENSITY}px)`;
                     
                     // Use the UNscaled blur radius for drawing on the full-res canvas
                     const blurRadius = MANUAL_BLUR_RADIUS;
                     const effectiveX = Math.max(0, x - blurRadius);
                     const effectiveY = Math.max(0, y - blurRadius);
                     const effectiveWidth = Math.min(blurRadius * 2, tempImg.naturalWidth - effectiveX);
                     const effectiveHeight = Math.min(blurRadius * 2, tempImg.naturalHeight - effectiveY);
                     
                     if (effectiveWidth > 0 && effectiveHeight > 0) {
                         // Draw the blurred portion from the already-blurred canvas *back onto itself*
                         // This applies the blur only to the target area
                         manualBlurCtx.drawImage(manualBlurCanvas,
                            effectiveX, effectiveY, effectiveWidth, effectiveHeight,
                            effectiveX, effectiveY, effectiveWidth, effectiveHeight);
                     }
                     manualBlurCtx.filter = 'none'; // Reset filter IMPORTANT!
                     
                     // Update images
                     manualBlurCanvas.toBlob(newBlob => {
                          if (!newBlob) {
                               throw new Error("Canvas toBlob failed to create a blob.");
                          }
                         const newUrl = URL.createObjectURL(newBlob);
                         largeImage.src = newUrl; // Update lightbox image
                         thumbnail.src = newUrl; // Update gallery thumbnail
                         updateLightboxGallery(); // Update lightbox gallery thumbnail
                         if (urlToRevoke) {
                             URL.revokeObjectURL(urlToRevoke); // Clean up old undo URL
                         }
                     }, 'image/jpeg', 0.9); // Quality setting for JPEG
                 } catch (canvasError) {
                      console.error("Error during canvas blur operation:", canvasError);
                      showCustomAlert("An error occurred while applying the blur.",'error');
                      // Revert undo state if canvas fails
                      undoHistory.delete(currentLightboxImageId);
                      if (urlToRevoke) undoHistory.set(currentLightboxImageId, urlToRevoke); // Put old one back
                      undoBlurBtn.disabled = !undoHistory.has(currentLightboxImageId);
                 }
            };
            tempImg.onerror = () => {
                 console.error("Failed to load image into temp canvas for blurring.");
                  showCustomAlert("Error loading image for manual blur.",'error');
                 // Revert undo state if load fails
                 undoHistory.delete(currentLightboxImageId);
                 if (urlToRevoke) undoHistory.set(currentLightboxImageId, urlToRevoke); // Put old one back
                 undoBlurBtn.disabled = !undoHistory.has(currentLightboxImageId);
            }
            tempImg.src = largeImage.src; // Must set src AFTER onload/onerror are defined
        }
        
        function handleUndoBlur() {
            const lastStateUrl = undoHistory.get(currentLightboxImageId);
            if (lastStateUrl) {
                const largeImage = document.getElementById('lightboxImage');
                const thumbnail = document.getElementById(currentLightboxImageId);
                if (!thumbnail) return;
                const currentUrl = thumbnail.src; // URL to revoke AFTER applying the old one
                largeImage.src = lastStateUrl;
                thumbnail.src = lastStateUrl;
                undoHistory.delete(currentLightboxImageId); // Remove the undone state
                undoBlurBtn.disabled = true; // Disable undo until next blur
                updateLightboxGallery();
                // Revoke the URL that is no longer used
                setTimeout(() => URL.revokeObjectURL(currentUrl), 100);
            }
        }
        async function handleDeleteLightboxImage() {
            if (!currentLightboxImageId) return;
            if (!await showCustomConfirm('Are you sure you want to delete this image?')) return;
            
            // Find current index BEFORE deleting
            const galleryImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
            const currentIndex = galleryImages.findIndex(gImg => gImg.id === currentLightboxImageId);
            
            const item = document.getElementById(currentLightboxImageId)?.closest('.gallery-item');
            const img = document.getElementById(currentLightboxImageId);
            if (!item || !img) return;
            
            const imgUrl = img.src;
            const fileName = window.originalFileNames.get(currentLightboxImageId);
            if (fileName) {
                const resultIndex = imageResults.findIndex(res => res.fileName === fileName);
                if (resultIndex > -1) imageResults.splice(resultIndex, 1);
            }
            window.originalFileNames.delete(currentLightboxImageId);
            // Clean up undo history for the deleted image
            const undoUrl = undoHistory.get(currentLightboxImageId);
            if (undoUrl) URL.revokeObjectURL(undoUrl);
            undoHistory.delete(currentLightboxImageId);
            // Clean up risk data
            window.riskAssessmentData.delete(currentLightboxImageId);
            // Remove from gallery
            item.remove();
            updateResults();
            
            // Update lightbox gallery immediately
            updateLightboxGallery();
            
            // Try to show next/previous image, if not possible, close lightbox
            const remainingImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
            if(remainingImages.length > 0) {
                 // Show next image, or previous if we deleted the last one
                 const nextIndex = currentIndex < remainingImages.length ? currentIndex : remainingImages.length - 1;
                 showLightboxImage(remainingImages[nextIndex].id);
             } else {
                 closeLightboxFunc();
             }
            // Update main gallery display if it becomes empty
            if (galleryDiv.children.length === 0 || (galleryDiv.children.length === 1 && galleryDiv.querySelector('p'))) {
                galleryDiv.innerHTML = '<p class="text-slate-500 col-span-full text-center">Processed images/frames will appear here...</p>';
                downloadBtn.style.display = 'none';
                document.getElementById('generateAiReportBtn').style.display = 'none';
                document.getElementById('manual-blur-info').style.display = 'none';
            }
        }
        async function generateLatexReport(imageDataArray) {
            // LaTeX generation remains the same
            let latexContent = `\\documentclass[a4paper,12pt]{article}
\\usepackage[utf8]{inputenc}
\\usepackage{graphicx}
\\usepackage{geometry}
\\geometry{margin=1in}
\\usepackage{parskip}
\\usepackage{titlesec}
\\usepackage{enumitem}
\\usepackage{xcolor}
\\usepackage{hyperref}
\\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,
    urlcolor=cyan,
}
\\titleformat{\\section}{\\Large\\bfseries}{\\thesection}{1em}{}
\\titleformat{\\subsection}{\\large\\bfseries}{\\thesubsection}{1em}{}
\\begin{document}
\\title{Risk Assessment Report}
\\author{}
\\date{${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}}
\\maketitle
\\tableofcontents
\\newpage
`;
            for (let i = 0; i < imageDataArray.length; i++) {
                const { fileName, base64, riskData } = imageDataArray[i];
                const escapeLatex = (text) => {
                    if (!text) return '';
                    return text.replace(/([\\{}#$%&_^~])/g, '\\$1')
                               .replace(/\n/g, '\\\\\\newline ');
                };
                const description = escapeLatex(riskData.description || 'No description provided.');
                const hazards = escapeLatex(riskData.hazards || 'No hazards identified.');
                const controls = escapeLatex(riskData.controls || 'No controls specified.');
                const sanitizedFileName = escapeLatex(fileName);
                latexContent += `\\section{Image ${i + 1}: ${sanitizedFileName}}
\\begin{figure}[h]
    \\centering
    \\includegraphics[width=0.9\\textwidth]{${base64}}
    \\caption{${sanitizedFileName}}
\\end{figure}
\\subsection{Description of Step}
${description}
\\subsection{What Can Go Wrong / Spot Hazards}
${hazards}
\\subsection{Existing Control Measures}
${controls}
\\newpage
`;
            }
            latexContent += `\\end{document}`;
            return latexContent;
        }
        async function generatePDFReport(imageDataArray) {
            return new Promise((resolve, reject) => {
                try {
                    const doc = new PDFDocument({ size: 'A4', margin: 50 });
                    const stream = doc.pipe(blobStream());
                    doc.fontSize(20).text('Risk Assessment Report', { align: 'center' });
                    doc.moveDown();
                    doc.fontSize(12).text(`Date: ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`, { align: 'center' });
                    doc.moveDown(2);
                    doc.fontSize(16).text('Table of Contents', { align: 'left' });
                    doc.moveDown();
                    imageDataArray.forEach((item, i) => {
                        doc.fontSize(12).text(`${i + 1}. ${item.fileName}`, { align: 'left', indent: 20 });
                        doc.moveDown(0.5);
                    });
                    
                    imageDataArray.forEach((item, i) => {
                        doc.addPage();
                        const { fileName, base64, riskData } = item;
                        const sanitizeText = (text) => text ? text.replace(/\n/g, '\n') : '';
                        const description = sanitizeText(riskData.description || 'No description provided.');
                        const hazards = sanitizeText(riskData.hazards || 'No hazards identified.');
                        const controls = sanitizeText(riskData.controls || 'No controls specified.');
                        doc.fontSize(16).text(`Image ${i + 1}: ${fileName}`, { align: 'left' });
                        doc.moveDown();
                        
                        // Use a try-catch for image embedding
                        try {
                            const maxWidth = doc.page.width - 100;
                            const maxHeight = 300;
                           
                            // --- BUG FIX ---
                            // The 'Buffer' object is from Node.js and not available in the browser.
                            // pdfkit.js in the browser can accept the base64 data URL directly.
                           
                            // REMOVED: const imageBuffer = Buffer.from(base64.split(',')[1], 'base64');
                           
                            // We need to get the image dimensions to scale it correctly.
                            // We can't do this synchronously, but we can make a best-effort guess
                            // or use the fact that the image is already loaded in the DOM.
                            // For simplicity here, we'll try to create a new image to read dimensions.
                            // A better way would be to pass dimensions from the canvas generation.
                           
                            const tempImg = new Image();
                            tempImg.src = base64; // The base64 data URL
                            
                            let imgWidth, imgHeight;

                            if (tempImg.naturalWidth && tempImg.naturalHeight) {
                               // This might work if the image is cached by the browser
                                imgWidth = tempImg.naturalWidth;
                                imgHeight = tempImg.naturalHeight;
                            } else {
                                // Fallback dimensions if naturalWidth isn't available
                                // (e.g., if this runs before the img object fully loads,
                                // though setting .src should be blocking in this context)
                                // Let's assume a standard 4:3-ish ratio if we can't read it.
                                imgWidth = 640;
                                imgHeight = 480;
                            }
                                
                            // Scale image to fit PDF
                            const aspectRatio = imgHeight / imgWidth;
                            if (imgWidth > maxWidth) {
                                imgWidth = maxWidth;
                                imgHeight = imgWidth * aspectRatio;
                            }
                            if (imgHeight > maxHeight) {
                                imgHeight = maxHeight;
                                imgWidth = imgHeight / aspectRatio;
                            }

                           // CHANGED: Pass the base64 string directly instead of a Buffer
                           doc.image(base64, { fit: [imgWidth, imgHeight], align: 'center' });
                            // --- END BUG FIX ---

                        } catch (imgError) {
                            console.error("Error embedding image in PDF:", imgError);
                            doc.text(`[Error: Could not embed image ${fileName}]`, {color: 'red'});
                        }
                        doc.moveDown();
                        doc.fontSize(14).text('Description of Step:', { align: 'left' });
                        doc.fontSize(12).text(description, { align: 'left', indent: 20 });
                        doc.moveDown();
                        doc.fontSize(14).text('What Can Go Wrong / Spot Hazards:', { align: 'left' });
                        doc.fontSize(12).text(hazards, { align: 'left', indent: 20 });
                        doc.moveDown();
                        doc.fontSize(14).text('Existing Control Measures:', { align: 'left' });
                        doc.fontSize(12).text(controls, { align: 'left', indent: 20 });
                    });
                    doc.end();
                    stream.on('finish', () => {
                        resolve(stream.toBlob('application/pdf'));
                    });
                    stream.on('error', reject);
                } catch (error) {
                    reject(error);
                }
            });
        }
        lightboxImage.addEventListener('click', handleManualBlurOnLightbox);
        undoBlurBtn.addEventListener('click', handleUndoBlur);
        deleteLightboxBtn.addEventListener('click', handleDeleteLightboxImage);
        // --- NEW: Handle Replace Image ---
        if (replaceImageBtn && replaceImageInput) {
            replaceImageBtn.addEventListener('click', () => replaceImageInput.click());

            replaceImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !currentLightboxImageId) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const newBase64 = event.target.result;

                    // 1. Update the Lightbox Preview
                    lightboxImage.src = newBase64;

                    // 2. Update the Gallery Thumbnail
                    const galleryThumb = document.getElementById(currentLightboxImageId);
                    if (galleryThumb) galleryThumb.src = newBase64;

                    // 3. Update Filename (for export)
                    if (window.originalFileNames) {
                        window.originalFileNames.set(currentLightboxImageId, file.name);
                    }
                    
                    // 4. Clear Undo History (since it's a new image)
                    undoHistory.delete(currentLightboxImageId);
                    undoBlurBtn.disabled = true;

                    // 5. Success Message
                    if(window.showCustomAlert) window.showCustomAlert("Image replaced successfully!", "success");
                };
                reader.readAsDataURL(file);
                e.target.value = ''; // Reset input
            });
        }
        // --- END NEW ---
        prevArrow.addEventListener('click', showPreviousImage);
        nextArrow.addEventListener('click', showNextImage);
        document.addEventListener('keydown', (event) => {
            if (lightboxModal.style.display === 'flex') {
                // Don't trigger keyboard shortcuts if user is typing in an input/textarea
                const activeElement = document.activeElement;
                const isTyping = activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT' || activeElement.isContentEditable);
                
                if (event.key === 'ArrowRight' && !isTyping) showNextImage();
                else if (event.key === 'ArrowLeft' && !isTyping) showPreviousImage();
                else if (event.key === 'Escape') closeLightboxFunc();
                else if (event.key === 'Delete' && !isTyping) handleDeleteLightboxImage();
            }
        });
        // --- DELETE your entire, long downloadBtn.addEventListener('click', ...) function ---


/**
¬†* Reusable helper to add all gallery images to a JSZip object.
¬†* @param {JSZip} zip - An initialized JSZip instance.
¬†* @returns {Promise<{imageDataArray: Array, fetchPromises: Array, imageNameMap: Map<string, string>}>}
¬†*/
async function addImagesToZip(zip) {
    const galleryImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
    if (galleryImages.length === 0) {
        return { imageDataArray: [], fetchPromises: [], imageNameMap: new Map() };
    }

    // Get list of imageIds that ARE USED by NON-DELETED rows (only include these images)
    const usedImageIds = new Set();
    try {
        const allRows = document.querySelectorAll('#table-container tbody tr');
        allRows.forEach(row => {
            // Only include images from non-deleted rows
            if (!row.classList.contains('deleted-row') && row.dataset.deleted !== 'true') {
                const imageId = row.dataset.imageId;
                if (imageId) {
                    usedImageIds.add(imageId);
                    console.debug(`Adding image ${imageId} (used by non-deleted row)`);
                }
            }
        });
    } catch (e) {
        console.warn('Could not determine used images from non-deleted rows:', e);
    }

    const fetchPromises = [];
    const imageDataArray = []; // Still needed for the original PDF/LaTeX reports
    const imageNameMap = new Map(); // <<< NEW: Create the map
    const imageFolder = zip.folder("edited_images"); // Put images in a subfolder

    for (let i = 0; i < galleryImages.length; i++) {
        const imgElement = galleryImages[i];
        const imgUrl = imgElement.src;
        const originalFileName = window.originalFileNames.get(imgElement.id) || `image_${i}.jpg`;
        
    // Deterministic download filename (consistent with CSV) using helper
    const downloadFileName = createFinalFileName(originalFileName, i);

        const imgId = imgElement.id;
        const riskData = window.riskAssessmentData.get(imgId) || {};
        
        // Only include this image if it's used by at least one non-deleted row
        if (!usedImageIds.has(imgId)) {
            console.debug(`Skipping image ${downloadFileName} (not used by any non-deleted row)`);
            continue;
        }
        
        imageNameMap.set(imgId, downloadFileName); // <<< NEW: Populate the map

        const promise = fetch(imgUrl)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.blob();
            })
            .then(async blob => {
                imageFolder.file(downloadFileName, blob); // Add to zip's subfolder
                
                // This part is for the old PDF/LaTeX reports
                const base64 = await new Promise((resolve, reject) => {
                   const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(blob);
                });
                
                imageDataArray.push({
                    imgId: imgId,
                    fileName: downloadFileName,
                    originalFileName: originalFileName,
                    base64: base64,
                    riskData: {
                        description: riskData.description || '',
                        hazards: riskData.hazards || '',
                        controls: riskData.controls || ''
                    }
               });
            })
            .catch(error => console.error(`Failed to fetch or process ${downloadFileName}:`, error));
        
        fetchPromises.push(promise);
    }
    
    return { imageDataArray, fetchPromises, imageNameMap }; // <<< RETURN THE MAP
}// NEW, simplified listener for the ORIGINAL download button
downloadBtn.addEventListener('click', async () => {
    if (typeof JSZip === 'undefined') { 
        showCustomAlert("Error: JSZip library not loaded.", 'error'); 
        return; 
    }
    
    statusDiv.innerText = 'Preparing images and reports for download...';
    downloadBtn.disabled = true; downloadBtn.innerText = 'Zipping...';
    
    const zip = new JSZip();
    
    try {
        // 1. Add all images to the zip
        const { imageDataArray, fetchPromises } = await addImagesToZip(zip);
        await Promise.all(fetchPromises);
        
        // 2. Add the specific reports for THIS download button (LaTeX, old PDF, etc.)
        if (imageDataArray.length > 0) {
            // (Your existing code for generating LaTeX, JSON, and the *image-notes* PDF)
            try {
                const latexContent = await generateLatexReport(imageDataArray);
                zip.file("risk_assessment_report.tex", latexContent);
            } catch (latexError) {
                console.error("Error generating LaTeX report:", latexError);
                zip.file("ERROR_generating_latex_report.txt", `Error: ${latexError.message}`);
            }

            const jsonData = JSON.stringify(
                imageDataArray.reduce((acc, item) => {
                    acc[item.fileName] = {
                        originalName: window.originalFileNames.get(item.fileName.replace(/^final_\d+_/, '').replace(/(\.[^.]+)$/, '')) || item.fileName,
                        description: item.riskData.description,
                        hazards: item.riskData.hazards,
                        controls: item.riskData.controls
                    };
                    return acc;
                }, {}),
                null, 2
            );
            zip.file("risk_assessment_data.json", jsonData);
            
            if (typeof PDFDocument !== 'undefined' && typeof blobStream !== 'undefined') {
                try {
                    const pdfBlob = await generatePDFReport(imageDataArray);
                    zip.file("risk_assessment_report.pdf", pdfBlob);
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    zip.file("ERROR_generating_pdf_report.txt", `Error: ${error.message}`);
                }
            }
        }
        
        // 3. Generate and download the zip
        if (Object.keys(zip.files).length === 0) {
            statusDiv.innerText = `Failed to prepare any files for download.`;
            return;
        }

        const content = await zip.generateAsync({ type: "blob" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = "risk_assessment_package.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        statusDiv.innerText = 'ZIP download started!';

    } catch (error) {
        console.error("Error generating download ZIP:", error);
        statusDiv.innerText = 'Error generating ZIP file.';
    } finally {
        downloadBtn.disabled = false; downloadBtn.innerText = 'Download All Images and Reports as ZIP';
    }
});
// EXPOSE THE HELPER FUNCTION GLOBALLY
    window.addImagesToZip = addImagesToZip;
    // --- Speech-to-Text Feature (Enhanced) ---
let recognition = null;
let currentTarget = null;
let isRecording = false;
let interimTranscript = '';
const speechBtns = document.querySelectorAll('.speech-btn');

// Language code mapping for speech recognition
const SPEECH_LANG_MAP = {
    'en': 'en-US',
    'fr': 'fr-FR',
    'de': 'de-DE'
};

function getSpeechLanguage() {
    const appLang = localStorage.getItem('appLanguage') || 'en';
    return SPEECH_LANG_MAP[appLang] || 'en-US';
}

function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        speechBtns.forEach(btn => btn.style.display = 'none');
        console.warn("Speech Recognition not supported in this browser.");
        showCustomAlert("Speech-to-text is not supported in your browser. Try Chrome for best results.", 'info');
        return false;
    }
    recognition = new SpeechRecognition();
    recognition.lang = getSpeechLanguage(); // Sync with app language
    recognition.continuous = true; // Keep listening until manually stopped
    recognition.interimResults = true; // Show real-time transcription
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        let finalTranscript = '';
        interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        if (currentTarget) {
            // Append final transcript to textarea
            if (finalTranscript) {
                const currentVal = currentTarget.value;
                const needsSpace = currentVal && !currentVal.endsWith(' ') && !currentVal.endsWith('\n');
                currentTarget.value = currentVal + (needsSpace ? ' ' : '') + finalTranscript;
                currentTarget.dispatchEvent(new Event('input'));
            }
            
            // Show interim (live) transcription in a floating indicator
            updateInterimDisplay(interimTranscript);
        }
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        let errorMsg = 'Speech recognition error';
        switch(event.error) {
            case 'no-speech':
                errorMsg = t('No speech detected. Please speak into your microphone.');
                break;
            case 'audio-capture':
                errorMsg = t('No microphone found. Please ensure a microphone is connected.');
                break;
            case 'not-allowed':
                errorMsg = t('Microphone access denied. Please allow microphone access in your browser.');
                break;
            case 'network':
                errorMsg = t('Network error. Please check your internet connection.');
                break;
            default:
                errorMsg = t('Speech recognition error: ') + event.error;
        }
        showCustomAlert(errorMsg, 'error');
        stopRecognition();
    };

    recognition.onend = () => {
        // If still recording, restart (handles browser auto-stop)
        if (isRecording && currentTarget) {
            try {
                recognition.start();
            } catch (e) {
                stopRecognition();
            }
        } else {
            stopRecognition();
        }
    };

    return true;
}

// Floating interim display for live transcription preview
function updateInterimDisplay(text) {
    let interimDiv = document.getElementById('speechInterimDisplay');
    
    if (!text) {
        if (interimDiv) interimDiv.style.display = 'none';
        return;
    }
    
    if (!interimDiv) {
        interimDiv = document.createElement('div');
        interimDiv.id = 'speechInterimDisplay';
        interimDiv.className = 'speech-interim-display';
        interimDiv.innerHTML = `
            <div class="interim-label">Live Transcription</div>
            <div class="interim-text"></div>
        `;
        document.body.appendChild(interimDiv);
    }
    
    interimDiv.querySelector('.interim-text').textContent = 'üé§ ' + text + '...';
    interimDiv.style.display = 'block';
}

// Show/hide recording indicator at top of screen
function showRecordingIndicator(show, langName = '') {
    let indicator = document.getElementById('recordingIndicator');
    
    if (!show) {
        if (indicator) indicator.remove();
        return;
    }
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'recordingIndicator';
        indicator.className = 'recording-indicator';
        document.body.appendChild(indicator);
    }
    
    indicator.innerHTML = `
        <span class="rec-dot"></span>
        <span>REC</span>
        <span style="font-weight: 400; opacity: 0.9;">‚Ä¢ ${langName}</span>
        <span style="font-size: 12px; opacity: 0.7; margin-left: 8px;">(click mic to stop)</span>
    `;
}

function startRecognition(targetTextarea) {
    if (!recognition) {
        if (!initSpeechRecognition()) return;
    }
    
    // Update language before starting (in case user changed app language)
    recognition.lang = getSpeechLanguage();
    
    currentTarget = targetTextarea;
    isRecording = true;
    
    try {
        recognition.start();
    } catch (e) {
        // Already started, stop and restart
        recognition.stop();
        setTimeout(() => {
            try { recognition.start(); } catch (err) { console.error(err); }
        }, 100);
    }
    
    // Show current language name
    const langNames = { 'en-US': 'English', 'fr-FR': 'Fran√ßais', 'de-DE': 'Deutsch' };
    const currentLangName = langNames[recognition.lang] || recognition.lang;
    
    // Show prominent recording indicator at top
    showRecordingIndicator(true, currentLangName);
    
    // Update button to recording state with custom recording class
    speechBtns.forEach(btn => {
        if (btn.dataset.target === targetTextarea.id) {
            btn.classList.add('recording');
            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            // Change to stop icon
            btn.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />';
        }
    });
}

function stopRecognition() {
    isRecording = false;
    if (recognition) {
        try { recognition.stop(); } catch (e) { /* ignore */ }
    }
    currentTarget = null;
    interimTranscript = '';
    
    // Hide recording indicator
    showRecordingIndicator(false);
    
    // Hide interim display
    const interimDiv = document.getElementById('speechInterimDisplay');
    if (interimDiv) interimDiv.style.display = 'none';
    
    // Reset all buttons
    speechBtns.forEach(btn => {
        btn.classList.remove('recording', 'bg-red-600', 'hover:bg-red-700', 'animate-pulse');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        // Reset to mic icon
        btn.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />';
    });
}

// Attach click handlers to buttons
speechBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const targetId = btn.dataset.target;
        const targetTextarea = document.getElementById(targetId);
        if (!targetTextarea) return;

        if (currentTarget === targetTextarea) {
            stopRecognition();
        } else {
            if (currentTarget) stopRecognition(); // Stop any active
            startRecognition(targetTextarea);
        }
    });
});

// Initialize speech recognition when DOM is ready (or lightbox opens)
document.addEventListener('DOMContentLoaded', initSpeechRecognition);

// --- Save/Load Project Feature ---
async function saveProject() {
    // Check if there's either images/notes OR table data to save
    const hasImages = galleryDiv.querySelectorAll('.gallery-item img').length > 0;
    const hasTableData = document.querySelector('#table-container table') !== null;
    
    if (!hasImages && !hasTableData) {
        showCustomAlert("No data to save. Please generate a table or upload images.", 'info');
        return;
    }
    
    const projectData = {
        version: '1.0',
        images: [],
        riskData: Array.from(window.riskAssessmentData),
        tableData: window.extractTableData ? window.extractTableData() : null
    };
    
    const galleryImages = Array.from(galleryDiv.querySelectorAll('.gallery-item img'));
    const imagePromises = galleryImages.map(async (img) => {
        const response = await fetch(img.src);
        const blob = await response.blob();
        const base64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        });
        return {
            id: img.id,
            originalName: window.originalFileNames.get(img.id) || 'unknown.jpg',
            base64: base64
        };
    });
    
    projectData.images = await Promise.all(imagePromises);

    // Persist deleted-row state if table exists
    try {
        const tableState = projectData.tableData;
        if (tableState && document.querySelector('#table-container table')) {
            const deleted = [];
            const counterMeasuresData = {};
            
            document.querySelectorAll('#table-container tbody tr').forEach(tr => {
                const rowIndex = tr.dataset.rowIndex || tr.getAttribute('data-row-index');
                
                // Persist deleted rows
                if (tr.classList.contains('deleted-row') || tr.dataset.deleted === 'true') {
                    deleted.push(rowIndex);
                }
                
                // Persist counter measures / action items with step details
                let counterMeasures = [];
                if (tr.dataset.counterMeasures) {
                    try {
                        counterMeasures = JSON.parse(tr.dataset.counterMeasures);
                    } catch (e) {}
                }
                // Also check the global map
                if (window.selectedControlsMap && window.selectedControlsMap[`row_${rowIndex}`]) {
                    counterMeasures = window.selectedControlsMap[`row_${rowIndex}`];
                }
                
                if (counterMeasures.length > 0) {
                    // Get step details for linking
                    const cells = tr.querySelectorAll('td');
                    const stepsCell = cells[2]; // Steps is column index 2
                    const stepText = stepsCell ? stepsCell.textContent.trim() : '';
                    const hazardSourceCell = cells[11]; // Hazard Source column
                    const hazardSource = hazardSourceCell ? (hazardSourceCell.querySelector('input')?.value || hazardSourceCell.textContent.trim()) : '';
                    const riskScoreCell = cells[9]; // Risk Score column
                    const riskScore = riskScoreCell ? riskScoreCell.textContent.trim() : '';
                    const riskCategoryCell = cells[10]; // Risk Category column
                    const riskCategory = riskCategoryCell ? riskCategoryCell.textContent.trim() : '';
                    
                    counterMeasuresData[rowIndex] = {
                        stepText: stepText,
                        hazardSource: hazardSource,
                        currentRiskScore: riskScore,
                        currentRiskCategory: riskCategory,
                        controls: counterMeasures
                    };
                }
            });
            
            tableState.deletedRows = deleted;
            tableState.counterMeasures = counterMeasuresData;
            projectData.tableData = tableState;
        }
    } catch (e) {
        console.warn('Could not persist deleted rows state:', e);
    }
    
    const jsonBlob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(jsonBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'risk_project.json';
    link.click();
    URL.revokeObjectURL(url);
    showCustomAlert("Project saved as JSON!", 'success');
}

async function loadProject(file) {
    try {
        const text = await file.text();
        const projectData = JSON.parse(text);
        
        galleryDiv.innerHTML = '';
        window.originalFileNames.clear();
        window.riskAssessmentData.clear();
        undoHistory.clear();
        imageResults = [];
        
        for (const imgData of projectData.images) {
            const blob = await fetch(imgData.base64).then(res => res.blob());
            const imageUrl = URL.createObjectURL(blob);
            window.originalFileNames.set(imgData.id, imgData.originalName);
            
            const container = document.createElement('div');
            container.className = 'gallery-item relative w-full pt-[100%] h-0 cursor-grab';
            container.id = `gallery-item-${imgData.id}`;
            container.draggable = true;
            
            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            imgElement.alt = `Loaded ${imgData.originalName}`;
            imgElement.id = imgData.id;
            imgElement.className = "absolute top-0 left-0 w-full h-full object-cover rounded-lg shadow-md cursor-pointer transition-transform duration-200 hover:scale-105";
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn absolute top-1.5 right-1.5 z-10 bg-black/60 text-white w-5 h-5 rounded-full text-xs font-bold leading-none flex items-center justify-center hover:bg-red-600 transition';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.title = 'Delete this image';
            
            container.appendChild(imgElement);
            container.appendChild(deleteBtn);
            galleryDiv.appendChild(container);
            
            imageResults.push({ fileName: imgData.originalName, faceCount: 'Loaded' });
        }
        
        projectData.riskData.forEach(([id, data]) => {
            window.riskAssessmentData.set(id, data);
        });
        
        if (projectData.tableData && window.buildTableFromData) {
    const dashboardContainer = document.getElementById('dashboard-container');
    if (dashboardContainer) dashboardContainer.style.display = 'block';
    window.buildTableFromData(projectData.tableData.rows);
    if (window.populatePictureColumn) window.populatePictureColumn();
    if (window.initializeDashboard) window.initializeDashboard();
    if (window.updateAllCategoryColors) window.updateAllCategoryColors();
    if (window.updateDashboardMetrics) window.updateDashboardMetrics();
    // Restore deleted-row state saved in project JSON
    try {
        const deleted = projectData.tableData && projectData.tableData.deletedRows ? projectData.tableData.deletedRows : [];
        if (Array.isArray(deleted) && deleted.length > 0) {
            deleted.forEach(idx => {
                const row = document.querySelector(`#table-container tr[data-row-index="${idx}"]`);
                if (row) {
                    row.classList.add('deleted-row');
                    row.dataset.deleted = 'true';
                    // Update the button UI in the Delete cell (last td)
                    const delBtn = row.querySelector('td:last-child button');
                    if (delBtn) {
                        delBtn.textContent = 'Restore';
                        delBtn.className = 'restore-btn';
                        delBtn.title = 'Restore row';
                    }
                    // Also disable row controls so struck appearance is accurate
                    try {
                        const controls = Array.from(row.querySelectorAll('select, input, textarea, button'));
                        controls.forEach(control => {
                            if (control === delBtn) return;
                            control.setAttribute('disabled', 'true');
                            control.style.opacity = '0.6';
                            control.style.pointerEvents = 'none';
                        });
                    } catch (e) {
                        console.warn('Error restoring deleted row controls:', e);
                    }
                }
            });
        }
    } catch (e) {
        console.warn('Could not restore deleted rows from project file:', e);
    }
}

// Restore counter measures (action items) from saved project JSON
if (projectData.tableData && projectData.tableData.counterMeasures) {
    try {
        const counterMeasures = projectData.tableData.counterMeasures;
        window.selectedControlsMap = window.selectedControlsMap || {};
        
        // Handle new format (object with rowIndex keys containing step details)
        if (typeof counterMeasures === 'object' && !Array.isArray(counterMeasures)) {
            Object.keys(counterMeasures).forEach(rowIndex => {
                const data = counterMeasures[rowIndex];
                const row = document.querySelector(`#table-container tr[data-row-index="${rowIndex}"]`);
                if (row) {
                    // New format has controls array inside data object
                    const controls = data.controls || data;
                    if (Array.isArray(controls) && controls.length > 0) {
                        row.dataset.counterMeasures = JSON.stringify(controls);
                        window.selectedControlsMap[`row_${rowIndex}`] = controls;
                    }
                }
            });
            console.log(`‚úÖ Restored ${Object.keys(counterMeasures).length} rows with counter measures`);
        }
        // Handle legacy format (array with rowIndex and controls)
        else if (Array.isArray(counterMeasures) && counterMeasures.length > 0) {
            counterMeasures.forEach(item => {
                const row = document.querySelector(`#table-container tr[data-row-index="${item.rowIndex}"]`);
                if (row && item.controls) {
                    row.dataset.counterMeasures = JSON.stringify(item.controls);
                    window.selectedControlsMap[`row_${item.rowIndex}`] = item.controls;
                }
            });
            console.log(`‚úÖ Restored ${counterMeasures.length} rows with counter measures (legacy format)`);
        }
        // Update control indicators on table after restoring
        setTimeout(() => updateAllControlIndicators(), 100);
    } catch (e) {
        console.warn('Could not restore counter measures from project file:', e);
    }
}
        
        updateResults();
        downloadBtn.style.display = 'block';
        document.getElementById('generateAiReportBtn').style.display = 'block';
        document.getElementById('manual-blur-info').style.display = 'block';
        document.getElementById('saveProjectBtn').style.display = 'block';
        
        // Switch to Rich Media tab to show loaded images
        if (window.switchTab) {
            window.switchTab('rich-media');
        }
        
        showCustomAlert("Project loaded successfully!", 'success');
    } catch (error) {
        console.error("Error loading project:", error);
        showCustomAlert("Failed to load project: Invalid file.", 'error');
    }
}

// Attach listeners
document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
document.getElementById('saveProjectBtn2').addEventListener('click', saveProject);
document.getElementById('loadProjectBtn').addEventListener('click', () => document.getElementById('projectFileInput').click());
document.getElementById('projectFileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) loadProject(file);
    e.target.value = '';
});



    })(); // End of App 2's isolated scope

// Debug helper to see image matching status
window.debugImageMatching = function() {
    const results = {
        galleryImages: [],
        tableRows: [],
        matches: []
    };
    
    // 1. Gallery status
    const gallery = Array.from(document.querySelectorAll('.gallery-item img'));
    gallery.forEach(img => {
        results.galleryImages.push({
            id: img.id,
            originalName: window.originalFileNames.get(img.id),
            hasRiskData: window.riskAssessmentData.has(img.id),
            description: window.riskAssessmentData.get(img.id)?.description || ''
        });
    });
    
    // 2. Table row status
    const rows = Array.from(document.querySelectorAll('#table-container tbody tr'));
    rows.forEach(row => {
        const pictureCell = row.querySelector('.picture-cell');
        const stepCell = row.querySelector('td:nth-child(2)');
        results.tableRows.push({
            dataImageId: row.dataset.imageId,
            stepText: stepCell?.textContent || '',
            pictureCellDataFilename: pictureCell?.dataset.filename,
            hasThumbnail: !!pictureCell?.querySelector('img')
        });
    });

    // 3. Check matches
    rows.forEach((row, idx) => {
        const imageId = row.dataset.imageId;
        const stepText = row.querySelector('td:nth-child(2)')?.textContent || '';
        const match = {
            rowIndex: idx,
            stepText: stepText,
            imageId: imageId,
            matchType: '',
            foundImage: false
        };

        if (imageId && document.getElementById(imageId)) {
            match.matchType = 'direct';
            match.foundImage = true;
        } else if (stepText) {
            // Try matching by description
            for (const img of gallery) {
                const riskData = window.riskAssessmentData.get(img.id);
                if (riskData?.description && (
                    riskData.description.toLowerCase().includes(stepText.toLowerCase()) ||
                    stepText.toLowerCase().includes(riskData.description.toLowerCase())
                )) {
                    match.matchType = 'description';
                    match.foundImage = true;
                    match.matchedImageId = img.id;
                    break;
                }
            }
        }
        results.matches.push(match);
    });

    console.log('=== Image Matching Debug Info ===');
    console.log('Gallery Images:', results.galleryImages);
    console.log('Table Rows:', results.tableRows);
    console.log('Matches:', results.matches);
    return results;
};

// --- Compatibility override: Robust CSV generator to ensure Picture column is populated ---
// This wrapper will replace earlier implementations at runtime and provide multiple
// fallbacks when imageId mappings are missing (match by thumbnail src, picture cell
// dataset, or synthesize a deterministic filename).
window.generateRiskTableCSV = function(imageNameMap = new Map()) {
    const table = document.querySelector('#table-container table');
    if (!table) {
        console.error('CSV Export Error: Could not find the risk assessment table.');
        throw new Error('Could not find the table data to export.');
    }

    // Build a merged image name map (originalFileNames + provided imageNameMap)
    try {
        const merged = new Map();
        const galleryImgs = Array.from(document.querySelectorAll('.gallery-item img'));

        if (window.originalFileNames) {
            window.originalFileNames.forEach((orig, id) => {
                const idx = Math.max(0, galleryImgs.findIndex(img => img.id === id));
                merged.set(id, createFinalFileName(orig, idx));
            });
        }

        if (imageNameMap && imageNameMap.size > 0) {
            imageNameMap.forEach((fname, id) => merged.set(id, fname));
        }

        imageNameMap = merged;
        console.log('imageNameMap for CSV:', Array.from(imageNameMap));
    } catch (e) {
        console.warn('Error while building imageNameMap for CSV:', e);
    }

    const headerCells = Array.from(table.querySelector('thead tr').querySelectorAll('th'));
    const headers = headerCells.map(th => th.innerText.trim());

    const csv = [];
    csv.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','));

    const galleryImages = Array.from(document.querySelectorAll('.gallery-item img'));

    table.querySelectorAll('tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        const parts = [];

        headers.forEach((header, colIndex) => {
            const cell = cells[colIndex];
            if (!cell) { parts.push('""'); return; }

            if (header === 'Picture') {
                const imageId = row.dataset.imageId || '';
                let filename = '';

                // 1) direct mapping from merged map
                if (imageId && imageNameMap && imageNameMap.has(imageId)) {
                    filename = imageNameMap.get(imageId);
                }

                // 2) originalFileNames fallback
                if (!filename && window.originalFileNames && window.originalFileNames.has(imageId)) {
                    const orig = window.originalFileNames.get(imageId);
                    const idx = Math.max(0, galleryImages.findIndex(img => img.id === imageId));
                    filename = createFinalFileName(orig, idx);
                }

                // 3) picture cell dataset (set when table was populated)
                if (!filename) {
                    const pictureCell = row.querySelector('.picture-cell');
                    if (pictureCell && pictureCell.dataset && pictureCell.dataset.filename) {
                        const orig = pictureCell.dataset.filename;
                        const idx = parseInt(row.dataset.rowIndex, 10) || 0;
                        filename = createFinalFileName(orig, idx);
                    }
                }

                // 4) try to match by thumbnail src
                if (!filename) {
                    const pictureCell = row.querySelector('.picture-cell');
                    const imgTag = pictureCell ? pictureCell.querySelector('img') : null;
                    if (imgTag && imgTag.src) {
                        const match = galleryImages.find(g => g.src === imgTag.src || g.src === imgTag.getAttribute('data-src'));
                        if (match) {
                            const matchedId = match.id;
                            filename = (imageNameMap && imageNameMap.get(matchedId)) || (window.originalFileNames && window.originalFileNames.get(matchedId)) || matchedId;
                            if (window.originalFileNames && window.originalFileNames.get(matchedId)) {
                                filename = createFinalFileName(window.originalFileNames.get(matchedId), Math.max(0, galleryImages.indexOf(match)));
                            }
                        }
                    }
                }

                // 5) final fallback: synthesize from first gallery image or imageId
                if (!filename) {
                    if (galleryImages.length > 0) {
                        const g0 = galleryImages[0];
                        const orig = (window.originalFileNames && window.originalFileNames.get(g0.id)) || g0.id || imageId || '';
                        filename = orig ? createFinalFileName(orig, 0) : '';
                    }
                }

                parts.push(`"${(filename || '').replace(/"/g, '""')}"`);
                return;
            }

            // Generic cell types: select, input, textarea, or plain text
            let value = '';
            const sel = cell.querySelector('select');
            const inp = cell.querySelector('input');
            const ta = cell.querySelector('textarea');
            if (sel) value = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : sel.value;
            else if (inp) value = inp.value;
            else if (ta) value = ta.value;
            else value = cell.innerText.trim();

            parts.push(`"${(value || '').replace(/\r?\n|\r/g, ' ').replace(/"/g, '""')}"`);
        });

        csv.push(parts.join(','));
    });

    if (csv.length <= 1) throw new Error('No data available in the table to export.');
    return csv.join('\n');
};
    // --- !!! INTEGRATION SCRIPT ---
downloadBtn.addEventListener('click', async () => {
});
    document.getElementById('generateAiReportBtn').addEventListener('click', async () => {  // Add 'async' for awaits
    if (!window.riskAssessmentData || window.riskAssessmentData.size === 0) {
        showCustomAlert("No risk assessment notes found. Please add notes to your images in the lightbox preview first.");
        return;
    }

    const galleryImages = Array.from(document.querySelectorAll('#face-blurrer-app #imageGallery .gallery-item img'));
    const entries = [];  // Array of per-image entries
    galleryImages.forEach(imgElement => {
        const imgId = imgElement.id;
        const riskData = window.riskAssessmentData.get(imgId);
        if (riskData && (riskData.description?.trim() || riskData.hazards?.trim() || riskData.controls?.trim())) {
            // Build user ratings context if available
            let userRatingsContext = '';
            if (riskData.userFrequency || riskData.userSeverity || riskData.userLikelihood) {
                userRatingsContext = `\nUSER RATINGS (Keep these as primary values): Frequency=${riskData.userFrequency || 'not set'}, Severity=${riskData.userSeverity || 'not set'}, Likelihood=${riskData.userLikelihood || 'not set'}\n`;
            }
            
            const entryText = `--- ENTRY (ImageID: ${imgId}) ---\n` +
                              `STEP/DESCRIPTION: ${riskData.description || 'N/A'}\n` +
                              `HAZARDS: ${riskData.hazards || 'N/A'}\n` +
                              `CONTROLS: ${riskData.controls || 'N/A'}` +
                              userRatingsContext + '\n';
            entries.push(entryText);
        }
    });

    if (entries.length === 0) {
        showCustomAlert("No risk assessment notes found. Please add notes (description, hazards, or controls) to your images.");
        return;
    }

    // Chunk the entries (e.g., 5 per batch)
    const BATCH_SIZE = 2;
    const batches = [];
    for (let i = 0; i < entries.length; i += BATCH_SIZE) {
        batches.push(entries.slice(i, i + BATCH_SIZE).join(''));
    }

    // Show the risk section
    const dashboardContainer = document.getElementById('dashboard-container');
    if (dashboardContainer) dashboardContainer.style.display = 'block';
    
    // Now process batches and populate table
    await processBatchesAndPopulateTable(batches);
});
    // --- Custom Alert/Confirm Functions ---
¬† ¬† // (Replace native alert/confirm for better UX and consistency)
¬† ¬† 
¬† ¬† /**
¬† ¬†  * Shows a non-blocking toast notification.
¬† ¬†  * @param {string} message The text to display.
¬† ¬†  * @param {string} type 'info' (default), 'success', or 'error'.
¬† ¬†  */
¬† ¬† function showCustomAlert(message, type = 'info') {
¬† ¬† ¬† ¬† const container = document.getElementById('toast-container');
¬† ¬† ¬† ¬† if (!container) return; // Fail silently if container not found

¬† ¬† ¬† ¬† let bgColor, iconSVG;
¬† ¬† ¬† ¬† switch (type) {
¬† ¬† ¬† ¬† ¬† ¬† case 'success':
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† bgColor = 'bg-green-100 border-green-400 text-green-800';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† iconSVG = `<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† break;
¬† ¬† ¬† ¬† ¬† ¬† case 'error':
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† bgColor = 'bg-red-100 border-red-400 text-red-800';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† iconSVG = `<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† break;
¬† ¬† ¬† ¬† ¬† ¬† default: // 'info'
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† bgColor = 'bg-blue-100 border-blue-400 text-blue-800';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† iconSVG = `<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† break;
¬† ¬† ¬† ¬† }

        const toast = document.createElement('div');
        toast.className = `flex items-center gap-3 p-4 rounded-lg shadow-lg border ${bgColor} transition-all duration-300 opacity-0 translate-x-10`;
        toast.innerHTML = `
            <div class="flex-shrink-0">${iconSVG}</div>
            <div class="text-sm font-medium flex-1">${message}</div>
            <button type="button" class="flex-shrink-0 p-1.5 rounded-full inline-flex hover:bg-black/10" onclick="this.parentElement.remove()">
                <span class="sr-only">Close</span>
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        `;¬† ¬† ¬† ¬† container.appendChild(toast);
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // Animate in
¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† toast.classList.remove('opacity-0', 'translate-x-10');
¬† ¬† ¬† ¬† }, 10);

¬† ¬† ¬† ¬† // Auto-dismiss after 5 seconds
¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† toast.classList.add('opacity-0');
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => toast.remove(), 500); // Remove from DOM after fade out
¬† ¬† ¬† ¬† }, 5000);
¬† ¬† }

¬† ¬† /**
¬† ¬†  * Shows a blocking confirmation modal.
¬† ¬†  * @param {string} message The confirmation question.
¬† ¬†  * @returns {Promise<boolean>} Resolves true if confirmed, false if canceled.
¬† ¬†  */
¬† ¬† function showCustomConfirm(message) {
¬† ¬† ¬† ¬† return new Promise(resolve => {
¬† ¬† ¬† ¬† ¬† ¬† const modal = document.getElementById('confirmModal');
¬† ¬† ¬† ¬† ¬† ¬† const msgEl = document.getElementById('confirmMessage');
¬† ¬† ¬† ¬† ¬† ¬† const okBtn = document.getElementById('confirmOkBtn');
¬† ¬† ¬† ¬† ¬† ¬† const cancelBtn = document.getElementById('confirmCancelBtn');

¬† ¬† ¬† ¬† ¬† ¬† if (!modal || !msgEl || !okBtn || !cancelBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error("Confirm modal elements not found!");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† resolve(false); // Failsafe
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† msgEl.textContent = message;
¬† ¬† ¬† ¬† ¬† ¬† modal.style.display = 'flex';

¬† ¬† ¬† ¬† ¬† ¬† // We must clone and replace buttons to remove old listeners
¬† ¬† ¬† ¬† ¬† ¬† const newOkBtn = okBtn.cloneNode(true);
¬† ¬† ¬† ¬† ¬† ¬† okBtn.parentNode.replaceChild(newOkBtn, okBtn);

¬† ¬† ¬† ¬† ¬† ¬† const newCancelBtn = cancelBtn.cloneNode(true);
¬† ¬† ¬† ¬† ¬† ¬† cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

¬† ¬† ¬† ¬† ¬† ¬† newOkBtn.onclick = () => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† modal.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† resolve(true);
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† newCancelBtn.onclick = () => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† modal.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† resolve(false);
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† // Also allow closing by clicking overlay
¬† ¬† ¬† ¬† ¬† ¬† modal.onclick = (e) => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target === modal) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† modal.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† resolve(false);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† });
¬† ¬† }
</script>
<div id="excelImportModal" class="gy-modal-overlay" style="display:none;">
    <div class="gy-modal-content">
        <button class="gy-close-modal" onclick="document.getElementById('excelImportModal').style.display='none'">√ó</button>
        
        <h2 style="text-align:center; color:#2c3e50; margin-top:0;">Goodyear RA ‚Üí JSON Converter</h2>
        <p style="text-align:center; color:#7f8c8d; margin-bottom:20px;">Universal Tool: Images, Text-Only & Manual Uploads</p>

        <div class="gy-dashboard">
            <div id="gyDropZone" class="gy-dropzone">
                <div style="font-size: 40px;">üìÇ</div>
                <h3>Drop Excel File</h3>
                <p>Drag & Drop here</p>
                <p class="text-emerald-600/70 text-sm">.xlsx, .csv or .json (Project)</p>
            </div>



            <div class="gy-mapper-box">
                <div class="gy-mapper-header">
                    <h4>Column Mapping</h4>
                    <button id="gyRefreshBtn" type="button">‚Üª Refresh Data</button>
                </div>
                <div class="gy-mapper-grid">
                    <div class="gy-map-field"><label>Step No</label><input type="text" id="gyColStep" placeholder="A" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Desc</label><input type="text" id="gyColDesc" placeholder="B" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Haz Group</label><input type="text" id="gyColHazGroup" placeholder="C" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Haz List</label><input type="text" id="gyColHazList" placeholder="D" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Risk</label><input type="text" id="gyColRisk" placeholder="E" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Controls</label><input type="text" id="gyColControl" placeholder="H" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Frequency</label><input type="text" id="gyColFrequency" placeholder="" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Severity</label><input type="text" id="gyColSeverity" placeholder="" oninput="this.value=this.value.toUpperCase()"></div>
                    <div class="gy-map-field"><label>Likelihood</label><input type="text" id="gyColLikelihood" placeholder="" oninput="this.value=this.value.toUpperCase()"></div>
                </div>
            </div>
        </div>

<input type="file" id="gyFileInput" accept=".xlsx, .xls, .json" style="display:none">
        <div id="gyStatus" class="text-center text-sm font-semibold text-slate-500 py-2"></div>

        <div class="gy-split-container">
            
            <div class="gy-source-panel" id="gySourcePanel" style="display:none;">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-slate-700 text-sm">Source Images <span id="gyImgCount" class="font-normal text-xs text-slate-500"></span></h4>
                    <button onclick="gyDownloadAllImages()" class="text-xs text-emerald-600 hover:underline">Download All</button>
                </div>
                <p class="text-xs text-slate-400 mb-3">Drag & Drop to cards on the right</p>
                
                <div id="gySourceGrid" class="gy-source-scroll">
                    </div>
            </div>

            <div class="gy-cards-panel" id="gyCardsPanel">
                <div class="flex justify-between items-center px-2 mb-4 sticky top-0 bg-white z-10 pb-2 border-b border-slate-100">
                    <h4 class="font-bold text-slate-700 text-sm uppercase tracking-wider">Steps Preview</h4>
                    <button onclick="gyAddEmptyStep()" class="btn-indigo py-1.5 px-3 text-xs shadow-sm flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                        Add Step
                    </button>
                </div>
                
                <div class="scroll-zone scroll-top"></div>
                <div id="gyResult" class="gy-grid-container"></div> <div class="scroll-zone scroll-bottom"></div>
            </div>

        </div>
        <div class="pt-8 mt-auto border-t-2 border-slate-200 flex justify-end gap-4 items-center">
            <button id="gyExportBtn" style="display:none;" class="btn-white">üíæ Save Project (JSON)</button>
            <button id="gyForwardBtn" style="display:none;" class="btn-indigo">‚úì Load as New Project</button>
        </div>
    </div>
</div>

<script>
(function() { // Enclose in IIFE to protect existing app scope
    let gyZip = null;
    let gySheetDoc = null;
    let gyStrings = [];
    let gyFilename = "";
    let gyImagesByRow = {}; 
    let gyFullData = [];
    let gyAllSourceImages = []; // Store all found images

    const dropZone = document.getElementById('gyDropZone');
    const fileInput = document.getElementById('gyFileInput');
    const statusEl = document.getElementById('gyStatus');
    const refreshBtn = document.getElementById('gyRefreshBtn');
    const exportBtn = document.getElementById('gyExportBtn');
    const forwardBtn = document.getElementById('gyForwardBtn');

    // Event Listeners
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = e => loadFile(e.target.files[0]);
    dropZone.ondragover = e => { e.preventDefault(); dropZone.style.background = '#e1f0fa'; };
    dropZone.ondragleave = e => { e.preventDefault(); dropZone.style.background = '#f0f8ff'; };
    dropZone.ondrop = e => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); };
    refreshBtn.onclick = () => reprocessData();
    exportBtn.onclick = () => downloadJSON();

    // Connect Excel Tab file input to modal
    const excelUploadInput = document.getElementById('excelUpload');
    if (excelUploadInput) {
        excelUploadInput.addEventListener('change', e => {
            if (e.target.files && e.target.files[0]) {
                // Open the modal
                document.getElementById('excelImportModal').style.display = 'flex';
                // Trigger the file load through gyFileInput
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(e.target.files[0]);
                fileInput.files = dataTransfer.files;
                loadFile(e.target.files[0]);
            }
        });
    }

    // Expose global helpers for HTML onClick attributes
    window.gyRemoveRow = (id) => {
        gyFullData = gyFullData.filter(i => i.id !== id);
        document.getElementById(`card-${id}`).remove();
        statusEl.textContent = `‚úì ${gyFullData.length} steps remaining.`;
    };
    
    window.gyUpdateItem = (id, key, val) => {
        const item = gyFullData.find(i => i.id === id);
        if(item) item[key] = val;
    };

    window.gyManualUpload = (id, input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const item = gyFullData.find(i => i.id === id);
                if(item) {
                    item.base64 = e.target.result;
                    item.originalName = input.files[0].name;
                    renderCardImage(item);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    // --- NEW: Add Empty Step Function ---
    window.gyAddEmptyStep = () => {
        const newId = `manual-${Date.now()}`;
        // Calculate next row number
        const maxRow = gyFullData.length > 0 
            ? Math.max(...gyFullData.map(i => parseInt(i.row) || 0)) 
            : 0;
        const nextRow = maxRow + 1;

        // Add empty item
        gyFullData.push({
            id: newId,
            row: nextRow,
            step: "",
            desc: "",
            hazards: "",
            controls: "",
            base64: null, // Triggers "Add Photo" placeholder
            originalName: `manual_step_${nextRow}.jpg`
        });

        renderUI(); // Update view

        // Scroll to bottom
        const container = document.getElementById('gyResult');
        setTimeout(() => container.scrollTop = container.scrollHeight, 50);
        
        // Update status and buttons
        if(statusEl) statusEl.textContent = `‚úì Added new step. Total: ${gyFullData.length}`;
        const hasData = true;
        if(exportBtn) exportBtn.style.display = 'block';
        if(forwardBtn) forwardBtn.style.display = 'block';
    };

async function loadFile(file) {
        if(!file) return;
        gyFilename = file.name;

        // 1. NEW: Handle Project JSON File
        if (file.name.toLowerCase().endsWith('.json')) {
            statusEl.textContent = 'Loading Project...';
            statusEl.style.color = '#3b82f6'; // Blue
            await loadGyProject(file);
            return;
        }

        // 2. Existing Excel Logic
        statusEl.textContent = 'Parsing Excel file...';
        statusEl.style.color = '#333';
        gyImagesByRow = {}; 
        gyFullData = []; 
        gyAllSourceImages = []; // Clear gallery
        
        try {
            gyZip = await JSZip.loadAsync(file);
            const strXml = await gyZip.file("xl/sharedStrings.xml")?.async("text") || "";
            gyStrings = parseSharedStrings(strXml);
            
            const parser = new DOMParser();
            let bestSheetIdx = 1, maxScore = -1;
            for(let i=1; i<=10; i++) {
                const path = `xl/worksheets/sheet${i}.xml`;
                if(gyZip.file(path)) {
                    const xml = await gyZip.file(path).async("text");
                    const doc = parser.parseFromString(xml, "text/xml");
                    let score = scoreSheet(doc, gyStrings);
                    if(score > maxScore) { maxScore = score; bestSheetIdx = i; gySheetDoc = doc; }
                    if(i===1 && !gySheetDoc) gySheetDoc = doc;
                }
            }
            
            statusEl.textContent = 'Extracting images...';
            await loadSourceImages(); // Populate Left Gallery
            await extractImagesToMap(bestSheetIdx); // Map to rows
            
            detectColumns(gySheetDoc);
            reprocessData();
        } catch(e) { console.error(e); statusEl.textContent = "Error: "+e.message; }
    }

    async function loadGyProject(file) {
        try {
            const text = await file.text();
            const json = JSON.parse(text);
            
            if (!json.riskData || !json.images) throw new Error("Invalid Project File Structure");

            gyFullData = [];
            
            // Reconstruct Cards
            json.riskData.forEach((item, index) => {
                const id = item[0];
                const data = item[1];
                const imgObj = json.images.find(img => img.id === id);
                
                gyFullData.push({
                    id: id,
                    row: index + 1,
                    step: data.step || "",
                    desc: data.description || "",
                    hazards: data.hazards || "",
                    controls: data.controls || "",
                    base64: imgObj ? imgObj.base64 : null,
                    originalName: imgObj ? imgObj.originalName : `step_${index+1}.jpg`
                });
            });

            // Hide Source Gallery (since we are in Edit Mode, not Import Mode)
            document.getElementById('gySourcePanel').style.display = 'none';
            
            renderUI();
            statusEl.textContent = `‚úì Project Loaded: ${gyFullData.length} steps restored.`;
            statusEl.style.color = '#27ae60';

        } catch (e) {
            console.error(e);
            statusEl.textContent = "Error loading project: " + e.message;
            statusEl.style.color = 'red';
        }
    }

    function scoreSheet(doc, strings) {
        let score = 0;
        const rows = doc.getElementsByTagName("row");
        for(let i=0; i<Math.min(rows.length, 20); i++) {
            const cells = rows[i].getElementsByTagName("c");
            for(let j=0; j<cells.length; j++) {
                const txt = getCellText(cells[j], strings);
                if(txt.includes("Job") || txt.includes("Task") || txt.includes("Hazard")) score += 2;
            }
        }
        return score;
    }

    function detectColumns(xmlDoc) {
        const keywords = {
            step: ["Step No", "Task Step", "Task/Step"],
            desc: ["Job Step", "Task Description", "Job Description"],
            hGrp: ["Hazard Group"],
            hList: ["Hazard List"],
            risk: ["Risk/Consequences", "Risk / Consequences"],
            ctrl: ["Current Control", "Counter Measure"],
            freq: ["Frequency", "Freq"],
            sev: ["Severity", "Sev"],
            like: ["Likelihood", "Like"]
        };
        let map = {};
        const rows = xmlDoc.getElementsByTagName("row");
        for(let i=0; i<Math.min(rows.length, 50); i++) {
            const cells = rows[i].getElementsByTagName("c");
            for(let j=0; j<cells.length; j++) {
                const cell = cells[j];
                const txt = getCellText(cell, gyStrings);
                const rAttr = cell.getAttribute("r");
                if(!rAttr || !txt) continue;
                const colLetter = rAttr.replace(/[0-9]/g, '');
                
                if(keywords.step.some(k => txt.includes(k))) map.step = colLetter;
                if(keywords.desc.some(k => txt.includes(k))) map.desc = colLetter;
                if(keywords.hGrp.some(k => txt.includes(k))) map.hGrp = colLetter;
                if(keywords.hList.some(k => txt.includes(k))) map.hList = colLetter;
                if(keywords.risk.some(k => txt.includes(k))) map.risk = colLetter;
                if(keywords.ctrl.some(k => txt.includes(k))) map.ctrl = colLetter;
                if(keywords.freq.some(k => txt.includes(k))) map.freq = colLetter;
                if(keywords.sev.some(k => txt.includes(k))) map.sev = colLetter;
                if(keywords.like.some(k => txt.includes(k))) map.like = colLetter;
            }
            if(map.desc) break;
        }
        document.getElementById('gyColStep').value = map.step || "A";
        document.getElementById('gyColDesc').value = map.desc || "B";
        document.getElementById('gyColHazGroup').value = map.hGrp || "C";
        document.getElementById('gyColHazList').value = map.hList || "D";
        document.getElementById('gyColRisk').value = map.risk || "E";
        document.getElementById('gyColControl').value = map.ctrl || "H";
        document.getElementById('gyColFrequency').value = map.freq || "";
        document.getElementById('gyColSeverity').value = map.sev || "";
        document.getElementById('gyColLikelihood').value = map.like || "";
    }

    function reprocessData() {
        if(!gySheetDoc) return;
        const colMap = {
            step: document.getElementById('gyColStep').value.toUpperCase(),
            desc: document.getElementById('gyColDesc').value.toUpperCase(),
            hGrp: document.getElementById('gyColHazGroup').value.toUpperCase(),
            hList: document.getElementById('gyColHazList').value.toUpperCase(),
            risk: document.getElementById('gyColRisk').value.toUpperCase(),
            ctrl: document.getElementById('gyColControl').value.toUpperCase(),
            freq: document.getElementById('gyColFrequency').value.toUpperCase(),
            sev: document.getElementById('gyColSeverity').value.toUpperCase(),
            like: document.getElementById('gyColLikelihood').value.toUpperCase(),
        };
        gyFullData = [];
        const rows = gySheetDoc.getElementsByTagName("row");
        for(let i=0; i<rows.length; i++) {
            const row = rows[i];
            const rowNum = parseInt(row.getAttribute("r"));
            const cells = row.getElementsByTagName("c");
            let d = { step:"", desc:"", hGrp:"", hList:"", risk:"", ctrl:"", freq:"", sev:"", like:"" };
            
            for(let j=0; j<cells.length; j++) {
                const cell = cells[j];
                const rAttr = cell.getAttribute("r");
                if(!rAttr) continue;
                const col = rAttr.replace(/[0-9]/g, '');
                const val = getCellText(cell, gyStrings);
                if(col===colMap.step) d.step = val;
                if(col===colMap.desc) d.desc = val;
                if(col===colMap.hGrp) d.hGrp = val;
                if(col===colMap.hList) d.hList = val;
                if(col===colMap.risk) d.risk = val;
                if(col===colMap.ctrl) d.ctrl = val;
                if(col===colMap.freq) d.freq = val;
                if(col===colMap.sev) d.sev = val;
                if(col===colMap.like) d.like = val;
            }
            
            let haz = "";
            if(d.hGrp || d.hList) haz += `${d.hGrp} ${d.hGrp && d.hList ? '-' : ''} ${d.hList}`;
            if(haz && d.risk) haz += "\n";
            if(d.risk) haz += `Risk: ${d.risk}`;

            const img = gyImagesByRow[rowNum];
            if(d.desc || d.step || img) {
                gyFullData.push({
                    id: `gy-${rowNum}-${Date.now()}`, row: rowNum,
                    step: d.step, desc: d.desc, hazards: haz.trim(), controls: d.ctrl,
                    userFrequency: d.freq || null, userSeverity: d.sev || null, userLikelihood: d.like || null,
                    base64: img ? img.base64 : null, originalName: img ? img.originalName : null
                });
            }
        }
        renderUI();
        statusEl.textContent = `‚úì Found ${gyFullData.length} steps.`;
        statusEl.style.color = '#27ae60';
    }

    function renderUI() {
        const res = document.getElementById('gyResult');
        res.innerHTML = '';
        gyFullData.forEach(item => {
            const card = document.createElement('div');
            card.className = 'gy-card';
            card.id = `card-${item.id}`;
            
            card.innerHTML = `
                <div class="gy-card-img" id="img-wrap-${item.id}"></div>
                <div class="gy-card-body">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:0 0 60px"><label style="font-size:0.7rem; font-weight:bold; color:#999;">STEP</label><textarea class="gy-textarea" style="text-align:center; font-weight:bold; background:#e8f6f3;" oninput="gyUpdateItem('${item.id}','step',this.value)">${item.step}</textarea></div>
                        <div style="flex:1"><label style="font-size:0.7rem; font-weight:bold; color:#999;">DESCRIPTION</label><textarea class="gy-textarea" oninput="gyUpdateItem('${item.id}','desc',this.value)">${item.desc}</textarea></div>
                    </div>
                    <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">HAZARDS</label><textarea class="gy-textarea" style="background:#fff5f5; border-color:#f5c6cb;" oninput="gyUpdateItem('${item.id}','hazards',this.value)">${item.hazards}</textarea></div>
                    <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">CONTROLS</label><textarea class="gy-textarea" oninput="gyUpdateItem('${item.id}','controls',this.value)">${item.controls}</textarea></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px; padding-top:8px; border-top:1px solid #e5e7eb;">
                        <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">FREQUENCY</label><select class="gy-textarea" style="padding:4px; height:auto;" onchange="gyUpdateItem('${item.id}','userFrequency',this.value)">
                            <option value="">${item.userFrequency || 'Not set'}</option>
                            <option value="1">1 - RARELY</option>
                            <option value="1.25">1.25 - OCCASIONAL</option>
                            <option value="1.5">1.5 - INTERMEDIATE</option>
                            <option value="1.75">1.75 - FREQUENTLY</option>
                            <option value="2">2 - PERMANENT</option>
                        </select></div>
                        <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">SEVERITY</label><select class="gy-textarea" style="padding:4px; height:auto;" onchange="gyUpdateItem('${item.id}','userSeverity',this.value)">
                            <option value="">${item.userSeverity || 'Not set'}</option>
                            <option value="1">1 - No potential of injury</option>
                            <option value="3">3 - Potential of FIRST AID</option>
                            <option value="5">5 - Potential of MEDICAL TREATMENT</option>
                            <option value="7">7 - Potential of DART</option>
                            <option value="9">9 - Potential of SIA</option>
                            <option value="10">10 - Potential of Fatality</option>
                        </select></div>
                        <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">LIKELIHOOD</label><select class="gy-textarea" style="padding:4px; height:auto;" onchange="gyUpdateItem('${item.id}','userLikelihood',this.value)">
                            <option value="">${item.userLikelihood || 'Not set'}</option>
                            <option value="1">1 - Almost impossible</option>
                            <option value="3">3 - Very unlikely</option>
                            <option value="5">5 - Possible to happen</option>
                            <option value="8">8 - Likely to happen</option>
                            <option value="10">10 - Very likely to happen</option>
                        </select></div>
                    </div>
                </div>
            `;
            res.appendChild(card);
            renderCardImage(item);
        });
        const hasData = gyFullData.length > 0;
        if(exportBtn) exportBtn.style.display = hasData ? 'block' : 'none';
        if(forwardBtn) forwardBtn.style.display = hasData ? 'block' : 'none'; // Safe check
    }

    function renderCardImage(item) {
        const wrapper = document.getElementById(`img-wrap-${item.id}`);
        // Add Drag & Drop attributes to the wrapper
        wrapper.setAttribute("ondragover", "gyAllowDrop(event)");
        wrapper.setAttribute("ondrop", `gyDrop(event, '${item.id}')`);
        
        if(item.base64) {
            wrapper.innerHTML = `
                <div class="gy-row-badge">Row ${item.row}</div>
                <button class="gy-action-btn gy-del-btn" onclick="gyRemoveRow('${item.id}')" title="Delete Step">√ó</button>
                <label class="gy-action-btn gy-rep-btn" title="Replace Image">‚Üª<input type="file" accept="image/*" hidden onchange="gyManualUpload('${item.id}', this)"></label>
                <img src="${item.base64}" style="pointer-events:none;"> `;
        } else {
            wrapper.innerHTML = `
                <div class="gy-row-badge">Row ${item.row}</div>
                <button class="gy-action-btn gy-del-btn" onclick="gyRemoveRow('${item.id}')" title="Delete Step">√ó</button>
                <label class="add-photo-btn" style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#999; cursor:pointer; border:2px dashed #e2e8f0;">
                    <div style="font-size:36px; color:#27ae60;">+</div><div style="font-weight:600">Drop Image Here</div>
                    <input type="file" accept="image/*" hidden onchange="gyManualUpload('${item.id}', this)">
                </label>
            `;
        }
    }

    // --- Utilities ---
    function getCellText(cell, strings) {
        const tAttr = cell.getAttribute("t");
        const isTag = cell.getElementsByTagName("is")[0];
        if(isTag) {
            let t = "";
            const tTags = isTag.getElementsByTagName("t");
            for(let k=0; k<tTags.length; k++) t += tTags[k].textContent;
            return t;
        }
        const vTag = cell.getElementsByTagName("v")[0];
        if(vTag) {
            const val = vTag.textContent;
            if(tAttr === "s") return strings[parseInt(val)] || "";
            return val;
        }
        return "";
    }

    function parseSharedStrings(xml) {
        if(!xml) return [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, "text/xml");
        return Array.from(doc.getElementsByTagName("si")).map(si => {
            return Array.from(si.getElementsByTagName("t")).map(t => t.textContent).join("");
        });
    }

    async function extractImagesToMap(sheetIndex) {
        const relsPath = `xl/worksheets/_rels/sheet${sheetIndex}.xml.rels`;
        const relsXml = await gyZip.file(relsPath)?.async("text") || "";
        const addToMap = (row, base64, ext) => {
            gyImagesByRow[row] = { base64: `data:image/${ext};base64,${base64}`, originalName: `${gyFilename.split('.')[0]}_row${row}.${ext}` };
        };
        const sheetXmlStr = new XMLSerializer().serializeToString(gySheetDoc);
        const drawMatch = sheetXmlStr.match(/drawing r:id="([^"]+)"/);
        if(drawMatch) await processDrawingML(getTarget(relsXml, drawMatch[1]), addToMap);
        const vmlMatch = sheetXmlStr.match(/legacyDrawing r:id="([^"]+)"/);
        if(vmlMatch) await processVML(getTarget(relsXml, vmlMatch[1]), addToMap);
    }

    async function processDrawingML(path, callback) {
        const fullPath = resolvePath(path);
        if(!gyZip.file(fullPath)) return;
        const xml = await gyZip.file(fullPath).async("text");
        const relsPath = fullPath.replace(/(.*)\/([^\/]+)$/, "$1/_rels/$2.rels");
        const rels = await gyZip.file(relsPath)?.async("text") || "";
        const anchors = xml.matchAll(/<xdr:twoCellAnchor[^>]*>(.*?)<\/xdr:twoCellAnchor>/gs);
        for(const a of anchors) {
            const from = a[1].match(/<xdr:from>.*?<xdr:row>(\d+)<\/xdr:row>.*?<\/xdr:from>/s);
            const blip = a[1].match(/r:embed="([^"]*)"/);
            if(from && blip) {
                const imgTarget = getTarget(rels, blip[1]);
                if(imgTarget) await extractAndCallback(imgTarget, parseInt(from[1]) + 1, callback);
            }
        }
    }

    async function processVML(path, callback) {
        const fullPath = resolvePath(path);
        if(!gyZip.file(fullPath)) return;
        const xml = await gyZip.file(fullPath).async("text");
        const relsPath = fullPath.replace(/(.*)\/([^\/]+)$/, "$1/_rels/$2.rels");
        const rels = await gyZip.file(relsPath)?.async("text") || "";
        const shapes = xml.matchAll(/<(\w+:)?shape[^>]*>(.*?)<\/\1shape>/gs);
        for(const s of shapes) {
            const content = s[2];
            const rowMatch = content.match(/<(\w+:)?Row>(\d+)<\/\1Row>/) || s[0].match(/row="(\d+)"/);
            if(!rowMatch) continue;
            let imgId = content.match(/(?:r:id|o:relid)="([^"]+)"/)?.[1];
            if(imgId && rels) await extractAndCallback(getTarget(rels, imgId), parseInt(rowMatch[2] || rowMatch[1]) + 1, callback);
        }
    }

    async function extractAndCallback(path, row, callback) {
        const fullPath = resolvePath(path);
        if(!gyZip.file(fullPath)) return;
        const base64 = await gyZip.file(fullPath).async("base64");
        const ext = fullPath.split('.').pop();
        callback(row, base64, ext);
    }

    function getTarget(rels, rid) {
        const match = rels.match(new RegExp(`Id="${rid}".*?Target="([^"]+)"`));
        return match ? match[1] : null;
    }

    function resolvePath(p) {
        if(!p) return "";
        let clean = p.replace(/^\//, '').replace('../', '');
        if(gyZip.file(clean)) return clean;
        if(gyZip.file("xl/"+clean)) return "xl/"+clean;
        const fname = clean.split('/').pop();
        if(gyZip.file("xl/media/"+fname)) return "xl/media/"+fname;
        return "";
    }

    function downloadJSON() {
        const riskData = gyFullData.map(i => [i.id, { step: i.step, description: i.desc, hazards: i.hazards || "Nil", controls: i.controls || "" }]);
        const json = { version: "1.0", images: gyFullData.map(i => ({ id: i.id, originalName: i.originalName || `manual_upload_${i.row}.jpg`, base64: i.base64 || "" })), riskData: riskData, tableData: { headers: [], rows: [] } };
        const blob = new Blob([JSON.stringify(json, null, 2)], {type: "application/json"});
        saveAs(blob, `RA_Export_${new Date().toISOString().slice(0,10)}.json`);
    }

    // --- Forward to App Logic ---
// --- UPDATED: Forward to App Logic with Placeholders ---
    if (forwardBtn) {
        forwardBtn.onclick = () => {
            // 1. Helper to create a placeholder image for text-only rows
            function getPlaceholderB64() {
                const cvs = document.createElement('canvas');
                cvs.width = 800; cvs.height = 600;
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = "#f1f5f9"; // Slate-100 background
                ctx.fillRect(0,0,800,600);
                ctx.fillStyle = "#94a3b8"; // Slate-400 text
                ctx.font = "bold 40px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("No Image Available", 400, 280);
                ctx.font = "24px sans-serif";
                ctx.fillText("Click 'Replace Image' to Add Photo", 400, 330);
                return cvs.toDataURL('image/jpeg', 0.6);
            }
            const placeholder = getPlaceholderB64();

            // 2. Generate JSON (Inject placeholder if base64 is missing)
            const riskData = gyFullData.map(i => [
                i.id,
                { 
                    step: i.step,
                    description: i.desc, 
                    hazards: i.hazards || "Nil", 
                    controls: i.controls || "",
                    userFrequency: i.userFrequency || null,
                    userSeverity: i.userSeverity || null,
                    userLikelihood: i.userLikelihood || null
                }
            ]);

            const jsonObj = {
                version: "1.0",
                images: gyFullData.map(i => ({ 
                    id: i.id, 
                    originalName: i.originalName || `step_${i.row}_placeholder.jpg`, 
                    base64: i.base64 || placeholder // <--- THE CRITICAL FIX
                })),
                riskData: riskData,
                tableData: { headers: [], rows: [] }
            };

            // 3. Create virtual file and feed to Main App
            const jsonString = JSON.stringify(jsonObj, null, 2);
            const file = new File([jsonString], "imported_project.json", { type: "application/json" });

            const mainAppInput = document.getElementById('projectFileInput');
            if(mainAppInput) {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                mainAppInput.files = dataTransfer.files;
                mainAppInput.dispatchEvent(new Event('change', { bubbles: true }));
                document.getElementById('excelImportModal').style.display = 'none';
                if(window.showCustomAlert) window.showCustomAlert("Excel data imported! Click any placeholder image to add a real photo.", "success");
            } else {
                alert("Error: Could not find main project loader (projectFileInput).");
            }
        };
    }

    // --- NEW: Download Image Helper ---
    window.gyDownloadImage = (id) => {
        const item = gyFullData.find(i => i.id === id);
        if (item && item.base64) {
            const link = document.createElement('a');
            link.href = item.base64;
            link.download = item.originalName || `step_image_${item.row}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    // --- NEW: Gallery & Drag-Drop Logic ---

async function loadSourceImages() {
        const grid = document.getElementById('gySourceGrid');
        grid.innerHTML = '';
        let count = 0;
        
        console.log("--- DEBUG: Starting Image Scan ---");
        
        // Debug: List all files in ZIP to console
        const allFiles = Object.keys(gyZip.files);
        console.log("Files found in ZIP:", allFiles.filter(f => f.includes('media')));

        for (let filename in gyZip.files) {
            // Regex matches png, jpg, jpeg, gif, bmp, webp
            if (filename.match(/xl\/media\/.*\.(png|jpg|jpeg|gif|bmp|webp)$/i)) {
                console.log("Processing image:", filename); // Debug Log
                
                try {
                    const blob = await gyZip.files[filename].async("blob");
                    const b64 = await blobToBase64(blob);
                    const name = filename.split('/').pop();
                    gyAllSourceImages.push({name, blob});
                    
                    const div = document.createElement('div');
                    div.className = "gy-source-item";
                    div.draggable = true;
                    // Use object-contain to ensure full image visibility in gallery
                    div.innerHTML = `<img src="${b64}" class="w-full h-full object-contain pointer-events-none bg-slate-100" title="${name}">`;
                    
                    div.ondragstart = (e) => {
                        e.dataTransfer.setData("text/base64", b64);
                        e.dataTransfer.setData("text/filename", name);
                        e.dataTransfer.effectAllowed = "copy";
                    };
                    grid.appendChild(div);
                    count++;
                } catch(err) {
                    console.error("Error reading image:", filename, err);
                }
            }
        }
        
        console.log(`--- DEBUG: Total Images Added to Gallery: ${count} ---`);
        
        document.getElementById('gySourcePanel').style.display = count > 0 ? 'flex' : 'none';
        document.getElementById('gyImgCount').innerText = `(${count})`;
    }
    // --- NEW: Auto-Scroll Logic for Drag & Drop ---
    const cardsPanel = document.getElementById('gyCardsPanel');
    let autoScrollInterval;
    
    // Detect when dragging over the cards panel
    cardsPanel.addEventListener('dragover', (e) => {
        e.preventDefault();
        const { top, bottom, height } = cardsPanel.getBoundingClientRect();
        const mouseY = e.clientY;
        
        // Sensitivity zones (top 10% and bottom 10% of the panel)
        const threshold = height * 0.15; 
        
        clearInterval(autoScrollInterval); // Clear previous to prevent stacking

        if (mouseY < top + threshold) {
            // Scroll Up
            autoScrollInterval = setInterval(() => { cardsPanel.scrollTop -= 10; }, 16);
        } else if (mouseY > bottom - threshold) {
            // Scroll Down
            autoScrollInterval = setInterval(() => { cardsPanel.scrollTop += 10; }, 16);
        }
    });

    // Stop scrolling when drag leaves or drops
    cardsPanel.addEventListener('dragleave', () => clearInterval(autoScrollInterval));
    cardsPanel.addEventListener('drop', () => clearInterval(autoScrollInterval));
    // --- End Auto-Scroll ---

    // Download All Button Logic
    window.gyDownloadAllImages = () => {
        if(gyAllSourceImages.length === 0) return;
        const zip = new JSZip();
        gyAllSourceImages.forEach(img => zip.file(img.name, img.blob));
        zip.generateAsync({type:"blob"}).then(content => saveAs(content, "All_Extracted_Images.zip"));
    };

    // Global Drag & Drop Handlers
    window.gyAllowDrop = (e) => {
        e.preventDefault();
        e.currentTarget.style.backgroundColor = "#f0fff4"; // Highlight green
        e.currentTarget.style.borderColor = "#27ae60";
    };

    window.gyDrop = (e, itemId) => {
        e.preventDefault();
        e.currentTarget.style.backgroundColor = ""; // Reset styles
        e.currentTarget.style.borderColor = "";

        // 1. Handle Drop from Gallery (Base64)
        const base64 = e.dataTransfer.getData("text/base64");
        const filename = e.dataTransfer.getData("text/filename");

        // 2. Handle Drop from Desktop (File)
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            gyManualUpload(itemId, { files: e.dataTransfer.files });
            return;
        }

        // Apply Gallery Drop
        if(base64) {
            const item = gyFullData.find(i => i.id === itemId);
            if(item) {
                item.base64 = base64;
                item.originalName = filename || "gallery_image.jpg";
                renderCardImage(item);
            }
        }
    };

    function blobToBase64(blob) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        });
    }

})(); // End IIFE
</script>

</body>
</html>


